<html>
	<head>
		<link rel="stylesheet" type="text/css" href="asset://ui/hud.css?buster=4b"></link>
		<script src="asset://ui/hud.js?buster=79"></script>
		<!--script src="https://code.responsivevoice.org/responsivevoice.js"></script--><!-- https://code.responsivevoice.org/ -->

		<!-- CHAT BOX STUFF -->
		<style>
			.TwitchForceFix
			{
				position: absolute;
				bottom: 2px;
				left: 2px;
				font-family: Arial;
				border: 2px solid #999;
				border-radius: 3px;
				padding: 3px;
				cursor: pointer;
				opacity: 0.7;
			}

			.TwitchForceFix:hover
			{
				opacity: 1.0;
			}

			#chatPanel
			{
				/*opacity: 0.9;*/
			}

			.chatEntryContainer
			{
				/*display: block;*/
				font-family: Arial;
				-webkit-transition: opacity 1s ease-in-out;
			}

			.chatEntryDisplayName
			{
				display: inline-block;
				margin-right: 10px;
				text-shadow: 0.07em 0.07em black;
			}

			.chatEntryText
			{
				font-weight: bold;
				display: inline;
				text-shadow: 0.07em 0.07em black;
			}

			.chatLink
			{
				display: inline;
			}

			.chatLink:hover
			{
				text-decoration: underline;
			}

			.resetChatButton
			{
				display: none;
			}

.skinnyBars::-webkit-scrollbar
{
	width: 0px;
	height: 0px;
}

.skinnyBars::-webkit-scrollbar-track
{
	-webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.7);
	border-radius: 10px;
	background-color: rgba(100, 100, 100, 0.7);
}

.skinnyBars::-webkit-scrollbar-thumb
{
	border-radius: 10px;
	-webkit-box-shadow: inset 0 0 6px rgba(0,0,0,1);
	background-color: #555;
}

.skinnyBars::-webkit-scrollbar-corner
{
	background-color: transparent;
}

.opacityContainer
{
	opacity: 0.7;
	-webkit-transition: opacity 0.3s linear;
}

.opacityContainerOpacity
{
	opacity: 1 !important;
}

.opacityContainer:hover
{
	opacity: 1;
}

.avatarImg
{
	-webkit-transition: all 0.5s ease-in-out;
}

.avatarName
{
	opacity: 1 !important;
	-webkit-transition: all 0.5s linear;
}

.avatarNameOpacity
{
	opacity: 0 !important;
}

.chatLabelDiv
{
	opacity: 0.3;
}

.chatLabelDiv:hover
{
	opacity: 1;
}

.avatarButtons
{
	opacity: 0;
}

.avatarImgContainer:hover .avatarButtons
{
	/*border: 3px solid red;*/
	opacity: 0.7;
}

.avatarButtons:hover
{
	opacity: 1 !important;
}

		</style>
		<!-- END CHAT BOX STUFF -->

		<script>
			//setTimeout(function()
			//{
				//aaapi.cmd('bringToFront');
			//}, 1000);
			var g_opts;
			var smallIconSize = 24;
			var iconSize = 24;
			var g_twitchConfig = aaapi.cmdEx("getTwitchConfig");
			var g_autoCloseTasks = (aaapi.cmdEx("getConVarValue", "auto_close_tasks") == "1");

			function showWindowsTaskBar()
			{
				if( !!!g_opts )
					return;

				if( g_opts.fullscreen && g_opts.embeddedInstanceType === "AwesomiumBrowser")
					aaapi.cmd("consoleCommand", "show_windows_task_bar");
			}
		</script>
	</head>
	<body class="aaAllowSelect">
		<!-- CHAT BOX STUFF -->

		<div id="bigChatStuff" style="z-index: 100001; pointer-events: none; position: absolute; left: 0; top: 0; right: 0; bottom: 0; padding: 2px; padding-bottom: 32px;">

		<table style="width: 100%; height: 100%;">
		<tr ><td valign="bottom" align="left">

		<div align="left" class="aaTitleText aaTextColorOneColor aaTitleTextSizeFontSize" style=" padding: 16px; padding-bottom: 0; pointer-events: none; display: inline-block; display: none;" onclick="toggleChat()" id="chatTitle">Chat</div><br />

		<div style="display: none; pointer-events: all; max-width: 800px;" id="chatPanel">

		<div id="tabContentsContainer" style="width: 100%;">
			
		<div class="aaTabContent aaTextSizeFontSize aaTextColorTwoColor" tabid="session" style="padding: 0; margin: 0; border: 0;">
			<!--div class="aaWindowPaneContent aaWindowPaneContentScrollable aaScrollBars aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor aaTextSizeFontSize aaTextColorTwoColor" style="max-height: 200px; padding: 10px; display: none; margin-bottom: 10px; max-width: 700px;">
				<div id="chatLogContainer" class="chatLogContainer"></div>
			</div>
			<form id="chatForm" style="margin: 0; padding: 0;">
				<div class="aaTitleText aaThemeColorOneColor aaTitleTextSizeFontSize" style="display: inline-block;">Chat:</div>
				<input id="chatInput" type="text" class="aaTitleTextSizeFontSize" size="46" value="" onmouseup="return false;" style="display: inline-block; padding: 4px;" placeholder="Enter chat text here..." />
			</form>
			<br />
			<div id="sessionNamesList"></div-->

			<table cellspacing="0" cellpadding="0" style="width: 99%;">
				<tr>
					<td align="left" valign="bottom" width="1">
						<div class="aaWindowPaneContent aaWindowPaneContentScrollable aaTextSizeFontSize aaTextColorTwoColor twitchPane skinnyBars" style="border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; max-height: 800px; max-width: 740px; padding-top: 10px; padding-right: 10px; padding-bottom: 10px; padding-left: 10px; display: none; margin-bottom: 10px; overflow-x: hidden; ">
							<div id="chatLogContainer" class="chatLogContainer"></div>
						</div>
						<div id="sessionNamesList" style='font-family: Arial; font-weight: bold;'></div>
						<form id="chatForm" class="opacityContainer aaThemeColorTwoLowBorderColor aaThemeColorTwoHighBackgroundColor" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 2px; border-top-width: 2px; border-right-width: 2px; border-bottom-width: 2px; border-left-width: 2px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; width: 100%; ">
							<input id="chatInput" type="text" class="aaTitleTextSizeFontSize aaTextColorTwoColor" style="background-image: none; background-attachment: initial; background-origin: initial; background-clip: initial; background-color: initial; display: inline-block; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 4px; padding-right: 4px; padding-bottom: 4px; padding-left: 4px; background-position: initial initial; background-repeat: initial initial; " size="49" placeholder="" /><div class="chatLabelDiv aaTextColorTwoColor" style="display: inline-block; font-family: Arial; float: right; line-height: 38px; font-size: 24px; "><label style="cursor: pointer; padding-right: 4px; ">Show Log<input class="fulllogcheckbox" type="checkbox" id="sessionFullLogBox"></label></div>
						</form>
					</td>
				</tr>
			</table>
		</div>

		<div class="aaTabContent aaTextSizeFontSize aaTextColorTwoColor" tabid="social" style="padding: 0; margin: 0; border: 0;">
			<table cellspacing="0" cellpadding="0" style="width: 99%;">
				<tr>
					<td align="left" valign="bottom" width="1">
						<div class="aaWindowPaneContent aaWindowPaneContentScrollable aaTextSizeFontSize aaTextColorTwoColor twitchPane skinnyBars" style="border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; max-height: 800px; max-width: 740px; padding-top: 10px; padding-right: 10px; padding-bottom: 10px; padding-left: 10px; display: none; margin-bottom: 10px; overflow-x: hidden; ">
							<div id="socialChatLogContainer" class="chatLogContainer"></div>
						</div>
						<div id="socialNamesList" style='font-family: Arial; font-weight: bold;'></div>
						<form id="socialChatForm" class="opacityContainer aaThemeColorTwoLowBorderColor aaThemeColorTwoHighBackgroundColor" style="margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 2px; border-top-width: 2px; border-right-width: 2px; border-bottom-width: 2px; border-left-width: 2px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; width: 99%; white-space: nowrap;">
							<input id="socialChatInput" type="text" class="aaTitleTextSizeFontSize aaTextColorTwoColor" style="background-image: none; background-attachment: initial; background-origin: initial; background-clip: initial; background-color: initial; display: inline-block; border-top-width: 0px; border-right-width: 0px; border-bottom-width: 0px; border-left-width: 0px; border-style: initial; border-color: initial; border-image: initial; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 4px; padding-right: 4px; padding-bottom: 4px; padding-left: 4px; background-position: initial initial; background-repeat: initial initial; width: 620px;" size="49" placeholder="" /><div class="chatLabelDiv aaTextColorTwoColor" style="display: inline-block; font-family: Arial; float: right; line-height: 38px; font-size: 24px; "><label style="cursor: pointer; padding-right: 4px; ">Show Log<input class="fulllogcheckbox" type="checkbox" id="socialFullLogBox"></label></div>
						</form>
					</td>
				</tr>
			</table>

			<!--div style='display: none;'>
			<div class="aaWindowPaneContent aaWindowPaneContentScrollable aaScrollBars aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor aaTextSizeFontSize aaTextColorTwoColor" style="max-height: 200px; padding: 10px; display: none; margin-bottom: 10px; max-width: 700px;">
				<div id="socialChatLogContainer" class="chatLogContainer"></div>
			</div>

			<form id="socialChatForm" style="margin: 0; padding: 0;">
				<div class="aaTitleText aaThemeColorOneColor aaTitleTextSizeFontSize" style="display: inline-block;">Chat:</div>
				<input id="socialChatInput" type="text" class="aaTitleTextSizeFontSize" size="46" value="" onmouseup="return false;" style="display: inline-block; padding: 4px;" placeholder="Enter chat text here..." />
			</form>
			<br />
			<div id="socialNamesList"></div>
			</div-->
		</div>

		<script>
			var fullLogMode = localStorage.getItem('fullLogMode');
			fullLogMode = (fullLogMode === '1');

			var socialTab = document.querySelector('.aaTabContent[tabid="social"]');
			var socialFullLogCheckBox = document.querySelector('#socialFullLogBox');
			if( fullLogMode )
				socialFullLogCheckBox.checked = true;

			socialFullLogCheckBox.addEventListener('change', function(e)
			{
				switchLogMode();
			});

			var socialChatFormElem = document.querySelector('#socialChatForm');
			var socialChatInputElem = document.querySelector('#socialChatInput');
			socialChatInputElem.addEventListener('focus', function(e)
			{
				socialChatFormElem.classList.add('opacityContainerOpacity');
			}.bind(socialChatInputElem));
			socialChatInputElem.addEventListener('blur', function(e)
			{
				if( this.value == '' )
					socialChatFormElem.classList.remove('opacityContainerOpacity');
			}.bind(socialChatInputElem));




			var sessionTab = document.querySelector('.aaTabContent[tabid="session"]');
			var sessionFullLogCheckBox = document.querySelector('#sessionFullLogBox');
			if( fullLogMode )
				sessionFullLogCheckBox.checked = true;

			sessionFullLogCheckBox.addEventListener('change', function(e)
			{
				switchLogMode();
			});

			var sessionChatFormElem = document.querySelector('#chatForm');
			var sessionChatInputElem = document.querySelector('#chatInput');
			sessionChatInputElem.addEventListener('focus', function(e)
			{
				sessionChatFormElem.classList.add('opacityContainerOpacity');
			}.bind(sessionChatInputElem));
			sessionChatInputElem.addEventListener('blur', function(e)
			{
				if( this.value == '' )
					sessionChatFormElem.classList.remove('opacityContainerOpacity');
			}.bind(sessionChatInputElem));
		</script>

		<div class="aaTabContent aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor aaTextSizeFontSize aaTextColorTwoColor" tabid="addNewTwitch" style="display: none;">
			<form id="addNewTwitchChatForm" style="margin: 0; padding: 0;">
				<div class="aaTitleText aaThemeColorOneColor aaTitleTextSizeFontSize" style="display: inline-block;">Twitch Channel:</div>
				<input id="addNewTwitchInput" type="text" class="aaTitleTextSizeFontSize" size="49" value="" onmouseup="return false;" style="display: inline-block; padding: 4px;" placeholder="#" /><input type="submit" value="JOIN" style="display: inline-block; padding-left: 16px; padding-right: 16px; margin-left: 12px;" class="aaTitleTextSizeFontSize aaButton" />
			</form>
		</div>

		<div class="aaTabContent aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor aaTextSizeFontSize aaTextColorTwoColor" tabid="nothing" style="display: none;">
			<!--input type="text" id="nothingBox" class="aaTitleTextSizeFontSize" size="46" value="" onmouseup="return false;" style="display: inline-block; padding: 4px;" placeholder="" /--><div style='display: inline-block; margin-right: 8px; font-family: Arial;' class="aaTitleTextSizeFontSize">Chat Disconnected</div><input onclick="reset();" type="button" value="&#x21bb;" style="font-weight: 900;" class="aaTitleTextSizeFontSize resetChatButton helpNote" help="Attempt to reconnect to the chat servers." />
		</div>

		</div>

		<div class="TwitchForceFix" onclick="reset();" style="display: none;">Twitch Chat Reconnect</div>

		<div class='opacityContainer'>

		<script>
			var g_isResetting = false;
			var isTwitchEnabled = (aaapi.cmdEx("getConVarValue", "twitch_enabled") === "1");
			var twitchChannelsExist = false;
			if( isTwitchEnabled )
			{
				// grab our inter-tab memory
				var twitchChannels = localStorage.getItem("twitchChannels");
				if( !!twitchChannels )
					twitchChannels = JSON.parse(twitchChannels);
				else
					twitchChannels = {};
//console.log(JSON.stringify(twitchChannels));
				for( var x in twitchChannels )
				{
					if( twitchChannels[x] >= 0 )
					{
						twitchChannelsExist = true;
						break;
					}
				}

				if( !twitchChannelsExist )
				{
					//console.log("Open twitch connection...");
					aaapi.cmd("openTwitchConnection");
				}
			}

			var expression = /[-a-zA-Z0-9@:%_\+.~#?&//=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#?&//=]*)?/gi;
			var regex = new RegExp(expression);
			function isLink(t)
			{
				if (t.match(regex) && "abcdefghijklmnopqrstuvwxyz0123456789".indexOf(t[0]) >= 0 )
					return true;
				else
					return false;
			}

			function isItemMSFXML(t)
			{
				return (t.indexOf('<msfitem ') == 0);
			}

			var fields = ['title', 'file', 'screen', 'marquee', 'preview', 'reference', 'stream', 'download', 'description', 'tags'];//, 'app', 'type'];
			function parseItemMSFXML(t)
			{
				var item = {
					info: {
						id: ''
					}
				};
				var dummy = document.createElement('div');
				dummy.innerHTML = t;

				var xml = dummy.firstChild;
				if( !!!xml || typeof xml.getAttribute != 'function' )
					return;

				var fieldName, fieldValue;
				for( var i = 0; i < fields.length; i++ )
				{
					fieldName = fields[i];
					fieldValue = xml.getAttribute(fieldName);
					if( !!fieldValue && fieldValue != '' )
						item[fieldName] = decodeURIComponent(fieldValue);
				}
				return item;
			}

			function fetchTwitchStream(channel)
			{
				// get the client's IP
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.onreadystatechange = function()
				{ 
					if (xmlHttp.readyState == 4)
					{
						if(xmlHttp.status == 200)
						{
							//console.log(xmlHttp.responseText);
							var twitchInfo = JSON.parse(xmlHttp.responseText);
							console.log(JSON.stringify(twitchInfo));
						}
						else
							console.log("Failed to fetch Twitch stream info.");
					}
				}
				
				xmlHttp.open("GET", "http://www.anarchyarcade.com/twitch/testlive.php?channel=" + channel, true);
				xmlHttp.send(null);
			}

			var uiBack = arcadeHud.getParameterByName("uiback");
			if( !uiBack )
				uiBack = "";

			// use session storage
			var tabId = sessionStorage.getItem("aaChatTab", tabId);
			if( !!!tabId )
				tabId = "";

			var isSocial = aaapi.cmdEx("getSocialMode");

			var tabs = [];
			var universeInfo = aaapi.cmdEx("getConnectedSession");// : null;
			if( universeInfo )
			{
				tabs.push({
					"id": "session",
					"title": "Lobby"
				});
			}

			if( isSocial )
			{
				tabs.push({
					"id": "social",
					"title": "Social"
				});
			}


			if( twitchChannelsExist )
			{
				// grab our inter-tab memory
				var twitchChannels = localStorage.getItem("twitchChannels");
				if( !!twitchChannels )
					twitchChannels = JSON.parse(twitchChannels);
				else
					twitchChannels = {};

				for( var x in twitchChannels )
				{
					if( twitchChannels[x] === -1 )
						continue;

					tabs.push({
						"id": "twitch" + x.substring(1),
						"title": "<div style='display: inline-block;' channel='" + x + "'><img src='hosticon.png' style='width: 16px; height: 16px; margin-right: 8px; display: none;' class='channelLiveButton helpNote' help='This Twitch channel is currently live!' channel='" + x + "' />" + x + "</div> <img src='xicon.png' style='width: 12px; height: 12px; margin-left: 8px;' class='channelCloseButton helpNote' help='Close this Twitch channel\'s chat tab.' />"
					});
				}
			}

			if( tabs.length > 0 )
			{
				var foundTab = false;
				for( var i = 0; i < tabs.length; i++ )
				{
					if( tabs[i].id === tabId )
					{
						foundTab = true;
						break;
					}
				}

				if( !foundTab )
				{
					// if the tab we want is not visible, let's auto-select the 1st available tab.
					tabId = tabs[0].id;
				}
			}

			var selectTwitchIconHTML = arcadeHud.generateIconHTML("objecticon.png", 32, 32, "aaTextColorTwoColor");
			var clearTwitchIconHTML = arcadeHud.generateIconHTML("eraseicon.png", 32, 32, "aaTextColorTwoColor");
			var clearAllTwitchIconHTML = arcadeHud.generateIconHTML("eraseallicon.png", 32, 32, "aaTextColorTwoColor");

			var chatAvatars = localStorage.getItem('customChatUser');
			if( !!chatAvatars )
				chatAvatars = JSON.parse(chatAvatars);
			else
				chatAvatars = [];
			/*[
				{
					name: 'AnarchyArcade',
					avatar: 'http://jk.smsithlord.com/chat/sm_sith_lord.jpg'
				},
				{
					name: 'projectxr3',
					avatar: 'https://i.imgur.com/EBXyEMN.png'
				},
				{
					name: 'pux1g',
					avatar: 'http://static-cdn.jtvnw.net/jtv_user_pictures/8e84ead7-233c-4d4f-a665-c5b0e15fb91e-profile_image-70x70.jpg'
				},
				{
					name: 'jojohnon',
					avatar: 'https://i.imgur.com/49HlT2d.png'
				},
				{
					name: 'teasnutz',
					avatar: 'http://smsithlord.com/pux/_hstnutz.jpg'
				}
			];*/
			//localStorage.setItem('customChatUser', JSON.stringify(chatAvatars));

			var socialChatLogContainerElem;
			function getChatAvatar(displayName, container)
			{
				var avatar;
				if( !!!socialChatLogContainerElem )
					socialChatLogContainerElem = document.querySelector("#socialChatLogContainer");

				// first, try to grab a provided avatar
				//if( container === socialChatLogContainerElem )
				//{
					for( var x in g_socialUsers )
					{
								//console.log(JSON.stringify(g_socialUsers[x].displayName));
						if( !!g_socialUsers[x].displayName && g_socialUsers[x].displayName.toLowerCase() == displayName.toLowerCase() )
						{
							avatar = g_socialUsers[x].avatar;
							//if( avatar.indexOf(':') == 1 )
								//avatar = "asset://local/" + avatar;



							//https://pbs.twimg.com/profile_images/646520348318404608/cENmZV0h_400x400.png
							//return avatar;
						}
					}
				//}

				if( !!!avatar )
				{
					var allUsers = aaapi.cmdEx("getAllUsers");
					for( var x in allUsers )
					{
					//for( var x in g_socialUsers )
					//{
								//console.log(JSON.stringify(allUsers[x]));
						if( !!allUsers[x].displayName && allUsers[x].displayName.toLowerCase() == displayName.toLowerCase() )
						{
							avatar = allUsers[x].avatarUrl;
							//if( avatar.indexOf(':') == 1 )
								//avatar = "asset://local/" + avatar;



							//https://pbs.twimg.com/profile_images/646520348318404608/cENmZV0h_400x400.png
							//return avatar;
						}
					}
				}

				for( var i = 0; i < chatAvatars.length; i++ )
				{
					if( chatAvatars[i].name.toLowerCase() == displayName.toLowerCase() )
					{
						//return undefined;
						avatar = chatAvatars[i].avatar;
						if( avatar.indexOf(':') == 1 )
							avatar = "asset://local/" + avatar;
						//https://pbs.twimg.com/profile_images/646520348318404608/cENmZV0h_400x400.png
						//return avatar;
					}
				}

				return avatar;
			}

			function setChatAvatar(displayName, url)
			{
				var didSet = false;
				for( var i = 0; i < chatAvatars.length; i++ )
				{
					if( chatAvatars[i].name.toLowerCase() == displayName.toLowerCase() )
					{
						chatAvatars[i].avatar = url;
						didSet = true;
						break;
					}
				}

				if( !didSet )
					chatAvatars.push({
						name: displayName,
						avatar: url
					});

				localStorage.setItem('customChatUser', JSON.stringify(chatAvatars));
			}

			function switchLogMode()
			{
				if( fullLogMode )
				{
					fullLogMode = false;
					localStorage.setItem('fullLogMode', '0');
					document.location.reload();
					/*
					var elems = document.querySelectorAll('.twitchPane');
					for( var i = 0; i < elems.length; i++ )
					{
						elems[i].classList.remove('.skinnyBars');
						elems[i].classList.add('.aaScrollBars');
					}
					*/
				}
				else
				{
					fullLogMode = true;
					localStorage.setItem('fullLogMode', '1');
					document.location.reload();
					/*var elems = document.querySelectorAll('.chatLogContainer');
					for( var i = 0; i < elems.length; i++ )
					{
						elems[i].innerHTML = '';
					}

					elems = document.querySelectorAll('.twitchPane');
					for( var i = 0; i < elems.length; i++ )
					{
						elems[i].classList.remove('.aaScrollBars');
						elems[i].classList.add('.skinnyBars');
					}

					//onNewSessionChatDetected();
					//onNewSocialChatDetected();
					//twitchChatDetect();
					*/
				}
			}

			function onTwitchChannelDetected(twitchChannels, channel)
			{
				var tabElem = document.createElement('div');
				tabElem.className = 'aaTabContent aaTextSizeFontSize aaTextColorTwoColor';
				tabElem.style.cssText = 'border: 0; padding: 0;';
				var thisTabid = 'twitch' + channel.substring(1);
				tabElem.setAttribute('tabid', thisTabid);

				if( thisTabid === tabId )
					tabElem.style.display = "block";
				else
					tabElem.style.display = "none";

				var paneContentElem = document.createElement('div');
				paneContentElem.className = 'aaWindowPaneContent aaWindowPaneContentScrollable aaTextSizeFontSize aaTextColorTwoColor twitchPane skinnyBars';
				paneContentElem.style.cssText = 'border: 0; max-height: 800px; max-width: 740px; padding: 10px; display: none; margin-bottom: 10px; overflow-x: hidden;';

				var chatTableElem = document.createElement('table');
				chatTableElem.cellSpacing = '0';
				chatTableElem.cellPadding = '0';
				chatTableElem.style.cssText = 'width: 99%;';

				var chatTableRowElem = document.createElement('tr');
				chatTableElem.appendChild(chatTableRowElem);


				var chatTableCellBElem = document.createElement('td');
				chatTableRowElem.appendChild(chatTableCellBElem);
				chatTableCellBElem.align = 'left';
				chatTableCellBElem.vAlign = 'bottom';
				chatTableCellBElem.width = '1';
				//chatTableCellBElem.style.border = '2px solid red';

				var twitchButtonsContainer = document.createElement('div');
				twitchButtonsContainer.channel = channel;
				chatTableCellBElem.appendChild(twitchButtonsContainer);
				twitchButtonsContainer.className = 'opacityContainer';

				var clearTwitchElem = document.createElement('div');
				clearTwitchElem.style.display = "block";
				clearTwitchElem.style.cursor = 'pointer';
				clearTwitchElem.className = "helpNote";
				clearTwitchElem.setAttribute("help", "Clear your chat log for this channel.");
				clearTwitchElem.innerHTML = clearTwitchIconHTML;
				//clearTwitchElem.src = 'eraseicon.png';
				clearTwitchElem.addEventListener('click', function(e)
				{
					// find the chat log for this channel
					var twitchChatLog = localStorage.getItem('twitchChatLog' + this.channel);
					if( !!twitchChatLog )
					{
						localStorage.removeItem('twitchChatLog' + this.channel);

						var twitchChannels = localStorage.getItem("twitchChannels");
						if( !!twitchChannels )
							twitchChannels = JSON.parse(twitchChannels);
						else
							twitchChannels = {};

						twitchChannels[this.channel] = (new Date()).getTime();
						localStorage.setItem("twitchChannels", JSON.stringify(twitchChannels));
					}
				}.bind(twitchButtonsContainer));
				twitchButtonsContainer.appendChild(clearTwitchElem);
				arcadeHud.assignHelp(clearTwitchElem);

				var clearAllTwitchElem = document.createElement('div');
				clearAllTwitchElem.style.display = "block";
				clearAllTwitchElem.style.cursor = 'pointer';
				clearAllTwitchElem.className = "helpNote";
				clearAllTwitchElem.setAttribute("help", "Clear ALL chat logs for ALL channels.");
				clearAllTwitchElem.innerHTML = clearAllTwitchIconHTML;
				//clearTwitchElem.src = 'eraseicon.png';
				clearAllTwitchElem.addEventListener('click', function(e)
				{
					var twitchChannels = localStorage.getItem("twitchChannels");
					if( !!twitchChannels )
						twitchChannels = JSON.parse(twitchChannels);
					else
						twitchChannels = {};

					if( isTwitchEnabled )
					{
						var twitchChannels = localStorage.getItem("twitchChannels");
						if( !!twitchChannels )
							twitchChannels = JSON.parse(twitchChannels);
						else
							twitchChannels = {};

						for( var x in twitchChannels )
						{
							// find the chat log for this channel
							var twitchChatLog = localStorage.getItem('twitchChatLog' + x);
							if( !!twitchChatLog )
							{
								localStorage.removeItem('twitchChatLog' + x);
								twitchChannels[x] = (new Date()).getTime();
							}
						}
						localStorage.setItem("twitchChannels", JSON.stringify(twitchChannels));
					}
				}.bind(twitchButtonsContainer));
				twitchButtonsContainer.appendChild(clearAllTwitchElem);
				arcadeHud.assignHelp(clearAllTwitchElem);

				if( arcadeHud.oldIsMapLoaded )
				{
					var selectTwitchElem = document.createElement('div');
					selectTwitchElem.style.display = "block";
					selectTwitchElem.style.cursor = 'pointer';
					selectTwitchElem.className = "helpNote aaOnlyIfMapLoaded aaOnlyIfHost";
					selectTwitchElem.setAttribute("help", "Spawn (or select) this Twitch stream into your arcade.");
					selectTwitchElem.innerHTML = selectTwitchIconHTML;
					//selectTwitchElem.src = 'objecticon.png';
					selectTwitchElem.addEventListener('click', function(e)
					{
						var file = "twitch.tv/" + this.channel.substring(1);

						var foundObject = false;
						var objectId = aaapi.cmdEx("getObjectWithFile", file);
						if( objectId !== "" )
						{
							var object = aaapi.cmdEx("getObject", objectId);
							if( !!object && object.entity > -1)
							{
								foundObject = true;

								aaapi.cmd("addToastMessage", "Object Selected");
								aaapi.cmd("attemptSelectEntity", object.entity, false);
								aaapi.cmd("deactivateInputMode");
							}
						}

						if( !foundObject )
						{
							aaapi.cmd("setLibraryBrowserContext", "items", "", "", "");
						//	aaapi.cmd("addToastMessage", "Not found in arcade.");
							document.location = "asset://ui/createItem.html?fileLocation=" + encodeURIComponent("http://www.twitch.tv/" + this.channel.substring(1));
						}
					}.bind(twitchButtonsContainer));
					twitchButtonsContainer.appendChild(selectTwitchElem);
					arcadeHud.assignHelp(selectTwitchElem);
				}

				var refreshTwitchElem = document.createElement('div');
				refreshTwitchElem.style.cssText = "display: block; font-size: 32px; font-weight: 900;";
				refreshTwitchElem.style.cursor = 'pointer';
				refreshTwitchElem.className = "helpNote aaTextColorTwoColor";
				refreshTwitchElem.setAttribute("help", "Refresh & reconnect to Twitch if your connection has gone haywire.");
				refreshTwitchElem.innerHTML = "&#x21bb;";
				refreshTwitchElem.addEventListener('click', reset);
				twitchButtonsContainer.appendChild(refreshTwitchElem);
				arcadeHud.assignHelp(refreshTwitchElem);

				var liveContainerElem = document.createElement('div');
				liveContainerElem.channel = channel;
				liveContainerElem.style.cssText = "display: none; margin-left: 16px;";
				chatTableCellBElem.appendChild(liveContainerElem);

				liveContainerElem.appendChild(document.createTextNode("Live Channel"));
/*
				var twitchPreviewImage = document.createElement('img');
				twitchPreviewImage.style.cssText = "width: 200px; height: 100px;";
				twitchPreviewImage.src = "http://static-cdn.jtvnw.net/previews-ttv/live_user_" + channel.substring(1) + "-200x100.jpg";
				twitchPreviewImage.addEventListener("load", function(e)
				{
					var liveButton = document.querySelector(".channelLiveButton[channel='" + this.channel + "']");
					if( !!liveButton )
						liveButton.style.display = "inline-block";
					//this.style.display = "block";
					//var iTime = performance.getEntriesByName(e.target.src)[0];
       				//console.log(iTime.transferSize); //or encodedBodySize, decodedBodySize
				}.bind(liveContainerElem));
				liveContainerElem.appendChild(twitchPreviewImage);
*/
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.onreadystatechange = function()
				{ 
					if (xmlHttp.readyState == 4)
					{
						if(xmlHttp.status == 200)
						{
							console.log(xmlHttp.responseText);
							if( xmlHttp.responseText == 1 )
							{
								if( g_twitchConfig.channel === this.channel )
									aaapi.cmd("setTwitchLiveStatus", true);

								var liveButton = document.querySelector(".channelLiveButton[channel='" + this.channel + "']");
								if( !!liveButton )
									liveButton.style.display = "inline-block";
							}
							else
							{
								if( g_twitchConfig.channel === this.channel )
									aaapi.cmd("setTwitchLiveStatus", false);
							}
						}
					}
				}.bind(liveContainerElem);

				xmlHttp.open("GET", "http://www.anarchyarcade.com/testlive.php?a=b&channel=" + channel.substring(1), true);
				xmlHttp.send();

				var chatTableCellAElem = document.createElement('td');
				chatTableRowElem.appendChild(chatTableCellAElem);

				var chatLogContainerElem = document.createElement('div');
				chatLogContainerElem.id = 'twitchChatLogContainer' + channel.substring(1);
				chatLogContainerElem.className = "chatLogContainer twitchChatLogContainer";

				var inputRow = document.createElement('tr');
				var inputCel = document.createElement('td');
				inputCel.style.cssText = 'padding: 0;';
				inputCel.colSpan = 3;
				//inputCel.style.border = '2px solid lime';

				var chatFormElem = document.createElement('form');
				chatFormElem.id = 'twitchChatForm' + channel.substring(1);
				chatFormElem.className = 'opacityContainer aaThemeColorTwoLowBorderColor aaThemeColorTwoHighBackgroundColor';
				chatFormElem.style.cssText = 'margin: 0; padding: 0; padding-right: 2px; border-width: 2px; border-style: solid; width: 100%;';
				chatFormElem.addEventListener("submit", function(e)
				{
					var twitchChatInputElem = document.querySelector("#twitchChatInput" + channel.substring(1));
					var chatText = twitchChatInputElem.value;

					if( chatText === "" )
						return;

					twitchChatInputElem.value = "";
					aaapi.cmd("sendTwitchChat", channel, chatText);
					e.preventDefault();
					return true;
				}.bind(channel), true);

				var chatLabelElem = document.createElement('div');
				chatLabelElem.className = 'chatLabelDiv aaTextColorTwoColor';
				chatLabelElem.style.cssText = 'display: inline-block; font-family: Arial; float: right; line-height: 38px; font-size: 24px;';
				chatLabelElem.addEventListener("selectstart", function(e)
				{
					e.preventDefault();
					return false;
				}, true);

				var chatLabel = document.createElement('label');
				chatLabel.appendChild(document.createTextNode('Show Log'));
				chatLabelElem.appendChild(chatLabel);
				chatLabel.style.cssText = 'cursor: pointer; padding-right: 4px;';

				var fullLogCheckBox = document.createElement('input');
				fullLogCheckBox.className = 'fulllogcheckbox';
				fullLogCheckBox.type = 'checkbox';
				if( fullLogMode )
					fullLogCheckBox.checked = true;
				chatLabel.appendChild(fullLogCheckBox);
				//chatLabelElem.innerHTML = 'Full Log';

				fullLogCheckBox.addEventListener('change', function(e)
				{
					//(e.target.checked);
					switchLogMode();
				});

				var chatInputElem = document.createElement('input');
				chatInputElem.addEventListener('focus', function(e)
				{
					chatFormElem.classList.add('opacityContainerOpacity');
				}.bind(chatInputElem));
				chatInputElem.addEventListener('blur', function(e)
				{
					if( this.value == '' )
						chatFormElem.classList.remove('opacityContainerOpacity');
				}.bind(chatInputElem));

				chatInputElem.id = 'twitchChatInput' + channel.substring(1);
				chatInputElem.type = 'text';
				chatInputElem.className = 'aaTitleTextSizeFontSize aaTextColorTwoColor';
				chatInputElem.style.cssText = 'background-color: none; background: none; display: inline-block; border: 0; margin: 0; padding: 4px;';
				chatInputElem.size = '49';
				chatInputElem.value = '';
				chatInputElem.placeholder = '';

				// compose
				tabElem.appendChild(chatTableElem);
				chatTableCellAElem.appendChild(paneContentElem);
				paneContentElem.appendChild(chatLogContainerElem);

				chatTableElem.appendChild(inputRow);
				inputRow.appendChild(inputCel);
				inputCel.appendChild(chatFormElem);

				//chatFormElem.appendChild(chatLabelElem);
				chatFormElem.appendChild(chatInputElem);
				chatFormElem.appendChild(chatLabelElem);

				//console.log(inputCel.innerHTML);//tabElem.innerHTML);

				// add tabElem to the DOM
				document.querySelector("#tabContentsContainer").appendChild(tabElem);

				if( thisTabid === tabId )
					chatInputElem.focus();
			}

			function onNewSessionChatDetected()
			{
				// find the chat log for this channel
				var sessionChatLog = localStorage.getItem('sessionChat');
				if( !!sessionChatLog )
					sessionChatLog = JSON.parse(sessionChatLog);
				else
					sessionChatLog = [];

				updateSessionUserList();

				// rebuild
				var sessionChatLogContainerElem = document.querySelector("#chatLogContainer");
				generateChatLog(sessionChatLog, sessionChatLogContainerElem);
			}

			function onNewSocialChatDetected()
			{
				// find the chat log for this channel
				var socialChatLog = localStorage.getItem('socialChat');
				if( !!socialChatLog )
					socialChatLog = JSON.parse(socialChatLog);
				else
					socialChatLog = [];

				updateSocialUserList();

				// rebuild
				var socialChatLogContainerElem = document.querySelector("#socialChatLogContainer");
				generateChatLog(socialChatLog, socialChatLogContainerElem);
			}

			var g_secondaryTwitchDetect = false;
			var g_initialTwitchDetect = true;
			function twitchChatDetect()
			{
				if( g_isResetting )
					return;

				// grab our inter-tab memory
				var twitchChannels = localStorage.getItem("twitchChannels");
				if( !!twitchChannels )
					twitchChannels = JSON.parse(twitchChannels);
				else
					twitchChannels = {};

				if( !g_initialTwitchDetect )
				{
					var aaActiveTab = document.querySelector(".aaTabActive");
					if( !!!aaActiveTab )
						return;

					var aaActiveTabId = aaActiveTab.getAttribute("tabid");

					if( isTwitchEnabled )
					{
						for( var x in twitchChannels )
						{
							if( twitchChannels[x] === -1 )
								continue;

							if( !!!g_activeTwitchChannels[x] )
							{
								if( g_secondaryTwitchDetect )
								{
									if( twitchChannels[x] < 0 )
										continue;

									onTwitchChannelDetected(twitchChannels, x);
									g_activeTwitchChannels[x] = true;
								}
								else
								{
									location.reload();
									return;
								}
							}
						}

						for( var x in g_activeTwitchChannels )
						{
							if( !!!twitchChannels[x] )
							{
								delete g_activeTwitchChannels[x];
								location.reload();
								return;
							}
						}

						for( var channel in twitchChannels )
						{
							if( twitchChannels[channel] > g_lastTwitchCheck )
								onNewChatDetected(twitchChannels, channel);
						}
					}

					// let's do some SOCIAL and SESSION stuff here...
					var sessionTime = localStorage.getItem("sessionChatTime");
					if( sessionTime > g_lastTwitchCheck )
						onNewSessionChatDetected();

					var socialTime = localStorage.getItem("socialChatTime");
					if( socialTime > g_lastTwitchCheck )
						onNewSocialChatDetected();

					g_lastTwitchCheck = (new Date()).getTime();
				}

				if( g_initialTwitchDetect )
				{
					g_initialTwitchDetect = false;
					g_secondaryTwitchDetect = true;
				}
				else if( g_secondaryTwitchDetect )
					g_secondaryTwitchDetect = false;
			}

			var g_activeTwitchChannels = {};
			var g_lastTwitchCheck = 0;



			function onNewChatDetected(twitchChannels, channel)
			{
				if( g_isResetting )
					return;

				// find the chat log for this channel
				var twitchChatLog = localStorage.getItem('twitchChatLog' + channel);
				if( !!twitchChatLog )
					twitchChatLog = JSON.parse(twitchChatLog);
				else
					twitchChatLog = [];

				// rebuild
				var twitchChatLogContainerElem = document.querySelector("#twitchChatLogContainer" + channel.substring(1));
				generateChatLog(twitchChatLog, twitchChatLogContainerElem);
			}


			if( twitchChannelsExist )
			{
				twitchChatDetect();

				tabs.push({
					"id": "addNewTwitch",
					"title": "<div class='helpNote' help='Add a new Twitch chat tab'>+</div>"
				});
			}

			var tabsInfo = {
				"tabs": tabs,
				"activeTabId": tabId,
				"bottomMode": true,
				"onChangeCallbackName": "onChangeCallback"//,
				//"onChangeHandlerName": "tabChangeHandler"
			};

			var windowTabsHeaderHTML = arcadeHud.generateWindowTabsHeaderHTML(tabsInfo);
			//var tabsContainer = document.querySelector('.tabsContainer');//createElement('div');
			//tabsContainer.innerHTML = windowTabsHeaderHTML;
			document.write(windowTabsHeaderHTML);
			//document.body.appendChild(tabsContainer);

			var closeButtons = document.querySelectorAll(".channelCloseButton");
			for( var i = 0; i < closeButtons.length; i++ )
			{
				closeButtons[i].addEventListener("click", function(e)
				{
					var channel = e.srcElement.parentNode.querySelector('div').getAttribute("channel");
					setTimeout(function()
					{
						aaapi.cmd("leaveTwitchChannel", this.channel);
					}.bind({channel: channel}), 100);
				});
			}

			function extractLinks(text)
			{
				var re = /\b((?:[a-z][\w-]+:(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]+|\(([^\s()<>]+|(\([^\s()<>]+\)))*\))+(?:\(([^\s()<>]+|(\([^\s()<>]+\)))*\)|[^\s`!()\[\]{};:'"".,<>?«»“”‘’]))/i;
				var links = [];
				if( re.exec(text) )
				{
					for(var i = 0; i <= re.exec(text).length; i++)
					{
					  if(re.exec(text)[i])
					  	links.push(re.exec(text)[i]);
					}
				}
				return links;
			}

			function onChatTileClicked(tile)
			{
				var scrapedDataEntry = tile.item;
				// first, check if an item that matches this one already exists...
		 		var item = aaapi.cmdEx("findLibraryItem", "file", scrapedDataEntry.file);
				if( !!!item && !!scrapedDataEntry.reference && scrapedDataEntry.reference !== "" )
		 			item = aaapi.cmdEx("findLibraryItem", "reference", scrapedDataEntry.reference);

		 		if( item )
		 		{
					aaapi.cmd("setLibraryBrowserContext", "items", item.info.id, "", "");
			 		aaapi.cmd("spawnItem", item.info.id, true);
			 	}
			 	else
			 	{
					aaapi.cmd("setLibraryBrowserContext", "items", "", "", "");
					document.location = "asset://ui/createItem.html?fileLocation=" + encodeURIComponent(scrapedDataEntry.file);
			 	}
			}

			//var request = new XMLHttpRequest();
			//https://texttospeech.googleapis.com/v1/text:synthesize
			//var audio = new Audio();
//audio.src ='https://translate.google.com/translate_tts?ie=utf-8&tl=en&q=Hello%20World';
//audio.play();
/*var voiceHttp = new XMLHttpRequest();
				voiceHttp.onreadystatechange = function()
				{ 
					if (voiceHttp.readyState == 4)
					{
						if(voiceHttp.status == 200)
						{
							//console.log(voiceHttp.responseText);
							//var twitchInfo = JSON.parse(voiceHttp.responseText);
							//console.log(JSON.stringify(twitchInfo));
						}
						else
							console.log("Failed to fetch Twitch stream info.");
					}
				}
				//var url = 'get_data.php';
				var thing = {
					input:
					{
						text: 'hello world'
					}
				};
var params = JSON.stringify(thing);
voiceHttp.open('POST', "https://texttospeech.googleapis.com/v1/text:synthesize", true);

				//voiceHttp.open("POST", "http://www.anarchyarcade.com/twitch/testlive.php?channel=" + channel, true);
				voiceHttp.send(params);
*/

//responsiveVoice.speak('Hello World');
			function generateChatLog(sessionChatLog, chatLogContainerElem)
			{
				var lastEntryTable = chatLogContainerElem.querySelector('table');
				var entries = (!!!lastEntryTable) ? [] : lastEntryTable.querySelectorAll('.chatEntryContainer');
				var lastEntryRow = (entries.length > 0) ? entries[entries.length-1] : null;
				var lastEntry = (!!lastEntryRow) ? lastEntryRow.chatEntry : null;
				//if( !!lastEntry )
				//	console.log("Last entry text: " + lastEntry.text);
				if( !!lastEntryRow && !!lastEntryRow.doneFadingOut )
				{
					lastEntryRow.parentNode.removeChild(lastEntryRow);
					lastEntryRow = null;
				}

				if( sessionChatLog.length > 0 )
				{
					//if( !!!lastEntry )
					sessionChatLog.reverse();
					chatLogContainerElem.parentNode.style.display = "block";

					var aaActiveTab = document.querySelector(".aaTabActive");
					var aaActiveTabId = aaActiveTab.getAttribute("tabid");

					var cTable;
					if( !!!lastEntryTable )
					{
						cTable = document.createElement('table');
						cTable.width = '100%';
						chatLogContainerElem.appendChild(cTable);
					}
					else
						cTable = lastEntryTable;

					//cTable.border = '1';
					var cNameCel, cTextCel;

					var youTubeId;
					var twitchLinks = [];
					var chatEntryElem;
					var chatDisplayNameElem;
					var chatTextElem;
					var chatEntry;
					
					//var hasSeenLastEntry = (!!lastEntry);
					//var max = (!fullLogMode) ? 5 : (sessionChatLog.length-1);
					//for( var i = sessionChatLog.length-1; i >= (sessionChatLog.length-1) - max; i-- )
					var max = (!fullLogMode) ? 5 : sessionChatLog.length;
					//console.log(max);
					var previousEntry, previousEntryRow;
					for( var i = 0; i < sessionChatLog.length && i < max; i++ )
					{
						previousEntry = chatLogContainerElem.previousEntry;
						previousEntryRow = chatLogContainerElem.previousEntryRow;

						chatEntry = sessionChatLog[i];
						if( chatEntry.displayName == 'System' )
						{
							max++;
							continue;
						}

						var isTheLast = false;
						if( !!lastEntry )
						{
							if( chatEntry.displayName.toLowerCase() == lastEntry.displayName.toLowerCase() && chatEntry.text == lastEntry.text )
							{
								// only if this is the LAST hit
								isTheLast = (i+1 < sessionChatLog.length && i+1 < max);
								for( var j = i+1; j < sessionChatLog.length && j < max; j++ )
								{
									if( sessionChatLog[j].displayName.toLowerCase() == lastEntry.displayName.toLowerCase() && sessionChatLog[j].text.toLowerCase() == lastEntry.text.toLowerCase() )
									{
										isTheLast = false;
									}
								}

								if( isTheLast )
								{
									//console.log("Waaaaaaaaaaaaaaaaaaas the last!!!!!!!!");

									//chatLogContainerElem.previousEntry = chatEntry;
									//chatLogContainerElem.previousEntryRow = chatEntryElem;
									break;
								}
								//else
								//	console.log("Wasn't the last!");
							}
						}
						//if( chatEntry.text.indexOf("<msfitem ") == 0 )
						//	console.log(JSON.stringify(chatEntry));

						//cRow = document.createElement('tr');
						//cTable.appendChild(cRow);

						var isStackedLine = false;
						//!!lastEntry && 
						//console.log(i + " vs " + (max-1) + " and " + (i == sessionChatLog.length-1));
						//max-1 || i == sessionChatLog.length-1
						//console.log(lastEntry);
						//if( (!!lastEntry && (i == 0) && lastEntry.displayName.toLowerCase() == chatEntry.displayName.toLowerCase() && lastEntryRow.style.opacity != '0') || (!!!lastEntry && !!previousEntry && previousEntry.displayName.toLowerCase() == chatEntry.displayName.toLowerCase()) )
						//if( isTheLast )
						//!!!lastEntry && 
						if( !!!lastEntry && !!previousEntry && previousEntry.displayName.toLowerCase() == chatEntry.displayName.toLowerCase() )
						{
							//console.log(i + ' vs ' + (sessionChatLog.length-1) + ' vs ' + (max-1) + ' and ' + (!!lastEntry) + ' - ' + chatEntry.text);
							//console.log(previousEntry.displayName + ' : ' + chatEntry.text);
							//if( !!!lastEntry )
							//{
								chatEntryElem = previousEntryRow;
								//console.log(chatEntryElem.tagName);
								//previousEntry = chatEntry;
								//previousEntryRow.chatEntry = chatEntry;
								//chatEntryElem.chatEntry = chatEntry;
								isStackedLine = true;
								cTextCel = chatEntryElem.querySelectorAll('td')[1];//chatEntryElem.querySelector('td:nth-of-type(2)');
								//console.log(cTextCel.innerHTML);
							/*}
							else
							{
								//lastEntry = chatEntry;
								chatEntryElem = lastEntryRow;
								lastEntryRow.chatEntry = chatEntry;
								isStackedLine = true;
								cTextCel = chatEntryElem.querySelectorAll('td')[1];
								//cTextCel.style.border = '10px solid lime';
							}*/
						}
						else if( !!lastEntry && !!lastEntryRow && lastEntry.displayName.toLowerCase() == chatEntry.displayName.toLowerCase() )
						{
							//console.log(i + ' vs ' + (sessionChatLog.length-1) + ' vs ' + (max-1) + ' and ' + (!!lastEntry) + ' - ' + chatEntry.text);
							//console.log(previousEntry.displayName + ' : ' + chatEntry.text);
							//if( !!!lastEntry )
							//{
								//console.log('path b');
								// reset the fade timer on this row
								if( !!lastEntryRow.fadeHandle )
								{
									clearTimeout(lastEntryRow.fadeHandle);

									var delay = 1000;
									//var thing = chatLogContainerElem;
									lastEntryRow.fadeHandle = setTimeout(function()
									{
										delete this.fadeHandle;
										//thing.previousEntryRow = undefined;
										//thing.previousEntry = undefined;
										this.style.opacity = '0';
										setTimeout(function()
										{
											this.doneFadingOut = true;
											if( this.parentNode.querySelectorAll('.chatEntryContainer').length > 1)
												this.parentNode.removeChild(this);
										}.bind(this), 1000);
									}.bind(lastEntryRow), delay * ((max - 0))*2.0);
								}

								lastEntryRow.chatEntry = chatEntry;
								chatEntryElem = lastEntryRow;
								//console.log(chatEntryElem.tagName);
								//previousEntry = chatEntry;
								previousEntryRow.chatEntry = chatEntry;
								chatEntryElem.chatEntry = chatEntry;
								isStackedLine = true;
								cTextCel = chatEntryElem.querySelectorAll('td')[1];
								//cTextCel.style.border = '10px solid lime';
								//chatEntryElem.querySelector('td:nth-of-type(2)');
								//console.log(cTextCel.innerHTML);
							/*}
							else
							{
								//lastEntry = chatEntry;
								chatEntryElem = lastEntryRow;
								lastEntryRow.chatEntry = chatEntry;
								isStackedLine = true;
								cTextCel = chatEntryElem.querySelectorAll('td')[1];
								//cTextCel.style.border = '10px solid lime';
							}*/
						}
						else
						{
							chatEntryElem = document.createElement("tr");
							chatEntryElem.chatEntry = chatEntry;
							chatEntryElem.className = "chatEntryContainer";
							chatEntryElem.style.opacity = '1';
	//aaActiveTab.getAttribute('tabId')
	//console.log(chatLogContainerElem.id + ' vs ' + aaActiveTab.getAttribute('tabId'));
							if( !fullLogMode )//&& activeTabId ==  )
							{
								var delay = 1000;
								//var thing = chatLogContainerElem;
								chatEntryElem.fadeHandle = setTimeout(function()
								{
									delete this.fadeHandle;
									//thing.previousEntryRow = undefined;
									//thing.previousEntry = undefined;
									this.style.opacity = '0';
									setTimeout(function()
									{
										this.doneFadingOut = true;
										if( this.parentNode.querySelectorAll('.chatEntryContainer').length > 1)
											this.parentNode.removeChild(this);
									}.bind(this), 1000);
								}.bind(chatEntryElem), delay * ((max - i))*2.0);
								//}.bind(chatEntryElem), delay * (max - (sessionChatLog.length-1-i)));
							}

							cNameCel = document.createElement('td');
							chatEntryElem.appendChild(cNameCel);
							cNameCel.style.cssText = 'text-align: right; width: 120px;';
							cNameCel.vAlign = 'top';

	///*
							//cAvatarElem = document.querySelector('div');
							//cNameCel.appendChild(chatAvatarElem);
							//cAvatarElem.style.cssText = 'width: 80px; height: 80px;';
	//*/
							var chatAvatarImageElemContainer = document.createElement('div');
							cNameCel.appendChild(chatAvatarImageElemContainer);
							chatAvatarImageElemContainer.style.cssText = 'text-align: left; display: inline-block;';
							chatAvatarImageElemContainer.className = 'avatarImgContainer';

							var editAvatarContainer = document.createElement('div');
							chatAvatarImageElemContainer.appendChild(editAvatarContainer);
							editAvatarContainer.style.cssText = 'position: relative;';
							var editAvatarImageContainer = document.createElement('div');
							editAvatarContainer.appendChild(editAvatarImageContainer);
							editAvatarImageContainer.style.cssText = 'z-index: 10; position: absolute;';

							var avatarButtonsContainer = document.createElement('div');
							editAvatarImageContainer.appendChild(avatarButtonsContainer);
							avatarButtonsContainer.className = 'avatarButtons';
							//avatarButtonsContainer.style.cssText = '';

							var editIcon = document.createElement('img');
							editIcon.src = 'editicon.png';
							editIcon.style.cssText = 'width: 18px; cursor: pointer;';
							avatarButtonsContainer.appendChild(editIcon);
							editIcon.chatEntry = chatEntry;
							editIcon.addEventListener('click', function(e)
							{
								editChatUser(e.target.chatEntry.displayName);
							});
	//https://translate.google.com/translate_tts?ie=UTF-8&q=hello&tl=en
							chatAvatarImageElem = document.createElement('img');
							chatAvatarImageElem.className = 'avatarImg';
							var avatarUrl = getChatAvatar(chatEntry.displayName, chatLogContainerElem);
							if( !!!avatarUrl )
								avatarUrl = "noavatar.jpg";
							chatAvatarImageElem.src = avatarUrl;
							chatAvatarImageElem.style.cssText = 'display: inline-block; max-width: 80px; max-height: 80px; position: relative;';
							//if(i == sessionChatLog.length-1 || i == max-1)
							if( i == 0 )
							{
								chatAvatarImageElem.classList.add('avatarNameOpacity');
								chatAvatarImageElem.style.left = '-80px';
								//chatAvatarImageElem.style.opacity = '0';
								setTimeout(function()
								{
									this.style.left = '0px';
									this.classList.remove('avatarNameOpacity');
									//this.style.opacity = '1';
								}.bind(chatAvatarImageElem), 1);
							}
							chatAvatarImageElemContainer.appendChild(chatAvatarImageElem);

							chatDisplayNameElem = document.createElement("div");
							chatDisplayNameElem.className = "chatEntryDisplayName aaTitleText aaTextColorTwoColor aaTextSizeFontSize aaThemeColorOneColor";
							chatDisplayNameElem.style.cssText = "padding: 0; max-width: 100px; overflow-x: hidden; text-overflow: ellipsis;";
							if( i == 0 )
							{
								chatDisplayNameElem.classList.add('avatarName');
								chatDisplayNameElem.classList.add('avatarNameOpacity');
								setTimeout(function()
								{
									//this.style.opacity = "1 !important";
									this.classList.remove('avatarNameOpacity');
								}.bind(chatDisplayNameElem), 1);
							}
							chatDisplayNameElem.appendChild(document.createTextNode(chatEntry.displayName));// + ":"
							cNameCel.appendChild(chatDisplayNameElem);

							cTextCel = document.createElement('td');
							chatEntryElem.appendChild(cTextCel);
							//cTextCel.width = '99%';
						}

						//if( !isStackedLine )
						//{
							chatTextElem = document.createElement("div");
							chatTextElem.className = "chatEntryText aaTextColorTwoColor aaTextSizeFontSize";
							chatTextElem.style.cssText = 'display: block; font-size: 24px;';
						//}
						//else
						//{
							//chatTextElem = previousEntryRow.querySelector('.chatEntryText').parentNode;
							//chatTextElem = previousEntryRow.querySelector('td:nth-of-type(2)').querySelector('div');
						//}

						if( isItemMSFXML(chatEntry.text) )
						{
							//console.log(chatEntry.text.length);
							var item = parseItemMSFXML(chatEntry.text);
							if( !!item )
							{
								var tileWidth = 200;
								var tileHeight = 100;
								var tileMode = 'preview';
								var tile = arcadeHud.createTile(item, chatTextElem, tileMode, "", onChatTileClicked, tileWidth, tileHeight);
								tile.item = item;
							}
							else
								chatTextElem.appendChild(document.createTextNode('- Invalid MSF XML -'));
						}
						else
						{
							var someText = "";
							var chattyText = chatEntry.text.split(' ');
							for( var j = 0; j < chattyText.length; j++ )
							{
								if( arcadeHud.oldIsMapLoaded != 1 || !isLink(chattyText[j]) )
								{
									if( j > 0 )
										someText += " ";

									someText += chattyText[j];
								}
								else
								{
									if( j > 0 )
										someText += " ";

									if( someText !== "" )
									{
										chatTextElem.appendChild(document.createTextNode(someText));
										someText = "";
									}

									var youTubeId = arcadeHud.extractYouTubeId(chattyText[j]);
									if( !!youTubeId )
									{
										//console.log("Found YouTube video!");
										var item = {
											info:
											{
												id: ''
											},
											file: chattyText[j],
											screen: arcadeHud.generateYouTubeImageURL(youTubeId),
											title: 'YouTube Video'
										};

										var tileWidth = 200;
										var tileHeight = 100;
										var tileMode = 'preview';
										var tile = arcadeHud.createTile(item, chatTextElem, tileMode, "", onChatTileClicked, tileWidth, tileHeight);
										tile.style.verticalAlign = 'middle';
										tile.item = item;
									}
									else
									{
										var linkElem = document.createElement('div');
										linkElem.className = "chatLink helpNote";
										linkElem.style.cssText = 'cursor: pointer;';
										linkElem.setAttribute("help", chattyText[j]);
										linkElem.url = chattyText[j];
										linkElem.addEventListener("click", function(e)
										{
											aaapi.cmd("setLibraryBrowserContext", "items", "", "", "");
											document.location = "asset://ui/createItem.html?fileLocation=" + encodeURIComponent(this.url);
										}.bind(linkElem));
										linkElem.appendChild(document.createTextNode(chattyText[j]));
										chatTextElem.appendChild(linkElem);
										arcadeHud.assignHelp(linkElem);
									}
								}
							}

							if( someText !== "" )
								chatTextElem.appendChild(document.createTextNode(someText));
						}

						if( (!isStackedLine && !isTheLast) || !!lastEntry )
							cTextCel.appendChild(chatTextElem);
						else// if( !!!lastEntry )
							cTextCel.insertBefore(chatTextElem, cTextCel.firstChild);
						//cTable.appendChild(chatEntryElem);

						if( !isStackedLine )
						{
							if( !!lastEntry )//!fullLogMode && 
								cTable.appendChild(chatEntryElem);
							else
								cTable.insertBefore(chatEntryElem, cTable.firstChild);
						}

						chatLogContainerElem.previousEntry = chatEntry;
						chatLogContainerElem.previousEntryRow = chatEntryElem;
					}

					chatLogContainerElem.parentNode.scrollTop = chatLogContainerElem.parentNode.scrollHeight;
				}
			}

			function onChangeCallback()
			{
				var aaTabs = document.querySelectorAll(".aaTab");
				var aaActiveTab = document.querySelector(".aaTabActive");
				if( !!!aaActiveTab )
					return;

				var aaActiveTabId = aaActiveTab.getAttribute("tabid");
				sessionStorage.setItem("aaChatTab", aaActiveTabId);

				var chatLogContainerElem = document.querySelector("#chatLogContainer");
				var socialChatLogContainerElem = document.querySelector("#socialChatLogContainer");
				//var twitchChatLogContainerElem = document.querySelector("#twitchChatLogContainer");
				if( aaActiveTabId === "social" )
				{
					var socialChatInputElem = document.querySelector("#socialChatInput");
					socialChatInputElem.value = document.querySelector("#chatInput").value;
					socialChatInputElem.focus();

					// fetch the chat log
					var socialChatLog = localStorage.getItem("socialChat");
					if( !!socialChatLog )
						socialChatLog = JSON.parse(socialChatLog);
					else
						socialChatLog = [];

					socialChatLogContainerElem.innerHTML = '';
					generateChatLog(socialChatLog, socialChatLogContainerElem);
				}
				else if( aaActiveTabId === "session" )
				{
					var chatInputElem = document.querySelector("#chatInput");
					chatInputElem.value = document.querySelector("#socialChatInput").value;
					chatInputElem.focus();

					// fetch the chat log
					var sessionChatLog = localStorage.getItem("sessionChat");
					if( !!sessionChatLog )
						sessionChatLog = JSON.parse(sessionChatLog);
					else
						sessionChatLog = [];

					chatLogContainerElem.innerHTML = '';
					generateChatLog(sessionChatLog, chatLogContainerElem);
				}
				else if( aaActiveTabId.indexOf("twitch") === 0 )
				{
					var channel = aaActiveTabId.substring(6);
					//fetchTwitchStream(channel);

					var twitchChatInputElem = document.querySelector("#twitchChatInput" + channel);
					if( !!twitchChatInputElem )
						twitchChatInputElem.focus();

					var twitchChatLogContainerElem = document.querySelector("#twitchChatLogContainer" + channel);
					if( !!twitchChatLogContainerElem )
					{
						twitchChatLogContainerElem.parentNode.scrollTop = twitchChatLogContainerElem.parentNode.scrollHeight;

						twitchChatLogContainerElem.innerHTML = '';
						delete twitchChatLogContainerElem.previousEntry;
						delete twitchChatLogContainerElem.previousEntryRow;
						g_lastTwitchCheck = 0;
						twitchChatDetect();
						//onNewChatDetected(null, channel);
					}
					//generateChatLog(sessionChatLog, chatLogContainerElem);
				}
				else if( aaActiveTabId === "addNewTwitch" )
				{
					var twitchChatInputElem = document.querySelector("#addNewTwitchInput");
					twitchChatInputElem.focus();
				}
			}
		</script>

		<script>
			var windowTabsFooterHTML = arcadeHud.generateWindowTabsFooterHTML();
			document.write(windowTabsFooterHTML);
		</script>

		</div>
		</td></tr>
		</table>
		</div>

		<script>
			var g_socialUsers;
			function fetchSocialUsers()
			{
				g_socialUsers = localStorage.getItem("socialUsers");

				if( !!g_socialUsers )
					g_socialUsers = JSON.parse(g_socialUsers);
				else
					g_socialUsers = {};
			}

			var chatElem = document.querySelector("#chatPanel");
			function toggleChat()
			{
				if( chatElem.style.display === "inline-block" )
					chatElem.style.display = "none";
				else
				{
					chatElem.style.display = "inline-block";
					onChangeCallback();
				}
			}

			var addNewTwitchChatFormElem = document.querySelector('#addNewTwitchChatForm');
			addNewTwitchChatFormElem.addEventListener('submit', function(e)
			{
				var channel = e.srcElement.querySelector('input').value;
				e.srcElement.querySelector('input').value = '';

				if( channel !== "" && channel.indexOf(" ") < 0 )
				{
					if( channel[0] !== '#' )
						channel = '#' + channel;

					var alreadyExists = false;
					var testChannel = "twitch" + channel.substring(1);
					for( var i = 0; i < tabs.length; i++ )
					{
						if( tabs[i].id === testChannel )
						{
							alreadyExists = true;
							break;
						}
					}

					if( !alreadyExists )
					{
						sessionStorage.setItem("aaChatTab", "twitch" + channel.substring(1));
						aaapi.cmd("joinTwitchChannel", channel);
					}
					else
						aaapi.cmd("addToastMessage", "You are already in " + channel);
				}

				e.preventDefault();
				return false;
			});

			// fetch twitch chat log
			function fetchTwitchChatLog(channel)
			{
			    var twitchChatLog = localStorage.getItem("twitchChatLog" + channel);
			    if( !!twitchChatLog )
			        twitchChatLog = JSON.parse(twitchChatLog);
			    else
			        twitchChatLog = [];
			}

			var sessionNamesListElem = document.querySelector("#sessionNamesList");
			var sessionNameContainer;
			var isFirstSessionName = true;

			// session
			function updateSessionUserList()
			{
				sessionNamesListElem.innerHTML = "Session Users: ";
				var allUsers = aaapi.cmdEx("getAllUsers");
				for( var x in allUsers )
				{
					if( isFirstSessionName )
						isFirstSessionName = false;
					else
						sessionNameContainer.innerHTML += ", &nbsp;";

					sessionNameContainer = document.createElement("div");
					sessionNameContainer.style.cssText = "display: inline-block;";
					sessionNameContainer.appendChild(document.createTextNode(allUsers[x].displayName));
					sessionNamesListElem.appendChild(sessionNameContainer);
				}
			}
			updateSessionUserList();

			var socialNamesListElem = document.querySelector("#socialNamesList");
			var socialNameContainer;
			var isFirstSocialName = true;
			function updateSocialUserList()
			{
				/*socialNamesListElem.innerHTML = "Social Users: ";
				var allUsers = {};//aaapi.cmdEx("getAllUsers");
				for( var x in allUsers )
				{
					if( isFirstSocialName )
						isFirstSocialName = false;
					else
						socialNameContainer.innerHTML += ", &nbsp;";

					socialNameContainer = document.createElement("div");
					socialNameContainer.style.cssText = "display: inline-block;";
					socialNameContainer.appendChild(document.createTextNode(allUsers[x].displayName));
					socialNamesListElem.appendChild(socialNameContainer);
				}*/

				if( isSocial )
				{
					socialNamesListElem.innerHTML = "Social Users: ";

					fetchSocialUsers();

					//var numUsers = Object.keys(g_socialUsers).length;

					var numUsers = 0;
					for( var x in g_socialUsers )
					{
						if( !!g_socialUsers[x].displayName && g_socialUsers[x].displayName !== "" )
						{
							numUsers++;

							if( isFirstSocialName )
								isFirstSocialName = false;
							else
								socialNameContainer.innerHTML += ", &nbsp;";

							socialNameContainer = document.createElement("div");
							socialNameContainer.style.cssText = "display: inline-block;";
							socialNameContainer.appendChild(document.createTextNode(g_socialUsers[x].displayName));
							socialNamesListElem.appendChild(socialNameContainer);
						}
					}

					//socialListTitleElem.innerHTML = "SOCIAL (" + numUsers + ") " + "<input type='button' id='leaveSocialButton' value='Leave Social' style='margin-right: 16px; margin-top: 4px; font-size: 10px; margin-left: 12px;' class='helpNote aaButton aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor' help='Disconnect from the global chat room.' onclick='leaveSocial();' />";

					//arcadeHud.assignHelp(document.querySelector("#leaveSocialButton"));
				}
				//else
				//{
				//	socialListTitleElem.innerHTML = "SOCIAL";
				//}
			}
			updateSocialUserList();

			var autoSelectAllElems = document.querySelectorAll(".autoSelectAll");
			for( var i = 0; i < autoSelectAllElems.length; i++ )
				autoSelectAllElems[i].addEventListener("focus", function(e)
				{
					this.select();
					e.preventDefault();
				}.bind(autoSelectAllElems[i]), true);

			var chatInputElem = document.querySelector("#chatInput");

			var chatForm = document.querySelector("#chatForm");
			chatForm.addEventListener("submit", function(e)
			{
				var chatText = chatInputElem.value;
				if( chatText === "" )
					return;

				chatInputElem.value = "";

				aaapi.cmd("sendLocalChatMsg", chatText);

				e.preventDefault();
				return true;
			}, true);

			var socialChatForm = document.querySelector("#socialChatForm");
			socialChatForm.addEventListener("submit", function(e)
			{
				var socialChatInputElem = document.querySelector("#socialChatInput");
				var chatText = socialChatInputElem.value;
				if( chatText === "" )
					return;

				socialChatInputElem.value = "";

				aaapi.cmd("sendSocialChatMsg", chatText);

				e.preventDefault();
				return true;
			}, true);

			if( !universeInfo )
			{
				document.querySelector(".aaTabContent[tabid=\"session\"]").style.display = "none";
			}

			if( !isSocial )
			{
				document.querySelector(".aaTabContent[tabid=\"social\"]").style.display = "none";
			}

			if( isTwitchEnabled )
			{
				document.querySelector(".aaTabContent[tabid=\"addNewTwitch\"]").style.display = "none";
			}

			if( tabs.length === 0 )
			{
				document.querySelector(".aaTabContent[tabid=\"nothing\"]").style.display = "block";
				//document.querySelector("#nothingBox").focus();
			}

			//setTimeout(twitchChatDetect, 1);
			//setInterval(twitchChatDetect, 500);

			if( aaapi.cmdEx("getConVarValue", "twitch_enabled") === "1" )
			{
				var elems = document.querySelectorAll(".resetChatButton");
				for( var i = 0; i < elems.length; i++ )
				{
					elems[i].style.display = "inline-block";
				}

				document.querySelector(".TwitchForceFix").style.display = "inline-block";
			}

			function reset()
			{
				g_isResetting = true;
				localStorage.removeItem('twitchChannels');
				aaapi.cmd("closeTwitchConnection");
				aaapi.cmd("openTwitchConnection");
				//setTimeout(function(){
					aaapi.cmd("deactivateInputMode");
				//}, 100);
			}
		</script>

		<!-- END CHAT BOX STUFF -->

		<script>
			function aaOnActivateInputMode(opts)
			{
				g_opts = opts;
				//showWindowsTaskBar();
				twitchChatDetect();
				setInterval(twitchChatDetect, 500);
			}
		</script>

	<script>
		var g_hideChatSocial = localStorage.getItem("hideChatSocial");
		var shouldHideChatSocial = (g_hideChatSocial == "1");
		shouldHideChatSocial = false;
		toggleChat();

		if( shouldHideChatSocial)
		{
			document.querySelector("#bigChatStuff").style.display = "none";
		}

		var lastAvatarDisplayName;
		function editChatUser(displayName)
		{
			lastAvatarDisplayName = displayName;
			//if( aaapi.cmdEx("getNeedsSave") )
				//askSave(true);
			//else
			var avatar = getChatAvatar(displayName);
			if( !!!avatar )
				avatar = '';
			var safeDisplayName = displayName;
			displayName.replace(/['\\]/g, '');
				createModalPrompt(safeDisplayName, "<div style='display: inline-block; margin-right: 6px;'>Avatar URL:</div><form style='padding: 0; margin: 0; display: inline-block; width: 420px;'><input class='avatarurlinput' type='text' style='width: 100%; font-size: 24px; font-family: Arial;' value='" + avatar + "' /></form>", "OK", "acceptAvatarChanges('" + safeDisplayName + "', document.querySelector('.avatarurlinput').value);", "Cancel", "cancelAvatarChanges();");
					//, document.querySelector('.avatarurlinput').value);
		}

		function acceptAvatarChanges(safeDisplayName, url)
		{
			//console.log(safeDisplayName + " : " + url);
			setChatAvatar(safeDisplayName, url);
			document.location.reload();
		}

		function cancelAvatarChanges()
		{
			console.log("nope");
		}

		var aaModalPromptMenu;
		function createModalPrompt(title, text, yesTitle, yesAction, noTitle, noAction, validateFunc)
		{
			if( !!aaModalPromptMenu )
			{
				console.log("ERROR: A modal menu is already being displayed!");
				return;
			}

			// Lets be modal.
			var modalContainer = document.createElement("div");
			modalContainer.style.cssText = "z-index: 1000000; position: fixed; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);";
			modalContainer.addEventListener("click", function(e)
			{
				/*
				var isChild = false;
				var childNode = e.target;
				while(!!childNode)
				{
					childNode = childNode.parentNode;
					if( childNode === e.currentTarget )
					{
						isChild = true;
						break;
					}
				}
				*/

				if( e.currentTarget !== e.target )
				{
					// the modal window itself is clicked
					/*
					if( !isChild )
					{
						console.log("propo stopped");
						e.preventDefault();
						e.stopImmediatePropagation();//Immediate
					}
					*/
					return;
				}
				else
				{
					if( !!!aaModalPromptMenu.flashInterval )
					{
						aaModalPromptMenu.flashInterval = setInterval(function()
						{
							var titleRow = this.querySelector("tr");
							var titleBarElems = titleRow.querySelectorAll("td");
							var titleBarElem;

							if( !!!this.flashCount )
							{
								for( var i = 0; i < titleBarElems.length; i++ )
								{
									titleBarElem = titleBarElems[i];
									if( titleBarElem.classList.contains("aaThemeColorOneHighBackgroundColor") )
									{
										titleBarElem.classList.remove("aaThemeColorOneHighBackgroundColor");
										titleBarElem.classList.add("aaThemeColorOneBackgroundColor");
									}
								}

								clearInterval(this.flashInterval);
								delete this.flashInterval;
							}
							else
							{
								for( var i = 0; i < titleBarElems.length; i++ )
								{
									titleBarElem = titleBarElems[i];
									if( titleBarElem.classList.contains("aaThemeColorOneHighBackgroundColor") )
									{
										titleBarElem.classList.remove("aaThemeColorOneHighBackgroundColor");
										titleBarElem.classList.add("aaThemeColorOneBackgroundColor");
									}
									else if(titleBarElem.classList.contains("aaThemeColorOneBackgroundColor"))
									{
										titleBarElem.classList.remove("aaThemeColorOneBackgroundColor");
										titleBarElem.classList.add("aaThemeColorOneHighBackgroundColor");
									}
								}

								this.flashCount--;
							}
						}.bind(aaModalPromptMenu), 100);

						aaModalPromptMenu.flashCount = 6;
					}
				}
			}.bind(modalContainer), true);

			var modalHTML = "";

			var modalYPos = (window.innerHeight / 3) + "px";
			var styleText = (text !== "") ? "margin-left: auto; margin-right: auto; top: " + modalYPos + "; width: 600px;" : "margin-left: auto; margin-right: auto; top: " + modalYPos + "; width: 300px;";

			// header
			var modalWindowHeaderHTML = arcadeHud.generateWindowHeaderHTML(title, styleText, true, true, "", "");
			modalHTML += modalWindowHeaderHTML;

			if( text !== "" )
			{
				// body
				modalHTML += '<div class="aaWindowPaneContent aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor aaTitleTextSizeFontSize aaTextColorTwoColor">';
				//modalHTML += "<form id='nodeNameForm' style='margin: 0;'>";
				/*
				modalHTML += "<table style='margin-left: 0; margin-right: 0;'>\
				<tr>\
					<td>\
						<img src='clock.png' style='width: 78px;' />\
					</td>\
					<td style='padding-left: 15px;'>";*/
					//	<div class='aaTextSizeFontSize aaTitleText aaThemeColorOneColor' style='white-space: normal;'>Here are notes on features I'm currently working on improving.<br /><br />Thank you for having patience.</div>\

				modalHTML += "<div style='font-family: Arial; text-align: justify; white-space: normal;' class='aaTextSizeFontSize aaTextColorTwoColor'>";
				modalHTML += text;
				//modalHTML += "<input id='nodeNameInput' type='text' class='aaTitleTextSizeFontSize' />";
				modalHTML += "</div>";

				//modalHTML += "</td></tr></table>";
				modalHTML += "</div>";
			}

			if( text !== "" )	// simple hax to get 2 different behaviors out of this prompt
			{
				modalHTML += '\
					<table class="aaWindowActions">\
						<tr>\
							<td>\
							</td>\
							<td style="width: 1%; white-space: nowrap;">\
								<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorOneHoverShadedBackground aaTextColorOneColor aaThemeColorOneLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Disconnect" />\
								<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Cancel" />\
							</td>\
						</tr>\
					</table>\
				';
			}
			else
			{
				modalHTML += '\
					<table class="aaWindowActions">\
						<tr>\
							<td>\
							</td>\
							<td style="width: 1%; white-space: nowrap;">\
								<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorOneHoverShadedBackground aaTextColorOneColor aaThemeColorOneLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Quit" />\
								<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Cancel" />\
							</td>\
						</tr>\
					</table>\
				';
			}

			//modalHTML += "</form>";

			// footer
			var modalWindowFooterHTML = arcadeHud.generateWindowFooterHTML();
			modalHTML += modalWindowFooterHTML;

			modalContainer.innerHTML = modalHTML;
			aaModalPromptMenu = modalContainer.querySelector(".aaWindow");
			document.body.appendChild(modalContainer);
/*
			var nodeNameInput = document.body.querySelector("#nodeNameInput");
			nodeNameInput.focus();
			var nodeNameForm = document.body.querySelector("#nodeNameForm");
			nodeNameForm.addEventListener("submit", function(e)
			{
				e.preventDefault();

				if( this.value === "" )
					this.focus();
				else
				{
					aaModalPromptMenu.parentNode.parentNode.removeChild(aaModalPromptMenu.parentNode);
					aaModalPromptMenu = undefined;

					confirmedSaveNewNode(this.value);
				}
			}.bind(nodeNameInput), true);
*/

			var buttons = modalContainer.querySelectorAll(".aaWindowActions input[type='button']");
			buttons[0].value = yesTitle;
			buttons[0].addEventListener("click", function(e)
			{
				if( !!validateFunc && typeof window[validateFunc] === "function" )
				{
					if( !window[validateFunc]() )
						return;
				}

				eval(yesAction);

				aaModalPromptMenu.parentNode.parentNode.removeChild(aaModalPromptMenu.parentNode);
				aaModalPromptMenu = undefined;
			}, true);

			buttons[1].value = noTitle;
			buttons[1].addEventListener("click", function(e)
			{
				aaModalPromptMenu.parentNode.parentNode.removeChild(aaModalPromptMenu.parentNode);
				aaModalPromptMenu = undefined;

				eval(noAction);
			}, true);
		}
	</script>
	</body>
</html>