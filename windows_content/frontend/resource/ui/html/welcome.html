<html>
	<head>
		<link rel="stylesheet" type="text/css" href="asset://ui/hud.css"></link>
		<script src="asset://ui/hud.js"></script>
		<script src="asset://ui/tga.js"></script>
		<style>
			.loadingIndicator
			{
				width: 50px;
				height: 50px;
				border-width: 10px;
				border-radius: 50%;
				border-style: dashed;
				-webkit-animation: spin 4s infinite linear;
			}

			@-webkit-keyframes spin
			{
				0%  {-webkit-transform: rotate(0deg);}
				100% {-webkit-transform: rotate(360deg);}   
			}
		</style>
		<script>
			//var steamFriends = aaapi.cmdEx('getAllFriends');
			//console.log(JSON.stringify(steamFriends));

			var localUserId = aaapi.cmdEx("getConVarValue", "aamp_client_id");
			var g_imageTilesOnly = (localStorage.getItem("imageTilesOnly") == "1");
			var universeInfo = aaapi.cmdEx("getConnectedSession");
			var bestScreenshot;

			// get the current mapHistory (or create an empty mapHistory)
			var tga = new TGA();
			var worldInfo = aaapi.cmdEx("getWorldInfo");
			//console.log(JSON.stringify(worldInfo));
			var g_screenshots = (!!worldInfo.map) ? aaapi.cmdEx("getAllMapScreenshots", "id" + worldInfo.map.info.id) : {};
			var mapHistory = (localStorage.getItem("mapHistory")) ? JSON.parse(localStorage.getItem("mapHistory")) : {};

			// if auto_load_map is 1, then auto-load what we want.
			var autoLoadMapVal = aaapi.cmdEx("getConVarValue", "auto_load_map");
			var lastMapLoadedVal = aaapi.cmdEx("getConVarValue", "last_map_loaded");

			// find the most recently loaded map / instance / spawn position
			var bestHistoryTimestamp;
			var bestHistoryEntry;
			var potentialMapHistoryEntry;
			var mapHistoryKeys = Object.keys(mapHistory);
			for( var i = 0; i < mapHistoryKeys.length; i++ )
			{
				potentialMapHistoryEntry = mapHistory[mapHistoryKeys[i]];
				if( !!!potentialMapHistoryEntry.timestamp || !!!bestHistoryTimestamp || potentialMapHistoryEntry.timestamp > bestHistoryTimestamp )
				{
					bestHistoryTimestamp = potentialMapHistoryEntry.timestamp;
					bestHistoryEntry = potentialMapHistoryEntry;
				}
			}

			var didQuickLoad = false;
			if( !!bestHistoryEntry )
			{
				if( !!bestHistoryEntry.screenshotId && bestHistoryEntry.screenshotId !== "" )
					bestScreenshot = g_screenshots[bestHistoryEntry.screenshotId];

				//console.log("Test val: " + (autoLoadMapVal == "1"));
				if( autoLoadMapVal == "1" && lastMapLoadedVal == "1" && !aaapi.cmdEx("isInGame") && aaapi.cmdEx("getConVarValue", "attempted_quick_load") === "0" )
				{
					var map = aaapi.cmdEx("getMap", bestHistoryEntry.mapId);
					if( !!map )
					{
						bestHistoryEntry.timestamp = new Date().getTime();

						if( bestHistoryEntry.instanceId === "" )
						{
							var mapInstances = aaapi.cmdEx("getMapInstances", bestHistoryEntry.mapId);
							
							if( mapInstances.length > 0 )
								bestHistoryEntry.instanceId = mapInstances[0].id;
						}

						didQuickLoad = true;
						aaapi.cmd("consoleCommand", "attempted_quick_load 1");

						// save the mapHistory out
						localStorage.setItem("mapHistory", JSON.stringify(mapHistory));

						window.location = "asset://ui/loading.html?map=" + bestHistoryEntry.mapId + "&instance=" + bestHistoryEntry.instanceId + "&pos=" + bestHistoryEntry.position + "&rot=" + bestHistoryEntry.rotation + "&screenshot=" + bestHistoryEntry.screenshotId;
					}
				}
			}

			if( !didQuickLoad )
				aaapi.cmd("consoleCommand", "attempted_quick_load 1");

			function playOnePlayer()
			{
				var loadedMapAlready = false;
				if( lastMapLoadedVal == "1" )
				{
					// get the current mapHistory (or create an empty mapHistory)
					var mapHistory = (localStorage.getItem("mapHistory")) ? JSON.parse(localStorage.getItem("mapHistory")) : {};

					// find the most recently loaded map / instance / spawn position
					var bestHistoryTimestamp;
					var bestHistoryEntry;
					var potentialMapHistoryEntry;
					var mapHistoryKeys = Object.keys(mapHistory);
					var loadableChecked = {};
					var loadableCheckedMapInstances = {};

					for( var i = 0; i < mapHistoryKeys.length; i++ )
					{
						potentialMapHistoryEntry = mapHistory[mapHistoryKeys[i]];
						if( !!!potentialMapHistoryEntry.timestamp || !!!bestHistoryTimestamp || potentialMapHistoryEntry.timestamp > bestHistoryTimestamp )
						{
							var loadableInstance = false;
							if( loadableChecked.hasOwnProperty(potentialMapHistoryEntry.instanceId) )
								loadableInstance = loadableChecked[potentialMapHistoryEntry.instanceId];
							else if( potentialMapHistoryEntry.instanceId != "")
							{
								if( !loadableCheckedMapInstances.hasOwnProperty(potentialMapHistoryEntry.mapId) )
								{
									loadableCheckedMapInstances[potentialMapHistoryEntry.mapId] = aaapi.cmdEx("getMapInstances", potentialMapHistoryEntry.mapId);
								}

								var mapInstances = loadableCheckedMapInstances[potentialMapHistoryEntry.mapId];

								for( var j = 0; j < mapInstances.length; j++ )
								{
									if( mapInstances[j].id == potentialMapHistoryEntry.instanceId )
									{
										loadableInstance = true;
										break;
									}
								}

								loadableChecked[potentialMapHistoryEntry.instanceId] = loadableInstance;
							}

							if( !loadableInstance )
								continue;
							/*if(!!potentialMapHistoryEntry.screenshotId && potentialMapHistoryEntry.screenshotId !== "")
							{
								var testerScreenshot = aaapi.cmdEx('getScreenshot', potentialMapHistoryEntry.screenshotId);
								if( !!testerScreenshot && testerScreenshot.hasOwnProperty('multiplayer') && testerScreenshot.multiplayer.isHost == 0 )
									continue;
							}*/

							bestHistoryTimestamp = potentialMapHistoryEntry.timestamp;
							bestHistoryEntry = potentialMapHistoryEntry;
						}
					}

					if( !!bestHistoryEntry )
					{
						var map = aaapi.cmdEx("getMap", bestHistoryEntry.mapId);
						if( !!map )
						{
							bestHistoryEntry.timestamp = new Date().getTime();

							if( bestHistoryEntry.instanceId === "" )
							{
								var mapInstances = aaapi.cmdEx("getMapInstances", bestHistoryEntry.mapId);
								
								if( mapInstances.length > 0 )
									bestHistoryEntry.instanceId = mapInstances[0].id;
							}

							// save the mapHistory out
							localStorage.setItem("mapHistory", JSON.stringify(mapHistory));

							window.location = "asset://ui/loading.html?map=" + bestHistoryEntry.mapId + "&instance=" + bestHistoryEntry.instanceId + "&pos=" + bestHistoryEntry.position + "&rot=" + bestHistoryEntry.rotation + "&screenshot=" + bestHistoryEntry.screenshotId;
							loadedMapAlready = true;
						}
					}
				}

				if( !loadedMapAlready )
				{
					arcadeHud.playMapNow("meta_lobby.bsp");
				}
			}
		</script>

		<style>
			.dashboardsContainer
			{
				position: absolute;
				top: 4%;
				bottom: 15%;
				left: 20%;
				right: 20%;
				display: none;
			}

			.activeDashboard
			{
				display: block;
			}

			#frontPage
			{
				/*background-color: #000;*/
				background: -webkit-linear-gradient(left, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.95) 30%, rgba(0, 0, 0, 0.95) 70%, rgba(0, 0, 0, 0.7));
				width: 100%;
				height: 100%;
				position: absolute;
			}

			.dashboard
			{
				/*background-color: rgba(0, 0, 0, 0.95);*/
				background: -webkit-linear-gradient(45deg, rgba(20, 20, 20, 0.97), rgba(20, 20, 20, 0.97) 50%, rgba(20, 20, 20, 0.97) 50%, rgba(30, 30, 30, 0.95) 100%);
				margin: 12px;
				text-align: center;
				padding: 16px;
				padding-top: 8px;
				border-radius: 20px;
			}

			.widgetCategory
			{
				font-size: 24px;
				font-family: Arial;
				letter-spacing: 0.05em;
				text-align: left;
				color: white;
			}

			.widgetContainer
			{
				position: relative;
				font-size: 32px;
				font-family: Arial;
				font-weight: 900;
				border: 2px solid grey;
				color: grey;
				width: 300px;
				height: 150px;
				vertical-align: bottom;
				text-align: right;
				margin: 10px;
				margin-top: 4px;
				display: inline-block;
				background-color: rgb(20, 20, 20);
			}

			.widgetContainerAlt
			{
				position: relative;
				font-size: 32px;
				font-family: Arial;
				font-weight: 900;
				color: grey;
				width: 300px;
				height: 150px;
				vertical-align: bottom;
				text-align: right;
				margin: 10px;
				margin-top: 4px;
				display: inline-block;
			}

			.widgetContainer:hover
			{
				color: white;
				border-color: white;
			}

			.widgetMask
			{
				opacity: 0.5;
			}

			.widgetContainer:hover > .widgetMask
			{
				opacity: 1.0;
			}

			.onlineServerSize
			{
				/*font-size: 18px;*/
				position: absolute;
				top: 4px;
				left: 4px;
				text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
			}

			.onlineImage
			{
				position: absolute;
				top: 4px;
				right: 4px;
				
			}

			.widgetExtended
			{
				position: absolute;
				bottom: 0px;
				right: 0px;
				font-size: 16px;
				padding: 6px;
				padding-left: 8px;
				padding-right: 8px;
				border-style: solid;
				border-color: transparent;
				border-size: 1px;
				border-radius: 6px;
			}

			.widgetExtended:hover
			{
				background-color: rgba(0, 0, 0, 0.8);
				border-color: #fff;
			}

			.widgetBottom
			{
				position: absolute;
				bottom: 0;
				right: 0;
				padding: 12px;
			}

			.widgetSubtitle
			{
				font-size: 32px;
				font-family: Arial;
				font-weight: bold;
				color: white;
			}

			.widgetAuthor
			{
				font-size: 16px;
				font-family: Arial;
				font-weight: bold;
				margin-right: 20px;
			}

			.widgetTitle
			{
				position: absolute;
				font-size: 32px;
				font-family: Arial;
				font-weight: 900;
				text-align: center;
				vertical-align: bottom;
				left: 0;
				right: 0;
				top: 50%;
				color: white;
				-webkit-transform: translateY(-50%);
				padding-top: 8px;
				padding-bottom: 8px;
			}

			.widgetContainer:hover > .widgetTitle
			{
				background-color: rgba(0, 0, 0, 0.8);
			}

			.closeAtlasButton
			{
				display: inline-block;
				background-color: rgba(0, 0, 0, 0.9);
				font-size: 24px;
				font-weight: bold;
				font-family: Arial;
				padding: 8px;
				padding-left: 24px;
				padding-right: 24px;
				border-radius: 12px;
				color: grey;
				border: 2px solid grey;
			}

			.closeAtlasButton:hover
			{
				color: white;
				border-color: white;
				background-color: rgba(10, 10, 10, 0.9);
			}

			.widgetImage
			{
				position: absolute;
				top: 0;
				left: 0;
			}

			.widgetPane
			{
				max-height: 675px;
				overflow-y: auto;
			}

			.bigAwardImage
			{
				height: 128px;
			}

			.widgetDot
			{
				cursor: pointer;
				display: inline-block;
				width: 8px;
				height: 8px;
				border-radius: 8px;
				border-size: 2px;
				border-style: solid;
				border-color: gray;
			}

			.widgetDot:hover
			{
				border-color: white;
				background-color: silver;
			}

			.widgetDotActive
			{
				background-color: white;
			}

			.skipButton
			{
				border: 4px solid transparent;
				margin-bottom: -8px;
			}

			.skipButton:hover
			{
				background-color: gray;
				border: 4px solid gray;
			}

			.featuredSlate
			{
				display: none;
			}

			.activeFeaturedSlate
			{
				display: block;
			}

			.awardsSlate
			{
				display: none;
				font-family: Arial;
			}

			.activeAwardsSlate
			{
				display: block;
			}

			#demoSocialUser
			{
				display: none;
			}

			.viewInfoLink
			{
				padding: 2px;
				border-radius: 50%;
				margin-top: 4px;
				cursor: pointer;
			}

			.viewInfoLink:hover
			{
				background-color: #555;
			}
		</style>
		<script>
			var featured = {
				"lobby94":
				{
					"title": "Neon Dream",
					"author": "Sashassin"
				},
				"lobby24":
				{
					"title": "Dinotopia",
					"author": "Xaphian"
				},
				"lobby30":
				{
					"title": "Excellent Lobby",
					"author": "MeatPuppeTT"
				},
				"clockwork":
				{
					"title": "Orange Chill",
					"author": "SM Sith Lord"
				},
				"lobby26":
				{
					"title": "Themed Gallery",
					"author": "Xaphian"
				},
				"sithgarage":
				{
					"title": "Sith's Garage",
					"author": "SM Sith Lord"
				},
				"lobby12":
				{
					"title": "Soulz Hangout",
					"author": "SoulzBaen"
				},
				"lobby79":
				{
					"title": "Party Cabin",
					"author": "RetroGameNinja"
				},
				"lobby81":
				{
					"title": "GOG DosBox",
					"author": "River"
				}
			};

			var schedule = [
				["clockwork", "lobby30", "lobby94"],	// sunday
				["clockwork", "lobby30", "lobby94"],	// monday
				["lobby24", "sithgarage", "lobby26"],	// tuesday
				["lobby24", "sithgarage", "lobby26"],	// wednesday
				["lobby12", "lobby79", "lobby81"],	// thursday
				["lobby12", "lobby79", "lobby81"],		// friday
				["lobby12", "lobby79", "lobby81"]		// saturday
			];

			var onlineEvent;

			var eventsData;
			var dynamicEventsDataFetchHandled = false;
			var dynamicEventsDataFetchHandle;
			function onDynamicEventsDataFetched()
			{
				dynamicEventsDataFetchHandled = true;
				dynamicEventsDataFetchHandle = null;

				// use the events data now...
				if( !!eventsData )
				{
					if( !!eventsData.featured )
						featured = eventsData.featured;
					if( !!eventsData.schedule )
						schedule = eventsData.schedule;
					if( !!eventsData.online && eventsData.online.active == true )
						onlineEvent = eventsData.online;
				}

				generateOnline();
				generateFeaturedWidget();
			}

			function generateOnline()
			{
				var onlineElem = document.querySelector('#online');
				var widgetImageElem = onlineElem.querySelector('.widgetImage');
				var onlineServerSizeElem = onlineElem.querySelector('.onlineServerSize');

				var lobbyId = (!!onlineEvent) ? onlineEvent.lobbyId : null;
				if( !!lobbyId && featured.hasOwnProperty(lobbyId) )
				{
					var theEvent = featured[lobbyId];
					onlineElem.setAttribute('lobbyId', lobbyId);
					if( theEvent.hasOwnProperty('thumbnail') )
						widgetImageElem.src = theEvent.thumbnail;

					if( theEvent.hasOwnProperty('size') )
						onlineServerSizeElem.innerText = theEvent.size;
					/*if( theEvent.hasOwnProperty('size') )
					{
						var sizeText = "";
						if( theEvent.size == 'S' )
							sizeText = "Small";
						else if( theEvent.size == 'M' )
							sizeText = "Medium";
						else if( theEvent.size == 'L' )
							sizeText = "Large";
						else if( theEvent.size == 'XL' )
							sizeText = "Extra Large";
						onlineServerSizeElem.innerText = sizeText;
					}*/
				}
				else
				{
					// randomly select one of the featured servers...
					var keys = Object.keys(featured);
					var randomEventKey = keys[Math.floor(Math.random() * keys.length)];

					var theEvent = featured[randomEventKey];
					onlineElem.setAttribute('lobbyId', randomEventKey);
					if( theEvent.hasOwnProperty('thumbnail') )
						widgetImageElem.src = theEvent.thumbnail;
					else
						widgetImageElem.src = "featuredshots/" + randomEventKey + ".jpg";

					if( theEvent.hasOwnProperty('size') )
						onlineServerSizeElem.innerText = theEvent.size;
				}

				document.querySelector('#onlineLoadingIndicator').style.display = 'none';
				onlineElem.style.display = 'inline-block';
			}

			function fetchDynamicEventsData()
			{
				// get the client's IP
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.onreadystatechange = function()
				{ 
					if (xmlHttp.readyState == 4)
					{
						if(xmlHttp.status == 200)
						{
							if( dynamicEventsDataFetchHandled )
								return;

							eventsData = JSON.parse(xmlHttp.responseText);
							onDynamicEventsDataFetched();
						}
						else
						{
							if( dynamicEventsDataFetchHandled )
								return;

							console.log("Failed to fetch events data.");
							onDynamicEventsDataFetched();
						}
					}
				}
				
				// timeout after 6 seconds, in case the interwebs is dead.
				dynamicEventsDataFetchHandle = setTimeout(function()
				{
					if( dynamicEventsDataFetchHandled )
						return;
					onDynamicEventsDataFetched();
				}, 6000);

				var rand = Math.random() + "" + Math.random() + "" + Math.random() + "" + Math.random();
				xmlHttp.open("GET", "http://www.anarchyarcade.com/getEventsData.php?rand=" + rand, true);
				xmlHttp.send(null);
			}
			fetchDynamicEventsData();
		</script>
	</head>
	<body>
		<div id="frontPage" style="display: none;"></div>
		<div class="dashboardsContainer activeDashboard" dashboardName="atlas">
			<table style="width: 100%; height: 100%;" id="loadingThing">
				<tr><td align="center">
					<div style="padding: 16px; border-width: 2px; border-style: solid; display: inline-block; border-radius: 24px; opacity: 0.7;" class="aaThemeColorTwoShadedBorderColor aaThemeColorTwoShadedBackground"><div class="loadingIndicator aaThemeColorOneBorderColor"></div></div>
				</td></tr>
			</table>
			<table style="pointer: default; width: 100%; height: 100%; display: none;" id="invisolayer">
				<tr><td colspan="2">
					<div class="dashboard">
						<div style="text-align: left;">
							<img src="aaicon.png" style="display: inline-block; vertical-align: middle;" /><div class="widgetCategory aaTitleText" style="display: inline-block; vertical-align: middle;">ANARCHY ARCADE</div>
						</div>
						<div class="widgetPane">
							<div id="onlineLoadingIndicator" style="display: inline-block;">
								<table style="width: 348px; height: 155px;" cellspacing="0" cellpadding="0">
									<tr><td align="center" valign="middle">
										<div class="loadingIndicator aaThemeColorOneBorderColor"></div>
									</td></tr>
								</table>
							</div>
							<div id="online" class="widgetContainer helpNote" help="Load into the ONLINE metaverse world as a guest." style="display: none; cursor: pointer; border-color: rgb(100, 100, 255); border-left-width: 6px; border-right-width: 6px; margin: 6px; margin-top: 0; margin-bottom: 10px; margin-right: 30px;" lobbyId="metaverse" onclick="joinOnline(this);">
								<img class="widgetImage" src="featuredshots/meta_lobby.jpg" />
								<img class="widgetMask" src="widgetmask.png" />
								<div class="onlineServerSize"></div>
								<img class="onlineImage" src="mpicon.png" />
								<div class="widgetExtended" onclick="window.location='asset://ui/hostSession.html?tab=servers';">SERVERS</div>
								<div class="widgetTitle aaTitleText">Online</div>
							</div>
							<div class="widgetContainer helpNote" help="Load into your LOCAL metaverse world as a god." style="cursor: pointer; margin-left: 30px;" onclick="playOnePlayer();">
								<img class="widgetImage" src="localbackground.jpg" id="loadLocalImage" />
								<div id="loadLocalImageContainer" style="display: none; position: absolute; width: 300px; height: 150px;"></div>
								<img class="widgetMask" src="widgetmask.png" />
								<div class="widgetExtended" onclick="window.location='asset://ui/play.html?tab=custom';">MAPS</div>
								<div class="widgetTitle aaTitleText">1-Player</div>
							</div>
						</div>
						<div style="cursor: default; text-align: center; visibility: hidden;">
							<div class="widgetDot widgetDotActive"></div>
							<div class="widgetDot"></div>
							<div class="widgetDot"></div>
						</div>
					</div>
				</td><td>
					<div class="dashboard" style="vertical-align: bottom;">
						<div style="text-align: left;">
							<img src="staricon.png" style="display: inline-block; vertical-align: middle;" /><div class="widgetCategory aaTitleText" style="display: inline-block; vertical-align: middle;">FEATURED</div>
						</div>
						<div id="featuredLoadingIndicator" style="display: block;">
							<table style="width: 100%; height: 188px;" cellspacing="0" cellpadding="0">
								<tr><td align="center" valign="middle">
									<div class="loadingIndicator aaThemeColorOneBorderColor"></div>
								</td></tr>
							</table>
						</div>
						<div id="featured" class="widgetPane" widgetId="featured" style="cursor: pointer; display: none;">
							<div class="featuredSlate activeFeaturedSlate">
								<div class="widgetContainer featuredWidget helpNote" help="Join this multiplayer server as a guest." lobby="" onclick="aaapi.cmd('joinLobby', this.getAttribute('lobby'));">
									<img class="widgetImage" src="featuredshots/_placeholder.jpg" />
									<img class="widgetMask" src="widgetmask.png" />
									<div class="onlineServerSize"></div>
									<img class="onlineImage" src="mpicon.png" />
									<div class="widgetBottom  aaTitleText">
										<div class="widgetSubtitle">Server</div>
										<div class="widgetAuthor">by Author</div>
									</div>
								</div>
							</div>
							<div class="featuredSlate">
								<div class="widgetContainer featuredWidget helpNote" help="Join this multiplayer server as a guest." lobby="" onclick="aaapi.cmd('joinLobby', this.getAttribute('lobby'));">
									<img class="widgetImage" src="featuredshots/_placeholder.jpg" />
									<img class="widgetMask" src="widgetmask.png" />
									<div class="onlineServerSize"></div>
									<img class="onlineImage" src="mpicon.png" />
									<div class="widgetBottom  aaTitleText">
										<div class="widgetSubtitle">Server</div>
										<div class="widgetAuthor">by Author</div>
									</div>
								</div>
							</div>
							<div class="featuredSlate">
								<div class="widgetContainer featuredWidget helpNote" help="Join this multiplayer server as a guest." lobby="" onclick="aaapi.cmd('joinLobby', this.getAttribute('lobby'));">
									<img class="widgetImage" src="featuredshots/_placeholder.jpg" />
									<img class="widgetMask" src="widgetmask.png" />
									<div class="onlineServerSize"></div>
									<img class="onlineImage" src="mpicon.png" />
									<div class="widgetBottom  aaTitleText">
										<div class="widgetSubtitle">Server</div>
										<div class="widgetAuthor">by Author</div>
									</div>
								</div>
							</div>
							<div class="dotsContainer" widgetId="featured" style="cursor: default; text-align: center;">
								<div class="widgetDot widgetDotActive" onclick="manualWidgetCycle(this);"></div>
								<div class="widgetDot" onclick="manualWidgetCycle(this);"></div>
								<div class="widgetDot" onclick="manualWidgetCycle(this);"></div>
							</div>
						</div>
					</div>
				</td></tr>
				<tr><td colspan="2">
					<div class="dashboard" style="height: 220px;">
						<div style="text-align: left;">
							<img src="locationicon.png" style="display: inline-block; vertical-align: middle;" /><div class="widgetCategory aaTitleText" style="display: inline-block; vertical-align: middle;">YOU ARE HERE</div>
						</div>
						<div class="widgetPane">
							<div class="aaOnlyIfMapLoaded">
								<table style="width: 100%;" cellspacing="0" cellpadding="0">
									<tr><td align="center" width="1">
										<div id="mapImageContainer" class="widgetContainer"></div>
									</td><td style="padding: 8px; font-size: 32px; font-family: Arial; font-weight: 900;" align="left">
										<div style="font-weight: bold; font-family: monospace; font-size: 18px;" class="aaOnlyIfUniverseNotConnected">SINGLEPLAYER</div>
										<div style="font-weight: bold; font-family: monospace; font-size: 18px;" class="aaOnlyIfUniverseConnected aaOnlyIfHost">MULTIPLAYER HOST</div>
										<div style="font-weight: bold; font-family: monospace; font-size: 18px;" class="aaOnlyIfUniverseConnected aaOnlyIfNotHost">MULTIPLAYER GUEST</div>
										<div style="font-weight: 900; font-size: 26px;" id="currentInstanceTitle"></div>
										<div style="font-weight: bold; font-size: 16px;" id="currentMap"></div>
										<div style="font-weight: bold; font-size: 16px;"><div id="currentObjectCount" style="display: inline;"></div> objects</div>
										<!--div class="viewInfoLink aaOnlyIfUniverseConnected helpNote" style="font-size: 18px; display: inline-block;" onclick="window.location='asset://ui/hostSession.html?tab=online';" help="Like this arcade."><img src="thumbupicon.png" /></div-->
										<div class="viewInfoLink aaOnlyIfUniverseConnected helpNote" style="font-size: 18px; display: inline-block;" onclick="window.location='asset://ui/hostSession.html?tab=online';" help="View details about this arcade."><img src="infoicon.png" /></div>
										<div class="viewInfoLink aaOnlyIfMapLoaded helpNote" help="Export this arcade's meta data for use in other frontends." style="font-size: 18px; display: inline-block;" onclick="window.location='asset://ui/export.html';"><img src="exporticon.png" /></div>
										<div class="viewInfoLink aaOnlyIfUniverseNotConnected" style="font-size: 18px; display: inline-block;" onclick="editInstance();"><img src="infoicon.png" /></div>

									</td></tr>
								</table>
							</div>
							<div class="aaOnlyIfNoMapLoaded" style="height: 150px;">
								<table style="width: 100%; height: 100%;">
									<tr><td align="center">
										<div style="font-size: 78px; font-family: Arial; font-weight: 900;">MAIN MENU</div>
									</td></tr>
								</table>
							</div>
							<div style="cursor: default; text-align: center; visibility: hidden;">
								<div class="widgetDot widgetDotActive"></div>
							</div>
						</div>
					</div>
				</td><td rowspan="2" align="center">
					<div class="dashboard" style="height: 95%;">
						<div id="allObjectsSlate" style="display: none;">
							<div style="text-align: left;">
								<img src="autoplayicon.png" style="display: inline-block; vertical-align: middle;" /><div class="widgetCategory aaTitleText" style="display: inline-block; vertical-align: middle;">AUTOPLAY</div>
							</div>
							<div id="allObjectsLoadingStuff" style="display: none;">
								<table style="width: 100%; height: 100%">
									<tr><td align="center">
										<div class="loadingIndicator aaThemeColorOneBorderColor"></div>
									</td></tr>
								</table>
							</div>
							<div id="allObjectsStuff">
								<div id="allObjectsTilesContainer" style="margin-left: -10px; margin-right: -10px;"></div>
							</div>
						</div>
						<div id="autoplaySlate" style="display: none;">
							<div style="text-align: left;">
								<img src="autoplayicon.png" style="display: inline-block; vertical-align: middle;" /><div class="widgetCategory aaTitleText" style="display: inline-block; vertical-align: middle;">AUTOPLAY</div>
							</div>
							<div id="autoplayLoadingStuff" style="display: none;">
								<table style="width: 100%; height: 100%">
									<tr><td align="center">
										<div class="loadingIndicator aaThemeColorOneBorderColor"></div>
									</td></tr>
								</table>
							</div>
							<div id="autoplayStuff">
								<div class="widgetPane">
									<div class="widgetContainer" id="autoplayImageContainer" style="cursor: pointer; background-position: center; background-size: cover;"></div>
								</div>
								<div id="autoplayTitle" style="display: inline-block; white-space: nowrap; font-family: Arial; font-size: 24px; width: 300px; overflow: hidden; text-overflow: ellipsis; line-height: 34px;"></div>
								<div style="cursor: default; margin-bottom: 12px;">
									<img src="skipbackicon.png" class="skipButton" id="skipBack" style="cursor: pointer; height: 18px; margin-right: 8px; display: none;" onclick="skipBackHandler(this);" />
									<img src="stopicon.png" onclick="doStop();" class="skipButton" style="cursor: pointer; height: 18px;" />
									<img src="skipnexticon.png" class="skipButton" id="skipNext" style="cursor: pointer; height: 18px; margin-left: 8px; display: none;" onclick="skipNextHandler(this);" />
								</div>
								<div id="autoplayTilesContainer" style="margin-left: -10px; margin-right: -10px;"></div>
							</div>
						</div>
						<div id="welcomeSlate" style="display: none;">
							<div style="text-align: left;">
								<img src="aaicon.png" style="display: inline-block; vertical-align: middle;" /><div class="widgetCategory aaTitleText" style="display: inline-block; vertical-align: middle;">WELCOME</div>
							</div>
							<table style="height: 450px; width: 100%;">
								<tr><td align="center" style="font-size: 24px;">
									<img src="aalogo.png" style="width: 300px;" />
								</td></tr>
							</table>
						</div>
					</div>
				</td></tr>
				<tr><td>
					<div class="dashboard">
						<div style="text-align: left;">
							<img src="awardsicon.png" style="display: inline-block; vertical-align: middle;" /><div class="widgetCategory aaTitleText" style="display: inline-block; vertical-align: middle;">ACHIEVEMENTS</div>
						</div>
						<div class="widgetPane" style="width: 320px; height: 170px;" widgetId="awards"></div>
						<div class="dotsContainer" widgetId="awards" style="text-align: center;" id="awardsDotsContainer"></div>
					</div>
				</td><td>
					<div class="dashboard">
						<div style="text-align: left;">
							<img src="socialicon.png" style="display: inline-block; vertical-align: middle;" /><div class="widgetCategory aaTitleText" style="display: inline-block; vertical-align: middle;" id="socialListTitle">SOCIAL</div>
						</div>
						<div class="widgetPane aaScrollBars" style="width: 320px; height: 190px;">
							<div id="socialList"></div>
						</div>
					</div>
				</td></tr>
				<tr><td colspan="3">
					<div style="text-align: center; cursor: default;">
						<div style="cursor: pointer; display: inline-block;">
							<div id="steamgamesNagButton" style="display: none;" onclick="getStarted();" class="closeAtlasButton aaOnlyIfMapLoaded helpNote" help="Import your Steam games from your Steam profile to get started.">&nbsp;<img src="steamicon.png" style="vertical-align: bottom;" />&nbsp;</div>
						</div>

						<div style="cursor: pointer;" onclick="aaapi.cmd('deactivateInputMode');" class="aaOnlyIfMapLoaded closeAtlasButton helpNote" help="Close this menu."><img src="aaicon.png" style="vertical-align: bottom;" /> &nbsp;Resume</div>

						<div style="cursor: pointer;" onclick="doPause();" class="closeAtlasButton helpNote" help="Pause AArcade for optimized performance.">&nbsp;<img src="pauseicon.png" style="vertical-align: bottom;" />&nbsp;</div>

						<!--div onclick="" class="closeAtlasButton helpNote" help="View server info & rate this server.">&nbsp;<img src="infoicon.png?w=1" style="vertical-align: bottom;" />&nbsp;</div-->

						<div style="cursor: pointer;" onclick="window.location='asset://ui/options.html';" class="closeAtlasButton helpNote" help="Customize & configure how your AArcade works.">&nbsp;<img src="cogicon.png" style="vertical-align: bottom;" />&nbsp;</div>

						<!-- intro basics addons advanced -->

						<div style="cursor: pointer;" onclick="showHelp();" class="closeAtlasButton helpNote" help="View the help documentation.">&nbsp;<img src="helpicon.png" style="vertical-align: bottom;" />&nbsp;</div>

						<div class="aaOnlyIfNeedsSave">
							<div style="cursor: pointer;" onclick="confirmSave();" class="closeAtlasButton helpNote" help="Save this arcade to your local library.">&nbsp;<img src="saveicon.png" style="vertical-align: bottom;" />&nbsp;</div>
						</div>

						<div style="cursor: pointer;" onclick="askDisconnectSession();" class="closeAtlasButton aaOnlyIfMapLoaded aaOnlyIfUniverseConnected helpNote" help="Disconnect from this server.">&nbsp;<img src="leaveicon.png" style="vertical-align: bottom;" />&nbsp;</div>

						<!--div onclick="window.location='asset://ui/export.html';" class="closeAtlasButton aaOnlyIfMapLoaded helpNote" help="Export this arcade's meta data for use in other frontends.">&nbsp;<img src="exporticon.png" style="vertical-align: bottom;" />&nbsp;</div-->

						<div style="cursor: pointer;" onclick="confirmQuit();" class="closeAtlasButton helpNote" help="Shutdown & close Anarchy Arcade.">&nbsp;<img src="powericon.png" style="vertical-align: bottom;" />&nbsp;</div>
					</div>
				</td></tr>
				<tr><td colspan="3">
					<div class="aaHelpContainer" style="padding: 8px; display: none; text-align: center;"></div>
				</td></tr>
			</table>
		</div>


		<!--input type="button" onclick="window.location.href ='questClue.html';" style="position: fixed; left: 20px; top: 100px;" value="WUBALUBADUBDUB QUEST CLUE" /-->

<!--<input type="button" onclick="window.location='wheelspin.html';" style="position: fixed; left: 20px; top: 180px;" value="Spin the wheel!" />

<input type="button" onclick="window.location='decisionwheel.html';" style="position: fixed; left: 20px; top: 220px;" value="Decision Wheel" />

		<input type="button" onclick="window.location='mouseEZWindows.html';" style="position: fixed; left: 20px; top: 140px;" value="Mouse EZ Test" />

		<input type="button" onclick="window.location='avatar.html';" style="position: fixed; left: 20px; top: 300px;" value="Avatar Menu" />

		<input type="button" onclick="bigFatFunction();" style="position: fixed; left: 20px; top: 260px;" value="WUBALUBADUBDUB STOCKROOM" /> -->

		<!--input type="button" onclick="window.location='https://mdn-samples.mozilla.org/s/webrtc-simple-datachannel/';" style="position: fixed; left: 20px; top: 240px;" value="Web RTC Test" /-->
<!-- earth1 sky_borealis01 tides -->

		<!-- input type="button" onclick="paintSky();" style="position: fixed; left: 20px; top: 100px;" value="Skybox Test" / -->
		
		<!--input type="button" onclick="window.location='bulk.html';" style="position: fixed; left: 20px; top: 100px;" value="Batch Import Test" />

		<input type="button" onclick="window.location='lists.html';" style="position: fixed; left: 20px; top: 180px;" value="Lists" /-->

		<!--input type="button" onclick="findObjectWithModel();" style="position: fixed; left: 20px; top: 300px;" value="remove bad rocks" />

		<input type="button" onclick="window.location='unixSystem.html';" style="position: fixed; left: 20px; top: 130px;" value="22 WUBALUBADUBDUB" /-->

		<!--input type="button" onclick="window.location='dir.html';" style="position: fixed; left: 20px; top: 500px;" value="WUBALUBADUBDUB" /-->

		<!--input type="button" onclick="window.location='materialmods.html';" style="position: fixed; left: 20px; top: 200px;" value="Material Mods Menu" /-->

		<!--input type="button" onclick="importItemJSON();" style="position: fixed; left: 20px; top: 300px;" value="Import Item JSON" /-->

		<script>
			function importItemJSON()
			{
				var container = document.createElement('div');
				container.style.cssText = "position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.96); padding-top: 200px;";

				var importItemJSONInputElem = document.createElement('textarea');
				importItemJSONInputElem.style.cssText = 'display: block; font-size: 20px; width: 50%; height: 200px;';
				container.appendChild(importItemJSONInputElem);

				var importItemJSONSubmitElem = document.createElement('input');
				importItemJSONSubmitElem.type = 'button';
				importItemJSONSubmitElem.style.cssText = 'font-size: 20px; padding: 10px;';
				importItemJSONSubmitElem.value = "Create";
				importItemJSONSubmitElem.addEventListener('click', function()
				{
					var itemObject = JSON.parse(importItemJSONInputElem.value);
					if( !!!itemObject )
					{
						// fail
						return;
					}
					var fileLocation = itemObject.file;
					// first check if an item already exists for this file location
 					var item = aaapi.cmdEx("findLibraryItem", "file", fileLocation);
		 			if( item )
		 			{
						// if this is a 3d text item, set the next cabinet model
						if( item.file.indexOf("http://text.txt/") == 0 && !!arcadeHud.getParameterByName('m', item.file) )
						{
							var clearModel = aaapi.cmdEx('findLibraryModel', 'file', 'models/cabinets/clear.mdl');
							if( !!clearModel )
							{
								aaapi.cmd("consoleCommand", "recent_model_id \"" + clearModel.info.id + "\"");

								// we must block the thread now until our console commands are all processed...
								var blocking = aaapi.cmdEx('getConVarValue', 'recent_model_id');
							}
						}
						else if( item.file.indexOf("travel.html?") == 0 )
						{
							var portalModel = aaapi.cmdEx('findLibraryModel', 'file', 'models/cabinets/portal.mdl');
							if( !!portalModel )
							{
								aaapi.cmd("consoleCommand", "recent_model_id \"" + portalModel.info.id + "\"");

								// we must block the thread now until our console commands are all processed...
								var blocking = aaapi.cmdEx('getConVarValue', 'recent_model_id');
							}
						}

			 			aaapi.cmd("spawnItem", item.info.id);
		 			}
			 		else
			 		{
			 			item = aaapi.cmdEx("createItem", "file", fileLocation);	

			 			// item is created but NOT saved yet, time for last-minute changes!!
						if( item )
						{
				 			// save it then spawn it
				 			var params = [];

							var itemKeys = Object.keys(item);
							for( var i = 0; i < itemKeys.length; i++ )
							{
								var x = itemKeys[i];

								if( x === "info" )
									continue;

								params.push(x);
								if( itemObject.hasOwnProperty(x) )
									item[x] = itemObject[x];

								params.push(item[x]);
							}

							if( aaapi.cmdEx("saveItem", item.info.id, params) )
							{
								// if this is a 3d text item, set the next cabinet model
								if( item.file.indexOf("http://text.txt/") == 0 && !!arcadeHud.getParameterByName('m', item.file) )
								{
									var clearModel = aaapi.cmdEx('findLibraryModel', 'file', 'models/cabinets/clear.mdl');
									if( !!clearModel )
									{
										aaapi.cmd("consoleCommand", "recent_model_id \"" + clearModel.info.id + "\"");

										// we must block the thread now until our console commands are all processed...
										var blocking = aaapi.cmdEx('getConVarValue', 'recent_model_id');
									}
								}
								else if( item.file.indexOf("travel.html?") == 0 )
								{
									var portalModel = aaapi.cmdEx('findLibraryModel', 'file', 'models/cabinets/portal.mdl');
									if( !!portalModel )
									{
										aaapi.cmd("consoleCommand", "recent_model_id \"" + portalModel.info.id + "\"");

										// we must block the thread now until our console commands are all processed...
										var blocking = aaapi.cmdEx('getConVarValue', 'recent_model_id');
									}
								}

								aaapi.cmd("spawnItem", item.info.id);
							}
						}	
					}
				});
				container.appendChild(importItemJSONSubmitElem);

				document.body.appendChild(container);
			}

			function paintSky()
			{
				var originalSky = aaapi.cmdEx('getConVarValue', 'sv_skyname');
				var targetSky = 'earth1';

				aaapi.cmd('setMaterialMod', 'skybox/' + originalSky + 'bk', '$basetexture', 'skybox/' + targetSky + 'bk');
				aaapi.cmd('setMaterialMod', 'skybox/' + originalSky + 'dn', '$basetexture', 'skybox/' + targetSky + 'dn');
				aaapi.cmd('setMaterialMod', 'skybox/' + originalSky + 'ft', '$basetexture', 'skybox/' + targetSky + 'ft');
				aaapi.cmd('setMaterialMod', 'skybox/' + originalSky + 'lf', '$basetexture', 'skybox/' + targetSky + 'lf');
				aaapi.cmd('setMaterialMod', 'skybox/' + originalSky + 'rt', '$basetexture', 'skybox/' + targetSky + 'rt');
				aaapi.cmd('setMaterialMod', 'skybox/' + originalSky + 'up', '$basetexture', 'skybox/' + targetSky + 'up');
			}

			var quadrantX = 1.0;
			var quadrantY = 1.0;
			var spaceSize = 60;
			var entryIndex = -1;
			var maxCols = 16;
			var maxRows = 16;
			var row;
			var col;
			function onMatchingEntryFound(queryId, entry)
			{
				entryIndex++;

				col = (entryIndex % maxCols);
				row = Math.floor(entryIndex / maxCols);

				// skip every 4th col / row
				if( (col % 4) == 0 )
				{
					entryIndex++;
					col++;
				}

				if( (row % 4) === 0 )
				{
					entryIndex += maxCols;
					row++;
				}

				if( row > maxRows )
				{
					if( quadrantX > 0 && quadrantY < 0 ) // IV
						return;	// WE HIT MAX IN ALL QUADS!
					else if( quadrantX < 0 && quadrantY < 0 ) // III
					{
						quadrantX = 1.0;
						quadrantY = -1.0;
					}
					else if( quadrantX < 0 && quadrantY > 0 ) // II
					{
						quadrantX = -1.0;
						quadrantY = -1.0;
					}
					else if( quadrantX > 0 && quadrantY > 0 ) // I
					{
						quadrantX = -1.0;
						quadrantY = 1.0;
					}

					row = 1;
					col = 1;
					entryIndex = -1;
				}

				var origin = {x: spaceSize * col * quadrantX, y: spaceSize * row * quadrantY, z: 0};
				var angles = {x: 0, y: 0, z: 0};

				//autoSpawnEntry(itemId, modelId, x, y, z, pitch, yaw, roll, scale, mirror, anim)
				aaapi.cmd("autoSpawnEntry", entry.info.id, entry.info.id, origin.x, origin.y, origin.z, angles.x, angles.y, angles.z, 1.0, false, "");

				setTimeout(function()
				{
					response = aaapi.cmdEx("findNextLibraryEntry", entry.queryId, "models");
					if( response.success )
						onMatchingEntryFound(response.queryId, response.entry);
				}, 100);
			}

			function findObjectWithModel()
			{
				var goodEntries = [];
				var response = aaapi.cmdEx("getNearestObjectToPlayerLook");
				while(response.success)
				{
					if( !!response.entry && !!response.entry.modelId && response.entry.modelId !== "" )
					{
						var model = aaapi.cmdEx("getLibraryModel", response.entry.modelId);

						var modelFile = model.platforms[arcadeHud.platformId].file;

						if( modelFile.indexOf("firstbeachrocks_001") >= 0 )
						{
							if( response.entry.entity >= 0 )
							{
								//aaapi.cmd("attemptSelectEntity", response.entity, true);
								//console.log("Found it!");
								window.location = "asset://ui/buildModeContext.html?entity=" + response.entry.entity;
								return;
							}
						}
					}
					response = aaapi.cmdEx("getNextNearestObjectToPlayerLook");
				}

/*
				var object;
				var model;
				var instanceObject;
				for( var i = 0; i < goodEntries.length; i++ )
				{
					instanceObject = aaapi.cmdEx("getObject", goodEntries[i].id);
					//console.log(instanceObject.item === instanceObject.model);
					if( !!!instanceObject )// && instanceObject.item !== instanceObject.model )
						continue;
console.log(instanceObject.model);
					if( instanceObject.model.indexOf("firstbeachrocks_001") >= 0 )
					{
						console.log("FOUND IT!");
						console.log(JSON.stringify(instanceObject));
						//aaapi.cmd("attemptSelectEntity", existingInstance.entityIndex, true);
						break;
					}
				}*/
			}

			function bigFatFunction()
			{
				//var workshopId = "582742223";//410297615, 418631919, 349922511, 628079730
				//var response = aaapi.cmdEx("findFirstLibraryEntry", "models", "platforms/" + arcadeHud.platformId + "/workshopid", workshopId);
				var response = aaapi.cmdEx("findFirstLibraryEntry", "models", "title", "chair");
				if( response.success )
					onMatchingEntryFound(response.queryId, response.entry);
			}

			function showListLink(helpName)
			{
				var listElem = document.querySelector(".listLink[helpName='" + helpName + "']");
				var helpElem = document.querySelector(".helpDetails[helpName='" + helpName + "']");
				if( helpElem && listElem && !listElem.classList.contains("activeListLink"))
				{
					var parentElem = listElem.parentNode;
					while(!!parentElem && !parentElem.classList.contains("dashboardsContainer"))
						parentElem = parentElem.parentNode;

					if( !!parentElem )
					{
						var oldElem = parentElem.querySelector(".activeListLinkHelp");
						if( !!oldElem )
							oldElem.classList.remove("activeListLinkHelp");

						var oldListElem = parentElem.querySelector(".activeListLink");
						if( oldListElem )
							oldListElem.classList.remove("activeListLink");

						helpElem.classList.add("activeListLinkHelp");
						listElem.classList.add("activeListLink");
					}
				}
			}

			function listLinkClicked(e)
			{
				showListLink(e.target.getAttribute("helpName"));
			}

			var elems = document.querySelectorAll(".listLink");
			for( var i = 0; i < elems.length; i++ )
			{
				elems[i].addEventListener("click", listLinkClicked);
			}

			function extendedClicked(e)
			{
				e.preventDefault();
				e.stopImmediatePropagation();
				e.stopPropagation();
				return false;
			}

			function jumpToAutoplay(tile)
			{
				//document.querySelector("#allObjectsSlate").style.display = "none";
				document.querySelector("#allObjectsStuff").style.display = "none";
				document.querySelector("#autoplayStuff").style.display = "none";
				document.querySelector("#autoplayLoadingStuff").style.display = "block";
				document.querySelector("#allObjectsLoadingStuff").style.display = "block";


				var taskId = (!!displayTaskInfo) ? displayTaskInfo.id : "";
				arcadeHud.jumpToYouTube(tile.objectId, taskId);
				//aaapi.cmd("deactivateInputMode");
			}

			function editInstance()
			{
				window.location='asset://ui/editInstance.html?id=' + aaapi.cmdEx("getInstance").instance.id + "&uiback=" + encodeURIComponent("window.location='asset://ui/welcome.html';");
			}

			function doPause()
			{
				window.location='asset://ui/pause.html';
			}

			var elems = document.querySelectorAll(".widgetExtended");
			for( var i = 0; i < elems.length; i++ )
			{
				elems[i].addEventListener("click", extendedClicked);
			}

			function joinOnline(elem)
			{
				var lobbyId = elem.getAttribute('lobbyId');
				//console.log("lobby id: " + lobbyId);
				aaapi.cmd('joinLobby', lobbyId);
			}

			var featuredWidgetExists = false;
			function generateFeaturedWidget()
			{
				var day = (new Date()).getDay();
				var featuredWidgets = document.querySelectorAll(".featuredWidget");
				var div, widget, scheduled, featuredLobby;
				for( var i = 0; i < featuredWidgets.length; i++ )
				{
					featuredLobby = schedule[day][i];
					scheduled = featured[featuredLobby];
					featuredWidgets[i].setAttribute("lobby", featuredLobby);

					widget = featuredWidgets[i].querySelector(".widgetImage");
					if( scheduled.hasOwnProperty("thumbnail") )
						widget.src = scheduled.thumbnail;
					else
						widget.src = "featuredshots/" + featuredLobby + ".jpg";
//console.log(JSON.stringify(scheduled));
					div = document.createTextNode(scheduled.title);
					widget = featuredWidgets[i].querySelector(".widgetSubtitle");
					widget.innerHTML = "";
					widget.appendChild(div);
					
					div = document.createTextNode(scheduled.author);
					widget = featuredWidgets[i].querySelector(".widgetAuthor");
					widget.innerHTML = "";
					widget.appendChild(div);

					var onlineServerSizeElem = featuredWidgets[i].querySelector('.onlineServerSize');
					if( scheduled.hasOwnProperty('size') )
						onlineServerSizeElem.innerText = scheduled.size;
				}

				document.querySelector('#featuredLoadingIndicator').style.display = "none";
				document.querySelector('#featured').style.display = "block";
				featuredWidgetExists = true;


				autoFeaturedFlipHandle = setInterval(function()
				{
					var dotsContainer = document.querySelector(".dotsContainer[widgetId='featured']");
					var widgetId = dotsContainer.getAttribute("widgetId");
					var widgetDots = dotsContainer.querySelectorAll(".widgetDot");
					var activeDot = dotsContainer.querySelector(".widgetDotActive");

					var currentIndex = 0;
					for( ; currentIndex < widgetDots.length; currentIndex++ )
					{
						if( widgetDots[currentIndex] == activeDot)
							break;
					}

					currentIndex++;
					if( currentIndex >= widgetDots.length )
						currentIndex = 0;

					widgetCycle(widgetDots[currentIndex]);
				}, 4000);
			}

			var displayItem, displayObjectId;
			var displayTaskInfo;
			function fetchDisplayTaskInfo()
			{
				displayTaskInfo = aaapi.cmdEx("getDisplayTaskInfo");
				onDisplayTaskInfoFetched();
			}

			function onDisplayTaskInfoFetched()
			{
				if( !!displayTaskInfo )
				{
					displayItem = aaapi.cmdEx("getLibraryItem", displayTaskInfo.itemId);
					displayObjectId = displayTaskInfo.objectId;

					var titleElem = document.querySelector("#autoplayTitle");
					titleElem.innerHTML = "";
					titleElem.appendChild(document.createTextNode(displayItem.title));

					var autoplayImageContainer = document.querySelector("#autoplayImageContainer");
					autoplayImageContainer.innerHTML = "";
					autoplayImageContainer.entityIndex = displayTaskInfo.entityIndex;
					autoplayImageContainer.addEventListener("click", function(e)
					{
						aaapi.cmd("attemptSelectEntity", autoplayImageContainer.entityIndex, true);
					});


					var autoplayImage = document.createElement("img");
					autoplayImage.className = "autoplayImage";
					autoplayImage.style.cssText = "max-height: 100%;";
					autoplayImage.style.display = "none";
					autoplayImage.item = displayItem;
					autoplayImageContainer.appendChild(autoplayImage);

					arcadeHud.loadItemBestImage(autoplayImage, displayItem, function()
					{
						//autoplayImage.style.display = "block";
						autoplayImageContainer.style.backgroundImage = "url(\"" + autoplayImage.src + "\")";
					});

					var autoplayTilesContainer = document.querySelector("#autoplayTilesContainer");
					autoplayTilesContainer.innerHTML = "";
					var allObjectsTilesContainer = document.querySelector("#allObjectsTilesContainer");
					allObjectsTilesContainer.innerHTML = "";


					var ytAutoPlay = sessionStorage.getItem("ytAutoPlay");
					if( !!!ytAutoPlay )
						ytAutoPlay = {};
					else
						ytAutoPlay = JSON.parse(ytAutoPlay);

					var ytObjectEntry = ytAutoPlay[displayObjectId];
					var originObject = (!!ytObjectEntry) ? ytObjectEntry.originalId : displayObjectId;

					document.querySelector("#skipBack").style.display = "none";
					document.querySelector("#skipNext").style.display = "none";

					var maxPrevObjects = 1;
					var numPrevObjects = 0;
					var otherId = displayObjectId;
					if( !!ytObjectEntry && ytObjectEntry.originalId !== displayObjectId )
					{
						var prevObjectId, prevObject, prevItem;
						while( numPrevObjects < maxPrevObjects )
						{
							prevObjectId = aaapi.cmdEx("getNearestObjectToObject", "previous", originObject, otherId, true, 300);

							if( prevObjectId === displayObjectId )
								break;

							prevObject = aaapi.cmdEx("getObject", prevObjectId);

							if( !!!prevObject )
								break;

							//if( !!arcadeHud.hiddenItems[prevObject.item] )
							//{
							//	otherId = prevObjectId;
							//	continue;
							//}

							prevItem = aaapi.cmdEx("getLibraryItem", prevObject.item);
							otherId = prevObjectId;
							numPrevObjects++;

							var tile = arcadeHud.createTile(prevItem, autoplayTilesContainer, "autoplay", "", jumpToAutoplay);
							tile.objectId = prevObjectId;

							if( numPrevObjects === 1 )
							{
								var skipElem = document.querySelector("#skipBack");
								skipElem.style.display = "inline-block";
								skipElem.objectId = prevObjectId;
							}
						}
					}

					var isYouTubeItem = !!arcadeHud.extractYouTubeId(displayItem.file) || !!arcadeHud.extractYouTubeId(displayItem.preview) || !!arcadeHud.extractYouTubeId(displayItem.stream);
					if( isYouTubeItem )
					{
						var tile = arcadeHud.createTile(displayItem, autoplayTilesContainer, "autoplay", "", jumpToAutoplay);
						tile.objectId = displayObjectId;
					}


					var max = 5 - numPrevObjects;
					if( !isYouTubeItem )
						max += 1;
					otherId = displayObjectId;
					for( var i = 0; i < max; i++ )
					{
						var nextObjectId = aaapi.cmdEx("getNearestObjectToObject", "next", originObject, otherId, true, 300);
						if( !!!nextObjectId )
							break;

						var nextObject = aaapi.cmdEx("getObject", nextObjectId);
						//if( !!arcadeHud.hiddenItems[nextObject.item] )
						//{
						//	otherId = nextObjectId;
						//	i = i-1;
						//	continue;
						//}

						var nextItem = aaapi.cmdEx("getLibraryItem", nextObject.item);
						var tile = arcadeHud.createTile(nextItem, autoplayTilesContainer, "autoplay", "", jumpToAutoplay);
						tile.objectId = nextObjectId;
						otherId = nextObjectId;

						if( i === 0 )
						{
							var skipElem = document.querySelector("#skipNext");
							skipElem.style.display = "inline-block";
							skipElem.objectId = nextObjectId;
						}
					}

					document.querySelector("#allObjectsSlate").style.display = "none";
					document.querySelector("#autoplayLoadingStuff").style.display = "none";
					document.querySelector("#allObjectsLoadingStuff").style.display = "none";
					document.querySelector("#autoplayStuff").style.display = "block";
					document.querySelector("#allObjectsStuff").style.display = "block";
					document.querySelector("#autoplaySlate").style.display = "block";
				}
			}

			function onIsMapLoaded(isMapLoaded)
			{
				setTimeout(function()
				{
					if( isMapLoaded )
					{
						document.querySelector("#currentInstanceTitle").appendChild(document.createTextNode(worldInfo.instance.title));
						document.querySelector("#currentMap").appendChild(document.createTextNode(worldInfo.map.platforms[arcadeHud.platformId].file));
						document.querySelector("#currentObjectCount").appendChild(document.createTextNode(aaapi.cmdEx("getInstanceObjectCount")));

						buildAutoplayList();
						if( !!!displayTaskInfo )
							buildAllObjectsList();
					}
					else
					{
						document.querySelector("#welcomeSlate").style.display = "block";
					}
				}, 1);
			}

			function addObjectThing(nextObject, nextItem)
			{
				//if( !!arcadeHud.hiddenItems[nextObject.item] )
				//{
				//	otherId = nextObjectId;
				//	i = i-1;
				//	continue;
				//}

				//var nextItem = aaapi.cmdEx("getLibraryItem", nextObject.item);
				if( !!nextItem )
				{
					var tile = arcadeHud.createTile(nextItem, allObjectsTilesContainer, "autoplay", "", jumpToAutoplay);
					tile.objectId = nextObject.id;
					return true;
				}
				else
					return false;
			}

			function buildAllObjectsList()
			{
				var otherId = "";

				var startingObject = aaapi.cmdEx("getNearestObjectToPlayerLook");
				if( !!startingObject && !!startingObject.entry )
				{
					var max = 12;
					startingObject = aaapi.cmdEx("getObject", startingObject.entry.id);

					var startingItem = aaapi.cmdEx("getLibraryItem", startingObject.item);
					var isYouTubeItem = !!arcadeHud.extractYouTubeId(startingItem.file) || !!arcadeHud.extractYouTubeId(startingItem.preview) || !!arcadeHud.extractYouTubeId(startingItem.stream);
					if( isYouTubeItem && addObjectThing(startingObject, startingItem) )
						max -= 1;

					var objectId = startingObject.id;
					if( objectId )
					{

						for( var i = 0; i < max; i++ )
						{
							var nextObjectId = aaapi.cmdEx("getNearestObjectToObject", "next", objectId, otherId, true, 300);
							if( !!!nextObjectId )
								break;
							
							var nextObject = aaapi.cmdEx("getObject", nextObjectId);
							var nextItem = aaapi.cmdEx("getLibraryItem", nextObject.item);
							var isYouTubeItem = !!arcadeHud.extractYouTubeId(nextItem.file) || !!arcadeHud.extractYouTubeId(nextItem.preview) || !!arcadeHud.extractYouTubeId(nextItem.stream);
							if( !isYouTubeItem || !addObjectThing(nextObject, nextItem) )
								i = i - 1;
							otherId = nextObjectId;
						}

						document.querySelector("#allObjectsSlate").style.display = "block";
					}
				}
			}

			var bestScreenshotId;
			var screenshotKeys = Object.keys(g_screenshots);
			var screenshots = [];
			if( !!worldInfo )
			{
				for( i = 0; i < screenshotKeys.length; i++ )
				{
					screenshot = g_screenshots[screenshotKeys[i]];
					if( screenshot.instance.id == "id" + worldInfo.instance.id )
						screenshots.push(screenshot);
				}
			}

			// get the current mapHistory (or create an empty mapHistory)
			var mapHistory = localStorage.getItem("mapHistory");
			if( !!mapHistory )
			{
				mapHistory = JSON.parse(mapHistory);

				// find the most recently loaded map / instance / spawn position
				var bestHistoryTimestamp;
				var bestHistoryEntry;
				var potentialMapHistoryEntry;
				var mapHistoryKeys = Object.keys(mapHistory);
				
				var loadableChecked = {};
				var loadableCheckedMapInstances = {};

				for( var i = 0; i < mapHistoryKeys.length; i++ )
				{
					potentialMapHistoryEntry = mapHistory[mapHistoryKeys[i]];
					//console.log(JSON.stringify(aaapi.cmdEx('getScreenshot', potentialMapHistoryEntry.screenshotId)));
					if( (!!!potentialMapHistoryEntry.timestamp || !!!bestHistoryTimestamp || potentialMapHistoryEntry.timestamp > bestHistoryTimestamp))//&& aaapi.cmdEx("getInstance", potentialMapHistoryEntry.instanceId).hasOwnProperty("instance") )
					{
						var loadableInstance = false;
						if( loadableChecked.hasOwnProperty(potentialMapHistoryEntry.instanceId) )
							loadableInstance = loadableChecked[potentialMapHistoryEntry.instanceId];
						else if( potentialMapHistoryEntry.instanceId != "")
						{
							if( !loadableCheckedMapInstances.hasOwnProperty(potentialMapHistoryEntry.mapId) )
							{
								loadableCheckedMapInstances[potentialMapHistoryEntry.mapId] = aaapi.cmdEx("getMapInstances", potentialMapHistoryEntry.mapId);
							}
							
							var mapInstances = loadableCheckedMapInstances[potentialMapHistoryEntry.mapId];

							for( var j = 0; j < mapInstances.length; j++ )
							{
								if( mapInstances[j].id == potentialMapHistoryEntry.instanceId )
								{
									loadableInstance = true;
									break;
								}
							}

							loadableChecked[instanceId] = loadableInstance;
						}

						if( !loadableInstance )
							continue;

						bestHistoryTimestamp = potentialMapHistoryEntry.timestamp;
						bestHistoryEntry = potentialMapHistoryEntry;
					}
				}
//console.log(JSON.stringify(bestHistoryEntry));
				if( !!bestHistoryEntry )
				{
					var badScreenshot = false;
					/*
					if(!!bestHistoryEntry.screenshotId && bestHistoryEntry.screenshotId !== "")
					{
						var testerBestScreenshot = aaapi.cmdEx('getScreenshot', bestHistoryEntry.screenshotId);
						if( !!!testerBestScreenshot || (testerBestScreenshot.hasOwnProperty('multiplayer') && testerBestScreenshot.multiplayer.isHost == 0) )
							badScreenshot = true;
					}*/

					if( !badScreenshot && !!bestHistoryEntry.screenshotId && bestHistoryEntry.screenshotId !== "" )
						bestScreenshotId = bestHistoryEntry.screenshotId;
					else
					{
						var map = aaapi.cmdEx("getMap", bestHistoryEntry.mapId);
						if( !!map )
						{
							if( bestHistoryEntry.instanceId !== "" )
							{
								for( i = 0; i < screenshotKeys.length; i++ )
								{
									screenshot = g_screenshots[screenshotKeys[i]];
									if( screenshot.instance.id == "id" + bestHistoryEntry.instanceId )
										bestScreenshotId = screenshot.instance.id;
								}
							}
						}
					}
				}
			}

			if( screenshots.length > 0 )
			{
				var mapImage = document.createElement("div");
				mapImage.id = "mapImage";
				//max-width: 100%; max-height: 420px; margin-left: auto; margin-right: auto; width: 100%;

				tga.open( "screenshots/" + screenshots[0].id + ".tga", function()
				{
					var elem = tga.getCanvas();
					elem.style.cssText = "width: 100%; height: 100%;";

				   mapImage.appendChild(elem);
				   mapImage.style.display = "block";
				   document.querySelector("#mapImageContainer").appendChild(mapImage);
				});
			}
			else
			{
				var mapImage = document.createElement("div");
				mapImage.id = "mapImage";
				mapImage.style.display = "block";

				var image = document.createElement("img");
				image.style.cssText = "width: 100%; height: 100%;";
				image.src = "map.jpg";
				mapImage.appendChild(image);

				document.querySelector("#mapImageContainer").appendChild(mapImage);
			}

			if( !!bestScreenshotId )
			{
				var localImage = document.querySelector("#loadLocalImage");
				var loadLocalImageContainer = document.querySelector("#loadLocalImageContainer");
				tga.open( "screenshots/" + bestScreenshotId + ".tga", function()
				{
					var elem = tga.getCanvas();
					elem.style.cssText = "width: 100%; height: 100%;";

				   loadLocalImageContainer.appendChild(elem);
				   loadLocalImageContainer.style.display = "block";
				});
			}
			//localImage.src = "";

			function manualWidgetCycle(dot)
			{
				var widgetID = dot.parentNode.getAttribute("widgetId");
				if( widgetID == "featured" )
					clearInterval(autoFeaturedFlipHandle);
				else if( widgetID == "awards" )
					clearInterval(autoAwardsFlipHandle);

				widgetCycle(dot);
			}

			function widgetCycle(dot)
			{
				var dotsContainer = dot.parentNode;
				var widgetId = dotsContainer.getAttribute("widgetId");

				var widgetContainer = document.querySelector(".widgetPane[widgetId='" + widgetId + "']");

				var widgetDots = dotsContainer.querySelectorAll(".widgetDot");

				var slates = (widgetId === "awards") ? widgetContainer.querySelectorAll(".awardsSlate") : widgetContainer.querySelectorAll(".featuredSlate");

				// deactivate the current dot
				dotsContainer.querySelector(".widgetDotActive").classList.remove("widgetDotActive");

				if(widgetId === "awards")
					widgetContainer.querySelector(".activeAwardsSlate").classList.remove("activeAwardsSlate");
				else
					widgetContainer.querySelector(".activeFeaturedSlate").classList.remove("activeFeaturedSlate");

				// activate the current dot
				dot.classList.add("widgetDotActive");

				var currentIndex = 0;
				for( ; currentIndex < widgetDots.length; currentIndex++ )
				{
					if( widgetDots[currentIndex] == dot)
						break;
				}

				// handle dots
				if(widgetId === "awards")
					slates[currentIndex].classList.add("activeAwardsSlate");
				else
					slates[currentIndex].classList.add("activeFeaturedSlate");
			}

			var autoFeaturedFlipHandle;

			var autoAwardsFlipHandle = setInterval(function()
			{
				var dotsContainer = document.querySelector(".dotsContainer[widgetId='awards']");
				var widgetId = dotsContainer.getAttribute("widgetId");
				var widgetDots = dotsContainer.querySelectorAll(".widgetDot");
				var activeDot = dotsContainer.querySelector(".widgetDotActive");

				var currentIndex = 0;
				for( ; currentIndex < widgetDots.length; currentIndex++ )
				{
					if( widgetDots[currentIndex] == activeDot)
						break;
				}

				currentIndex++;
				if( currentIndex >= widgetDots.length )
					currentIndex = 0;

				widgetCycle(widgetDots[currentIndex]);
			}, 4500);

			function getStarted()
			{
				window.location='asset://ui/importSteamGames.html?uiback=' + encodeURIComponent("window.location='asset://ui/welcome.html';");
			}
			
			// https://www.htmlgoodies.com/html5/javascript/calculating-the-difference-between-two-dates-in-javascript.html
			function daysBetween( date1, date2 ) {
			  //Get 1 day in milliseconds
			  var one_day=1000*60*60*24;

			  // Convert both dates to milliseconds
			  var date1_ms = date1;//.getTime();
			  var date2_ms = date2;//.getTime();

			  // Calculate the difference in milliseconds
			  var difference_ms = date2_ms - date1_ms;
			    
			  // Convert back to days and return
			  return difference_ms/one_day; 
			}

			var steamgamesNag = localStorage.getItem("steamgames_nag");
			if( steamgamesNag != "0" )
			{
				if( !!!steamgamesNag )
					steamgamesNag = 0;
				else
					steamgamesNag = parseInt(steamgamesNag);

				// now check when the last nag was
				var lastSteamgamesNag = localStorage.getItem("last_steamgames_nag");

				var shouldSteamgamesNag = false;
				if( !!!lastSteamgamesNag )
					shouldSteamgamesNag = true;
				else
				{
					var dateA = new Date(parseInt(lastSteamgamesNag));
					var dateB = new Date();
					var dif = daysBetween(dateA.getTime(), dateB.getTime());
					
					if( dif >= steamgamesNag )
						shouldSteamgamesNag = true;
				}

				if(shouldSteamgamesNag)
					document.querySelector("#steamgamesNagButton").style.display = "block";
			}

			function confirmSave()
			{
				askSave(false);
			}

			function askSave(showDiscard)
			{
				var victims = [];
				var volatileCount = aaapi.cmdEx("getVolatileCounts");

				// TODO: Try to detect & prevent saving over one of your arcade instances that existed in singleplayer!!
//console.log(JSON.stringify(universeInfo));
				//var instanceInfo = aaapi.cmdEx("getInstance", universeInfo.instance);
				//if( !!instanceInfo )
				//	console.log(JSON.stringify(instanceInfo.instance.));
				var showBackupButton = (!!universeInfo && !universeInfo.isHost);
				var volatileCountText = "";
				if( showBackupButton )
					volatileCountText += "Instance ID: " + universeInfo.instance + "<br />";


				var htmlBuf = "Changed: ";
				var isFirstEntry = true;
				for( var x in volatileCount.changed )
				{
					if( x === "instances" || volatileCount.changed[x] - volatileCount.remote[x] == 0 )
						continue;

					if( !isFirstEntry )
						htmlBuf += ", ";
					else
						isFirstEntry = false;

					htmlBuf += (volatileCount.changed[x] - volatileCount.remote[x]) + " " + x;
				}

				if( !isFirstEntry )
					volatileCountText += htmlBuf;

				if( showBackupButton && Object.keys(volatileCount.remote).length > 1 )
				{
					htmlBuf = "<br />New: ";

					isFirstEntry = true;
					for( var x in volatileCount.remote )
					{
						if( x === "instances" || volatileCount.remote[x] == 0 )
							continue;

						if( !isFirstEntry )
							htmlBuf += ", ";
						else
							isFirstEntry = false;

						htmlBuf += volatileCount.remote[x] + " " + x;
					}

					if( !isFirstEntry )
						volatileCountText += htmlBuf;

					createSaveModalPrompt(showDiscard, "Save Changes", "Do you want to save this arcade and <u><b>ALL</b></u> the items & models used in it to your personal library?<br /><br />Note that this will overwrite existing entries in your libary.<br /><br /><label><input type='radio' name='savewhat' value='all' checked /> Save ALL Entries & Instance</label><br /><label><input type='radio' name='savewhat' value='onlynew' /> New Entries Only & Instance</label><br /><br />" + volatileCountText, "yesSave();", "noSave();");
				}
				else
					createSaveModalPrompt(showDiscard, "Save Changes", "Do you want to save this arcade and <u><b>ALL</b></u> the items & models used in it to your personal library?<br /><br />Note that this will overwrite existing entries in your libary.<br /><br />" + volatileCountText, "yesSave();", "noSave();");
			}

			// from https://stackoverflow.com/questions/15900485/correct-way-to-convert-size-in-bytes-to-kb-mb-gb-in-javascript
			function formatBytes(a,b){if(0==a)return"0 Bytes";var c=1024,d=b||2,e=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],f=Math.floor(Math.log(a)/Math.log(c));return parseFloat((a/Math.pow(c,f)).toFixed(d))+" "+e[f]}
			//Backup Library (' + formatBytes(aaapi.cmdEx("getDbSize")) + ')

			var aaSaveModalPromptMenu;
			function createSaveModalPrompt(showDiscard, title, text, yesAction, noAction)
			{
				if( !!aaSaveModalPromptMenu )
				{
					console.log("ERROR: A modal menu is already being displayed!");
					return;
				}

				// Lets be modal.
				var modalContainer = document.createElement("div");
				modalContainer.style.cssText = "position: fixed; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);";
				modalContainer.addEventListener("click", function(e)
				{
					/*
					var isChild = false;
					var childNode = e.target;
					while(!!childNode)
					{
						childNode = childNode.parentNode;
						if( childNode === e.currentTarget )
						{
							isChild = true;
							break;
						}
					}
					*/

					if( e.currentTarget !== e.target )
					{
						// the modal window itself is clicked
						/*
						if( !isChild )
						{
							console.log("propo stopped");
							e.preventDefault();
							e.stopImmediatePropagation();//Immediate
						}
						*/
						return;
					}
					else
					{
						if( !!!aaSaveModalPromptMenu.flashInterval )
						{
							aaSaveModalPromptMenu.flashInterval = setInterval(function()
							{
								var titleRow = this.querySelector("tr");
								var titleBarElems = titleRow.querySelectorAll("td");
								var titleBarElem;

								if( !!!this.flashCount )
								{
									for( var i = 0; i < titleBarElems.length; i++ )
									{
										titleBarElem = titleBarElems[i];
										if( titleBarElem.classList.contains("aaThemeColorOneHighBackgroundColor") )
										{
											titleBarElem.classList.remove("aaThemeColorOneHighBackgroundColor");
											titleBarElem.classList.add("aaThemeColorOneBackgroundColor");
										}
									}

									clearInterval(this.flashInterval);
									delete this.flashInterval;
								}
								else
								{
									for( var i = 0; i < titleBarElems.length; i++ )
									{
										titleBarElem = titleBarElems[i];
										if( titleBarElem.classList.contains("aaThemeColorOneHighBackgroundColor") )
										{
											titleBarElem.classList.remove("aaThemeColorOneHighBackgroundColor");
											titleBarElem.classList.add("aaThemeColorOneBackgroundColor");
										}
										else if(titleBarElem.classList.contains("aaThemeColorOneBackgroundColor"))
										{
											titleBarElem.classList.remove("aaThemeColorOneBackgroundColor");
											titleBarElem.classList.add("aaThemeColorOneHighBackgroundColor");
										}
									}

									this.flashCount--;
								}
							}.bind(aaSaveModalPromptMenu), 100);

							aaSaveModalPromptMenu.flashCount = 6;
						}
					}
				}.bind(modalContainer), true);

				var modalHTML = "";

				// header
				var modalYPos = (window.innerHeight / 3) + "px";
				var modalWindowHeaderHTML = arcadeHud.generateWindowHeaderHTML(title, "margin-left: auto; margin-right: auto; top: " + modalYPos + "; width: 600px;", true, true, "", "");
				modalHTML += modalWindowHeaderHTML;

				// body
				modalHTML += '<div class="aaWindowPaneContent aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor aaTitleTextSizeFontSize aaTextColorTwoColor">';
				//modalHTML += "<form id='nodeNameForm' style='margin: 0;'>";
				/*
				modalHTML += "<table style='margin-left: 0; margin-right: 0;'>\
					<tr>\
						<td>\
							<img src='clock.png' style='width: 78px;' />\
						</td>\
						<td style='padding-left: 15px;'>";*/
						//	<div class='aaTextSizeFontSize aaTitleText aaThemeColorOneColor' style='white-space: normal;'>Here are notes on features I'm currently working on improving.<br /><br />Thank you for having patience.</div>\

				modalHTML += "<div style='font-family: Arial; text-align: justify; white-space: normal;' class='aaTextSizeFontSize aaTextColorTwoColor'>";
				modalHTML += text;
				//modalHTML += "<input id='nodeNameInput' type='text' class='aaTitleTextSizeFontSize' />";
				modalHTML += "</div>";
				//modalHTML += "</td></tr></table>";
				modalHTML += "</div>";

				modalHTML += '\
					<table class="aaWindowActions">\
						<tr>\
							<td>\
							</td>\
							<td style="width: 1%; white-space: nowrap;">\
								<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorOneHoverShadedBackground aaTextColorOneColor aaThemeColorOneLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Backup Library & Save" />\
								<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorOneHoverShadedBackground aaTextColorOneColor aaThemeColorOneLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Save" />\
								<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Discard" />\
								<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Cancel" />\
							</td>\
						</tr>\
					</table>\
				';

				//modalHTML += "</form>";

				// footer
				var modalWindowFooterHTML = arcadeHud.generateWindowFooterHTML();
				modalHTML += modalWindowFooterHTML;

				modalContainer.innerHTML = modalHTML;
				aaSaveModalPromptMenu = modalContainer.querySelector(".aaWindow");
				document.body.appendChild(modalContainer);
/*
				var nodeNameInput = document.body.querySelector("#nodeNameInput");
				nodeNameInput.focus();
				var nodeNameForm = document.body.querySelector("#nodeNameForm");
				nodeNameForm.addEventListener("submit", function(e)
				{
					e.preventDefault();

					if( this.value === "" )
						this.focus();
					else
					{
						aaSaveModalPromptMenu.parentNode.parentNode.removeChild(aaSaveModalPromptMenu.parentNode);
						aaSaveModalPromptMenu = undefined;

						confirmedSaveNewNode(this.value);
					}
				}.bind(nodeNameInput), true);
*/

				var buttons = modalContainer.querySelectorAll(".aaWindowActions input[type='button']");
				var showBackupButton = (!!universeInfo && !universeInfo.isHost);
				if( showBackupButton )
				{
					buttons[1].className = "aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor";

					buttons[0].addEventListener("click", function(e)
					{
						var elems = document.querySelectorAll("input[name='savewhat']");
						var saveWhat = "all";
						if( elems.length > 0 )
						{
							for( var i = 0; i < elems.length; i++ )
							{
								if( elems[i].checked )
									saveWhat = elems[i].value;
							}

							if( aaapi.cmdEx("createDbBackup") )
							{
								aaSaveModalPromptMenu.parentNode.parentNode.removeChild(aaSaveModalPromptMenu.parentNode);
								aaSaveModalPromptMenu = undefined;

								aaapi.cmd("performAutoSave", "SAVEMODE_SAVE", true, (saveWhat === "onlynew"));
								window.location.reload();
							}
							else
							{
								console.log("Failed to create backup.");
							}
						}
					}, true);

					buttons[0].value = "Backup Library (" + formatBytes(aaapi.cmdEx("getDbSize")) + ") & Save";
				}
				else
					buttons[0].style.display = "none";

				buttons[1].addEventListener("click", function(e)
				{
					aaSaveModalPromptMenu.parentNode.parentNode.removeChild(aaSaveModalPromptMenu.parentNode);
					aaSaveModalPromptMenu = undefined;


					var elems = document.querySelectorAll("input[name='savewhat']");
					var saveWhat = "all";
					if( elems.length > 0 )
					{
						for( var i = 0; i < elems.length; i++ )
						{
							if( elems[i].checked )
								saveWhat = elems[i].value;
						}
					}

					aaapi.cmd("performAutoSave", "SAVEMODE_SAVE", true, (saveWhat === "onlynew"));
					if( showDiscard )
						aaapi.cmd("quit");
						//confirmQuit();
					else
						window.location.reload();

					//eval(yesAction);
				}, true);

				if( !showDiscard )
					buttons[2].style.display = "none";

				buttons[2].addEventListener("click", function(e)
				{
					aaSaveModalPromptMenu.parentNode.parentNode.removeChild(aaSaveModalPromptMenu.parentNode);
					aaSaveModalPromptMenu = undefined;

					aaapi.cmd("performAutoSave", "SAVEMODE_DISCARD");
					if( showDiscard )
					{
						aaapi.cmd("quit");
						/*
						setTimeout(function()
						{
							confirmQuit();
						}, 100);
*/
					}
					else
						window.location.reload();

					//eval(noAction);
				}.bind(buttons[2]), true);

				buttons[3].addEventListener("click", function(e)
				{
					aaSaveModalPromptMenu.parentNode.parentNode.removeChild(aaSaveModalPromptMenu.parentNode);
					aaSaveModalPromptMenu = undefined;

					aaapi.cmd("setSaveMode", "SAVEMODE_NONE");
					//window.location = "welcome.html";
				}, true);
			}
			function confirmQuit()
			{
				//if( aaapi.cmdEx("getNeedsSave") )
					//askSave(true);
				//else
					createModalPrompt("Are You Sure?", "", "Quit", "yesQuit();", "Cancel", "noQuit();");
			}

			function yesQuit()
			{
				var shouldAskSave = (aaapi.cmdEx("getNeedsSave") && (!!!universeInfo || universeInfo.isHost));
				
				if( shouldAskSave )
					askSave(true);
				else
					aaapi.cmd("quit");
			}

			function noQuit()
			{
				//console.log("nope");
			}
		</script>


		<script>
			
			function disconnectSession()
			{
				var connectedSessionInfo = aaapi.cmdEx("getConnectedSession");
				if( !!connectedSessionInfo && !connectedSessionInfo.isHost )
				{
					setTimeout(function()
					{
						aaapi.cmd("disconnectSession");
						aaapi.cmd("restartNetwork");
						aaapi.cmd("deactivateInputMode");
						aaapi.cmd("disconnect");
					}, 100);
				}
				else
				{
					aaapi.cmd("restartNetwork");
					setTimeout(function()
					{
						window.location.reload();
					}, 100);
				}
			}

			function yesDisconnectSession()
			{
				disconnectSession();
			}

			function noDisconnectSession()
			{
				console.log("nope");
			}

			function askDisconnectSession()
			{
				createModalPrompt("Are You Sure?", "This will end your online session & return you to singleplayer mode.", "Disconnect", "yesDisconnectSession();", "Cancel", "noDisconnectSession();");
			}

			var aaModalPromptMenu;
			function createModalPrompt(title, text, yesTitle, yesAction, noTitle, noAction, validateFunc)
			{
				if( !!aaModalPromptMenu )
				{
					console.log("ERROR: A modal menu is already being displayed!");
					return;
				}

				// Lets be modal.
				var modalContainer = document.createElement("div");
				modalContainer.style.cssText = "position: fixed; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);";
				modalContainer.addEventListener("click", function(e)
				{
					/*
					var isChild = false;
					var childNode = e.target;
					while(!!childNode)
					{
						childNode = childNode.parentNode;
						if( childNode === e.currentTarget )
						{
							isChild = true;
							break;
						}
					}
					*/

					if( e.currentTarget !== e.target )
					{
						// the modal window itself is clicked
						/*
						if( !isChild )
						{
							console.log("propo stopped");
							e.preventDefault();
							e.stopImmediatePropagation();//Immediate
						}
						*/
						return;
					}
					else
					{
						if( !!!aaModalPromptMenu.flashInterval )
						{
							aaModalPromptMenu.flashInterval = setInterval(function()
							{
								var titleRow = this.querySelector("tr");
								var titleBarElems = titleRow.querySelectorAll("td");
								var titleBarElem;

								if( !!!this.flashCount )
								{
									for( var i = 0; i < titleBarElems.length; i++ )
									{
										titleBarElem = titleBarElems[i];
										if( titleBarElem.classList.contains("aaThemeColorOneHighBackgroundColor") )
										{
											titleBarElem.classList.remove("aaThemeColorOneHighBackgroundColor");
											titleBarElem.classList.add("aaThemeColorOneBackgroundColor");
										}
									}

									clearInterval(this.flashInterval);
									delete this.flashInterval;
								}
								else
								{
									for( var i = 0; i < titleBarElems.length; i++ )
									{
										titleBarElem = titleBarElems[i];
										if( titleBarElem.classList.contains("aaThemeColorOneHighBackgroundColor") )
										{
											titleBarElem.classList.remove("aaThemeColorOneHighBackgroundColor");
											titleBarElem.classList.add("aaThemeColorOneBackgroundColor");
										}
										else if(titleBarElem.classList.contains("aaThemeColorOneBackgroundColor"))
										{
											titleBarElem.classList.remove("aaThemeColorOneBackgroundColor");
											titleBarElem.classList.add("aaThemeColorOneHighBackgroundColor");
										}
									}

									this.flashCount--;
								}
							}.bind(aaModalPromptMenu), 100);

							aaModalPromptMenu.flashCount = 6;
						}
					}
				}.bind(modalContainer), true);

				var modalHTML = "";

				var modalYPos = (window.innerHeight / 3) + "px";
				var styleText = (text !== "") ? "margin-left: auto; margin-right: auto; top: " + modalYPos + "; width: 600px;" : "margin-left: auto; margin-right: auto; top: " + modalYPos + "; width: 300px;";

				// header
				var modalWindowHeaderHTML = arcadeHud.generateWindowHeaderHTML(title, styleText, true, true, "", "");
				modalHTML += modalWindowHeaderHTML;

				if( text !== "" )
				{
					// body
					modalHTML += '<div class="aaWindowPaneContent aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor aaTitleTextSizeFontSize aaTextColorTwoColor">';
					//modalHTML += "<form id='nodeNameForm' style='margin: 0;'>";
					/*
					modalHTML += "<table style='margin-left: 0; margin-right: 0;'>\
					<tr>\
						<td>\
							<img src='clock.png' style='width: 78px;' />\
						</td>\
						<td style='padding-left: 15px;'>";*/
						//	<div class='aaTextSizeFontSize aaTitleText aaThemeColorOneColor' style='white-space: normal;'>Here are notes on features I'm currently working on improving.<br /><br />Thank you for having patience.</div>\

					modalHTML += "<div style='font-family: Arial; text-align: justify; white-space: normal;' class='aaTextSizeFontSize aaTextColorTwoColor'>";
					modalHTML += text;
					//modalHTML += "<input id='nodeNameInput' type='text' class='aaTitleTextSizeFontSize' />";
					modalHTML += "</div>";

					//modalHTML += "</td></tr></table>";
					modalHTML += "</div>";
				}

				if( text !== "" )	// simple hax to get 2 different behaviors out of this prompt
				{
					modalHTML += '\
						<table class="aaWindowActions">\
							<tr>\
								<td>\
								</td>\
								<td style="width: 1%; white-space: nowrap;">\
									<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorOneHoverShadedBackground aaTextColorOneColor aaThemeColorOneLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Disconnect" />\
									<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Cancel" />\
								</td>\
							</tr>\
						</table>\
					';
				}
				else
				{
					modalHTML += '\
						<table class="aaWindowActions">\
							<tr>\
								<td>\
								</td>\
								<td style="width: 1%; white-space: nowrap;">\
									<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorOneHoverShadedBackground aaTextColorOneColor aaThemeColorOneLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Quit" />\
									<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Cancel" />\
								</td>\
							</tr>\
						</table>\
					';
				}

				//modalHTML += "</form>";

				// footer
				var modalWindowFooterHTML = arcadeHud.generateWindowFooterHTML();
				modalHTML += modalWindowFooterHTML;

				modalContainer.innerHTML = modalHTML;
				aaModalPromptMenu = modalContainer.querySelector(".aaWindow");
				document.body.appendChild(modalContainer);
/*
				var nodeNameInput = document.body.querySelector("#nodeNameInput");
				nodeNameInput.focus();
				var nodeNameForm = document.body.querySelector("#nodeNameForm");
				nodeNameForm.addEventListener("submit", function(e)
				{
					e.preventDefault();

					if( this.value === "" )
						this.focus();
					else
					{
						aaModalPromptMenu.parentNode.parentNode.removeChild(aaModalPromptMenu.parentNode);
						aaModalPromptMenu = undefined;

						confirmedSaveNewNode(this.value);
					}
				}.bind(nodeNameInput), true);
*/

				var buttons = modalContainer.querySelectorAll(".aaWindowActions input[type='button']");
				buttons[0].value = yesTitle;
				buttons[0].addEventListener("click", function(e)
				{
					if( !!validateFunc && typeof window[validateFunc] === "function" )
					{
						if( !window[validateFunc]() )
							return;
					}

					aaModalPromptMenu.parentNode.parentNode.removeChild(aaModalPromptMenu.parentNode);
					aaModalPromptMenu = undefined;

					eval(yesAction);
				}, true);

				buttons[1].value = noTitle;
				buttons[1].addEventListener("click", function(e)
				{
					aaModalPromptMenu.parentNode.parentNode.removeChild(aaModalPromptMenu.parentNode);
					aaModalPromptMenu = undefined;

					eval(noAction);
				}, true);
			}


			function buildAutoplayList()
			{
				fetchDisplayTaskInfo();
			}

			function onYouTubeEnded()
			{
				setTimeout(function()
				{
					buildAutoplayList();
				}, 500);
			}

			var g_opts;
			
			function showWindowsTaskBar()
			{
				if( !!!g_opts )
					return;

				if( g_opts.fullscreen && g_opts.embeddedInstanceType === "AwesomiumBrowser")
					aaapi.cmd("consoleCommand", "show_windows_task_bar");
			}

			function aaOnActivateInputMode(opts)
			{
				g_opts = opts;
				showWindowsTaskBar();
				if( opts.isGamepadInput )
					document.querySelector("#frontPage").style.background = "none";
				//twitchChatDetect();
				//setInterval(twitchChatDetect, 500);
			}

			var lastBringToFront;
			document.addEventListener("mousemove", function(e)
			{
				var date = (new Date()).getTime();
				if( !!lastBringToFront && date - lastBringToFront < 1000 )
					return;

				lastBringToFront = date;
				showWindowsTaskBar();
			});

			function showHelp()
			{
				window.location='asset://ui/help.html?uiback=' + encodeURIComponent("window.location='asset://ui/welcome.html';");
			}

			function skipBackHandler(elem)
			{
				document.querySelector("#autoplayStuff").style.display = "none";
				document.querySelector("#autoplayLoadingStuff").style.display = "block";

				var displayTaskId = (!!displayTaskInfo) ? displayTaskInfo.id : "";
				arcadeHud.jumpToYouTube(elem.objectId, displayTaskId);
				//aaapi.cmd("deactivateInputMode");
			}

			function skipNextHandler(elem)
			{
				document.querySelector("#autoplayStuff").style.display = "none";
				document.querySelector("#autoplayLoadingStuff").style.display = "block";

				var displayTaskId = (!!displayTaskInfo) ? displayTaskInfo.id : "";
				arcadeHud.jumpToYouTube(elem.objectId, displayTaskId);
				//aaapi.cmd("deactivateInputMode");
			}

			function doStop()
			{
				document.querySelector("#allObjectsSlate").style.display = "none";
				document.querySelector("#autoplayLoadingStuff").style.display = "none";
				document.querySelector("#allObjectsLoadingStuff").style.display = "none";
				document.querySelector("#autoplayStuff").style.display = "block";
				document.querySelector("#allObjectsSlate").style.display = "block";
				document.querySelector("#autoplaySlate").style.display = "none";
				aaapi.cmd("closeTask", displayTaskInfo.id);
				buildAllObjectsList();
				//aaapi.cmd("deactivateInputMode");
			}

			//buildAutoplayList();
		</script>


		<style>
			/*#socialListContainer
			{
				position: absolute;
				bottom: 0;
				right: 0;
				display: none;
			}*/

			#socialList
			{
				display: none;
				max-height: 454px;
				overflow-y: auto;
			}

			.socialCard
			{
				border-radius: 8px;
				padding: 8px;
				margin: 4px;
				margin-left: 20px;
				opacity: 0.9;
			}

			.socialCard:hover
			{
				opacity: 1.0;
			}

			.socialActionsCell
			{
				display: none;
			}

			.socialCard:hover .socialActionsCell
			{
				display: table-cell;
			}

			.joinButton
			{
				min-width: inherit;
				margin-right: 4px;
				padding: 4px;
			}

			.socialListAvatar
			{
				width: 64px;
				height: 64px;
			}

			.socialListName
			{
				font-size: 20px;
				font-family: Arial;
				font-weight: bold;
				margin-left: 4px;
				white-space: nowrap;
			}

			.socialListMap
			{
				font-size: 12px;
				font-family: Arial;
				font-weight: bold;
				margin-left: 4px;
				white-space: nowrap;
			}

			.socialListArcade
			{
				font-size: 12px;
				font-family: Arial;
				font-weight: bold;
				margin-left: 4px;
				white-space: nowrap;
			}

			.joinContainer
			{
				padding: 4px;
				border-style: solid;
				border-size: 2px;
				border-color: #333;
				background-color: #111;
				display: none;
			}

			table:hover > tr > td > .joinContainer
			{
				display: block;
			}

			.joinContainer:hover
			{
				border-color: grey;
			}
		</style>

		<script>
			var isSocial = aaapi.cmdEx("getSocialMode");
			function leaveSocial()
			{
				clearInterval(reupdateSocialHandle);
				aaapi.cmd("setSocialMode", false);
				isSocial = false;
				socialListTitleElem.innerHTML = "SOCIAL";
				socialListElem.style.display = "none";
				toggleSocialList();
				//updateSocialUsersList();
				//document.location.reload();
			}

			function joinSocial()
			{
				isSocial = true;
				aaapi.cmd("setSocialMode", true);
				updateSocialUsersList();
				/*
				if( !arcadeHud.oldIsMapLoaded )
				{
					setTimeout(function()
					{
						document.location.reload();
						//updateSocialUsersList();
					}, 1000);
				}
				else
					aaapi.cmd("deactivateInputMode");
				*/
			}

			var g_socialUsers;
			function fetchSocialUsers()
			{
				g_socialUsers = localStorage.getItem("socialUsers");

				if( !!g_socialUsers )
					g_socialUsers = JSON.parse(g_socialUsers);
				else
					g_socialUsers = {};
			}

			//if( isSocial )
			//	document.querySelector("#socialListContainer").style.display = "block";

			var socialListElem = document.querySelector("#socialList");
			//var chatElem = document.querySelector("#chatPanel");
			var socialListTitleElem = document.querySelector("#socialListTitle");
			function updateSocialUsersListCount()
			{
				if( isSocial )
				{
					fetchSocialUsers();

					//var numUsers = Object.keys(g_socialUsers).length;

					var numUsers = 0;
					for( var x in g_socialUsers )
					{
						if( !!g_socialUsers[x].displayName && g_socialUsers[x].displayName !== "" )
							numUsers++;
					}

					socialListTitleElem.innerHTML = "SOCIAL (" + numUsers + ") " + "<input type='button' id='leaveSocialButton' value='Leave Social' style='margin-right: 16px; margin-top: 4px; font-size: 10px; margin-left: 12px;' class='helpNote aaButton aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor' help='Disconnect from the global chat room.' onclick='leaveSocial();' />";

					arcadeHud.assignHelp(document.querySelector("#leaveSocialButton"));
				}
				else
				{
					socialListTitleElem.innerHTML = "SOCIAL";
				}
			}
			updateSocialUsersListCount();	// this also fecths g_socialUsers for us.

			function updateSocialUsersList()
			{
				if( isSocial )
				{
					updateSocialUsersListCount();	// this also fecths g_socialUsers for us.

					socialListElem.innerHTML = "";

					var socialUserTable, socialUserTR, socialUserTDJoin, socialUserTDInfo, socialUserTDAvatar, socialUserJoinContainer, socialUserJoinImage, socialUserNameContainer, socialUserName, socialUserModeContainer, socialUserMode, socialUserMapContainer, socialUserMap;

					for( var x in g_socialUsers )
					{
						socialUser = g_socialUsers[x];
						if( !!!socialUser.displayName )
							continue;

						socialUserTable = document.createElement("table");
						socialUserTable.cellSpacing = "0";
						socialUserTable.cellPadding = "0";
						socialUserTable.className = "socialUserTable";
						socialUserTable.style.cssText = "width: 100%; border: 2px solid transparent;";

						socialUserTR = document.createElement("tr");
						socialUserTable.appendChild(socialUserTR);
						socialUserTDJoin = document.createElement("td");
						socialUserTDJoin.style.cssText = "width: 1px;";
						socialUserTR.appendChild(socialUserTDJoin);

						socialUserJoinContainer = document.createElement("div");
						socialUserJoinContainer.className = "joinContainer";

						var isInOurSession = (!!universeInfo && universeInfo.lobby === socialUser.lobby && universeInfo.universe === socialUser.universe && universeInfo.instance === socialUser.instance );

						if( socialUser.lobby === "" || socialUser.instance === "" || socialUser.instance === "Private" || socialUser.universe === "" || socialUser.universe === "Private" || isInOurSession )
							socialUserJoinContainer.style.cssText = "display: none !important;";

						socialUserJoinContainer.addEventListener("click", function(e)
						{
							if( !isInOurSession )
							{
								if( !!universeInfo && universeInfo.universe !== "" && universeInfo.instance !== "" )
									aaapi.cmd("disconnectSession");
								
								aaapi.cmd("joinLobby", this.lobby);
							}
							else
								aaapi.cmd("addToastMessage", "This user is in your current session with you!");
						}.bind(socialUser));

						socialUserTDJoin.appendChild(socialUserJoinContainer);
						socialUserJoinImage = document.createElement("img");
						socialUserJoinImage.src = "mpicon.png";
						socialUserJoinContainer.appendChild(socialUserJoinImage);
						socialUserTDInfo = document.createElement("td");
						socialUserTDInfo.align = "right";
						socialUserTDInfo.style.cssText = "padding-right: 8px; font-family: Arial;";
						socialUserTR.appendChild(socialUserTDInfo);
						socialUserNameContainer = document.createElement("div");
						socialUserNameContainer.style.cssText = "font-size: 18px; display: inline-block; vertical-align: top;";
						socialUserNameContainer.appendChild(document.createTextNode(socialUser.displayName));
						socialUserTDInfo.appendChild(socialUserNameContainer);
						socialUserName = document.createElement("div");
						socialUserName.className = "userName";
						socialUserNameContainer.appendChild(socialUserName);
						//socialUserModeContainer = document.createElement("div");
						socialUserMode = document.createElement("div");
						socialUserMode.style.cssText = "font-size: 10px;";
						socialUserMode.className = "userMode";

						if( socialUser.lobby === "" || socialUser.instance === "" )
						{
							if( socialUser.userId === localUserId )
								socialUserMode.innerHTML = "(YOU) SINGLEPLAYER";
							else
								socialUserMode.innerHTML = "SINGLEPLAYER";
						}
						else if( socialUser.instance === "Private" || socialUser.universe === "Private" )
							socialUserMode.innerHTML = "PRIVATE";
						else
						{
							if( socialUser.userId === localUserId )
								socialUserMode.innerHTML = "(YOU) MULTIPLAYER";
							else if( isInOurSession )
								socialUserMode.innerHTML = "(IN-SESSION) MULTIPLAYER";
							else
								socialUserMode.innerHTML = "MULTIPLAYER";
						}

						socialUserTDInfo.appendChild(socialUserMode);
						//socialUserMapContainer = document.createElement("div");
						socialUserMap = document.createElement("div");
						socialUserMap.style.cssText = "font-size: 10px; font-weight: 900;";
						socialUserMap.className = "userMap";

						var mapFile;
						if( socialUser.userId === localUserId && !!worldInfo && !!worldInfo.map )
						{
							mapFile = worldInfo.map.platforms[arcadeHud.platformId].file;
						}
						else
							mapFile = socialUser.mapFile;

						if( !!mapFile )
						{
							if( mapFile.toLowerCase().indexOf(".bsp") === mapFile.length-4 )
								mapFile = mapFile.substring(0, mapFile.length-4);
							socialUserMap.appendChild(document.createTextNode(mapFile));
						}
						else
						{
							socialUserMap.appendChild(document.createTextNode("Main Menu"));
						}

						socialUserTDInfo.appendChild(socialUserMap);
						socialUserTDAvatar = document.createElement("td");
						socialUserTDAvatar.style.cssText = "width: 1px;";
						socialUserTR.appendChild(socialUserTDAvatar);
						socialUserAvatarImage = document.createElement("img");
						socialUserAvatarImage.src = socialUser.avatar;
						socialUserAvatarImage.style.cssText = "width: 48px;";
						socialUserTDAvatar.appendChild(socialUserAvatarImage);

						socialListElem.appendChild(socialUserTable);
					}
				}
				else
				{
					socialListElem.innerHTML = "<input id='joinSocialButton' type='button' value='Join Social' style='padding: 16px; margin-top: 48px;' class='helpNote aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor' help='You can chat (Y) with players who are in other maps if you are in SOCIAL MODE.' onclick='joinSocial();' /><br />";

					arcadeHud.assignHelp(document.querySelector("#joinSocialButton"));
				}
			}

			var reupdateSocialHandle;
			function toggleSocialList()
			{
				if( socialListElem.style.display === "block" )
					socialListElem.style.display = "none";
				else
				{
					reupdateSocialHandle = setInterval(function(e)
					{
						updateSocialUsersList();
					}, 2000);
					updateSocialUsersList();

					socialListElem.style.display = "block";
				}
			}
			toggleSocialList();

			var socialListener = {
				"countUpdate": function(count)
				{
					console.log("Online count: " + count);
					document.querySelector("#onlineCount").innerHTML = " <b>(" + count + " ONLINE)</b>";
				}
			};
		</script>

		
		<div id="hostedProjectSlate" style="position: absolute; bottom: 60px; left: 30px; background-color: rgba(0, 0, 0, 0.95); padding: 10px; text-align: center; display: none;">
			<div class="aaTextSizeFontSize" style="font-family: Arial; font-weight: 900;">Hosted Project</div>
			<div class="aaTitleTextSizeFontSize aaTitleText" style="" id="projectTitle"></div>
			<div>
				<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorOneHoverShadedBackground aaTextColorOneColor aaThemeColorOneLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Re-Upload Map" onclick="reuploadMap();" />
				<!--input type="button" class="aaButton aaTextSizeFontSize aaThemeColorOneHoverShadedBackground aaTextColorOneColor aaThemeColorOneLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Dismiss" onclick="dismissReuploadMap();" /-->
			</div>
		</div>

		
		<div id="currentProjectSlate" style="position: absolute; bottom: 60px; right: 30px; background-color: rgba(0, 0, 0, 0.95); padding: 10px; text-align: center; display: none;">
			<div class="aaTextSizeFontSize" style="font-family: Arial; font-weight: 900;">Current Project</div>
			<div class="aaTitleTextSizeFontSize aaTitleText" style="" id="projectTitle"></div>
			<div>
				<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorOneHoverShadedBackground aaTextColorOneColor aaThemeColorOneLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Reload" onclick="reloadMap();" />
				<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorOneHoverShadedBackground aaTextColorOneColor aaThemeColorOneLowBorderColor" style="padding: 6px; padding-left: 12px; padding-right: 12px;" value="Dismiss" onclick="dismissHammer();" />
			</div>
		</div>

		<script>
			var hostedProjectSlate = document.querySelector("#hostedProjectSlate");
			var hostedProjectVal = aaapi.cmdEx('isOwnProjectMap');
			if( hostedProjectVal )
				hostedProjectSlate.style.display = "block";


			var currentProjectSlate = document.querySelector("#currentProjectSlate");
			var currentProjectVal = aaapi.cmdEx("getConVarValue", "current_project");
			if( !!currentProjectVal && currentProjectVal !== "" )
			{
				currentProjectSlate.style.display = "block";
				document.querySelector("#projectTitle").innerHTML = currentProjectVal;
			}

			function reuploadMap()
			{
				var worldInfo = aaapi.cmdEx("getWorldInfo");
				if( !!worldInfo.map )
				{
					aaapi.cmd("addToastMessage", "Uploading Map");
					aaapi.cmd("addSingleMapToUploadBatch", worldInfo.map.info.id);
					window.location.href = "asset://ui/tabMenu.html?tab=transfers";
				}
			}

			function reloadMap()
			{
				var instanceInfo = aaapi.cmdEx("getInstance");
				if( !!!instanceInfo )
					return;

				if( !!currentProjectVal && currentProjectVal !== "" )
					aaapi.cmd("consoleCommand", "last_opened_project \"" + currentProjectVal + "\"");
				
				playNow(instanceInfo.instance.mapId);
			}

			function dismissHammer()
			{
				aaapi.cmd("consoleCommand", "current_project \"\"");
				window.location.reload();
			}

			var mapHistory = (localStorage.getItem("mapHistory")) ? JSON.parse(localStorage.getItem("mapHistory")) : {};

			function playNow(mapId)
			{
				var hasInstanceToLoad = false;
				var mapHistoryEntry = mapHistory[mapId];
				var mapInstances;
				if( !!mapHistoryEntry )
				{
					if( mapHistoryEntry.instanceId === "" )
					{
						mapInstances = aaapi.cmdEx("getMapInstances", mapId);
						
						if( mapInstances.length > 0 )
							mapHistoryEntry.instanceId = mapInstances[0].id;
					}

					if( mapHistoryEntry.instanceId !== "" )
					{
						mapHistoryEntry.timestamp = new Date().getTime();

						// save the mapHistory out
						localStorage.setItem("mapHistory", JSON.stringify(mapHistory));

						hasInstanceToLoad = true;
					}
				}

				if( hasInstanceToLoad )
				{
					window.location = "asset://ui/loading.html?map=" + mapHistoryEntry.mapId + "&instance=" + mapHistoryEntry.instanceId + "&pos=" + mapHistoryEntry.position + "&rot=" + mapHistoryEntry.rotation + "&screenshot=" + mapHistoryEntry.screenshotId;
				}
				else
				{
					// are there any instances at all?
					if( !!!mapInstances )
						mapInstances = aaapi.cmdEx("getMapInstances", mapId);

					if( mapInstances.length > 0 )
						window.location = "asset://ui/playInstance.html?id=" + mapId;
					else
					{
						// create our mapHistory entry
						var mapHistoryEntry = {
							"mapId": mapId,
							"instanceId": "",
							"position": "",
							"rotation": "",
							"screenshotId": "",
							"timestamp": new Date().getTime()
						};

						// add our entry to the mapHistory
						mapHistory[mapId] = mapHistoryEntry;

						// save the mapHistory out
						localStorage.setItem("mapHistory", JSON.stringify(mapHistory));

						window.location = "asset://ui/loading.html?map=" + mapId + "&instance=" + "" + "&pos=" + "" + "&rot=" + "" + "&screenshot=" + "";
					}
				}
			}
			
			var lastProjectVal = aaapi.cmdEx("getConVarValue", "last_opened_project");
			if( !!lastProjectVal && lastProjectVal !== "" )
			{
				aaapi.cmd("consoleCommand", "last_opened_project \"\"");

				var projectMapId = aaapi.cmdEx("getHammerProjectMapID", lastProjectVal);//"2564a1b5";//482182db";
				if( projectMapId !== "" )
				{
					createModalPrompt("Level Design Project", "You recently opened your <i><b>" + lastProjectVal + "</b></i> project in Hammer.<br /><br />Do you want to load the map in-game now?", "Load My Map", "loadMyMap(\"" + projectMapId + "\");", "Dismiss", "dismissMyMap();");
				}
			}

			function loadMyMap(projectMapId)
			{
				aaapi.cmd("consoleCommand", "last_opened_project \"" + lastProjectVal + "\"");
				playNow(projectMapId);
			}

			function dismissMyMap()
			{
				// do nothing
			}
/*
var mapHistory = (localStorage.getItem("mapHistory")) ? JSON.parse(localStorage.getItem("mapHistory")) : {};
var mapHistoryKeys = Object.keys(mapHistory);
console.log(JSON.stringify(mapHistory[mapHistoryKeys[0]]));

var map = aaapi.cmdEx("getMap", mapHistory[mapHistoryKeys[0]].mapId);
console.log(JSON.stringify(map));
*/
/*
			function socialChange(elem)
			{
				aaapi.cmd("setSocialMode", elem.checked);
				if(elem.checked)
				{
					setTimeout(function(){aaapi.cmd("fetchOnlineCount");}, 1000);
				}
				else
					document.querySelector("#onlineCount").innerHTML = "";
			}
*/
			function tester()
			{
				var url = "https://www.thetvdb.com/?tab=episode&seriesid=71906&seasonid=3191&id=67443&lid=7";
				var seriesId = arcadeHud.getParameterByName("seriesid", url);
				var seasonId = arcadeHud.getParameterByName("seasonid", url);
				var episodeId = arcadeHud.getParameterByName("id", url);
				console.log("Series ID: " + seriesId + " and Season ID: " + seasonId + " and Episode ID: " + episodeId);
			}

			function huh()
			{
				var model = aaapi.cmdEx("getLibraryModel", "f935bc22");
				console.log(JSON.stringify(model));
				var item = aaapi.cmdEx("getLibraryItem", "f935bc22");
				console.log(JSON.stringify(item));
				//var instance = aaapi.cmdEx("getInstance", "-q0NAMh8P0hjUBUfE7ry");
				//console.log(JSON.stringify(instance));
			}

			function CheckNPCs()
			{
				var goodEntries = [];
				var response = aaapi.cmdEx("getNearestObjectToPlayerLook");
				while(response.success)
				{
					if( !!response.entry && !!response.entry.itemId && response.entry.itemId !== "" )
						goodEntries.push(response.entry);

					response = aaapi.cmdEx("getNextNearestObjectToPlayerLook");
				}

				var object;
				var model;
				var instanceObject;
				for( var i = 0; i < goodEntries.length; i++ )
				{
					instanceObject = aaapi.cmdEx("getObject", goodEntries[i].id);
					//console.log(instanceObject.item === instanceObject.model);
					if( !!!instanceObject )// && instanceObject.item !== instanceObject.model )
						continue;

					if( arcadeHud.npcs.hasOwnProperty(instanceObject.model) )
						delete arcadeHud.npcs[instanceObject.model];

					//var npcIndex = npcs.indexOf(instanceObject.model);
					//if( npcIndex >= 0 )
					//{
					//	npcs.splice(npcIndex.

						/*
						model = aaapi.cmdEx("getLibraryModel", instanceObject.model);
						if( !!model && !!model.platforms && !!model.platforms[arcadeHud.platformId] && !!model.platforms[arcadeHud.platformId].file )
						{
							var stuff = model.platforms[arcadeHud.platformId].file.toLowerCase();

							if( stuff.indexOf("models/cabinets") >= 0  || stuff.indexOf("models\\cabinets") >= 0 || stuff.indexOf("models/icons") >= 0 || stuff.indexOf("models\\icons") >= 0 )
								continue;

							console.log(instanceObject.item + ": " + model.title);
						}
						*/
					//}
				}

				for( var x in arcadeHud.npcs )
				{
					model = aaapi.cmdEx("getLibraryModel", x);
					if( !!model )
					{
						//console.log(model.title);
						arcadeHud.createTile(model, npcRemainerContainer, "models");
					}
				}

				if( Object.keys(arcadeHud.npcs).length === 0 )
				{
					npcRemainerContainer.style.cssText += " font-family: arial; font-size: 62px; font-weight: 900;"
					npcRemainerContainer.innerHTML = "VICTORY!  All NPC's have been placed!";
				}
			}

			function showAwards()
			{
				window.location = "awards.html" + "?uiback=" + encodeURIComponent("window.location='asset://ui/welcome.html';");
			}

			var stats = aaapi.cmdEx("getStats");
			var achievements = aaapi.cmdEx("getAchievements");

			var sortedAchievements = [];
			for( var achievementName in achievements )
				sortedAchievements.push(achievements[achievementName]);

			function sortAchievements(a, b)
			{
				if( a.achieved && !b.achieved )
					return 1;
				else if( b.achieved && !a.achieved )
					return -1;

				if( stats[a.stat].value > 0 && stats[b.stat].value <= 0 )
					return -1;
				else if( stats[a.stat].value <= 0 && stats[b.stat].value > 0 )
					return 1;

				var remainingA = a.statMax - stats[a.stat].value;
				var remainingB = b.statMax - stats[b.stat].value;
			
				if( remainingA > remainingB )
					return 1;
				else if( remainingA < remainingB )
					return -1;
				else
					return 0;
			}

			sortedAchievements.sort(sortAchievements);

			var awardsSlatesContainer = document.querySelector(".widgetPane[widgetId='awards']");
			var awardsDotsContainer = document.querySelector("#awardsDotsContainer");
			var achievement;
			var dot;
			var div, table, tr, tdImage, image, tdInfo, title, description, status, statusTitle, statusStatsContainer, statusStatCurrent, statusStatMax, viewLink, viewImage;
			for( var i = 0; i < sortedAchievements.length; i++ )
			{
				achievement = sortedAchievements[i];

				dot = document.createElement("div");
				if( i > 0 )
					dot.className = "widgetDot";
				else
					dot.className = "widgetDot widgetDotActive";
				dot.addEventListener("click", function(e){manualWidgetCycle(e.target);});

				awardsDotsContainer.appendChild(dot);

				// now create the slate too
				div = document.createElement("div");
				if( i > 0 )
					div.className = "awardsSlate";
				else
					div.className = "awardsSlate activeAwardsSlate";

				table = document.createElement("table");
				div.appendChild(table);
				table.style.cssText = "width: 100%; height: 100%;";
				table.cellSpacing = "0";
				table.cellPadding = "0";

				tr = document.createElement("tr");
				table.appendChild(tr);

				tdImage = document.createElement("td");
				tr.appendChild(tdImage);
				tdImage.align = "center";
				tdImage.width = "1";

				image = document.createElement("img");
				tdImage.appendChild(image);
				if( !achievement.achieved )
					image.src = "awards/" + achievement.name + "_off.jpg";
				else
					image.src = "awards/" + achievement.name + ".jpg";
				image.className = "bigAwardImage";

				tdInfo = document.createElement("td");
				tr.appendChild(tdInfo);
				tdInfo.style.cssText = "padding: 8px;";

				title = document.createElement("div");
				tdInfo.appendChild(title);
				title.style.cssText = "font-weight: 900; font-size: 18px;";
				title.innerHTML = achievement.displayName;

				description = document.createElement("div");
				tdInfo.appendChild(description);
				description.style.cssText = "font-weight: bold; font-size: 12px;";
				description.innerHTML = achievement.description;

				statusDiv = document.createElement("div");
				tdInfo.appendChild(statusDiv);
				statusDiv.style.cssText = "font-weight: bold; font-family: monospace; font-size: 12px; margin-top: 8px;";

				statusTitle = document.createElement("div");
				statusDiv.appendChild(statusTitle);
				statusTitle.style.cssText = "display: inline;";
				statusTitle.innerHTML = (!achievement.achieved) ? "IN-PROGRESS" : "ACHIEVED";

				statusStatsContainer = document.createElement("div");
				statusDiv.appendChild(statusStatsContainer);
				statusStatsContainer.style.cssText = "font-weight: bold; font-size: 12px; display: inline; margin-left: 8px;";

				if( !achievement.achieved )
				{
					statusStatCurrent = document.createElement("div");
					statusDiv.appendChild(statusStatCurrent);
					statusStatCurrent.style.cssText = "display: inline;";
					statusStatCurrent.innerHTML = stats[achievement.stat].value;

					statusDiv.appendChild(document.createTextNode("/"));

					statusStatMax = document.createElement("div");
					statusDiv.appendChild(statusStatMax);
					statusStatMax.style.cssText = "display: inline;";
					statusStatMax.innerHTML = achievement.statMax;
				}
				else
				{
					var date = new Date(0);
					date.setUTCSeconds(achievement.unlockTime);
					statusDiv.appendChild(document.createTextNode(date.toDateString()));
				}

				viewLink = document.createElement("div");
				tdInfo.appendChild(viewLink);
				viewLink.style.cssText = "font-size: 18px; display: inline-block;";
				viewLink.className = "viewInfoLink";
				viewLink.addEventListener("click", function(){showAwards();});

				viewImage = document.createElement("img");
				viewLink.appendChild(viewImage);
				viewImage.style.cssText = "padding: 2px;";
				viewImage.src = "infoicon.png";

				awardsSlatesContainer.appendChild(div);
			}

//aaapi.cmd("requestActivateInputMode");
			setTimeout(function()
			{
				var loadingThing = document.querySelector("#loadingThing");
				loadingThing.parentNode.removeChild(loadingThing);
				document.querySelector("#frontPage").style.display = "block";
				document.querySelector("#invisolayer").style.display = "table";
		//window.location = "de_haunts8/index.html";
			}, 100);
		</script>
<!--img src="sm_primo2/front.jpg" style="-webkit-transform: rotateY(60deg);" /-->

		<!--input type="button" style="position: absolute; top: 30px;
		left: 30px; border" onclick="showAwards();" value="Tester Link" /-->
	</body>
</html>