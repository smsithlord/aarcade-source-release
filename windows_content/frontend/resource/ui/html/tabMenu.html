<html>
	<head>
		<link rel="stylesheet" type="text/css" href="asset://ui/hud.css"></link>
		<script src="asset://ui/hud.js"></script>	
		<script src="asset://ui/tga.js"></script>	
		<script src="asset://ui/dragscroll.js"></script><!-- https://github.com/asvd/dragscroll -->
		<style>
			.questHiddenCategoryState
			{
				display: inline;
			}

			.loadingIndicator
			{
				width: 50px;
				height: 50px;
				border-width: 10px;
				border-radius: 50%;
				border-style: dashed;
				-webkit-animation: spin 4s infinite linear;
			}

			@-webkit-keyframes spin
			{
				0%  {-webkit-transform: rotate(0deg);}
				100% {-webkit-transform: rotate(360deg);}   
			}

			.transferCount
			{
				display: inline;
			}

			.transferUploadCount
			{
				display: inline;
			}

			.aaDownArrow
			{
				width: 0; 
				height: 0; 
				border-left: 12px solid transparent;
				border-right: 12px solid transparent;

				border-top-style: solid;
				border-top-width: 12px;/* solid #555;*/
			}


			.tabTitle
			{
				display: none;
				font-family: Arial;
				display: none;
				vertical-align: bottom;
				text-transform: lowercase;
				letter-spacing: 0.2em;
				margin-left: 8px;
			}

			.activeTabTitle
			{
				display: inline-block !important;
			}

			.textureThumb
			{
				width: 128px;
				height: 128px;
				overflow: hidden;
				/*background-image: url('noimageicon.png');*/
				background-size: auto 100%;
				background-repeat: no-repeat;
				background-position: center center;
			}

			.textureThumbName
			{
				width: 144px;
				overflow: hidden;
				text-overflow: ellipsis;
				text-align: center;
				font-family: Arial;
				font-size: 18px;
				padding-top: 2px;
				padding-bottom: 2px;
			}

			.textureButtonsContainer
			{
				position: relative;
				display: none;
			}

			.textureContainer
			{
				display: inline-block;
			}

			.textureContainer:hover .textureButtonsContainer
			{
				display: block;
			}

			.textureButton
			{
				display: none;
			}

			.textureNeedsThumb .createThumb /* .textureHasPreset .textureNeedsThumb .createThumb */
			{
				display: inline-block;
			}

			.addPreset
			{
				display: inline-block;
			}

			.textureHasPreset .addPreset
			{
				display: none;
			}

			.textureHasPreset .removePreset
			{
				display: inline-block;
			}

			.textureButton img
			{
				width: 24px;
			}

			.transborder
			{
				border-color: transparent;
			}

			.abslotClearButton
			{
				letter-spacing: 0.1em;
				margin-top: 4px;
				padding: 4px;
				border-radius: 4px;
				border-style: solid;
				border-width: 2px;
				text-align: center;
				font-family: Arial;
				cursor: pointer;
				display: block;
				opacity: 0;
			}

			.abslot
			{
				letter-spacing: 0.1em;
				padding: 10px;
				padding-left: 0;
				padding-right: 0;
				border-radius: 4px;
				border-style: solid;
				border-width: 2px;
				display: inline-block;
			}

			.abslotContainer:hover > .abslotClearButton
			{
				opacity: 1.0;
			}

			.abslotClearButtonLabel
			{
				opacity: 0;
			}

			.abslotClearButton:hover > .abslotClearButtonLabel
			{
				opacity: 1.0;
			}

			.questCategoryTitle
			{
				font-size: 14px;
				font-weight: bold;
				font-family: Arial;
			}
		</style>
	</head>
	<body style="display: none;">

		<div id="fetchingStuff" style="display: none; font-family: Arial; font-weight: 900;" class="aaTextColorTwoColor aaTextSizeFontSize">
			<center>
				<div class="loadingIndicator aaThemeColorOneBorderColor"></div>
				<br />
				PLEASE WAIT
			</center>
		</div>

		<script>
			var tga = new TGA();
			//imageTilesOnly = true;
			imageTilesOnly = (localStorage.getItem("imageTilesOnly") == "1");

			//console.log(JSON.stringify(arcadeHud.favoritesLists));
			var zoomSlider;

			var gridViewOption = localStorage.getItem("gridViewOption");
			if( !!gridViewOption )
				gridViewOption = (gridViewOption == "1");
			else
				gridViewOption = false;

			var g_screenshotDetectedinterval;
			var g_oldScreenshotId;
			function getFreshScreenshot()
			{
				var currentScreenshots = aaapi.cmdEx("getAllMapScreenshots", "id" + worldInfo.map.info.id);

				var goodCurrentScreenshots = [];
				var currentScreenshot;
				var currentScreenshotKeys = Object.keys(currentScreenshots);
				for( var i = 0; i < currentScreenshotKeys.length; i++ )
				{
					currentScreenshot = currentScreenshots[currentScreenshotKeys[i]];

					if( currentScreenshot.instance.id == "id" + worldInfo.instance.id )
						goodCurrentScreenshots.push(currentScreenshot);
				}

				// most recent screenshots on top
				goodCurrentScreenshots.sort(function(a, b)
				{
					var aCreated = parseInt(a.created);
					var bCreated = parseInt(b.created);
					if( aCreated > bCreated )
						return -1;
					else if( aCreated < bCreated )
						return 1;
					else
						return 0;
				});

				var freshCurrentScreenshot = goodCurrentScreenshots[0];
				return freshCurrentScreenshot;
			}

			var fresh = arcadeHud.getParameterByName("fresh");	// means a screenshot just got taken.
			fresh = (!!fresh && fresh == "1");

			var uiBack = arcadeHud.getParameterByName("uiback");
			var givenTabId = arcadeHud.getParameterByName("tab");
			var originalGivenTabId = givenTabId;
			if( !!!givenTabId )
				givenTabId = sessionStorage.getItem("aaMainTab");//'tasks';

			var connectedUniverse = aaapi.cmdEx("getConnectedSession");

			if( !!!connectedUniverse && (givenTabId == "players" || givenTabId == "panos") )
				givenTabId = "";

		 	var g_userBans = localStorage.getItem("userBans");
		 	if( !!g_userBans )
		 		g_userBans = JSON.parse(g_userBans);
		 	else
		 		g_userBans = {};

			// https://stackoverflow.com/questions/2998784/how-to-output-integers-with-leading-zeros-in-javascript
			function pad(num)
			{
				var size = 4;
				var goodNum = "000" + num;
				return goodNum.substr(goodNum.length-size);
			}

			var panoInfos = [];
			var panoIndex = pad(0);
			var cachedPanoName = "cachedPano" + panoIndex;
			while( localStorage[cachedPanoName] !== undefined )
			{
				panoInfos.push(JSON.parse(localStorage.getItem(cachedPanoName)));
				
				panoIndex = pad(parseInt(panoIndex) + 1);
				cachedPanoName = "cachedPano" + panoIndex;
			}

			var worldInfo = aaapi.cmdEx("getWorldInfo");
			var screenshots = aaapi.cmdEx("getAllMapScreenshots", "id" + worldInfo.map.info.id);

			var goodScreenshots = [];
			var screenshot;
			var screenshotKeys = Object.keys(screenshots);
			for( var i = 0; i < screenshotKeys.length; i++ )
			{
				screenshot = screenshots[screenshotKeys[i]];

				if( screenshot.instance.id == "id" + worldInfo.instance.id )
					goodScreenshots.push(screenshot);
			}

			// most recent screenshots on top
			goodScreenshots.sort(function(a, b)
			{
				var aCreated = parseInt(a.created);
				var bCreated = parseInt(b.created);
				if( aCreated > bCreated )
					return -1;
				else if( aCreated < bCreated )
					return 1;
				else
					return 0;
			});

			if( fresh )
			{
				var freshScreenshot = goodScreenshots[0];

				// update our spawn location (but not our map last loaded timestamp) in mapHistory
				var mapHistory = (localStorage.getItem("mapHistory")) ? JSON.parse(localStorage.getItem("mapHistory")) : {};
//console.log(JSON.stringify(freshScreenshot));
				// update our entry in the mapHistory
				var mapHistoryEntry = mapHistory[worldInfo.map.info.id];
				if( !!mapHistoryEntry )
				{
					mapHistoryEntry.position = freshScreenshot.body.position;
					mapHistoryEntry.rotation = freshScreenshot.body.rotation;
					mapHistoryEntry.screenshotId = freshScreenshot.id;
					mapHistoryEntry.instanceId = freshScreenshot.instance.id.substring(2);

					// save the mapHistory out
					localStorage.setItem("mapHistory", JSON.stringify(mapHistory));
				}
			}
		</script>
		
		<div style="pointer-events: none; position: absolute; left: 0; top: 0; right: 0; bottom: 0;">
		<table style="width: 100%; height: 100%;">
		<tr ><td valign="middle" align="center">
		<div style="display: inline-block; padding-bottom: 8px;">

		<script>
			document.addEventListener("keyup", function(e)
			{
				if( e.keyCode === 9 )
				{
					window.location = "asset://ui/welcome.html";
				}
			}, false);

			var uiClose = (givenTabId && givenTabId !== "tasks") ? "aaapi.cmd('deactivateInputMode');" : "";
			//var windowHeaderHTML = arcadeHud.generateWindowHeaderHTML("Tab Menu", "", true, true, uiBack, uiClose);
			//document.write(windowHeaderHTML);
		</script>

		<div id="dummyMarker"></div>

		<center>
			<table style="width: 100%;">
				<tr>
					<td valign="top" id="extraPanel" style="max-width: 1740px;">
						<div style="height: 100%; width: 100%; min-width: 300px; display: inline-block;">
						<script>
							var extraPanel = document.querySelector("#extraPanel");

							var extraPanelVal = sessionStorage.getItem("extraPanel");
							if( givenTabId )
								extraPanelVal = "block";
							if( !!extraPanelVal && extraPanelVal !== "" )
								extraPanel.style.display = extraPanelVal;

							// prefer a tab ID given in the URL
							var tabId = givenTabId;

							// otherwise, use session storage
							if( !!!tabId )
								tabId = sessionStorage.getItem("aaMainTab");//, tabId);

							// otherwise, let arcadeHud decide
							if( !!!tabId )
								tabId = "";

							if( !!!connectedUniverse && (tabId == "players" || tabId == "panos") )
								tabId = "";

							var launchIconHTML = arcadeHud.generateIconHTML("taskicon.png", 32, 32, "aaTextColorTwoColor");
							var libraryIconHTML = arcadeHud.generateIconHTML("libraryicon.png", 32, 32, "aaTextColorTwoColor");
							var photoIconHTML = arcadeHud.generateIconHTML("photoicon.png", 32, 32, "aaTextColorTwoColor");
							var commandsIconHTML = arcadeHud.generateIconHTML("commandsicon.png", 32, 32, "aaTextColorTwoColor");
							var mpiconIconHTML = arcadeHud.generateIconHTML("mpicon.png", 32, 32, "aaTextColorTwoColor");
							var paintIconHTML = arcadeHud.generateIconHTML("painticon.png", 32, 32, "aaTextColorTwoColor");
							var questsIconHTML = arcadeHud.generateIconHTML("questsicon.png", 32, 32, "aaTextColorTwoColor");
							var transfersIconHTML = arcadeHud.generateIconHTML("switchicon.png", 32, 32, "aaTextColorTwoColor");

							var windowTabsHeaderHTML = arcadeHud.generateWindowTabsHeaderHTML({
								"styleText": 'width: 100%; height: 100%;',
								"tabAlign": 'center',
								"bottomMode": true,
								"tabs": [
									{
										"id": "tasks",
										"title": launchIconHTML + "<div class='tabTitle aaTextColorTwoColor' tabname='tasks'>Tasks</div> <div id='taskCount' class='tabTitle aaTextColorTwoColor'  style='display: inline;'>0</div>",
										"help": "Tasks"// "Tasks (<div id='taskCount' style='display: inline;'>0</div>)"
									},
									{
										"id": "screenshots",
										"title": photoIconHTML + "<div class='tabTitle aaTextColorTwoColor' tabname='screenshots'>Camera</div> <div id='screenshotCount' class='tabTitle aaTextColorTwoColor' style='display: inline;'>0</div>",//"<div style='display: none;'>(<div id='screenshotCount' style='display: inline;'>0</div>)</div>",
										//"class": "aaOnlyIfHost",
										"help": "Screenshots"
									},
									/*{
										"id": "panos",
										"title": "Panoramas (<div id='panoCount' style='display: inline;'>0</div>)",
										"class": "aaOnlyIfHost"
									},*/
									{
										"id": "backpack",
										"title": libraryIconHTML + "<div class='tabTitle aaTextColorTwoColor' tabname='backpack'>Library</div>",
										"help": "Library"//"<div style='display: none;'> (<div id='backpackCount' style='display: inline;'>0</div>)</div>"//,
										//"class": "aaOnlyIfHost"
									},
									{
										"id": "commands",
										"title": commandsIconHTML + "<div class='tabTitle aaTextColorTwoColor' tabname='commands'>Commands</div>",
										"help": "Commands"//" + "<div style='display: none;'>(<div id='commandCount' style='display: inline;'>0</div>)</div>"
									},
									{
										"id": "players",
										"title": mpiconIconHTML + "<div class='tabTitle aaTextColorTwoColor' tabname='players'>(<div id='playerCount' style='display: inline;'>0</div>)</div>",
										"help": "Players"
									},
									{
										"id": "paint",
										"title": paintIconHTML + "<div class='tabTitle aaTextColorTwoColor' tabname='paint'>Paint</div>",
										"help": "Paint"
									},
									{
										"id": "quests",
										"title": questsIconHTML + "<div class='tabTitle aaTextColorTwoColor' tabname='quests'>Quests</div>",
										"help": "Quests"
									},
									{
										"id": "transfers",
										"title": transfersIconHTML + "<div class='tabTitle aaTextColorTwoColor' tabname='transfers'>Transfers</div>",
										"help": "Transfers"
									}
								],
								"activeTabId": tabId,
								"onChangeCallbackName": "onChangeCallback"
							});
							document.write(windowTabsHeaderHTML);

							var backpackReady = false;
							var paintReady = false;
							var questsReady = false;
							var transfersReady = false;
							function onChangeCallback(tabId)
							{
								// clear the old active tab title
								var activeTabTitle = document.querySelector('.activeTabTitle');
								if(!!activeTabTitle)
									activeTabTitle.classList.remove('activeTabTitle');

								// and create the new one, if found
								activeTabTitle = document.querySelector('.tabTitle[tabname="' + tabId + '"]');
								if( !!activeTabTitle )
								{
									activeTabTitle.classList.add('activeTabTitle');
								}

								sessionStorage.setItem("aaMainTab", tabId);
								if( tabId === "backpack" && !backpackReady )
								{
									backpackReady = true;

									var entityIndex = arcadeHud.getParameterByName('entity');
									// what library panel mode are we in?
									if( entityIndex === null )	// favorites
									{
										activatePanel('results');

										if(libSearchInput.value != '' || typeSelect.value != '')
											doSearch(libSearchInput.value);
										else
											showList(arcadeHud.activeFavoritesList);
									}
									else
									{
										activatePanel('objectInspect');
										inspectEntity(entityIndex);
									}
								}
								else if( tabId === "paint" && !paintReady )
								{
									paintReady = true;
									prepPaintMenu();
								}
								else if( tabId === "quests" && !questsReady )
								{
									questsReady = true;
									prepQuestsMenu();
								}
								else if( tabId === "transfers" && !transfersReady )
								{
									transfersReady = true;
									prepTransfersMenu();
								}
							}

							// panels are all related to the Library tab.
							function activatePanel(panelName)
							{
								var panel = document.querySelector('.panel[panel=' + panelName + ']');
								var panelActive = document.querySelector('.panelActive');
								if( !!panelActive )
									panelActive.classList.remove('panelActive');
								panel.classList.add('panelActive');

								//objectInspectLoading.style.display = 'none';
							}

							function inspectEntity(entityIndex)
							{
								var entityInfo;
								if( entityIndex !== -1 )
									entityInfo = aaapi.cmdEx("getEntityInfo", parseInt(entityIndex));

								//if( !!entityInfo )
								//	console.log(JSON.stringify(entityInfo));

								//console.log(entityIndex);
								var entry;
								if( !!!entityInfo.item )
								{
									entry = aaapi.cmdEx("getLibraryModel", entityInfo.model.id);
									var onlyIfItemElems = document.querySelectorAll(".onlyIfItem");
									for( var i = 0; i < onlyIfItemElems.length; i++ )
										onlyIfItemElems[i].style.display = "none";

									var onlyIfModelElems = document.querySelectorAll(".onlyIfModel");
									for( var i = 0; i < onlyIfModelElems.length; i++ )
										onlyIfModelElems[i].style.display = "block";
								}
								else
								{
									entry = aaapi.cmdEx("getLibraryItem", entityInfo.item.id);
									var onlyIfModelElems = document.querySelectorAll(".onlyIfModel");
									for( var i = 0; i < onlyIfModelElems.length; i++ )
										onlyIfModelElems[i].style.display = "none";

									/*if(entityInfo.object.slave == 1)
										document.querySelector("#mirrorButton").style.display = "none";
									else
										document.querySelector("#unmirrorButton").style.display = "none";*/
								}

								var image = document.createElement('img');
								image.style.cssText = 'max-width: 1900px; max-height:  800px; margin-left: auto; margin-right: auto; display: block;';
								arcadeHud.loadItemBestImage(image, entry, function()
								{
									var panel = document.querySelector('.panel[panel=objectInspect]');
									panel.appendChild(image);
									objectInspectLoading.style.display = 'none';
								});
								//console.log(JSON.stringify(entry));
							}

							function inspectObject(objectId)
							{
								console.log(objectId);
							}


							var aaModalMenu;
							//var aaModalFlashInterval;
							function createModalConfirm(title, text, noAction, yesAction)
							{
								if( !!aaModalMenu )
								{
									console.log("ERROR: A modal menu is already being displayed!");
									return;
								}

								// Lets be modal.
								var modalContainer = document.createElement("div");
								modalContainer.style.cssText = "position: fixed; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);";
								modalContainer.addEventListener("click", function(e)
								{
									/*
									var isChild = false;
									var childNode = e.target;
									while(!!childNode)
									{
										childNode = childNode.parentNode;
										if( childNode === e.currentTarget )
										{
											isChild = true;
											break;
										}
									}
									*/

									if( e.currentTarget !== e.target )
									{
										// the modal window itself is clicked
										/*
										if( !isChild )
										{
											console.log("propo stopped");
											e.preventDefault();
											e.stopImmediatePropagation();//Immediate
										}
										*/
										return;
									}
									else
									{
										if( !!!aaModalMenu.flashInterval )
										{
											aaModalMenu.flashInterval = setInterval(function()
											{
												var titleRow = this.querySelector("tr");
												var titleBarElems = titleRow.querySelectorAll("td");
												var titleBarElem;

												if( !!!this.flashCount )
												{
													for( var i = 0; i < titleBarElems.length; i++ )
													{
														titleBarElem = titleBarElems[i];
														if( titleBarElem.classList.contains("aaThemeColorOneHighBackgroundColor") )
														{
															titleBarElem.classList.remove("aaThemeColorOneHighBackgroundColor");
															titleBarElem.classList.add("aaThemeColorOneBackgroundColor");
														}
													}

													clearInterval(this.flashInterval);
													delete this.flashInterval;
												}
												else
												{
													for( var i = 0; i < titleBarElems.length; i++ )
													{
														titleBarElem = titleBarElems[i];
														if( titleBarElem.classList.contains("aaThemeColorOneHighBackgroundColor") )
														{
															titleBarElem.classList.remove("aaThemeColorOneHighBackgroundColor");
															titleBarElem.classList.add("aaThemeColorOneBackgroundColor");
														}
														else if(titleBarElem.classList.contains("aaThemeColorOneBackgroundColor"))
														{
															titleBarElem.classList.remove("aaThemeColorOneBackgroundColor");
															titleBarElem.classList.add("aaThemeColorOneHighBackgroundColor");
														}
													}

													this.flashCount--;
												}
											}.bind(aaModalMenu), 100);

											aaModalMenu.flashCount = 6;
										}
									}
								}.bind(modalContainer), true);

								var modalHTML = "";

								// header
								var modalYPos = (window.innerHeight / 3) + "px";
								var modalWindowHeaderHTML = arcadeHud.generateWindowHeaderHTML(title, "margin-left: auto; margin-right: auto; top: " + modalYPos + ";", true, true, "", "");
								modalHTML += modalWindowHeaderHTML;

								// body
								modalHTML += '<div class="aaWindowPaneContent aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor aaTitleTextSizeFontSize aaTextColorTwoColor">';
								modalHTML += text;//"Are you sure?";
								modalHTML += "</div>";

								modalHTML += '\
									<table class="aaWindowActions">\
										<tr>\
											<td>\
											</td>\
											<td style="width: 1%; white-space: nowrap;">\
												<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" value="Yes" />\
												<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" value="No" />\
											</td>\
										</tr>\
									</table>\
								';

								// footer
								var modalWindowFooterHTML = arcadeHud.generateWindowFooterHTML();
								modalHTML += modalWindowFooterHTML;

								modalContainer.innerHTML = modalHTML;
								aaModalMenu = modalContainer.querySelector(".aaWindow");
								document.body.appendChild(modalContainer);

								var buttons = modalContainer.querySelectorAll(".aaWindowActions input[type='button']");
								buttons[0].addEventListener("click", function(e)
								{
									aaModalMenu.parentNode.parentNode.removeChild(aaModalMenu.parentNode);
									aaModalMenu = undefined;

									eval(yesAction);
								}, true);

								buttons[1].addEventListener("click", function(e)
								{
									aaModalMenu.parentNode.parentNode.removeChild(aaModalMenu.parentNode);
									aaModalMenu = undefined;

									eval(noAction);
								}, true);
							}

							function confirmedDeleteScreenshot(shotId)
							{
								aaapi.cmd("deleteScreenshot", shotId.toLowerCase());
								window.location='asset://ui/tabMenu.html?tab=screenshots';
							}

							function canceledDeleteScreenshot()
							{
							}

							function createModalScreenshotConfirm(title, text, noAction, yesAction)
							{
								if( !!aaModalMenu )
								{
									console.log("ERROR: A modal menu is already being displayed!");
									return;
								}

								// Lets be modal.
								var modalContainer = document.createElement("div");
								modalContainer.style.cssText = "position: fixed; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 999999;";
								modalContainer.addEventListener("click", function(e)
								{
									/*
									var isChild = false;
									var childNode = e.target;
									while(!!childNode)
									{
										childNode = childNode.parentNode;
										if( childNode === e.currentTarget )
										{
											isChild = true;
											break;
										}
									}
									*/

									if( e.currentTarget !== e.target )
									{
										// the modal window itself is clicked
										/*
										if( !isChild )
										{
											console.log("propo stopped");
											e.preventDefault();
											e.stopImmediatePropagation();//Immediate
										}
										*/
										return;
									}
									else
									{
										if( !!!aaModalMenu.flashInterval )
										{
											aaModalMenu.flashInterval = setInterval(function()
											{
												var titleRow = this.querySelector("tr");
												var titleBarElems = titleRow.querySelectorAll("td");
												var titleBarElem;

												if( !!!this.flashCount )
												{
													for( var i = 0; i < titleBarElems.length; i++ )
													{
														titleBarElem = titleBarElems[i];
														if( titleBarElem.classList.contains("aaThemeColorOneHighBackgroundColor") )
														{
															titleBarElem.classList.remove("aaThemeColorOneHighBackgroundColor");
															titleBarElem.classList.add("aaThemeColorOneBackgroundColor");
														}
													}

													clearInterval(this.flashInterval);
													delete this.flashInterval;
												}
												else
												{
													for( var i = 0; i < titleBarElems.length; i++ )
													{
														titleBarElem = titleBarElems[i];
														if( titleBarElem.classList.contains("aaThemeColorOneHighBackgroundColor") )
														{
															titleBarElem.classList.remove("aaThemeColorOneHighBackgroundColor");
															titleBarElem.classList.add("aaThemeColorOneBackgroundColor");
														}
														else if(titleBarElem.classList.contains("aaThemeColorOneBackgroundColor"))
														{
															titleBarElem.classList.remove("aaThemeColorOneBackgroundColor");
															titleBarElem.classList.add("aaThemeColorOneHighBackgroundColor");
														}
													}

													this.flashCount--;
												}
											}.bind(aaModalMenu), 100);

											aaModalMenu.flashCount = 6;
										}
									}
								}.bind(modalContainer), true);

								var modalHTML = "";

								// header
								var modalYPos = (window.innerHeight / 3) + "px";
								var modalWindowHeaderHTML = arcadeHud.generateWindowHeaderHTML(title, "margin-left: auto; margin-right: auto; top: " + modalYPos + ";", true, true, "", "");
								modalHTML += modalWindowHeaderHTML;

								// body
								modalHTML += '<center><div id="modalScreenshotContent">';//'<div class="aaWindowPaneContent aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor aaTitleTextSizeFontSize aaTextColorTwoColor">';
								//modalHTML += text;//"Are you sure?";
								modalHTML += "</div></center>";
/*
								modalHTML += '\
									<table class="aaWindowActions">\
										<tr>\
											<td>\
											</td>\
											<td style="width: 1%; white-space: nowrap;">\
												<div class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="width: 100px; height: 100px;" />REGULAR</div>\
												<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" value="No" />\
											</td>\
										</tr>\
									</table>\
								';
*/
								// footer
								var modalWindowFooterHTML = arcadeHud.generateWindowFooterHTML();
								modalHTML += modalWindowFooterHTML;

								modalContainer.innerHTML = modalHTML;
								aaModalMenu = modalContainer.querySelector(".aaWindow");
								document.body.appendChild(modalContainer);

								var screenshotContent = document.querySelector("#modalScreenshotContent");

								var regularButton = document.createElement("div");
								regularButton.className = "aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor";
								regularButton.style.cssText = "display: inline-block; margin: 10px; font-size: 14px; font-weight: bold;";

								var screenshotIconSize = "128px";//arcadeHud.themeSizes.IconSize;
								var screenshotHTML = arcadeHud.generateIconHTML("ezregular.png", screenshotIconSize, screenshotIconSize, "aaTextColorOneColor");
								regularButton.innerHTML = screenshotHTML + "<br />REGULAR<br /><br />";
								regularButton.addEventListener("click", function(e)
								{
									aaModalMenu.parentNode.parentNode.removeChild(aaModalMenu.parentNode);
									aaModalMenu = undefined;

									aaapi.cmd("takeScreenshot", true);
									window.location='asset://ui/tabMenu.html?tab=screenshots&fresh=1';
								}, true);
								screenshotContent.appendChild(regularButton);




								/*var cardButton = document.createElement("div");
								cardButton.className = "aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor";
								cardButton.style.cssText = "display: inline-block; margin: 10px; font-size: 14px; font-weight: bold;";

								var screenshotIconSize = "128px";//arcadeHud.themeSizes.IconSize;
								var screenshotHTML = arcadeHud.generateIconHTML("ezregular.png", screenshotIconSize, screenshotIconSize, "aaTextColorOneColor");
								cardButton.innerHTML = screenshotHTML + "<br />CARD<br /><br />";
								cardButton.addEventListener("click", function(e)
								{
									window.location = "cardMaker.html";
								}, true);
								screenshotContent.appendChild(cardButton);*/



///*
								var interactiveButton = document.createElement("div");
								interactiveButton.className = "aaButton aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor";
								interactiveButton.style.cssText = "display: inline-block; margin: 10px; font-size: 14px; font-weight: bold;";
								screenshotHTML = arcadeHud.generateIconHTML("ezinteractive.png", screenshotIconSize, screenshotIconSize, "aaTextColorOneColor");
								interactiveButton.innerHTML = screenshotHTML + "<br />INTERACTIVE<br /><br />";
								interactiveButton.addEventListener("click", function(e)
								{
									screenshotContent.innerHTML = "";
									screenshotContent.appendChild(fetchingStuff);
									fetchingStuff.style.display = "block";
									//document.body.style.pointerEvents = "none";

									//aaModalMenu.parentNode.parentNode.removeChild(aaModalMenu.parentNode);
									//aaModalMenu = undefined;

									var g_oldScreenshotId = getFreshScreenshot();
									if( !!g_oldScreenshotId && !!g_oldScreenshotId.id )
										g_oldScreenshotId = g_oldScreenshotId.id;
									else
										g_oldScreenshotId = "";

									aaapi.cmd("takeScreenshot", true, "", true);
									//window.location='asset://ui/tabMenu.html?tab=screenshots&fresh=1';

									// set an interval until we do get a new screenshot
									g_screenshotDetectedinterval = setInterval(function()
									{
										var freshScreenshot = getFreshScreenshot();

										if( freshScreenshot.id != g_oldScreenshotId )
										{
											clearInterval(g_screenshotDetectedinterval);
											g_screenshotDetectedinterval = null;

											window.location='arcadesnap.html?id=' + freshScreenshot.id;
										}
									}, 1000);
								}, true);
								screenshotContent.appendChild(interactiveButton);

								var panoramaButton = document.createElement("div");
								panoramaButton.className = "aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor";
								panoramaButton.style.cssText = "display: inline-block; margin: 10px; font-size: 14px; font-weight: bold;";
								screenshotHTML = arcadeHud.generateIconHTML("ez360.png", screenshotIconSize, screenshotIconSize, "aaTextColorOneColor");
								panoramaButton.innerHTML = screenshotHTML + "<br />PANORAMA<br /><br />";
								panoramaButton.addEventListener("click", function(e)
								{
									screenshotContent.innerHTML = "";
									screenshotContent.appendChild(fetchingStuff);
									fetchingStuff.style.display = "block";
									//document.body.style.pointerEvents = "none";

									//aaModalMenu.parentNode.parentNode.removeChild(aaModalMenu.parentNode);
									//aaModalMenu = undefined;

									var g_oldScreenshotId = getFreshScreenshot();
									if( !!g_oldScreenshotId && !!g_oldScreenshotId.id )
										g_oldScreenshotId = g_oldScreenshotId.id;
									else
										g_oldScreenshotId = "";

									aaapi.cmd("takeScreenshot", true, "", true);
									//window.location='asset://ui/tabMenu.html?tab=screenshots&fresh=1';

									// set an interval until we do get a new screenshot
									g_screenshotDetectedinterval = setInterval(function()
									{
										var freshScreenshot = getFreshScreenshot();

										if( freshScreenshot.id != g_oldScreenshotId )
										{
											clearTimeout(g_screenshotDetectedinterval);
											g_screenshotDetectedinterval = null;

											window.location='arcadesnap.html?isPanoShot=1&panoId=none&id=' + freshScreenshot.id + "&mainId=" + freshScreenshot.id;
										}
									}, 1000);
								}, true);
								screenshotContent.appendChild(panoramaButton);
//*/

/*
								var panoramaButton = document.createElement("div");
								panoramaButton.className = "aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor";
								panoramaButton.style.cssText = "display: inline-block; margin: 10px; font-size: 14px; font-weight: bold;";
								screenshotHTML = arcadeHud.generateIconHTML("ez360.png", screenshotIconSize, screenshotIconSize, "aaTextColorOneColor");
								panoramaButton.innerHTML = screenshotHTML + "<br />PANORAMA<br /><br />";
								screenshotContent.appendChild(panoramaButton);
*/
								var cancelButton = document.createElement("div");
								cancelButton.className = "aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor";
								cancelButton.style.cssText = "display: block; margin: 10px; font-weight: bold; padding: 10px;";
								cancelButton.innerHTML = "Cancel";
								cancelButton.addEventListener("click", function(e)
								{
									aaModalMenu.parentNode.parentNode.removeChild(aaModalMenu.parentNode);
									aaModalMenu = undefined;

									//eval(yesAction);
								}, true);
								screenshotContent.appendChild(cancelButton);
/*
								var buttons = modalContainer.querySelectorAll(".aaWindowActions input[type='button']");
								buttons[0].addEventListener("click", function(e)
								{
									aaModalMenu.parentNode.parentNode.removeChild(aaModalMenu.parentNode);
									aaModalMenu = undefined;

									eval(yesAction);
								}, true);

								buttons[1].addEventListener("click", function(e)
								{
									aaModalMenu.parentNode.parentNode.removeChild(aaModalMenu.parentNode);
									aaModalMenu = undefined;

									eval(noAction);
								}, true);*/
							}

							function confirmedCreateScreenshot(shotId)
							{
								aaapi.cmd("deleteScreenshot", shotId);
								window.location='asset://ui/tabMenu.html?tab=screenshots';
							}

							function canceledCreateScreenshot()
							{
							}
						</script>

						<!--
						<div class="aaTabContent aaTextSize aaTextColorTwoColor aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor" tabid="worlds" style="">
							<div class="aaThemeColorOneHoverShadedBackground aaThemeColorOneShadedBorderColor" style="border-style: solid; border-width: 2px; padding: 10px; border-radius: 6px; display: inline-block; box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);" onclick="window.location='asset://ui/play.html';">
								<div class="mapImage aaThemeColorOneInverseShadedBorderColor" style="width: 240px; height: 135px; border-width: 2px; border-style: solid; border-radius: 4px;"></div>
								<div class="mapTitle aaTitleText aaTitleTextSizeFontSize aaTextColorOneColor"></div>
							</div>
							<br /><br />
							<div id="worldsContainer" style="display: none;"></div>
						</div>
						-->


						<!--div style="position: relative; width: 100%; pointer-events: none;">
							<div style="position: absolute; text-align: right; width: 100%; padding: 8px; font-size: 30px; -webkit-transform: translateY(-100%);"><div class="aaHelpContainer" style="padding-right: 12px;"></div></div>
						</div-->

						<div class="aaTabContent aaTextSize aaTextColorTwoColor aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor" tabid="tasks">

							<div class="taskCategory aaThemeColorTwoHoverShadedBackground">
								<div class="taskButton" style="vertical-align: middle;">
									<img src="collapse.png" style="width: 20px;" onclick="toggleCategory(this, 'tasks');" id="toggleTasksButton" />
								</div>
								<div class="taskCategoryTitle">
									In-Game
								</div>
							</div>

							<div id="tasks" style="display: none;">
								<div id="noTasksOpen">No in-game tasks are running.</div>
							</div>

							<div class="taskCategory aaThemeColorTwoHoverShadedBackground">
								<div class="taskButton" style="vertical-align: middle;">
									<img src="collapse.png" style="width: 20px;" onclick="toggleCategory(this, 'windowsTasks');" id="toggleWindowsTasksButton" />
								</div>
								<div class="taskCategoryTitle">
									Windows
								</div>
							</div>

							<div id="windowsTasks" style="display: none;">
							</div>

							<div class="taskCategory aaThemeColorTwoHoverShadedBackground">
								<div class="taskButton" style="vertical-align: middle;">
									<img src="collapse.png" style="width: 20px;" onclick="toggleCategory(this, 'hiddenTasks');" id="toggleHiddenTasksButton" />
								</div>
								<div class="taskCategoryTitle">
									Hidden
								</div>
							</div>

							<div id="hiddenTasks" style="display: none;">
							</div>
						</div>

						<div class="aaTabContent aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor aaWindowPaneContentScrollable aaScrollBars" tabid="players" style="max-height: 650px; max-width: 1600px; display: none;">
							<div style="padding: 10px; font-family: Arial;" class="aaTextColorTwoColor aaTextSizeFontSize">
								




							<style>
								.playerCard /* followedPlayerCard */
								{
									display: inline-block;
									margin: 6px;
									vertical-align: top;
									/*min-height: 300px;*/
								}

								.playerContainer
								{
									padding: 10px;
									border-width: 2px;
									border-style: solid;
									width: 150px;
								}

								.playerAvatarContainer
								{
									border-width: 2px;
									border-style: solid;
								}

								.playerAvatarImage
								{
									width: 100%;
								}

								.playerDisplayNameContainer
								{
									border-width: 2px;
									border-style: solid;
									padding: 10px;
									margin-top: 10px;
								}

								.playerDisplayName
								{
									font-family: Arial;
									font-weight: bold;
									overflow: hidden;
								}

								.followedPlayerCard .playerContainer, .followedPlayerCard:hover .playerContainer
								{
									/*border-color: red !important;*/
									background: transparent;
								}

								.unfollowButton
								{
									display: none;
								}

								.followButton
								{
									display: block;
								}

								.playerActionButton
								{
									padding: 6px;
								}

								.followedPlayerCard .unfollowButton
								{
									display: block;
								}

								.followedPlayerCard .followButton
								{
									display: none;
								}

								.playerActionButtonsContainer
								{
									/*display: none;*/
									visibility: hidden;
									pointer-events: none;
								}

								.playerCard:hover .playerActionButtonsContainer
								{
									/*display: block;*/
									visibility: visible;
									pointer-events: all;
								}

								.bannedPlayersContainer
								{
									max-height: 150px;
									overflow: auto;
								}

								.bannedPlayerContainer
								{
									display: block;
									margin: 10px;
									padding: 10px;
									border-width: 2px;
									border-style: solid;
									border-radius: 8px;
									font-family: Arial;
								}

								.bannedPlayerDisplayNameContainer
								{
									display: block;
									padding: 4px;
									border-width: 2px;
									border-style: solid;
									border-radius: 4px;
								}

								.bannedPlayerDisplayName
								{
									visibility: hidden;
								}

								.bannedPlayerContainer:hover .bannedPlayerDisplayName
								{
									visibility: visible;
								}

								.bannedPlayerDate
								{
									display: block;
									padding: 4px;
								}

								.unbanButton
								{
									display: inline-block;
									padding: 4px;
								}

								.noBannedPlayers
								{
									text-align: center;
									font-family: Arial;
									padding: 20px;
								}

								.spMode
								{
									font-family: Arial;
									font-size: 20px;
									font-weight: 900;
									text-align: center;
									padding: 20px;
								}

								.modeIcon
								{
									height: 24px;
									margin: 6px;
									display: inline-block;
								}

								.modeIconContainer
								{
									cursor: pointer;
									display: inline-block;
									border-radius: 4px;
									vertical-align: middle;
									margin: 0;
									-webkit-filter: grayscale(100%);
								}

								.modeIconContainer:not(.modeIconContainerActive):not(:hover) 
								{
									background-color: transparent;
								}

								.modeIconContainerActive
								{
									-webkit-filter: none;
								}

								.modeIconContainer:hover
								{
									-webkit-filter: none;
								}
							</style>

							<center>
								<div class="playerCards aaOnlyIfUniverseConnected" style="white-space: nowrap;"></div>
							</center>
							<div class="aaOnlyIfUniverseConnected aaOnlyIfHost">
								<div style="margin-top: 20px;" class="aaTextSizeFontSize aaTextColorTwoColor" style="font-family: Arial;">Banned Players</div>
								<div class="noBannedPlayers">You have not banned any players.</div>
								<div class="bannedPlayersContainer aaScrollBars"></div>
							</div>
							<script>
								// populate player cards
								var playerCardsElem = document.querySelector(".playerCards");

							 	var allUsers = aaapi.cmdEx("getAllUsers");
							 	/*
							 	allUsers.push(allUsers[0]);
							 	allUsers.push(allUsers[0]);
							 	allUsers.push(allUsers[0]);
							 	allUsers.push(allUsers[0]);
							 	allUsers.push(allUsers[0]);
							 	allUsers.push(allUsers[0]);
							 	allUsers.push(allUsers[0]);
							 	allUsers.push(allUsers[0]);
							 	allUsers.push(allUsers[0]);
							 	allUsers.push(allUsers[0]);
							 	allUsers.push(allUsers[0]);
							 	allUsers.push(allUsers[0]);*/

							 	for( var i = 0; i < allUsers.length; i++ )
							 	{
							 		var playerCardElem = document.createElement("div");

							 		if( allUsers[i].followed == "0" )
							 			playerCardElem.className = "playerCard";
							 		else
							 			playerCardElem.className = "playerCard followedPlayerCard";
							 		playerCardElem.setAttribute("userId", allUsers[i].userId);

							 		var playerContainerElem = document.createElement("div");
							 		playerContainerElem.className = "playerContainer aaThemeColorOneHoverShadedBackground aaThemeColorOneShadedBorderColor";
							 		if( allUsers[i].local != "1" )
							 		{
							 			playerContainerElem.addEventListener("click", function(e)
							 			{
							 				followPlayer(this);
							 			}.bind(playerContainerElem), true);
							 		}
							 		else
							 		{
							 			/*
							 			var goodAvatarUrl = allUsers[i].avatarUrl;
							 			if( goodAvatarUrl === "" )
							 				goodAvatarUrl = "noavatar.jpg";

							 			document.querySelector("#ownerAvatar").src = goodAvatarUrl;

							 			var safeOwnerName = allUsers[i].displayName;//document.createTextNode(allUsers[i].displayName);
							 			if( safeOwnerName === "" )
							 				safeOwnerName = "Your Arse";

							 			document.querySelector("#bigHeader").setAttribute("help", "You, " + safeOwnerName + ", are the host of this server.");
							 			*/
			/*
							 			var ownerNameElems = document.querySelectorAll(".ownerName");
							 			for( var j = 0; j < ownerNameElems.length; j++ )
							 			{
							 				while( ownerNameElems[j].firstChild )
							 					ownerNameElems[j].removeChild(ownerNameElems[j].firstChild);

							 				var safeOwnerName = document.createTextNode(allUsers[i].displayName);
							 				if( safeOwnerName === "" )
							 					safeOwnerName = "Your Arse";

							 				ownerNameElems[j].appendChild(safeOwnerName);
							 			}*/
							 		}

							 		var playerAvatarContainerElem = document.createElement("div");
							 		playerAvatarContainerElem.className = "playerAvatarContainer aaThemeColorOneInverseShadedBorderColor";

							 		var playerAvatarImageElem = document.createElement("img");
							 		playerAvatarImageElem.className = "playerAvatarImage";
							 		var goodAvatarUrl = allUsers[i].avatarUrl;
							 		if( goodAvatarUrl === "" )
							 			goodAvatarUrl = "noavatar.jpg";
							 		playerAvatarImageElem.src = goodAvatarUrl;

							 		var playerDisplayNameContainerElem = document.createElement("div");
							 		playerDisplayNameContainerElem.className = "playerDisplayNameContainer aaThemeColorTwoShadedBackground aaThemeColorOneInverseShadedBorderColor";

							 		var playerDisplayNameElem = document.createElement("div");
							 		playerDisplayNameElem.className = "playerDisplayName";
							 		var goodName = allUsers[i].displayName;
							 		if( goodName === "" )
							 			goodName = "Human Player";
							 		var safeNameElem = document.createTextNode(goodName);

							 		var playerItemImageContainerElem;
							 		var playerItemImageElem;
							 		var playerItem = undefined;
							 		var playerItemId;
							 		var playerObjectId = allUsers[i].objectId;
							 		var playerObject;
							 		if( playerObjectId !== "" )
							 		{

							 			playerObject = aaapi.cmdEx("getObject", playerObjectId);

							 			playerItemId = playerObject.item;
							 			playerItem = aaapi.cmdEx("getLibraryItem", playerItemId);

							 			if( !!playerItem )
							 			{
									 		playerItemImageElem = document.createElement("img");
									 		//playerItemImageElem.src = item.screen;
									 		playerItemImageElem.style.cssText = "width: 100%; margin: auto;";
							 			}
							 		}

							 		var playerActionButtonsContainerElem = document.createElement("div");
							 		playerActionButtonsContainerElem.className = "playerActionButtonsContainer";

							 		var playerFollowButtonElem = document.createElement("div");
							 		playerFollowButtonElem.className = "playerActionButton followButton aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor";
							 		if( allUsers[i].local != "1" )
							 		{
							 			playerFollowButtonElem.addEventListener("click", function(e)
							 			{
							 				followPlayer(this);
							 			}.bind(playerFollowButtonElem), true);
							 		}
							 		else
							 			playerFollowButtonElem.style.display = "none";
							 		playerFollowButtonElem.innerHTML = "FOLLOW";

							 		var playerUnfollowButtonElem = document.createElement("div");
							 		playerUnfollowButtonElem.className = "playerActionButton unfollowButton aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor";
							 		if( allUsers[i].local != "1" )
							 		{
							 			playerUnfollowButtonElem.addEventListener("click", function(e)
							 			{
							 				followPlayer(this);
							 			}.bind(playerUnfollowButtonElem), true);
								 	}
							 		else
							 			playerUnfollowButtonElem.style.display = "none";
							 		playerUnfollowButtonElem.innerHTML = "UNFOLLOW";

							 		var playerRestrictButtonElem = document.createElement("div");
							 		playerRestrictButtonElem.className = "playerActionButton aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor";
							 		if( allUsers[i].local != "1" )
							 		{
							 			playerRestrictButtonElem.addEventListener("click", function(e)
							 			{
							 				restrictPlayer(this);
							 			}.bind(playerRestrictButtonElem), true);
							 		}
							 		//else
							 			playerRestrictButtonElem.style.display = "none";
							 		playerRestrictButtonElem.innerHTML = "RESTRICT";

							 		var playerBanButtonElem = document.createElement("div");
							 		playerBanButtonElem.className = "playerActionButton aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor aaOnlyIfHost";
							 		if( allUsers[i].local != "1" )
							 		{
							 			playerBanButtonElem.addEventListener("click", function(e)
							 			{
							 				banPlayer(this);
							 				setTimeout(function()
							 				{
							 					document.location.reload();
							 				}, 500);
							 			}.bind(playerBanButtonElem), true);
							 		}
							 		else
							 			playerBanButtonElem.style.display = "none";
							 		playerBanButtonElem.innerHTML = "BAN";

							 		// compose
							 		playerCardElem.appendChild(playerContainerElem);
							 		playerContainerElem.appendChild(playerAvatarContainerElem);
							 		playerAvatarContainerElem.appendChild(playerAvatarImageElem);
							 		playerContainerElem.appendChild(playerDisplayNameContainerElem);
							 		playerDisplayNameContainerElem.appendChild(playerDisplayNameElem);
							 		playerDisplayNameElem.appendChild(safeNameElem);
							 		if( !!playerItem )
							 		{
							 			playerItemImageContainerElem = document.createElement("div");
							 			playerItemImageContainerElem.style.cssText = "width: 174px;";

							 			playerItemImageContainerElem.appendChild(playerItemImageElem);
							 			playerCardElem.appendChild(playerItemImageContainerElem);

										arcadeHud.loadItemBestImage(playerItemImageElem, playerItem, function()
										{
											/*
											this.ready = true;

											var imageContainer = this.parentNode;
											imageContainer.style.background = "transparent url('" + this.src + "') center";
											imageContainer.style.backgroundSize = "cover";*/
										}.bind(playerItemImageElem));
							 		}
							 		playerCardElem.appendChild(playerActionButtonsContainerElem);
							 		playerActionButtonsContainerElem.appendChild(playerFollowButtonElem);
							 		playerActionButtonsContainerElem.appendChild(playerUnfollowButtonElem);
							 		playerActionButtonsContainerElem.appendChild(playerRestrictButtonElem);
							 		playerActionButtonsContainerElem.appendChild(playerBanButtonElem);

							 		playerCardsElem.appendChild(playerCardElem);
							 	}

							 	function followPlayer(elem)
							 	{
							 		var parentElem = elem;
							 		var userId;
							 		while( !!parentElem && !!!userId )
							 		{
							 			userId = parentElem.getAttribute("userId");
							 			parentElem = parentElem.parentNode;
							 		}

							 		if( !!userId )
							 			aaapi.cmd("followPlayer", userId);
							 	}

							 	function banPlayer(elem)
							 	{
							 		var parentElem = elem;
							 		var userId;
							 		while( !!parentElem && !!!userId )
							 		{
							 			userId = parentElem.getAttribute("userId");
							 			parentElem = parentElem.parentNode;
							 		}

							 		if( !!userId )
							 			aaapi.cmd("banPlayer", userId);
							 	}

							 	// populate banned palyer list

							 	var banInfo;
								var bannedPlayersContainerElem = document.querySelector(".bannedPlayersContainer");
								var noBannedPlayersElem = document.querySelector(".noBannedPlayers");
							 	if( Object.keys(g_userBans).length > 0 )
							 		noBannedPlayersElem.style.display = "none";

							 	for( var x in g_userBans )
							 	{
							 		banInfo = g_userBans[x];

								 	var bannedPlayerContainerElem = document.createElement("div");
								 	bannedPlayerContainerElem.className = "bannedPlayerContainer aaThemeColorTwoShadedBackground aaThemeColorTwoShadedBorderColor";

								 	var bannedPlayerDisplayNameContainerElem = document.createElement("div");
								 	bannedPlayerDisplayNameContainerElem.className = "bannedPlayerDisplayNameContainer aaThemeColorTwoLowBackgroundColor aaThemeColorTwoInverseShadedBorderColor";

								 	var bannedPlayerDisplayNameElem = document.createElement("div");
								 	bannedPlayerDisplayNameElem.className = "bannedPlayerDisplayName";

								 	var safeBannedPlayerName = document.createTextNode(banInfo.displayName);

								 	var bannedPlayerDateElem = document.createElement("div");
								 	bannedPlayerDateElem.className = "bannedPlayerDate";
								 	bannedPlayerDateElem.innerHTML = new Date(parseInt(banInfo.date)).toLocaleDateString();

								 	var unbanButtonElem = document.createElement("div");
								 	unbanButtonElem.className = "unbanButton aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor";
								 	unbanButtonElem.innerHTML = "Unban";
								 	unbanButtonElem.userId = banInfo.id;
								 	unbanButtonElem.addEventListener("click", function(e)
								 	{
								 		delete g_userBans[this.userId];
								 		localStorage.setItem("userBans", JSON.stringify(g_userBans));
								 		aaapi.cmd("unbanPlayer", this.userId);
								 		document.location.reload();
								 	}.bind(unbanButtonElem));

								 	// compose
								 	bannedPlayerContainerElem.appendChild(bannedPlayerDisplayNameContainerElem);
								 	bannedPlayerDisplayNameContainerElem.appendChild(bannedPlayerDisplayNameElem);
								 	bannedPlayerDisplayNameElem.appendChild(safeBannedPlayerName);
								 	bannedPlayerContainerElem.appendChild(bannedPlayerDateElem);
								 	bannedPlayerContainerElem.appendChild(unbanButtonElem);

								 	bannedPlayersContainerElem.appendChild(bannedPlayerContainerElem);
								}
							</script>



							</div>
					</div>

						<div class="aaTabContent aaTextSize aaTextColorTwoColor aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor" tabid="screenshots">
							<div id="screenshotList" class="aaOnlyIfMapLoaded aaScrollBars" style="padding: 10px; max-height: 750px; text-align: center;"></div>
						</div>

						<div class="aaTabContent aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor aaOnlyIfHost" tabid="panos" style="display: none;">
							<center>
							
								<style>
									.panoImage
									{
										max-width: 70px;
									}
								</style>

								<script>
									function newPano()
									{
										if(!givenTabId || givenTabId === "tasks")
											aaapi.cmd("consoleCommand", "ignore_next_tab_up 1");

										window.location = 'asset://ui/panoScreenshot.html?uiback=' + encodeURIComponent("window.location='asset://ui/tabMenu.html';");
									}
								</script>

								<div style="padding: 10px; font-family: Arial;" class="aaTextColorTwoColor aaTextSizeFontSize">
									360&deg; screenshots allow your friends to see what it's like to walk around your arcade in 3D.<br /><br />
									<div id="noPanos">
										<br />
										<b>Your friends will only have 2D top-down mode if you don't take any 360&deg; screenshots this session.</b>
									</div>

									<div class="aaButton aaBigButton aaTitleTextSizeFontSize aaThemeColorOneHoverShadedBackground aaTextColorOneColor aaThemeColorOneLowBorderColor helpNote" onclick="newPano();" style="width: 80%;" help="FIRST stand where you want to take your 360&deg; screenshot from, THEN click this button.">New 360&deg; Screenshot</div><br />

									<div id="panosContainer" class="aaScrollBars" style="margin-top: 10px; display: none; max-height: 400px; overflow-x: hidden; overflow-y: auto;">
									</div>
								</div>
							</center>
						</div>

						<script>
							if( panoInfos.length > 0 )
							{
								document.querySelector("#noPanos").style.display = "none";
								var panosContainerElem = document.querySelector("#panosContainer");

								var panoInfo, panoContainerElem, panoImageFrontElem, panoImageRightElem, panoImageBackElem, panoImageLeftElem;
								for( var i = 0; i < panoInfos.length; i++ )
								{
									panoInfo = panoInfos[i];

									panoContainerElem = document.createElement("div");
									panoContainerElem.className = "aaThemeColorOneInverseShadedBorderColor";
									panoContainerElem.style.cssText = "border-style: solid; border-width: 2px; display: block; white-space: nowrap; width: 280px;";

									panoImageFrontElem = document.createElement("img");
									panoImageFrontElem.className = "panoImage";
									panoImageFrontElem.src = panoInfo.binary.front;

									panoImageRightElem = document.createElement("img");
									panoImageRightElem.className = "panoImage";
									panoImageRightElem.src = panoInfo.binary.right;

									panoImageBackElem = document.createElement("img");
									panoImageBackElem.className = "panoImage";
									panoImageBackElem.src = panoInfo.binary.back;

									panoImageLeftElem = document.createElement("img");
									panoImageLeftElem.className = "panoImage";
									panoImageLeftElem.src = panoInfo.binary.left;

									// compose
									panoContainerElem.appendChild(panoImageFrontElem);
									panoContainerElem.appendChild(panoImageRightElem);
									panoContainerElem.appendChild(panoImageBackElem);
									panoContainerElem.appendChild(panoImageLeftElem);
									panosContainerElem.appendChild(panoContainerElem);
								}

								panosContainerElem.style.display = "block";
							}
						</script>

						<div class="aaWindowPaneContent aaTabContent aaTextSize aaTextColorTwoColor aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor" style="padding: 0; pointer-events: all;" tabid="backpack"><!-- aaOnlyIfHost -->

						<div class='panel' panel='objectInspect'>
							<div id="objectInspectLoading" style="font-family: Arial; font-weight: 900; padding: 40px;" class="aaTextColorTwoColor aaTextSizeFontSize">
								<center>
									<div class="loadingIndicator aaThemeColorOneBorderColor"></div>
								</center>
							</div>
						</div>

							<div class='panel' panel='results'>
								<div class="aaTabContent aaTextSize aaTextColorTwoColor" style="padding: 4px; border: 0;" id="listDetails">
									<table style="width: 100%; overflow-x: hidden;">
										<tr>
											<td>
												<table cellspacing="0" cellpadding="0" width="100%">
													<tr>
														<td width="1" style="white-space: nowrap; padding-left: 0px;" align="right" valign="middle" colspan="5">
															<table style="width: 100%;">
																<tr>
																	<td width="1" style="white-space: nowrap;">
																		<div class="helpNote aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="font-weight: 900; min-width: initial; padding: 6px; width: 26px; margin-left: 2px; margin-right: 3px; height: 26px; display: inline-block;" onclick="resetFilters();" help="Reset filters & show your favorites.">&#x21bb;</div>
																	</td>
																	<td style="white-space: nowrap; padding-left: 0px;" align="right" valign="middle">
																		<select id="listSelect" style="width: 100%; -webkit-appearance: none; appearance: none; font-weight: normal; letter-spacing: 0.2em; padding: 2px; border-radius: 8px; border-style: inset; border-width: 1px; outline: none; font-size: 27px; padding-right: 30px;" class="aaTextColorTwoColor aaThemeColorTwoBorderColor aaTitleText aaTitleTextSizeFontSize aaThemeColorTwoBackgroundColor helpNote" help="Set your active favorites list. This is also the list that favorite/unfavorite buttons will use.">
																			<!--option value=''>Search Results</option-->
																			<!--option>Christmas Stuff</option-->
																		</select>
																		<div style="position: relative; display: inline-block; vertical-align: top; left: -38px; margin-top: 16px;">
																			<div class="aaDownArrow aaTextColorTwoHIghBorderColor" style="position: absolute;"></div>
																		</div>
																	</td>
																	<td width="1" style="white-space: nowrap;">
																		<div class="helpNote aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="min-width: initial; padding: 6px; width: 26px; margin-left: 2px; margin-right: 3px; height: 26px; display: inline-block;" onclick="editList();" help="Edit this list's properties.">
																			<script>
																				document.write(arcadeHud.generateIconHTML("editicon.png", 26, 26, "aaTextColorTwoColor"));
																			</script>
																		</div>
																		<div class="helpNote aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" help="Create a NEW list." style="min-width: initial; padding: 6px; width: 26px; height: 26px; display: inline-block; margin-right: 4px;" onclick="createList();">
																			<script>
																				document.write(arcadeHud.generateIconHTML("plusicon.png", 26, 26, "aaTextColorTwoColor"));
																			</script>
																		</div>
																	</td>
																	<td width="1" style="white-space: nowrap;" valign="middle">
																		<select id="typeSelect" style="max-width: 300px; -webkit-appearance: none; appearance: none; font-weight: normal; letter-spacing: 0.2em; padding: 2px; border-radius: 8px; border-style: inset; border-width: 1px; outline: none; font-size: 27px; padding-right: 30px;" class="aaTextColorTwoColor aaThemeColorTwoBorderColor aaTitleText aaTitleTextSizeFontSize aaThemeColorTwoBackgroundColor helpNote" help="Filter what types of results are shown.">
																			<!--option>All Types</option>
																			<option>Christmas Stuff</option-->
																		</select>
																		<div style="position: relative; display: inline-block; vertical-align: top; left: -38px; margin-top: 16px;">
																			<div class="aaDownArrow aaTextColorTwoHighColor" style="position: absolute;"></div>
																		</div>
																	</td>
																	<td width="1" style="display: none; white-space: nowrap; padding-left: 0px;" align="right" valign="middle">
																		<select id="sourceSelect" style="-webkit-appearance: none; appearance: none; font-weight: normal; padding: 2px; border-radius: 8px; border-style: inset; border-width: 1px; outline: none; font-size: 27px; padding-right: 30px;" class="aaTextColorTwoColor aaThemeColorTwoBorderColor aaTitleText aaTitleTextSizeFontSize aaThemeColorTwoBackgroundColor helpNote" help="Set your active favorites list. This is also the list that favorite/unfavorite buttons will use.">
																			<option>Any Source</option>
																			<!--option>Current World Only</option>
																			<option>Counter-Strike: Source</option-->
																		</select>
																		<div style="position: relative; display: inline-block; vertical-align: top; left: -38px; margin-top: 16px;">
																			<div class="aaDownArrow aaTextColorTwoHIghBorderColor" style="position: absolute;"></div>
																		</div>
																	</td>
																</tr>
															</table>
														</td>
													</tr>
												</table>
											</td>
										</tr>
									</table>
								</div>

								<div class="aaWindowPaneContentScrollable aaScrollBars dragscroll" style="max-height: 750px; overflow-x: hidden; text-align: center;">
									<div id="listLoading" style="font-family: Arial; font-weight: 900; padding: 40px;" class="aaTextColorTwoColor aaTextSizeFontSize">
										<center>
											<div class="loadingIndicator aaThemeColorOneBorderColor"></div>
										</center>
									</div>
									<div id="listItems"></div>
									<div id="listProps"></div>
									<div id="listMaps"></div>
									<div id="listScreenshots"></div>
									<div id="listFavorites"></div>
									<div id="listServers"></div>
									<div id="scrollTrigger"></div>
									<div id="emptyList" style="display: none; font-family: Arial; font-weight: 900; padding: 40px; text-align: center;" class="aaTextColorTwoColor aaTextSizeFontSize">This favorites list is empty.<br />Click on <div style="display: inline-block;">
										<script>
											var iconHTML = arcadeHud.generateIconHTML("favoriteicon.png", 26, 26, "aaTextColorOneColor");
											document.write(iconHTML);
										</script>
									</div> icons in menus to add stuff to your list.</div>
								</div>

								<div class="aaTabContent aaTextSize aaTextColorTwoColor" style="padding: 4px; border: 0;" id="listDetails">
									<table style="width: 100%; overflow-x: hidden;">
										<tr>
											<td>
												<table cellspacing="0" cellpadding="0" width="100%">
													<tr>
														<!--td width="1">
															<div id="gridButton" class="helpNote aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" help="Grid View" style="min-width: initial; padding: 6px; width: 26px; height: 26px; margin-left: 4px; margin-right: 8px; display: none;" onclick="changeView();">
																<script>
																	document.write(arcadeHud.generateIconHTML("gridicon.png", 26, 26, "aaTextColorTwoHighColor"));
																</script>
															</div>
															<div id="listButton" class="helpNote aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" help="List View" style="min-width: initial; padding: 6px; width: 26px; height: 26px; margin-left: 4px; margin-right: 8px; display: none;" onclick="changeView();">
																<script>
																	document.write(arcadeHud.generateIconHTML("listicon.png", 26, 26, "aaTextColorTwoHighColor"));
																</script>
															</div>
														</td-->
														<td width="1">
															<div style="border-radius: 8px; border-style: inset; border-width: 1px; outline: none; padding: 0; margin-right: 4px;" class="aaThemeColorTwoBorderColor aaTitleText aaTitleTextSizeFontSize aaThemeColorTwoBackgroundColor">

																<!--div style="position: relative;"-->
																	<div style="display: inline-block; vertical-align: middle; margin-left: 8px;">
																		<script>
																			document.write(arcadeHud.generateIconHTML("gridicon.png", 26, 26, "aaTextColorTwoColor"));
																		</script>
																	</div>
																<!--/div-->

																<input type='range' id='zoomslider' class='aaSlider' style='width: 100px; height: 36px; margin-right: 12px; margin-left: 4px; vertical-align: middle;' min='-1' max='1' step='1' value='0' />
															</div>
														</td>
														<td>
															<form onsubmit="return searchSubmit(event);" style="display: block; margin: 0; padding: 0;"><input type="text" id="libSearchInput" placeholder="Search or paste shortcut..." style="width: 100%; height: 43px; min-width: 550px; letter-spacing: 0.2em; padding: 8px;
															padding-left: 36px; border-radius: 8px; border-style: inset; border-width: 1px; outline: none; font-size: 18px; background-position: left center; background-repeat: no-repeat;" class="aaTextColorTwoColor aaThemeColorOneBorderColor aaTitleText aaTitleTextSizeFontSize aaThemeColorTwoBackgroundColor" /></form>
														</td>
														<td>
															<div style="display: inline-block; position: relative; left: -4px;">
																<div style="position: absolute; -webkit-transform: translateX(-100%) translateY(-50%); white-space: nowrap;">
																	<!--div class="modeIconContainer aaThemeColorTwoHighBackgroundColor helpNote" help="Your Steam Games">
																		<div class='modeIcon'>
																			<script>
																				document.write(arcadeHud.generateIconHTML("steamicon.png", 26, 26, "aaThemeColorOneColor"));
																			</script>
																		</div>
																	</div-->
																	<div mode="items" class="modeIconContainer modeIconContainerActive aaThemeColorTwoHighBackgroundColor helpNote" help="Items">
																		<div class='modeIcon'>
																			<script>
																				document.write(arcadeHud.generateIconHTML("itemicon.png", 26, 26, "aaThemeColorOneColor"));
																			</script>
																		</div>
																	</div>
																	<div mode="models" class="modeIconContainer aaThemeColorTwoHighBackgroundColor helpNote" help="Models">
																		<div class='modeIcon'>
																			<script>
																				document.write(arcadeHud.generateIconHTML("3dmodelicon.png", 26, 26, "aaThemeColorOneColor"));
																			</script>
																		</div>
																	</div>
																	<div mode="maps" class="modeIconContainer aaThemeColorTwoHighBackgroundColor helpNote" help="Maps">
																		<div class='modeIcon'>
																			<script>
																				document.write(arcadeHud.generateIconHTML("map.png", 26, 26, "aaThemeColorOneColor"));
																			</script>
																		</div>
																	</div>
																	<div mode="screenshots" class="modeIconContainer aaThemeColorTwoHighBackgroundColor helpNote" help="Screenshots">
																		<div class='modeIcon'>
																			<script>
																				document.write(arcadeHud.generateIconHTML("photoicon.png", 26, 26, "aaThemeColorOneColor"));
																			</script>
																		</div>
																	</div>
																	<div mode="interactiveshots" class="modeIconContainer aaThemeColorTwoHighBackgroundColor helpNote" help="Interactive Screenshots">
																		<div class='modeIcon'>
																			<script>
																				document.write(arcadeHud.generateIconHTML("interactiveshoticon.png", 26, 26, "aaThemeColorOneColor"));
																			</script>
																		</div>
																	</div>
																	<div mode="favorites" class="modeIconContainer aaThemeColorTwoHighBackgroundColor helpNote" help="Favorites">
																		<div class='modeIcon'>
																			<script>
																				document.write(arcadeHud.generateIconHTML("favoriteicon.png", 26, 26, "aaThemeColorOneColor"));
																			</script>
																		</div>
																	</div>
																	<!--div class="modeIconContainer aaThemeColorTwoHighBackgroundColor helpNote" help="Open-With Apps">
																		<div class='modeIcon'>
																			<script>
																				document.write(arcadeHud.generateIconHTML("appicon.png", 26, 26, "aaThemeColorOneColor"));
																			</script>
																		</div>
																	</div>
																	<div class="modeIconContainer aaThemeColorTwoHighBackgroundColor helpNote" help="Wizards">
																		<div class='modeIcon'>
																			<script>
																				document.write(arcadeHud.generateIconHTML("wizardicon.png", 26, 26, "aaThemeColorOneColor"));
																			</script>
																		</div>
																	</div-->
																	<!--div style="cursor: pointer; display: inline-block; border-radius: 4px; vertical-align: middle; margin: 0;" class="aaThemeColorTwoHoverBackgroundColor helpNote" help="Favorites Lists">
																		<img src="listicon.png"  style="height: 24px; margin: 6px;" />
																	</div-->
																</div>
															</div>
														</td>
														<!--td style="width: 1px;">
															<div class="helpNote aaButton aaTextSizeFontSize aaThemeColorOneHoverShadedBackground aaTextColorOneColor aaThemeColorOneLowBorderColor" style="min-width: initial; padding: 6px; margin-left: 4px; margin-right: 6px; height: 26px; display: inline-block; white-space: nowrap;" onclick="editList();" help="Edit this list's properties.">
																<div style="margin-left: 2px; display: inline-block;">
																	<script>
																		document.write(arcadeHud.generateIconHTML("newicon.png", 26, 26, "aaTextColorOneColor"));
																	</script>
																</div>
																<div style="display: inline-block; vertical-align: bottom; margin-right: 4px; margin-left: 4px; letter-spacing: 0.1em;" class="aaTextColorOneColor">
																	Add New
																</div>
															</div>
														</td-->
													</tr>
													<!--tr>
														<td width="1" style="white-space: nowrap; padding-left: 0px;" align="right" valign="middle" colspan="5">
															<table style="width: 100%;">
																<tr>
																	<td width="100%" style="white-space: nowrap; padding-left: 0px;" align="right" valign="middle" colspan="4">
																		<select id="listSelect" style="width: 100%; -webkit-appearance: none; appearance: none; font-weight: normal; letter-spacing: 0.2em; padding: 2px; border-radius: 8px; border-style: inset; border-width: 1px; outline: none; color: #ccc; font-size: 27px; padding-right: 30px;" class="aaThemeColorTwoBorderColor aaTitleText aaTitleTextSizeFontSize aaThemeColorTwoBackgroundColor helpNote" help="Set your active favorites list. This is also the list that favorite/unfavorite buttons will use.">
																		</select>
																		<div style="position: relative; display: inline-block; vertical-align: top; left: -38px; margin-top: 16px;">
																			<div class="aaDownArrow aaThemeColorTwoHighBorderColor" style="position: absolute;"></div>
																		</div>
																	</td>
																	<td width="1" style="white-space: nowrap;">
																		<div class="helpNote aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="min-width: initial; padding: 6px; width: 26px; margin-left: 2px; margin-right: 3px; height: 26px; display: inline-block;" onclick="editList();" help="Edit this list's properties.">
																			<script>
																				document.write(arcadeHud.generateIconHTML("editicon.png", 26, 26, "aaTextColorTwoHighColor"));
																			</script>
																		</div>
																		<div class="helpNote aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" help="Create a NEW list." style="min-width: initial; padding: 6px; width: 26px; height: 26px; display: inline-block; margin-right: 4px;" onclick="createList();">
																			<script>
																				document.write(arcadeHud.generateIconHTML("plusicon.png", 26, 26, "aaTextColorTwoHighColor"));
																			</script>
																		</div>
																	</td>
																</tr>
															</table>
														</td>
													</tr-->
												</table>
											</td>
										</tr>
									</table>
								</div>
							</div>
						</div>

						<div class="aaTabContent aaTextSize aaTextColorTwoColor aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor" tabid="commands" style="border-radius: 4px; display: block;">
							<div id="commands" class="aaOnlyIfMapLoaded dragscroll aaWindowPaneContentScrollable aaScrollBars transborder" style="padding: 4px; text-align: center; height: 416px; border-style: solid; border-size: 1px; border-radius: 8px; pointer-events: all;"></div>
							<table id="abslots" style="margin-right: 20px; width: 100%;">
								<tr></tr>
								<tr align="center" class="aaTitleTextSize aaTitleText aaTextColorOneColor">
									<td>1</td>
									<td>2</td>
									<td>3</td>
									<td>4</td>
									<td>5</td>
									<td>6</td>
									<td>7</td>
									<td>8</td>
									<td>9</td>
									<td>0</td>
								</tr>
							</table>
						</div>

						<div class="aaTabContent aaTextSize aaTextColorTwoColor aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor" tabid="transfers" style="border-radius: 4px; display: block; max-width: 1620px; pointer-events: all; padding: 8px;">
							<div id="downloadsStuff">
								<div class="aaTitleTextSize aaTitleText aaTextColorTwoColor">DOWNLOADS (<div id="downloadedCount" class="transferCount">0</div>/<div id="downloadCount" class="transferCount">0</div>)</div>
								<div id="downloadsPane" class="aaWindowPaneContent aaWindowPaneContentScrollable aaScrollBars aaThemeColorTwoShadedBackground aaThemeColorTwoLowBorderColor aaTextSizeFontSize aaTextColorTwoColor" style="max-height: 350px; border-radius: 8px; width: 750px;">
									<div id="noDownloads" class="aaTextSizeFontSize aaTextColorTwoColor" style="font-family: Arial; padding: 8px;">You have not downloaded any game assets this session.</div>
									<div id="downloading"></div>
									<div id="downloads"></div>
									<div id="requested"></div>
									<div id="downloaded"></div>
								</div>
							</div>
							<div id="uploadsStuff" class="aaOnlyIfHost">
								<div class="aaTitleTextSize aaTitleText aaTextColorTwoColor">UPLOADS (<div id="uploadedCount" class="transferUploadCount">0</div>/<div id="uploadCount" class="transferUploadCount">0</div>)</div>
								<div id="uploadsPane" class="aaWindowPaneContent aaWindowPaneContentScrollable aaScrollBars aaThemeColorTwoShadedBackground aaThemeColorTwoLowBorderColor aaTextSizeFontSize aaTextColorTwoColor" style="max-height: 350px; border-radius: 8px; width: 750px;">
									<div id="noUploads" class="aaTextSizeFontSize aaTextColorTwoColor" style="font-family: Arial; padding: 8px;">You have not uploaded any game assets this session.</div>
									<div id="uploading"></div>
									<div id="uploads"></div>
									<div id="requestedUploads"></div>
									<div id="uploaded"></div>
								</div>
							</div>
							<!--div id="downloadedStuff"-->
								<!--div class="aaTitleTextSize aaTitleText aaTextColorTwoColor">COMPLETED DOWNLOADS ()</div>
								<div id="downloadedPane" class="aaWindowPaneContent aaWindowPaneContentScrollable aaScrollBars aaThemeColorTwoShadedBackground aaThemeColorTwoLowBorderColor aaTextSizeFontSize aaTextColorTwoColor" style="max-height: 120px; border-radius: 8px;">
								</div-->
							<!--/div-->
							<!--div class=" aaTitleTextSize aaTitleText aaTextColorTwoColor">UPLOADS (<div id="uploadCount" class="transferCount">0</div>)</div>
							<div class="aaWindowPaneContent aaWindowPaneContentScrollable aaScrollBars aaThemeColorTwoShadedBackground aaThemeColorTwoLowBorderColor aaTextSizeFontSize aaTextColorTwoColor" style="max-height: 120px; border-radius: 8px;">
								<div id="uploads"></div>
							</div-->
							<!--div class="aaTitleTextSize aaTitleText aaTextColorTwoColor">REQUESTED (<div id="requestedCount" class="transferCount">0</div>)</div>
							<div class="aaTitleTextSize aaTitleText aaTextColorTwoColor">COMPLETED (<div id="completedCount" class="transferCount">0</div>)</div-->
						</div>

						<div class="aaTabContent aaTextSize aaTextColorTwoColor aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor" tabid="paint" style="border-radius: 4px; display: block; max-width: 1620px; pointer-events: all; padding: 8px;">
							<table style="height: 100%; width: 100%;">
								<tr>
									<td>
										<table cellspacing="0" cellpadding="0" style="width: 100%;">
											<tr>
												<td style="white-space: nowrap;">
													<select id="paletteselect" style="width: 100%; -webkit-appearance: none; appearance: none; font-weight: normal; letter-spacing: 0.2em; padding: 2px; border-radius: 8px; border-style: inset; border-width: 1px; outline: none; font-size: 27px; padding-right: 30px;" class="aaTextColorTwoColor aaThemeColorTwoBorderColor aaTitleText aaTitleTextSizeFontSize aaThemeColorTwoBackgroundColor helpNote" help="Choose which texture palette you want to use."></select>
													<div style="position: relative; display: inline-block; vertical-align: top; left: -38px; margin-top: 16px;">
														<div class="aaDownArrow aaTextColorTwoHIghBorderColor" style="position: absolute;"></div>
													</div>
												</td>
												<td style="width: 1px;">
													<div class="helpNote aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="min-width: initial; padding: 6px; width: 26px; margin-left: 2px; margin-right: 3px; height: 26px; display: inline-block;" onclick="editPalette();" help="Edit this palette's properties.">
														<script>
															document.write(arcadeHud.generateIconHTML("editicon.png", 26, 26, "aaTextColorTwoColor"));
														</script>
													</div>
												</td>
												<td style="width: 1px;">
													<div class="helpNote aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" help="Create a NEW palette." style="min-width: initial; padding: 6px; width: 26px; height: 26px; display: inline-block; margin-right: 4px;" onclick="createPalette();">
														<script>
															document.write(arcadeHud.generateIconHTML("plusicon.png", 26, 26, "aaTextColorTwoColor"));
														</script>
													</div>
												</td>
											</table>
									</td>
								</tr>
								<tr>
									<td>
										<div id="palette" class="aaOnlyIfMapLoaded aaScrollBars" style="padding: 4px; max-height: 750px; overflow-y: auto;"></div>
									</td>
								</tr>
								<tr>
									<td height="1" align="center">
										<table cellspacing="0" cellpadding="0">
											<tr>
												<td style="padding-left: 0px;">
													<div id="reapplyMatButton" type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor helpNote" help="Reset the material under your crosshair." onclick="reapplyAll();" style="pointer-events: all; cursor: pointer; padding: 8px; display: inline-block;">Re-Apply All</div>
												</td>
												<td style="padding-left: 8px;">
													<div id="resetMatButton" type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor helpNote" help="Reset the material under your crosshair." onclick="resetMaterial();" style="pointer-events: all; cursor: pointer; padding: 8px; display: inline-block;">Reset Material</div>
												</td>
												<td style="padding-left: 8px;">
													<div id="unpaintSkyboxButton" type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor helpNote" help="Resets the skybox material." onclick="unpaintSky();" style="pointer-events: all; cursor: pointer; padding: 8px; display: inline-block;">Reset Skybox</div>
												</td>
												<td style="padding-left: 8px;">
													<div id="pickSkyboxButton" type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor helpNote" help="Sample the SKYBOX for this map and add it to your current palette." onclick="pickSkybox();" style="pointer-events: all; cursor: pointer; padding: 8px; display: inline-block;">Pick Skybox</div>
												</td>
												<td style="padding-left: 8px;">
													<div id="pickTextureButton" type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor helpNote" help="Sample the texture under your crosshair and add it to your current palette." onclick="pickTexture();" style="pointer-events: all; cursor: pointer; padding: 8px; display: inline-block;">Pick Texture</div>
												</td>
											</tr>
										</table>
									</td>
								</tr>
							</table>
						</div>

						<div class="aaTabContent aaTextSize aaTextColorTwoColor aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor" tabid="quests" style="border-radius: 4px; display: block; max-width: 1620px; pointer-events: all; padding: 8px;">
							<div id="noQuestsAvailable">No quests are available.</div>
							<div style="display: none;" class="activeQuestsSection">
								<div class="questCategoryTitle" style="padding: 12px; text-align: center;">ACTIVE</div>
								<div id="questsActiveContainer" class="activeQuestsSection aaScrollBars" style="display: none; max-height: 240px; overflow-y: auto;">
								</div>
							</div>
							<div style="display: none;" class="inactiveQuestsSection">
								<div class="questCategoryTitle" style="padding: 12px; text-align: center;">INACTIVE</div>
								<div id="questsInactiveContainer" class="inactiveQuestsSection aaScrollBars" style="display: none; max-height: 240px; overflow-y: auto;">
								</div>
							</div>
							<div style="display: none;" class="completedQuestsSection">
								<div class="questCategoryTitle" style="padding: 12px; text-align: center;">COMPLETED</div>
								<div class="completedQuestsSection aaScrollBars" id="questsCompletedContainer" style="display: none; max-height: 150px; overflow-y: auto;">
								</div>	
							</div>
							<div style="display: block;" class="hiddenQuestsSection">
								<div class="questCategoryTitle" onclick="toggleHiddenQuests()" style="cursor: pointer; padding: 12px; text-align: center;">
									<div class="questHiddenCategoryState">&#9650;</div> HIDDEN <div class="questHiddenCategoryState">&#9650;</div></div>
								<div id="questsHiddenContainer" class="hiddenQuestsSection aaScrollBars" style="display: none; max-height: 150px; overflow-y: auto;">
								</div>
							</div>
						</div>

						<script>
							var windowTabsFooterHTML = arcadeHud.generateWindowTabsFooterHTML();
							document.write(windowTabsFooterHTML);

							var elem = document.querySelector(".aaTabs tr");
							elem.parentNode.appendChild(elem);
						</script>
						</div>
					</td>
				</tr>
			</table>
		</center>

		<script>
			//var windowFooterHTML = arcadeHud.generateWindowFooterHTML();
			//document.write(windowFooterHTML);

			function pickSkybox()
			{
				var curSky = aaapi.cmdEx("getConVarValue", "painted_skyname");
				if( curSky == '' )
					curSky = aaapi.cmdEx("getConVarValue", "sv_skyname");
				if( curSky == '' )
					return;

				paintTexture = 'skybox/' + curSky;

				aaapi.cmd('consoleCommand', 'paint_texture "' + paintTexture + '"');

				if( paintTexture != '' && texturePalette.entries.indexOf(paintTexture) < 0 )
				{
					// adopt it first
					aaapi.cmd('adoptSky', curSky);

					texturePalette.entries.push(paintTexture);
					window.localStorage.setItem('texturePalette' + paletteId, JSON.stringify(texturePalette));
				}

				document.location.href = 'tabMenu.html?tab=paint';
			}
		</script>

		</div>
		</td></tr>
		</table>
		</div>

		<a href="javascript:location.reload();" class="devReload">&bull;&nbsp;</a>

		<style>
			.command
			{
				font-family: Arial;
				font-style: italic;
				text-shadow: 2px 2px 2px #000;
				font-weight: bold;
				color: #aaa;
				font-size: 25px;

				border-radius: 10px;
				white-space: nowrap;
				text-align: center;
				vertical-align: middle;
				border-collapse: separate;
				border-spacing: 0;
				padding: 10px;
				margin: 4px;
				display: inline-block;
				-webkit-box-shadow: 3px 5px 8px #000;
				border: 3px solid #000;
				background-color: rgba(50, 50, 50, 0.9);
			}

			.command:hover
			{
				color: #fff;
				background-color: rgba(70, 70, 70, 0.9);
			}
		</style>
		<script>
			var screenshotListElem = document.querySelector("#screenshotList");

			var commands = [
				/*{
					"title": "Debug: Spawn Smoke",
					"command": "smoke_test;",
					"closeMenu": false,
					"help": "Test some smoke."
				},*/
				{
					"title": "Developer Adopt Asset Files",
					"command": "adopt_asset_menu",
					"closeMenu": true,
					"help": "Make an extra COPY of the asset files for a model or material."
				},
				{
					"title": "Always Animate Image",
					"command": "always_animated_image_toggle",
					"closeMenu": true,
					"help": "Flags the object under your crosshair as an always animating image."
				},
				{
					"title": "Pause AArcade",
					"command": "manual_pause",
					"closeMenu": true,
					"help": "When AArcade is paused & in the background, it becomes optimized so that it doesn't lag your PC down."
				},
				{
					"title": "Image Loader Reset",
					"command": "reset_image_loader",
					"closeMenu": true,
					"help": "If images start failing to load, you can reset the image loader here to fix it. (Or reload the map - either way works.)"
				},
				{
					"title": "Input Lock",
					"command": "input_mode_toggle",
					"closeMenu": true,
					"help": "Toggles you into input mode on the selected cabinet so that you can send input to it as if it were fullscreened."
				},
				{
					"title": "Smoke Out",
					"command": "fog_test",
					"closeMenu": false,
					"help": "Test some fog."
				},
				{
					"title": "Quests Restart All",
					"command": "restart_quest_system",
					"closeMenu": true,
					"help": "Reset & restart the available quests in this world."
				},
				{
					"title": "Shadows Toggle",
					"command": "toggle object_shadows 0 1; set_active_spawned_shadows;",
					"closeMenu": false,
					"help": "Shadows of spawned objected can cause visual glitches or decrease performance, depending on the arcade."
				},
				{
					"title": "Legs",
					"command": "toggle cl_first_person_uses_world_model 0 1;",
					"closeMenu": false,
					"help": "Give yourself legs even while in first person mode! However, having 1st person legs will cause your flashlight to act a little weird."
				},
				{
					"title": "Double Rainbow Mode",
					"command": "toggle avr 0 2",
					"closeMenu": false,
					"help": "Toggle sound-sensitive colored reflections on all cabinet screens."
				},
				/*{
					"title": "Double Rainbow Mode",
					"command": "avr 2",
					"closeMenu": false,
					"help": "Turn on sound-sensitive colored reflections on all cabinet screens."
				},
				{
					"title": "Double Rainbow Reset",
					"command": "avr 0",
					"closeMenu": false,
					"help": "Turn off sound-sensitive colored reflections on all cabinet screens."
				},*/
				{
					"title": "Player Model Morph",
					"command": "morphmodel",
					"closeMenu": true,
					"help": "Morph yourself into what ever 3D model you are looking at."
				},
				/*{
					"title": "Player Model Morph Smart",
					"command": "morphplayermodel",
					"closeMenu": true,
					"help": "Morph yourself into the nearest compatible 3D player model."
				},*/
				{
					"title": "Player Model Reset",
					"command": "resetmodel",
					"closeMenu": true,
					"help": "Reset yourself back to the default player model."
				},
				/*{
					"title": "Libretro Auto-Play Toggle",
					"command": "toggle auto_libretro 0 1",
					"closeMenu": true,
					"help": "Toggle Libretro auto-play on/off."
				},*/
				{
					"title": "Camera Perspective",
					"command": "toggle_perspective",
					"closeMenu": false,
					"help": "Cycle between 1st and 3rd person camera modes."
				},
				/*{
					"title": "Camera 3rd Person",
					"command": "thirdperson",
					"closeMenu": true,
					"help": "Go into 3rd person mode."
				},*/
				{
					"title": "Camera Rotation Lock",
					"command": "cam_maya_toggle",
					"closeMenu": true,
					"help": "Toggles the camera's rotation in 3rd person mode. This allows you to look back at your camera with your avatar while in 3rd person mode."
				},
				/*{
					"title": "Camera 1st Person",
					"command": "firstperson",
					"closeMenu": true,
					"help": "Go back into 1st person mode."
				},*/
				{
					"title": "Sound Mute Toggle",
					"command": "toggle volume 0 1",
					"closeMenu": true,
					"help": "Toggle the Source engine volume on/off."
				},
				{
					"title": "Fly Mode",
					"command": "noclip",
					"closeMenu": true,
					"help": "Fly through solid objects instead of walking."
				},
				{
					"title": "Overlay Black & White",
					"command": "toggle mat_yuv",
					"closeMenu": false,
					"help": "Toggle black & white mode.  Very noire of you."
				},
				{
					"title": "Overlay Combine Vision",
					"command": "toggle_overlay \"effects/combine_binocoverlay.vmt\"",//"toggle r_screenoverlay \"effects/combine_binocoverlay.vmt\" 0",
					"closeMenu": false,
					"help": "Toggle combine camera overlay mode."
				},
				/*{
					"title": "Overlay Reset",
					"command": "r_screenoverlay 0",
					"closeMenu": false,
					"help": "Resets your overlay to normal."
				},*/
				{
					"title": "Tiny Mode",
					"command": "tiny_mode_toggle;",
					"closeMenu": true,
					"help": "Make yourself tiny."
				},
				{
					"title": "Avatar Menu",
					"command": "avatar_menu;",
					"closeMenu": true,
					"help": "Change your avatar to one from a custom favorites list you've prepared."
				},
				{
					"title": "Wheel Spin",
					"command": "wheel_menu;",
					"closeMenu": true,
					"help": "Randomly choose one of the objects in front of you."
				},
				/*{
					"title": "Tiny Mode Reset",
					"command": "ent_fire !player setmodelscale 1.0; cl_forwardspeed 450; cl_sidespeed 450; cl_backspeed 450;",
					"closeMenu": true,
					"help": "Make yourself untiny."
				},*/
				{
					"title": "Reflections",
					"command": "toggle mat_fastspecular",
					"closeMenu": true,
					"help": "Toggles reflections.  This can fix over-bright props or hard-to-see screens."
				},
				{
					"title": "HDR Lighting",
					"command": "toggle mat_hdr_level 0 2; mat_autoexposure_max 1; toggle  mat_autoexposure_min 1 0.5;",
					"closeMenu": true,
					"help": "Toggles HDR. HDR simulates your pupils adjusting to lighting conditions.  Turning it off can fix how some maps look."
				},
				{
					"title": "Movement Speed",
					"command": "toggle cl_forwardspeed 450 100; cl_sidespeed 450 50; cl_backspeed 450 50;",
					"closeMenu": true,
					"help": "Slow your default movement speed."
				},
				{
					"title": "Mirror Everything",
					"command": "toggle play_everywhere 0 1;",
					"closeMenu": true,
					"help": "Temporarily make all screens behave as if they were video mirrors."
				},
				{
					"title": "Object Physics",
					"command": "togglephysics",
					"closeMenu": true,
					"help": "Temporarily toggles physics on the AArcade object under your crosshair."
				},
				{
					"title": "Object Look At Me",
					"command": "look_at_me",
					"closeMenu": true,
					"help": "Temporarily toggles making the nearest object under your crosshair look at you."
				},
				{
					"title": "Spawn Nearby Objects",
					"command": "spawnobjects",
					"closeMenu": true,
					"help": "Spawan nearby objects. Only needed if you use limited spawn settings or beta nodes, otherwise, not needed."
				},
				{
					"title": "GIF Autoplay Nearby",
					"command": "play_nearest_gif",
					"closeMenu": true,
					"help": "Plays the nearest GIF item to where you are looking (if one exists.)"
				},
				/*{
					"title": "VR Spectator Toggle",
					"command": "toggle vrspectator 0 1;",
					"closeMenu": true,
					"help": "Use 'Look At Me' objects as spectator cameras. (NOTE: This has a performance impact.)"
				},
				{
					"title": "VR Spectator Mirror Toggle",
					"command": "toggle vrspectatormirror 0 1;",
					"closeMenu": true,
					"help": "Show an in-game preview of what the spectator cam sees. You must have VR Spectator mode turned ON for this to have an effect. (NOTE: This has a severe performance impact.)"
				},*/
				{
					"title": "All Guns Toggle",
					"command": "toggle_weapons;",
					"closeMenu": true,
					"help": "Toggles weapons mode. Make sure to set it to 6 or higher, otherwise weapon categories will overpower the toggle off command."
				},
				/*{
					"title": "All Guns Off",
					"command": "disable_weapons;",
					"closeMenu": true,
					"help": "Turns off guns."
				},*/
				{
					"title": "Camera Attract Next",
					"command": "select_next;",
					"closeMenu": true,
					"help": "Flys your camera to the next nearest attact mode object."
				},
				{
					"title": "Camera Attract Previous",
					"command": "select_prev;",
					"closeMenu": true,
					"help": "Flys your camera to the previous nearest attact mode object."
				},
				{
					"title": "Camera Slow Fly Mode",
					"command": "toggle_camera_fly_mode;",
					//"command": "bind joy5 +movedown; bind joy6 +moveup; sv_noclipspeed 0.2; cl_upspeed 100; ent_fire !player setmodelscale 0.1; noclip;",
					"closeMenu": true,
					"help": "Shrinks you down (Tiny Mode), enables flymode, adjusts flymode movement speed, and rebinds the gamepad top shoulder buttons to be Move Up / Down instead."
				},
				{
					"title": "Vehicle Spawn",
					"command": "ch_createairboat",
					"closeMenu": true,
					"help": "Try not to spawn it stuck into the ground."
				},
				{
					"title": "Headcrab",
					"command": "npc_create npc_headcrab",
					"closeMenu": true,
					"help": "They are your buddies, but they don't move around so well."
				},
				{
					"title": "Sound Stop",
					"command": "stopsound",
					"closeMenu": true,
					"help": "Stops all the sounds that are currently playing from the map."
				},
				{
					"title": "Developer Mode",
					"command": "toggle developer",
					"closeMenu": true,
					"help": "Toggle develoepr mode.  Shows excessive debug information in the console & on-screen when enabled."
				},
				/*{
					"title": "Painted Materials Re-Apply",
					"command": "repaint",
					"closeMenu": true,
					"help": "Resets ALL of your painted materials in your current instance."
				},*/
				{
					"title": "Painted Materials Reset All",
					"command": "unpaintall",
					"closeMenu": true,
					"help": "Resets ALL of your painted materials in your current instance."
				},
				{
					"title": "Painted Material Reset",
					"command": "unpaint",
					"closeMenu": true,
					"help": "Resets the painted material under your crosshair."
				},
				{
					"title": "Painted Material Paint",
					"command": "paint",
					"closeMenu": true,
					"help": "Paints the painted material under your crosshair."
				},
				{
					"title": "Painted Material Pick",
					"command": "pick_texture",
					"closeMenu": true,
					"help": "Sets the texture under your crosshair as your active paint texture."
				},
				{
					"title": "Object Move",
					"command": "moveobject",
					"closeMenu": true,
					"help": "Move the object that is under your crosshair."
				},
				{
					"title": "Object Clone",
					"command": "cloneobject",
					"closeMenu": true,
					"help": "Clone the object that is under your crosshair."
				},
				{
					"title": "Object Delete",
					"command": "deleteobject",
					"closeMenu": true,
					"help": "Remove the object that is under your crosshair."
				},
				{
					"title": "Vehicle Remove All Spawned",
					"command": "ent_remove_all prop_vehicle_airboat",
					"closeMenu": true,
					"help": "Removes all the vehicles that you already spawned into the world."
				},
				{
					"title": "Vehicle Menu",
					"command": "vehicle_menu",
					"closeMenu": true,
					"help": "Brings up the vehicle menu."
				},
				{
					"title": "Task Close",
					"command": "task_close_entity",
					"closeMenu": true,
					"help": "Close the task under your crosshair (or the currently auto-playing task if no active task is found under your crosshair.)"
				},
				{
					"title": "Task Close All",
					"command": "task_close_all",
					"closeMenu": true,
					"help": "Close ALL running in-game tasks."
				},
				{
					"title": "Wireframe Toggle",
					"command": "toggle mat_wireframe 0 3;",
					"closeMenu": true,
					"help": "Toggle wireframe mode - useful for seeing through walls."
				}/*,
				{
					"title": "Object Mirror Toggle",
					"command": "mirrorobject",
					"closeMenu": true,
					"help": "Toggle mirror mode on/ff for the object under your crosshair."
				}
					aaapi.cmd('consoleCommand', 'reset_image_loader');
					aaapi.cmd('refreshItemTextures', itemId, 'ALL');*/
			];

			commands.sort(function(a, b)
			{
				if( a.title.toLowerCase() > b.title.toLowerCase() )
					return 1;
				else if( a.title.toLowerCase() < b.title.toLowerCase() )
					return -1;
				else
					return 0;
			});

			var actionBarIcons = [
				{
					command: 'manual_pause',
					icon: 'pauseicon'
				},
				{
					command: 'always_animated_image_toggle',
					icon: 'animateicon'
				},
				{
					command: 'adopt_asset_menu',
					icon: 'adopticon'
				},
				{
					command: 'moveobject',
					icon: 'moveicon'
				},
				{
					command: 'ch_createairboat',
					icon: 'vehicleicon'
				},
				{
					command: 'moveobject',
					icon: 'moveicon'
				},
				{
					command: 'toggle_weapons;',
					icon: 'gunicon'
				},
				/*{
					command: 'disable_weapons;',
					icon: 'nogunicon'
				},*/
				{
					command: 'toggle mat_yuv',
					icon: 'bwicon'
				},
				{
					command: 'toggle_perspective',
					icon: '1st3rdicon'
				},
				/*{
					command: 'firstperson',
					icon: '1sticon'
				},
				{
					command: 'thirdperson',
					icon: '3rdicon'
				},*/
				{
					command: 'cam_maya_toggle',
					icon: '3rdlockicon'
				},
				{
					command: 'spawnobjects',
					icon: 'spawnnearby'
				},
				{
					command: 'toggle avr 0 2',
					icon: 'dblrainbowicon'
				},
				{
					command: 'avr 0',
					icon: 'dblrainbowreseticon'
				},
				{
					command: 'noclip',
					icon: 'flyicon'
				},
				{
					command: 'select_next;',
					icon: 'cameranexticon'
				},
				{
					command: 'select_prev;',
					icon: 'cameraprevicon'
				},
				{
					command: 'toggle_camera_fly_mode;',
					icon: 'cameraflymode'
				},
				{
					command: 'toggle cl_first_person_uses_world_model 0 1;',
					icon: 'legsicon'
				},
				{
					command: 'toggle mat_hdr_level 0 2; mat_autoexposure_max 1; toggle  mat_autoexposure_min 1 0.5;',
					icon: 'hdricon'
				},
				{
					command: 'npc_create npc_headcrab',
					icon: 'crabicon'
				},
				{
					command: 'reset_image_loader',
					icon: 'brokenicon'
				},
				{
					command: 'input_mode_toggle',
					icon: 'inputlockicon'
				},
				{
					command: 'toggle play_everywhere 0 1;',
					icon: 'mirrorallicon'
				},
				{
					command: 'toggle cl_forwardspeed 450 100; cl_sidespeed 450 50; cl_backspeed 450 50;',
					icon: 'speedicon'
				},
				{
					command: 'togglephysics',
					icon: 'physicsicon'
				},
				{
					command: "toggle_overlay \"effects/combine_binocoverlay.vmt\"",
					icon: 'combineicon'
				},
				{
					command: 'r_screenoverlay 0',
					icon: 'overlayreseticon'
				},
				{
					command: 'unpaintall',
					icon: 'fillresetallicon'
				},
				{
					command: 'morphmodel',
					icon: 'playericon'
				},
				{
					command: 'morphplayermodel',
					icon: 'playermodelmorphsmarticon'
				},
				{
					command: 'resetmodel',
					icon: 'playerreseticon'
				},
				{
					command: 'toggle mat_fastspecular',
					icon: 'reflectionsicon'
				},
				{
					command: 'toggle object_shadows 0 1; set_active_spawned_shadows;',
					icon: 'shadowsicon'
				},
				{
					command: 'fog_test',
					icon: 'smokeouticon'
				},
				{
					command: 'restart_quest_system',
					icon: 'questsicon'
				},
				{
					command: 'stopsound',
					icon: 'stopsoundsicon'
				},
				{
					command: 'tiny_mode_toggle;',
					icon: 'tinyicon'
				},
				{
					command: 'avatar_menu;',
					icon: 'avataricon'
				},
				{
					command: 'wheel_menu;',
					icon: 'wheelicon'
				},
				/*{
					command: 'ent_fire !player setmodelscale 0.1; cl_forwardspeed 50; cl_sidespeed 50; cl_backspeed 50;',
					icon: 'tinyicon'
				},
				{
					command: 'ent_fire !player setmodelscale 1.0; cl_forwardspeed 450; cl_sidespeed 450; cl_backspeed 450;',
					icon: 'resettinyicon'
				},*/
				{
					command: 'toggle auto_libretro 0 1',
					icon: 'libretroplayicon'
				},
				{
					command: 'toggle volume 0 1',
					icon: 'soundicon'
				},
				{
					command: 'toggle developer',
					icon: 'commandsicon'
				},
				{
					command: 'cloneobject',
					icon: 'cloneicon'
				},
				{
					command: 'deleteobject',
					icon: 'eraseicon'
				},
				{
					command: 'mirrorobject',
					icon: 'screenmirror'
				},
				{
					command: 'pick_texture',
					icon: 'pickericon'
				},
				{
					command: 'paint',
					icon: 'fillicon'
				},
				{
					command: 'unpaint',
					icon: 'fillreseticon'
				},
				{
					command: 'ent_remove_all prop_vehicle_airboat',
					icon: 'vehiclesremoveallicon'
				},
				{
					command: 'vehicle_menu',
					icon: 'vehiclemenuicon'
				},
				{
					command: 'task_close_entity',
					icon: 'taskcloseicon'
				},
				{
					command: 'task_close_all',
					icon: 'taskcloseallicon'
				},
				{
					command: 'toggle mat_wireframe 0 3;',
					icon: 'wireicon'
				},
				{
					command: 'look_at_me',
					icon: 'shadesicon'
				},
				{
					command: 'play_nearest_gif',
					icon: 'gificon'
				}
			];

			function findActionBarIcon(command)
			{
				for( var i = 0; i < actionBarIcons.length; i++ )
				{
					if( actionBarIcons[i].command == command )
						return actionBarIcons[i].icon;
				}

				return '';
			}

			function findCommandForAction(action)
			{
				for( var i = 0; i < commands.length; i++ )
				{
					if( commands[i].command == action )
						return commands[i];
				}

				return;
			}

			var abslotsElem = document.querySelector("#abslots");
			var abslotsRow = abslotsElem.querySelector("tr:nth-of-type(1)");
			var abslot, abslotElem;
			var commandsElem = document.querySelector("#commands");
			var command, commandElem, commandLabelElem, icon, iconHTML;
			for( var i = 0; i < commands.length; i++ )
			{
				command = commands[i];
				//<input type="button" class="aaButton aaBigButton aaTitleTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor helpNote" value="Multiplayer" onclick="" help="" disabled /><br />
				commandElem = document.createElement("div");
				//commandElem.type = "button";
				commandElem.className = "aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor helpNote";//"aaTitleTextSize aaTitleText aaThemeColorOneHoverShadedBackground aaTextColorOneColor aaThemeColorOneShadedBorderColor helpNote";

				commandLabelElem = document.createElement('div');
				commandLabelElem.style.cssText = "display: block; pointer-events: none;";
				commandElem.appendChild(commandLabelElem);

				icon = findActionBarIcon(command.command);
				if( icon != '' )
				{
					iconHTML = arcadeHud.generateIconHTML(icon + ".png", 24, 24, "aaTextColorTwoColor");
					commandLabelElem.innerHTML = iconHTML + " " + command.title;
				}
				else
				{
					iconHTML = arcadeHud.generateIconHTML("commandsicon.png", 24, 24, "aaTextColorTwoColor");
					commandLabelElem.innerHTML = iconHTML + " " + command.title;
				}
				//commandElem.innerHTML = command.title;

				commandElem.style.cssText = "letter-spacing: 0.1em; padding: 10px; border-radius: 4px; border-style: solid; border-width: 2px; display: block; margin: 4px; text-align: left;";

				commandElem.command = command;
				//commandElem.className = "command helpNote";
				commandElem.setAttribute("help", command.help);
				//commandElem.innerHTML = command.title;
				commandElem.scrollStart = -1;
				commandElem.addEventListener("mousedown", function(e)
				{
					this.scrollStart = commandsElem.scrollTop;
				}.bind(commandElem));
				commandElem.addEventListener("click", function(e)
				{
					//console.log(this.scrollStart);
					if( this.scrollStart != commandsElem.scrollTop )
						return;

					var activeElem = document.querySelector('.abslot.aaThemeColorOneBorderColor');
					if( !!activeElem )
					{
						setActionBarAction(activeElem, this.command);
						return;
					}

					if( this.command.closeMenu )
						aaapi.cmd("consoleCommand", this.command.command, true);
					else
						aaapi.cmd("consoleCommand", this.command.command);
				}.bind(commandElem));
				commandsElem.appendChild(commandElem);
			}

			var abslots = [];
			var abslotRow, abslotCol;
			var iconContainer, abslotContainer, abslotClearButton;
			for( var i = 0; i < 10; i++ )
			{
				abslot = aaapi.cmdEx("getConVarValue", "abslot" + i);
				abslots.push(abslot);

				abslotCol = document.createElement('td');

				abslotContainer = document.createElement("div");
				abslotContainer.className = "abslotContainer";

				abslotElem = document.createElement("div");
				//abslotElem.type = "button";
				abslotElem.className = "abslot aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor helpNote";

				icon = findActionBarIcon(abslot);
				if( icon != '' )
				{
					iconHTML = arcadeHud.generateIconHTML(icon + ".png", 48, 48, "aaTextColorTwoColor");
					abslotElem.innerHTML = iconHTML;
				}
				else
				{
					iconHTML = arcadeHud.generateIconHTML("commandsicon.png", 48, 48, "aaTextColorTwoColor aaHidden");
					iconContainer = document.createElement('div');
					iconContainer.style.cssText = "visibility: hidden; display: inline-block;";
					iconContainer.innerHTML = iconHTML;
					abslotElem.appendChild(iconContainer);
				}

				var command = findCommandForAction(abslot);
				if( !!command )
					abslotElem.setAttribute('help', command.help);
				else if( abslot != '' )
					abslotElem.setAttribute('help', abslot);
				else
					abslotElem.setAttribute('help', 'Empty - No command has been set for this hotkey.');

				abslotElem.abslot = abslot;
				abslotElem.abslotIndex = i;
				abslotElem.addEventListener('click', function(e)
				{
					var doToggle = (this.abslot == '');
					var activeElem = document.querySelector('.abslot.aaThemeColorOneBorderColor');
					var activeSelf = (activeElem == this);

					if( !!activeElem )
					{
						var command = findCommandForAction(this.abslot);
						if( activeSelf )
						{
							setActionBarAction(activeElem, {command: '', help: 'yadda'});
							return;
						}
						else if( !!command )
						{
							setActionBarAction(activeElem, command);
							return;
						}
						else if( this.abslot == '' )
							doToggle = true;
					}

					if( doToggle )
					{
						if( !!activeElem )
						{
							activeElem.classList.add('aaThemeColorTwoLowBorderColor');
							activeElem.classList.remove('aaThemeColorOneBorderColor');
							activeElem.clearButton.clearButtonLabel.innerHTML = 'set';
							commandsElem.classList.add('transborder');
							commandsElem.classList.remove('aaThemeColorOneBorderColor');
						}

						if( !activeSelf )
						{
							this.classList.add('aaThemeColorOneBorderColor');
							this.classList.remove('aaThemeColorTwoLowBorderColor');
							this.clearButton.clearButtonLabel.innerHTML = 'cancel';
							commandsElem.classList.add('aaThemeColorOneBorderColor');
							commandsElem.classList.remove('transborder');
						}

						return;
					}

					aaapi.cmd("consoleCommand", this.abslot, true);
				}.bind(abslotElem));
				//abslotsElem.appendChild(abslotElem);

				abslotClearButton = document.createElement("div");
				abslotClearButtonLabel = document.createElement("div");
				abslotClearButtonLabel.className = "abslotClearButtonLabel";
				abslotClearButtonLabel.innerHTML = 'set';
				abslotClearButton.appendChild(abslotClearButtonLabel);
				abslotClearButton.className = "abslotClearButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor helpNote";
				abslotClearButton.setAttribute('help', 'Set this hotkey to a different command.');
				abslotElem.clearButton = abslotClearButton;
				abslotClearButton.clearButtonLabel = abslotClearButtonLabel;

				abslotClearButton.addEventListener('click', function(e)
				{
					var activeElem = document.querySelector('.abslot.aaThemeColorOneBorderColor');
					var activeSelf = (activeElem == this);

					if( !!activeElem )
					{
						activeElem.classList.add('aaThemeColorTwoLowBorderColor');
						activeElem.classList.remove('aaThemeColorOneBorderColor');
						activeElem.clearButton.clearButtonLabel.innerHTML = 'set';
						commandsElem.classList.add('transborder');
						commandsElem.classList.remove('aaThemeColorOneBorderColor');
					}

					if( !activeSelf )
					{
						this.classList.add('aaThemeColorOneBorderColor');
						this.classList.remove('aaThemeColorTwoLowBorderColor');
						this.clearButton.clearButtonLabel.innerHTML = 'cancel';
						commandsElem.classList.add('aaThemeColorOneBorderColor');
						commandsElem.classList.remove('transborder');
					}
				}.bind(abslotElem));

				abslotContainer.appendChild(abslotClearButton);
				abslotContainer.appendChild(abslotElem);

				abslotCol.appendChild(abslotContainer);
				abslotsRow.appendChild(abslotCol);
			}

			function setActionBarAction(abslotElem, command)
			{
				var abslotClearButton = abslotElem.clearButton;
				var abslotClearButtonLabel = abslotClearButton.clearButtonLabel;
				var abslot = command.command;

				var icon = findActionBarIcon(abslot);
				if( icon != '' )
				{
					iconHTML = arcadeHud.generateIconHTML(icon + ".png", 48, 48, "aaTextColorTwoColor");
					abslotElem.innerHTML = iconHTML;
				}
				else
				{
					iconHTML = arcadeHud.generateIconHTML("commandsicon.png", 48, 48, "aaTextColorTwoColor aaHidden");

					abslotElem.innerHTML = '';

					var iconContainer = document.createElement('div');
					iconContainer.style.cssText = "visibility: hidden; display: inline-block;";
					iconContainer.innerHTML = iconHTML;
					abslotElem.appendChild(iconContainer);
				}
				abslotElem.setAttribute('help', command.help);
				abslotElem.abslot = command.command;
				aaapi.cmd("consoleCommand", "abslot" + abslotElem.abslotIndex + " \"" + command.command + "\"");

				var activeElem = document.querySelector('.abslot.aaThemeColorOneBorderColor');
				if( !!activeElem )
				{
					activeElem.classList.add('aaThemeColorTwoLowBorderColor');
					activeElem.classList.remove('aaThemeColorOneBorderColor');
					activeElem.clearButton.clearButtonLabel.innerHTML = 'set';
					commandsElem.classList.add('transborder');
					commandsElem.classList.remove('aaThemeColorOneBorderColor');
				}
			}

		</script>

		<script>
			var worldInfo = aaapi.cmdEx("getWorldInfo");
			var instance = worldInfo.instance;
			var map = worldInfo.map;

			if( !!instance )
			{
				elems = document.querySelectorAll(".instanceTitle");
				for( var i = 0; i < elems.length; i++ )
					elems[i].innerHTML = instance.title;
			}

			if( !!map )
			{
				elems = document.querySelectorAll(".mapTitle");
				for( var i = 0; i < elems.length; i++ )
					elems[i].innerHTML = map.title;
			}


			var mapImageInstance = document.querySelector(".mapImage");
			if( !!mapImageInstance && goodScreenshots.length > 0 )
			{
				var mapImageContainer = document.createElement("div");
				mapImageContainer.style.cssText = "max-width: 100%; max-height: 420px; margin-left: auto; margin-right: auto; display: none;";

				tga.open( "screenshots/" + goodScreenshots[0].id + ".tga", function(){
					var elem = tga.getCanvas();
					elem.style.cssText = "max-width: 100%; max-height: 420px; margin-left: auto; margin-right: auto; width: 100%;";
					this.appendChild(elem);
					this.style.display = "block";
				}.bind(mapImageContainer));

				mapImageInstance.appendChild(mapImageContainer);
			}
		</script>




		<style>
			#noTasksOpen
			{
				font-family: Arial;
				font-size: 20px;
				font-weight: 900;
				text-align: center;
				padding: 20px;
			}

			#noQuestsAvailable
			{
				font-family: Arial;
				font-size: 20px;
				font-weight: 900;
				text-align: center;
				padding: 20px;
			}

			/*#noEntriesInBackpack
			{
				font-family: Arial;
				font-size: 20px;
				font-weight: 900;
				text-align: center;
				padding: 20px;
			}*/

			#hiddenTasks
			{
				display: none;
			}

			#tasks, #hiddenTasks, #windowsTasks
			{
				/*max-height: 186px;*/
				overflow-y: auto;
			}

			#windowsTasks
			{
				max-height: 310px;
			}

			.taskContainer
			{
				height: 40px;
				font-family: Arial;
				font-size: 20px;
				font-weight: bold;
				letter-spacing: 0.1em;
				padding: 10px;
				border-radius: 4px;
				/*
				border: 1px solid black;
				background-color: rgba(50, 50, 100, 0.7);
				*/
			}

			#tasks::-webkit-scrollbar, #hiddenTasks::-webkit-scrollbar, #windowsTasks::-webkit-scrollbar
			{
				width: 15px;
				height: 15px;
			}

			#tasks::-webkit-scrollbar-track, #hiddenTasks::-webkit-scrollbar-track, #windowsTasks::-webkit-scrollbar-track
			{
				-webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.7);
				border-radius: 10px;
				background-color: rgba(100, 100, 100, 0.7);
			}

			#tasks::-webkit-scrollbar-thumb, #hiddenTasks::-webkit-scrollbar-thumb, #windowsTasks::-webkit-scrollbar-thumb
			{
				border-radius: 10px;
				-webkit-box-shadow: inset 0 0 6px rgba(100,100,100,1);
				background-color: #777;
			}

			#tasks::-webkit-scrollbar-corner, #hiddenTasks::-webkit-scrollbar-corner, #windowsTasks::-webkit-scrollbar-corner
			{
				background-color: transparent;
			}

			.taskCategory
			{
				display: none;
				/*background-color: rgba(50, 50, 50, 0.5);*/
				font-weight: bold;
				font-family: Arial;
				-webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.9);
				border-radius: 4px;
				height: 40px;
				padding-left: 10px;
			}

			.taskCategoryTitle
			{
				font-size: 16px;
				padding: 10px;
				letter-spacing: 0.2em;
				font-style: italic;
				display: inline-block;
			}

			.taskAllButton
			{
				font-size: 16px;
				padding: 10px;
				letter-spacing: 0.2em;
				font-style: italic;
				display: inline-block;
				float: right;
			}

			.windowsButton
			{

				display: inline-block;
				border: 2px solid transparent;
				vertical-align: top;
				padding: 3px;
				border-radius: 5px;
			}

			.taskButton
			{
				background: none;
				display: inline-block;
				border-style: solid;
				border-width: 0;
				vertical-align: top;
				padding: 3px;
				border-radius: 5px;
			}

			.displayed .taskButton.displayIcon
			{
				background-color: rgba(50, 200, 50, 0.8);
			}

			.taskButton:hover
			{
				background-color: rgba(150, 150, 150, 0.8);
			}

			.taskTitle
			{
				width: 85%;
				height: 100%;
				line-height: 40px;
				white-space: nowrap;
				overflow: hidden;
			}

			.tab
			{
				border-radius: 0 0 10px 10px;
				white-space: nowrap;
				font-size: 18px;
				text-align: center;
				vertical-align: middle;
				font-family: Arial;
				padding: 5px;
				font-style: italic;
				text-shadow: 2px 2px 2px #000;
				font-weight: bold;
				border-collapse: separate;
				border-spacing: 0;
				padding: 5px;
				display: inline-block;
				-webkit-box-shadow: 3px 5px 8px #000;
				margin-top: -2px;
				/*
				margin-left: 1px;
				margin-right: 1px;
				*/
				color: #aaa;
				border: 3px solid #000;
				background-color: rgba(50, 50, 50, 0.9);
			}

			.tab:hover
			{
				color: #fff;
				background-color: rgba(70, 70, 70, 0.9);
			}

			.tabOn
			{
				background-color: rgba(250, 50, 50, 0.7);
			}

			.tabOn:hover
			{
				background-color: rgba(250, 50, 50, 0.9);
			}

			.iconsContainer
			{
				/*display: none;*/
				display: inline-block;
				visibility: hidden;
			}

			.taskContainer:hover .iconsContainer
			{
				/*display: inline-block;*/
				visibility: visible;
			}
		</style>



		<script>
			var context;
			var type;
			var response;
			var scrollTriggerParent;
			function livingScroll(e)
			{
				//console.log(usedEntries + " vs " + cacheSize);
				if( !!!queryId || usedEntries != cacheSize )
					return;

				var isShowingList = (queryId == "favlist");

				// only handle searches, for now...
				if( !isShowingList && (!!!response || response.success !== true) )
					return;

				if( !!!scrollTriggerParent )
					scrollTriggerParent = scrollTrigger.parentNode;

				var scrollElem = scrollTriggerContainer;
				var scrollRect = scrollTriggerParent.getBoundingClientRect();
				var containerTop = scrollRect.top;
				var containerBottom = containerTop + scrollRect.height;

				var rect = scrollElem.getBoundingClientRect();
				//console.log(rect.top + ' vs ' + containerBottom);
				if( rect.top <= containerBottom )//rect.top <= containerBottom && rect.bottom >= containerTop )
				{
					//console.log("auto-scroll more!");
					usedEntries = Math.round(cacheSize - (cacheSize/1));	// this is where you'd tone down the percentage

					if( !isShowingList )
					{
						var active = document.querySelector('.modeIconContainerActive');
						context = (!!active) ? active.getAttribute('mode') : 'items';

						// Added to fix the repeating 1st result by burning the top result.
						if( context == "maps" )
						{
							response = g_allFoundMapsCached[g_lastUsedMapResult];
							if( !!!response )
								response = {success: false};
							else
								response = {success: true, entry: response};
						}
						else if( (context === "items" || context === "models") )
						{
							response = (context === "items") ? aaapi.cmdEx("findNextLibraryEntry", queryId, "items") : aaapi.cmdEx("findNextLibraryEntry", queryId, "models");
						}

						// Then actually do the next result
						doNextResult(context, response);
					}
					else
					{
						//var librarySearchMax = localStorage.getItem("librarysearchmax");
						//if( !!!librarySearchMax )
						//	librarySearchMax = "40";

						var zoomValue = zoomSlider.value;
						//cacheSize = parseInt(librarySearchMax);

						var fullCacheSize = 20;
						//if( zoomValue == -2 )
						//	fullCacheSize = 14;
						//else
						if( zoomValue == -1 )
							fullCacheSize = 120;
						else if( zoomValue == 0 )
							fullCacheSize = 56;
						else if( zoomValue == 1 )
							fullCacheSize = 20;

						//if( fullCacheSize < cacheSize )
							cacheSize = fullCacheSize;

						//cacheSize += fullCacheSize;
						usedEntries = 0;
						intervalFetch();
					}
				}
			}

			var types = aaapi.cmdEx("getAllLibraryTypes");
			var response = aaapi.cmdEx("getAllTasks", true);	// param is supposed to update thumbnails, doesn't work yet. No thumbnails for tasks yet.
			var tasks = response.tasks;
			var windowsTasks = response.windowsTasks;
			
			var scrollTriggerContainer = document.querySelector("#scrollTrigger");
			scrollTriggerContainer.parentNode.addEventListener('scroll', livingScroll);

			var listItemsContainer = document.querySelector("#listItems");
			//var listPropsContainer = document.querySelector("#listProps");
			var listPropsContainer = listItemsContainer;
			var listMapsContainer = listItemsContainer;
			var listScreenshotsContainer = listItemsContainer;
			var listFavoritesContainer = listItemsContainer;

			var backpackContainer = document.querySelector("#backpack");

			var tasksContainer = document.querySelector("#tasks");
			var toggleTasksButton = document.querySelector("#toggleTasksButton");

			var windowsTasksContainer = document.querySelector("#windowsTasks");
			var toggleWindowsTasksButton = document.querySelector("#toggleWindowsTasksButton");

			var hiddenWindowsTasksContainer = document.querySelector("#hiddenTasks");
			var toggleHiddenTasksButton = document.querySelector("#toggleHiddenTasksButton");

			function toggleHiddenTasks(elem)
			{
				var hidden = (hiddenWindowsTasksContainer.style.display === "none");
				if( !!elem )
				{
					if( hidden )
						elem.innerHTML = "DON'T SHOW HIDDEN";
					else
						elem.innerHTML = "SHOW HIDDEN";
				}

				if( hidden )
					hiddenWindowsTasksContainer.style.display = "block";
				else
					hiddenWindowsTasksContainer.style.display = "none";
			}

			function toggleCategory(elem, category)
			{
				var categoryElem = document.querySelector("#" + category);
				var isHidden = (categoryElem.style.display === "none");

				if( isHidden )
				{
					elem.src = "expand.png";
					categoryElem.style.display = "block";
					sessionStorage.setItem("taskMenu_" + category, "block");
				}
				else
				{
					elem.src = "collapse.png";
					categoryElem.style.display = "none";
					sessionStorage.setItem("taskMenu_" + category, "none");
				}
			}

			function toggleExtraPanel()
			{
				var elem = extraPanel;
				/*
				if( extraPanel.style.display !== "none" )
					extraPanel.style.display = "none";
				else
					extraPanel.style.display = "initial";
				*/

				var isHidden = (elem.style.display === "initial");
				if( isHidden )
				{
					elem.style.display = "none";
					sessionStorage.setItem("extraPanel", "none");
				}
				else
				{
					elem.style.display = "initial";
					sessionStorage.setItem("extraPanel", "initial");
				}
			}

			// session storage to remember UI stuff
			var menuSettings = 
			{
				"taskMenu_tasks": "block",
				"taskMenu_windowsTasks": "block",
				"taskMenu_hiddenTasks": "none"
			};

			var menuSettingVal;
			var menuSettingsKeys = Object.keys(menuSettings);
			for( var i = 0; i < menuSettingsKeys.length; i++ )
			{
				menuSettingVal = sessionStorage.getItem(menuSettingsKeys[i]);
				if( !!menuSettingVal && menuSettingVal !== "" )
					menuSettings[menuSettingsKeys[i]] = menuSettingVal;
			}

			if( menuSettings["taskMenu_tasks"] !== windowsTasksContainer.style.display )
				toggleCategory(toggleTasksButton, "tasks");

			if( menuSettings["taskMenu_windowsTasks"] !== windowsTasksContainer.style.display )
				toggleCategory(toggleWindowsTasksButton, "windowsTasks");

			if( menuSettings["taskMenu_hiddenTasks"] !== hiddenWindowsTasksContainer.style.display )
				toggleCategory(toggleHiddenTasksButton, "hiddenTasks");

			var numExpectedHiddenTasks = 0;
			for( var i = 0; i < tasks.length; i++ )
			{
				if( tasks[i].isHiddenTask && !tasks[i].isWindowsTask )
					numExpectedHiddenTasks++;
			}

			if( tasks.length <= numExpectedHiddenTasks )
			{
				//document.querySelector("#closeAllButton").style.display = "none";	// obsolete
				document.querySelector("#noTasksOpen").style.display = "block";
			}
			else
				document.querySelector("#noTasksOpen").style.display = "none";

			var task, taskContainer, taskElem, iconsContainer, iconButton, iconImage;
			/*
			if( true )	// WINDOWS
			{
				// NON-HIDDEN WINDOWS
				for( var i = 0; i < windowsTasks.length; i++ )
				{
					task = windowsTasks[i];

					if( task.isHiddenTask )
						continue;

					taskContainer = document.createElement("div");
					taskContainer.className = "taskContainer";
					//taskContainer.style.cssText = "height: 40px; font-family: Arial; font-size: 20px; font-weight: bold; letter-spacing: 0.1em; padding: 10px; border-radius: 10px; border: 1px solid black; background-color: rgba(50, 50, 100, 0.7);";

					if( task.isDisplayTask )
						taskContainer.className += " displayed";

					taskElem = document.createElement("div");
					taskElem.className = "taskTitle";
					//taskElem.innerHTML = "<img src='windows.png?cahce=busted' style='vertical-align: middle;' /> " + task.title;
					taskElem.innerHTML = task.title;

					iconsContainer = document.createElement("div");
					iconsContainer.style.cssText = "float: right;";

					iconButton = document.createElement("div");
					iconButton.className = "windowsButton helpNote";
					iconButton.setAttribute("help", "This is a Windows task.  AArcade does NOT have control over it.");
					iconButton.style.cssText = "margin-right: 8px;";
					iconButton.taskId = task.id;
					iconImage = document.createElement("img");
					iconImage.src = "windowsicon.png";
					iconButton.appendChild(iconImage);
					iconsContainer.appendChild(iconButton);

					iconButton = document.createElement("div");
					iconButton.className = "taskButton helpNote";
					iconButton.setAttribute("help", "Switch to this Windows task.");
					iconButton.style.cssText = "margin-right: 8px;";
					iconButton.taskId = task.id;
					iconButton.addEventListener("click", function(e)
					{
						aaapi.cmd("switchToTask", this.taskId);
						var slate = document.createElement("div");
						slate.style.cssText = "position: absolute; left: 0; right: 0; top: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.9);"
						document.body.appendChild(slate);

						var elem = document.createElement("div");
						elem.style.cssText = "font-family: Arial; font-weight: bold; font-size: 30px; position: absolute; text-align: center; width: 200px; position: absolute;";
						elem.style.left = e.clientX - 100 + "px";
						elem.style.top = e.clientY - 50 + "px";
						elem.innerHTML = "Release TAB";
						document.addEventListener("mousemove", function(e)
						{
							this.style.left = e.clientX - 100 + "px";
							this.style.top = e.clientY - 50 + "px";
						}.bind(elem), true);

						document.body.appendChild(elem);
					});
					iconImage = document.createElement("img");
					iconImage.src = "switchicon.png";
					iconButton.appendChild(iconImage);
					iconsContainer.appendChild(iconButton);

					iconButton = document.createElement("div");
					iconButton.className = "taskButton displayIcon helpNote";
					iconButton.setAttribute("help", "Hide this Windows task, so it doesn't appear on this menu any more.");
					iconButton.style.cssText = "margin-right: 8px;";
					iconButton.taskId = task.id;
					iconButton.addEventListener("click", function()
					{
						//aaapi.cmd("displayTask", this.taskId);
						aaapi.cmd("hideTask", this.taskId);
						location.reload();
					});
					iconImage = document.createElement("img");
					//iconImage.className = "displayIcon";
					iconImage.src = "minusicon.png";
					iconButton.appendChild(iconImage);
					iconsContainer.appendChild(iconButton);

					taskContainer.appendChild(iconsContainer);

					taskContainer.appendChild(taskElem);
					windowsTasksContainer.appendChild(taskContainer);
				}

				// HIDDEN WINDOWS
				for( var i = 0; i < windowsTasks.length; i++ )
				{
					task = windowsTasks[i];

					if( !task.isHiddenTask || task.isPresetHidden )
						continue;

					taskContainer = document.createElement("div");
					taskContainer.className = "taskContainer";
					taskContainer.style.cssText = "height: 40px; font-family: Arial; font-size: 20px; font-weight: bold; letter-spacing: 0.1em; padding: 10px; border-radius: 10px; border: 1px solid black; background-color: rgba(50, 50, 100, 0.7);";

					if( task.isDisplayTask )
						taskContainer.className += " displayed";

					taskElem = document.createElement("div");
					taskElem.className = "taskTitle";
					//taskElem.innerHTML = "<img src='windows.png?cahce=busted' style='vertical-align: middle;' /> " + task.title;
					taskElem.innerHTML = task.title;

					iconsContainer = document.createElement("div");
					iconsContainer.style.cssText = "float: right;";

					iconButton = document.createElement("div");
					iconButton.className = "windowsButton helpNote";
					iconButton.setAttribute("help", "This is a Windows task.  AArcade does NOT have control over it.");
					iconButton.style.cssText = "margin-right: 8px;";
					iconButton.taskId = task.id;
					iconImage = document.createElement("img");
					iconImage.src = "windowsicon.png";
					iconButton.appendChild(iconImage);
					iconsContainer.appendChild(iconButton);

					iconButton = document.createElement("div");
					iconButton.className = "taskButton helpNote";
					iconButton.setAttribute("help", "Switch to this Windows task.");
					iconButton.style.cssText = "margin-right: 8px;";
					iconButton.taskId = task.id;
					iconButton.addEventListener("click", function(e)
					{
						aaapi.cmd("switchToTask", this.taskId);
						var slate = document.createElement("div");
						slate.style.cssText = "position: absolute; left: 0; right: 0; top: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.9);"
						document.body.appendChild(slate);

						var elem = document.createElement("div");
						elem.style.cssText = "font-family: Arial; font-weight: bold; font-size: 30px; position: absolute; text-align: center; width: 200px; position: absolute;";
						elem.style.left = e.clientX - 100 + "px";
						elem.style.top = e.clientY - 50 + "px";
						elem.innerHTML = "Release TAB";
						document.addEventListener("mousemove", function(e)
						{
							this.style.left = e.clientX - 100 + "px";
							this.style.top = e.clientY - 50 + "px";
						}.bind(elem), true);

						document.body.appendChild(elem);
					});
					iconImage = document.createElement("img");
					iconImage.src = "switchicon.png";
					iconButton.appendChild(iconImage);
					iconsContainer.appendChild(iconButton);

					iconButton = document.createElement("div");
					iconButton.className = "taskButton displayIcon helpNote";
					iconButton.setAttribute("help", "Unhide this Windows task, so it appears in AArcade's Task Menu again.");
					iconButton.style.cssText = "margin-right: 8px;";
					iconButton.taskId = task.id;
					iconButton.addEventListener("click", function()
					{
						aaapi.cmd("unhideTask", this.taskId);
						location.reload();
					});
					iconImage = document.createElement("img");
					//iconImage.className = "displayIcon";
					iconImage.src = "plusicon.png";
					iconButton.appendChild(iconImage);
					iconsContainer.appendChild(iconButton);

					taskContainer.appendChild(iconsContainer);

					taskContainer.appendChild(taskElem);
					hiddenWindowsTasksContainer.appendChild(taskContainer);
				}
			}
			*/

			// AARCADE TASKS
			var numTasks = 0;
			for( var i = 0; i < tasks.length; i++ )
			{
				task = tasks[i];

				if( task.isHiddenTask )
					continue;

				numTasks++;

				taskContainer = document.createElement("div");

				taskContainer.className = "taskContainer aaTitleTextSize aaTitleText";
				if( task.isDisplayTask )
					taskContainer.className += " displayed aaThemeColorOneHoverShadedBackground aaThemeColorOneShadedBorderColor";
				else
					taskContainer.className += " aaThemeColorTwoHoverShadedBackground aaThemeColorOneShadedBorderColor";

				taskContainer.style.cssText = "font-family: Arial; font-weight: bold; letter-spacing: 0.1em; padding: 10px; border-radius: 4px; border-style: solid; border-width: 2px; cursor-events: all; margin-top: 4px; margin-bottom: 4px; box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); margin-right: 4px; cursor: pointer;";

				taskElem = document.createElement("div");

				var taskImageContainer = document.createElement("div");
				taskImageContainer.style.cssText = "display: inline-block; margin-right: 10px; vertical-align: top; width: 90px; height: 38px; text-align: center; box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);";

				var taskImage = document.createElement("img");
				taskImage.style.display = "none";
				//taskImage.style.cssText = "display: inline-block; max-width: 90px; max-height: 40px;";
				var taskItem = aaapi.cmdEx("getLibraryItem", task.itemId);
				taskImage.item = taskItem;
				taskImageContainer.appendChild(taskImage);
				taskElem.appendChild(taskImageContainer);
				taskElem.image = taskImage;
				taskContainer.addEventListener("mouseover", function(e)
				{
					if(false && !!this.image.ready)
					{
						var table = document.querySelector("#dummyMarker").parentNode.parentNode.parentNode.parentNode;
						table.style.background = "transparent url('" + this.image.src + "') center scroll no-repeat";
						table.style.backgroundSize = "cover";
					}
					e.preventDefault();
				}.bind(taskElem), true);

				//if( task.isDisplayTask )
				//{
					arcadeHud.loadItemBestImage(taskImage, taskImage.item, function()
					{
						this.ready = true;

						var imageContainer = this.parentNode;
						imageContainer.style.background = "transparent url('" + this.src + "') center";
						imageContainer.style.backgroundSize = "cover";
						//console.log(imageContainer.style.background);
						/*
						if( false && extraPanel.style.display !== "none" )
						{
							var table = document.querySelector("#dummyMarker").parentNode.parentNode.parentNode.parentNode;
							console.log(table.tagName);
							table.style.background = "transparent url('" + this.src + "')";
							table.style.backgroundSize = "cover";
						}
						*/
					}.bind(taskImage));
				//}
				//else
				//{
				//	arcadeHud.loadItemBestImage(taskImage, taskImage.item, function()
				//	{
				//		this.ready = true;

				//		var imageContainer = this.parentNode;
				//		imageContainer.style.background = "transparent url('" + this.src + "') center";
				//		imageContainer.style.backgroundSize = "cover";
				//	});
				//}

				if( task.isDisplayTask )
					taskElem.className = "taskTitle aaTextColorOneColor";
				else
				{
					taskElem.className = "taskTitle aaTextColorTwoColor";
					taskElem.style.cssText += " text-shadow: none;";
				}

				var textNode = document.createTextNode(task.itemTitle);
				taskElem.appendChild(textNode);
				//taskElem.innerHTML += task.itemTitle;
				//taskElem.innerHTML = task.title;

				taskElem.addEventListener("click", function(e)
				{
					//aaapi.cmd("selectTaskObject", this.id);
					aaapi.cmd("displayTask", this.id);
					aaapi.cmd("deactivateInputMode");
				}.bind(task));

				iconsContainer = document.createElement("div");
				iconsContainer.className = "iconsContainer";
				iconsContainer.style.cssText = "float: right;";

				/*
				iconButton = document.createElement("div");
				iconButton.className = "taskButton aaThemeColorOneHoverShadedBackground helpNote";
				iconButton.setAttribute("help", "Select this task's object.");
				iconButton.style.cssText = "margin-right: 8px;";
				iconButton.taskId = task.id;
				iconButton.addEventListener("click", function()
				{
					aaapi.cmd("selectTaskObject", this.taskId);
				});
				iconImage = document.createElement("img");
				iconImage.src = "objecticon.png";
				iconButton.appendChild(iconImage);
				iconsContainer.appendChild(iconButton);
				*/

				/*
				if( !task.isDisplayTask )
				{
					iconButton = document.createElement("div");
					iconButton.className = "taskButton aaThemeColorOneHoverShadedBackground helpNote displayIcon";
					iconButton.setAttribute("help", "Show this task on all slave screens.");
					iconButton.style.cssText = "margin-right: 8px;";
					iconButton.taskId = task.id;
					iconButton.addEventListener("click", function()
					{
						aaapi.cmd("displayTask", this.taskId);
						aaapi.cmd("deactivateInputMode");
					});
					iconImage = document.createElement("img");
					iconImage.src = "eye.png";
					iconButton.appendChild(iconImage);
					iconsContainer.appendChild(iconButton);
				}
				*/

				iconButton = document.createElement("div");
				//if( !task.isDisplayTask )
				//	iconButton.className = "taskButton aaThemeColorTwoHoverShadedBackground helpNote";
				//else
					iconButton.className = "taskButton aaThemeColorOneHoverShadedBackground helpNote";

				iconButton.setAttribute("help", "Close this in-game task.");
				iconButton.style.cssText = "margin-right: 8px;";
				iconButton.taskId = task.id;
				iconButton.addEventListener("click", function()
				{
					aaapi.cmd("closeTask", this.taskId);
					aaapi.cmdEx("threadBlock");	// wait for the engine to catch up.
					location.reload();
				});
				iconImage = document.createElement("img");
				iconImage.src = "close.png";
				iconButton.appendChild(iconImage);
				iconsContainer.appendChild(iconButton);

				taskContainer.appendChild(iconsContainer);

				taskContainer.appendChild(taskElem);
				tasksContainer.appendChild(taskContainer);
			}

			document.querySelector("#taskCount").innerHTML = numTasks//'(' +  + ')';
		</script>

		<style>
			.hotshot
			{
				display: inline-block;
				padding: 4px;
				/*background-color: rgba(0, 0, 0, 0.9);*/
				border-width: 3px;
				border-style: solid;
				border-radius: 4px;
				border-color: transparent;
				margin: 4px;
			}

			.hotshot:hover
			{
				/*border-color: white;*/
				/*
				background-color: rgba(192, 35, 35, 0.8);
				*/
			}

			.trashButtonContainer
			{
				display: none;
			}

			.hotshot:hover .trashButtonContainer
			{
				display: block;
			}

			.panel
			{
				display: none;
			}

			.panelActive
			{
				display: block;
			}
		</style>

		<script>
			// Add the "take new screenshot" button to the front of the list.
			var screenshotElem = document.createElement("div");
			screenshotElem.className = "hotshot aaThemeColorOneHoverShadedBackground aaThemeColorOneShadedBorderColor helpNote";
			screenshotElem.style.cssText = "width: 240px; height: 135px;";
			screenshotElem.setAttribute("help", "Capture a new screenshot from your current position.");
			screenshotElem.addEventListener("click", function()
			{
				createModalScreenshotConfirm('Create Screenshot', 'Wubalubadubdub.', 'canceledCreateScreenshot();', 'confirmedCreateScreenshot("yadda");');
				/*
				aaapi.cmd("takeScreenshot");
				window.location='asset://ui/tabMenu.html?tab=screenshots';
				*/
			}.bind(screenshotElem));

			var objectIconHTML = arcadeHud.generateIconHTML("objecticon.png", 24, 24, "aaThemeColorOneColor");

			function onSpawnClick()
			{
				if(!givenTabId || givenTabId === "tasks")
					aaapi.cmd("consoleCommand", "ignore_next_tab_up 1");

				//aaapi.cmd("setLibraryBrowserContext", contextCategory, '', libSearchInput.value, typeSelect.value);
				//console.log("MOde: " + this.mode + ", Text: " + this.searchText + ", Type: " + typeSelect.type);
				arcadeHud.spawnItem(this.mode, this.itemId, libSearchInput.value, typeSelect.value);
			}


			// from https://stackoverflow.com/questions/23104582/scaling-an-image-to-fit-on-canvas
			function drawImageScaled(img, canvas)
			{
				var ctx = canvas.getContext('2d');
				var hRatio = canvas.width  / img.width    ;
				var vRatio =  canvas.height / img.height  ;
				var ratio  = Math.max ( hRatio, vRatio );
				var centerShift_x = ( canvas.width - img.width*ratio ) / 2;
				var centerShift_y = ( canvas.height - img.height*ratio ) / 2;  
				ctx.clearRect(0,0,canvas.width, canvas.height);
				ctx.drawImage(img, 0,0, img.width, img.height,
				centerShift_x,centerShift_y,img.width*ratio, img.height*ratio);  
			}

			var elem = document.createElement("img");
			elem.style.cssText = "width: 240px; height: 135px;";
			elem.src = "takeshot.png";

			screenshotElem.appendChild(elem);
			screenshotListElem.appendChild(screenshotElem);

			var trashButtonContainer;
			var trashButton;
			for( var i = 0; i < goodScreenshots.length; i++ )
			{
				screenshot = goodScreenshots[i];
				screenshotElem = document.createElement("div");
				screenshotElem.className = "hotshot aaThemeColorOneHoverShadedBackground aaThemeColorOneShadedBorderColor helpNote";

				//if( !!!universeInfo || universeInfo.isHost )
				//{
					spawnButtonContainer = document.createElement("div");
					screenshotElem.appendChild(spawnButtonContainer);
					spawnButtonContainer.className = "helpNote";
					spawnButtonContainer.setAttribute("help", "Spawn this shortcut as an object in your current arcade.");
					spawnButtonContainer.style.cssText = "display: block; position: relative;";
					//spawnButtonContainer.style.cssText = "position: relative;";

					spawnButton = document.createElement("div");
					spawnButton.container = screenshotElem;
					spawnButton.style.cssText = "position: absolute;";
					spawnButton.screenshot = screenshot;
					//spawnButton.map = mapsList[x];
					spawnButton.addEventListener("click", function(e)
					{
						e.stopImmediatePropagation();

						var screenshot = this.screenshot;
						var mapFile = "";
						if(!!screenshot && !!screenshot.map && !!screenshot.map.file && screenshot.map.file !== "")
							mapFile = screenshot.map.file.substring(0, screenshot.map.file.lastIndexOf("."));
						else if( !!this.map && !!this.map.platforms && !!this.map.platforms[arcadeHud.platformId] && !!this.map.platforms[arcadeHud.platformId].file && this.map.platforms[arcadeHud.platformId].file !== "" )
							mapFile = this.map.platforms[arcadeHud.platformId].file.substring(0, this.map.platforms[arcadeHud.platformId].file.lastIndexOf("."));

						if( mapFile !== "" )
						{
							var smartTitle = "";
							var smartURL = "travel.html?mapfile=" + mapFile;

							var title = "";
							if( !!screenshot && !!screenshot.instance && !!screenshot.instance.title && screenshot.instance.title !== "" )
								title = screenshot.instance.title;
							else if( !!this.map && !!this.map.title && this.map.title !== "" )
								title = this.map.title;
							else if( mapFile !== "" )
								title = mapFile;

							if( title !== "" )
							{
								smartTitle = "Jump To: " + title;

								if( !!screenshot )
								{
									//console.log(JSON.stringify(screenshot));
									smartURL += "&screenshot=" + screenshot.id;
									smartURL += "&pos=" + screenshot.body.position;
									smartURL += "&rot=" + screenshot.body.rotation;
									smartURL += "&instance=" + screenshot.instance.id.substring(2);
								}

								//console.log(smartTitle);
								//console.log(smartURL);

								aaapi.cmd("setLibraryBrowserContext", "items", "", "", "");
					//	aaapi.cmd("addToastMessage", "Not found in arcade.");
								document.location = "asset://ui/createItem.html?fileLocation=" + encodeURIComponent(smartURL) + "&title=" + encodeURIComponent(smartTitle) + "&type=" + encodeURIComponent("-ohTuY-Me2QaaNaxvi6H");
							}
						}
					}.bind(spawnButton));
					spawnButton.innerHTML = objectIconHTML;
					spawnButtonContainer.appendChild(spawnButton);
				//}


				trashButtonContainer = document.createElement("div");
				trashButtonContainer.className = "trashButtonContainer helpNote";
				trashButtonContainer.setAttribute("help", "Delete this screenshot.");
				trashButtonContainer.style.cssText = "position: relative; float: right; left: -36px; top: 4px;";

				trashButton = document.createElement("div");
				trashButton.className = "aaThemeColorOneHoverShadedBackground";
				trashButton.style.cssText = "position: absolute; padding: 4px; border-radius: 4px;";
				var iconSize = arcadeHud.themeSizes.IconSize;
				var html = arcadeHud.generateIconHTML("close.png", iconSize, iconSize, "aaTextColorOneColor");
				trashButton.innerHTML = html;
				trashButton.shotId = screenshot.id;
				trashButton.addEventListener("click", function(e)
				{
					e.stopImmediatePropagation();
					createModalConfirm('Delete Screenshot', 'Are you sure?', 'canceledDeleteScreenshot();', 'confirmedDeleteScreenshot("' + this.shotId + '");');
				}.bind(trashButton), true);

				trashButtonContainer.appendChild(trashButton);
				screenshotElem.appendChild(trashButtonContainer);

				screenshotElem.screenshot = screenshot;
				screenshotElem.screenshotId = screenshot.id;
				screenshotElem.setAttribute("help", "Teleport to this location.");
				screenshotElem.addEventListener("click", function(clickEvent)
				{
					var parentElem = clickEvent.currentTarget;
					var img = document.createElement('img');
					img.screenshotId = this.screenshotId;

					function onImageDone()
					{
						var rect = parentElem.getBoundingClientRect();
						img.style.cssText = 'position: absolute; -webkit-transition: all 0.5s ease-in-out; z-index: 100; top: ' + rect.top + 'px; left: ' + rect.left + 'px; width: ' + rect.width + 'px; height: ' + rect.height + 'px';
						document.body.appendChild(img);
						img.offsetHeight;
						img.style.width = window.innerWidth + 'px';
						img.style.height = window.innerHeight + 'px';
						img.style.top = '0px';
						img.style.left = '0px';
						img.style.opacity = '1';
						setTimeout(function()
						{
							var screenshot = this.screenshot;
							// update our entry in the mapHistory
							var mapHistory = arcadeHud.getMapHistory();
							var mapHistoryEntry = mapHistory[screenshot.map.id.substring(2)];
							if( !!mapHistoryEntry )
							{
								//mapHistoryEntry.position = screenshot.body.position;
								//mapHistoryEntry.rotation = screenshot.body.rotation;
								//mapHistoryEntry.screenshotId = screenshot.id;
								mapHistoryEntry.instanceId = screenshot.instance.id.substring(2);
								mapHistoryEntry.position = screenshot.body.position;
								mapHistoryEntry.rotation = screenshot.body.rotation;
								mapHistoryEntry.screenshotId = screenshot.id;
								mapHistoryEntry.timestamp = new Date().getTime();
							}
							else
							{
								mapHistoryEntry = {
									"mapId": screenshot.map.id.substring(2),
									"instanceId": screenshot.instance.id.substring(2),
									"position": screenshot.body.position,
									"rotation": screenshot.body.rotation,
									"screenshotId": screenshot.id,
									"timestamp": new Date().getTime()
								};
							}

							// save the mapHistory out
							localStorage.setItem("mapHistory", JSON.stringify(mapHistory));

							// actually teleport.  takes a second to drop down still.
							aaapi.cmd("teleportScreenshot", img.screenshotId.toLowerCase(), false);

							// hide everything in the body other than img
							var allElems = document.querySelectorAll('body > *');
							for( var i = 0; i < allElems.length; i++ )
							{
								if( allElems[i] == img )
									continue;

								allElems[i].style.display = 'none';
							}

							setTimeout(function()
							{
								img.style.opacity = 0;
								setTimeout(function()
								{
									aaapi.cmd("deactivateInputMode", false);
								}, 500);
							}, 100);
						}.bind(this), 500);
					}
					img.addEventListener('load', function()
					{
						onImageDone.call(this);
					}.bind(this));
					img.addEventListener('error', function()
					{
						onImageDone.call(this);
					}.bind(this));

					if( this.screenshot.hasBigFile != 0 )
						img.src = 'screenshots/' + this.screenshotId.toLowerCase() + '.jpg';
					else
					{
						tga.open( 'screenshots/' + this.screenshotId.toLowerCase() + '.tga', function()
						{
							img.src = tga.getCanvas().toDataURL('image/jpeg', 0.9);
						});
					}

					//console.log("screenshots/" + screenshot.id + ".tga");
					/*
					// update our spawn location (but not our map last loaded timestamp) in mapHistory
					var mapHistory = (localStorage.getItem("mapHistory")) ? JSON.parse(localStorage.getItem("mapHistory")) : {};

					// update our entry in the mapHistory
					var mapHistoryEntry = mapHistory[worldInfo.map.info.id];
					if( !!mapHistoryEntry )
					{
						mapHistoryEntry.position = this.screenshot.body.position;
						mapHistoryEntry.rotation = this.screenshot.body.rotation;
						mapHistoryEntry.screenshotId = this.screenshot.id;

						//var mapHistoryEntry = {
						//	"mapId": mapId,
						//	"instanceId": instanceId,
						//	"position": position,
						//	"rotation": rotation,
						//	"screenshotId": screenshotId,
						//	"timestamp": new Date().getTime()
						//};
					}

					// save the mapHistory out
					localStorage.setItem("mapHistory", JSON.stringify(mapHistory));
					aaapi.cmd("teleportScreenshot", this.screenshotId.toLowerCase(), true);
					*/
				}.bind(screenshotElem));

				screenshotElem.style.cssText = "width: 240px; height: 135px;";
				tga.open( "screenshots/" + screenshot.id + ".tga", function()
				{
					var elem = tga.getCanvas();
					elem.style.cssText = "width: 240px; height: 135px;";
					this.appendChild(elem);
				}.bind(screenshotElem));

				screenshotListElem.appendChild(screenshotElem);
			}
		
			/*

				<div class="aaTitleText aaTitleTextSizeFontSize aaTitleSizeFontSize aaThemeColorOneColor">Your World</div>
				<div class="aaThemeColorOneHoverShadedBackground aaThemeColorOneShadedBorderColor" style="border-style: solid; border-width: 2px; padding: 10px; border-radius: 6px; display: inline-block; box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);">
					<div class="mapImage aaThemeColorOneInverseShadedBorderColor" style="width: 240px; height: 135px; border-width: 2px; border-style: solid; border-radius: 4px;"></div>
					<div class="mapTitle aaTitleText aaTitleTextSizeFontSize aaTextColorOneColor"></div>
					<div class="instanceTitle aaTitleTextSizeFontSize"></div>
				</div>

			*/

			//var worldsContainer = document.querySelector("#worldsContainer");
			//worldsContainer.innerHTML = "TODO: Progressively get every map & a screenshot to go with it.";

			var backpackEntries = arcadeHud.favorites;

			var backpackMapEntries;
			backpackMapEntries = localStorage.getItem("myBackpackMaps");
			if( !!backpackMapEntries )
				backpackMapEntries = JSON.parse(backpackMapEntries);
			else
				backpackMapEntries = [];

			var g_hiddenMaps = localStorage.getItem("hiddenMaps");
			if( !!g_hiddenMaps )
				g_hiddenMaps = JSON.parse(g_hiddenMaps);
			else
				g_hiddenMaps = {};

			/*backpackEntries = localStorage.getItem("myBackpack");
			if( !!backpackEntries )
				backpackEntries = JSON.parse(backpackEntries);
			else
				backpackEntries = [];*/

			function sortModelsToBack(a, b)
			{
				if( !!a.item && !!!b.item )
					return -1;
				else if( !!b.item && !!!a.item )
					return 1;
				// else don't alter order.
			}

			backpackEntries.sort(sortModelsToBack);

			var typeIconSize = "38px";

			var listLoading = document.querySelector("#listLoading");
			var objectInspectLoading = document.querySelector('#objectInspectLoading');
			//var panelLoading = document.querySelector('#panelLoading');

			var listItems = document.querySelector("#listItems");
			var listProps = document.querySelector("#listProps");
			var listMaps = document.querySelector("#listMaps");
			var listScreenshots = document.querySelector("#listScreenshots");
			var listFavorites = document.querySelector("#listFavorites");
			var listServers = document.querySelector("#listServers");
			var emptyList = document.querySelector("#emptyList");

			function onFavoritesClick(e)
			{
				var oldMode;
				var oldActive = document.querySelector('.modeIconContainerActive');
				if( !!oldActive )
				{
					oldActive.classList.remove('modeIconContainerActive');
					oldMode = oldActive.getAttribute('mode');
				}

				var context = 'items';
				var active = document.querySelector('.modeIconContainer[mode=' + context + ']');
				if( !!active )
					active.classList.add('modeIconContainerActive');



				// do nothing for now
				var listId = e.item.info.id;
				listSelect.value = listId;
				
				//var listId = listSelect.options[listSelect.selectedIndex].value;
				//if( listId != '' )
				//{
					if( listSelect.options[0].value == '' )
						listSelect.removeChild(listSelect.options[0]);

					typeSelect.selectedIndex = 0;
					libSearchInput.value = '';

					aaapi.cmd("setLibraryBrowserContext", 'items', '', '', '');

					showList(listId);
				//}
				//else
				//	doSearch(libSearchInput.value);
			}

			function appendBackpackEntry(backpackEntry, contextType)
			{
				if( !gridViewOption )
				{
					backpackEntryContainer = document.createElement("div");

					backpackEntryContainer.className = "taskContainer aaTitleTextSize aaTitleText";
					//if( task.isDisplayTask )
					//	backpackEntryContainer.className += " displayed aaThemeColorOneHoverShadedBackground aaThemeColorOneShadedBorderColor";
					//else
						backpackEntryContainer.className += " aaThemeColorTwoHoverShadedBackground aaThemeColorTwoInverseHoverShadedBorderColor";//aaThemeColorTwoShadedBorderColor

					// box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
					//
					backpackEntryContainer.style.cssText = "cursor: pointer; text-align: left; font-family: Arial; font-weight: bold; letter-spacing: 0.1em; padding: 10px; border-radius: 4px; cursor-events: all; margin-top: 4px; margin-bottom: 4px; margin-right: 4px;";
					// border-style: solid; border-width: 1px;

					var entryElem = document.createElement("div");
					entryElem.style.cssText = "width: 80%; text-shadow: none;";
					entryElem.className = "taskTitle aaTextColorTwoColor";

					if( contextType == 'items' )
					{
						// box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
						var entryImageContainer = document.createElement("div");
						entryImageContainer.style.cssText = "display: inline-block; margin-right: 10px; vertical-align: top; width: 90px; height: 38px; text-align: center;";

						var entryImage = document.createElement("img");
						entryImage.style.display = "none";
						entryImage.entry = backpackEntry;
						entryImageContainer.appendChild(entryImage);
						entryElem.appendChild(entryImageContainer);
						entryElem.image = entryImage;

						arcadeHud.loadItemBestImage(entryImage, entryImage.entry, function()
						{
							this.ready = true;

							if( !!!arcadeHud.thumbCanvas )
								arcadeHud.thumbCanvas = document.createElement('canvas');
							arcadeHud.thumbCanvas.width = 90;
							arcadeHud.thumbCanvas.height = 38;
							//document.bodyappendChild(canvas);
							drawImageScaled(this, arcadeHud.thumbCanvas);

							var imageContainer = this.parentNode;
							//imageContainer.style.background = "transparent url('" + this.src + "') center";
							imageContainer.style.backgroundImage = "url(\"" + arcadeHud.thumbCanvas.toDataURL('image/jpeg', 0.9) + "\")";
							imageContainer.style.backgroundSize = "cover";
						}.bind(entryImage));
					}
					else
					{
						/*var entryTypeImageContainer = document.createElement("div");
						entryTypeImageContainer.style.cssText = "display: inline-block; margin-right: 10px; vertical-align: top; width: 90px; text-align: center;";

						var typeIconName = (isItem) ? "itemicon.png" : "3dmodelicon.png";
						var iconHTML = arcadeHud.generateIconHTML(typeIconName, typeIconSize, typeIconSize, "aaTextColorTwoColor");
						entryTypeImageContainer.innerHTML = iconHTML;
						entryElem.appendChild(entryTypeImageContainer);*/

						var entryImageContainer;
						var entryImage;

						var modelFile;
						var modelThumbnail;
						//&& (!!!backpackEntry.screen || backpackEntry.screen.indexOf(".") < 0)
						//console.log(JSON.stringify(backpackEntry));
						if( arcadeHud.modelThumbs && !!backpackEntry && arcadeHud.npcs.indexOf(backpackEntry.info.id) < 0 && arcadeHud.defaultModels.indexOf(backpackEntry.info.id) < 0 && arcadeHud.letters.indexOf(backpackEntry.info.id) < 0 && !!backpackEntry.platforms && !!backpackEntry.platforms[arcadeHud.platformId] && !!backpackEntry.platforms[arcadeHud.platformId].file && backpackEntry.platforms[arcadeHud.platformId].file.indexOf(".mdl") === backpackEntry.platforms[arcadeHud.platformId].file.length-4 )
						{
							modelFile = backpackEntry.platforms[arcadeHud.platformId].file;
							modelFile = modelFile.replace(/\\/g, "/");
							modelThumbnail = aaapi.cmdEx("generateModelThumbnail", modelFile);

// box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
							entryImageContainer = document.createElement("div");
							entryImageContainer.style.cssText = "display: inline-block; margin-right: 10px; vertical-align: top; width: 90px; height: 38px; text-align: center;";

							entryImage = document.createElement("div");
							//entryImage.style.display = "none";
							entryImage.entry = backpackEntry;
							entryImageContainer.appendChild(entryImage);
							entryElem.appendChild(entryImageContainer);
							entryElem.image = entryImage;

							function loadModelTGA()
							{
								tga.open(modelThumbnail, function()
								{
									var elem = tga.getCanvas();
									//elem.style.cssText = "width: 90px; height: 90px; position: relative; top: -30px;";
									//elem.style.backgroundImage = "url(\"" + elem.toDataURL('image/jpeg', 0.9) + "\")";
									//entryImage.appendChild(elem);
									entryImage.parentNode.style.backgroundImage = "url(\"" + elem.toDataURL('image/png', 0.1) + "\")";
									entryImage.parentNode.style.backgroundSize = "90%";
									entryImage.parentNode.style.backgroundPosition = "center";

									/*entryImage.style.display = "block";
									if( window.hasOwnProperty("g_imageTilesOnly") && g_imageTilesOnly && mode === "items" )
										entryImage.parentNode.style.opacity = "1";*/

									//entryImage.parentNode.style.backgroundImage = "none";


								   //document.querySelector("#mapImageContainer").appendChild(mapImage);
								});
							}

							if( modelThumbnail.indexOf("-caching-") < 0 )
								loadModelTGA();
							else
							{
								setTimeout(function()
								{
									modelThumbnail = aaapi.cmdEx("generateModelThumbnail", modelFile);
									if( !!modelThumbnail && modelThumbnail.indexOf("-caching-") < 0 )
										loadModelTGA();
								}, 1000);
							}
						}
						else
						{
							// box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
							entryImageContainer = document.createElement("div");
							entryImageContainer.style.cssText = "display: inline-block; margin-right: 10px; vertical-align: top; width: 90px; height: 38px; text-align: center;";

							entryImage = document.createElement("img");
							entryImage.style.display = "none";
							entryImage.entry = backpackEntry;
							entryImageContainer.appendChild(entryImage);
							entryElem.appendChild(entryImageContainer);
							entryElem.image = entryImage;

							arcadeHud.loadItemBestImage(entryImage, entryImage.entry, function()
							{
								this.ready = true;

								var imageContainer = this.parentNode;
								imageContainer.style.background = "transparent url('" + this.src + "') center";
								imageContainer.style.backgroundSize = "cover";
							}.bind(entryImage));
						}

						//arcadeHud.loadItemBestImage(entryImage, entryImage.entry, function()
						//{
						//	this.ready = true;
//console.log("yar");
							/*var imageContainer = this.parentNode;
							imageContainer.style.background = "transparent url('" + this.src + "') center";
							imageContainer.style.backgroundSize = "cover";*/
						//}.bind(entryImage));
					}

					//if( task.isDisplayTask )
					//	entryElem.className = "taskTitle aaTextColorOneColor";
					//else
					//{
					//}

					var textNode = document.createTextNode(backpackEntry.title);
					entryElem.appendChild(textNode);
					//entryElem.innerHTML += backpackEntry.title;
					//entryElem.innerHTML = task.title;
					entryElem.backpackEntry = backpackEntry;
					entryElem.contextType = contextType;
					entryElem.mouseDownScroll = -1;
					entryElem.addEventListener("mousedown", function(e)
					{
						entryElem.mouseDownScroll = listItemsContainer.parentNode.scrollTop;
					}, false);

					entryElem.addEventListener("click", function(e)
					{
						//console.log(entryElem.mouseDownScroll + " vs " + listItemsContainer.parentNode.scrollTop);
						if( this.mouseDownScroll < 0 || this.mouseDownScroll != listItemsContainer.parentNode.scrollTop )
							return;

						var backpackEntry = this.backpackEntry;
						if( contextType == 'items' )
						{
							var oldTransform = localStorage.getItem("trans" + backpackEntry.info.id);

							if( !!!oldTransform )
								oldTransform = {};
							else
								oldTransform = JSON.parse(oldTransform);

							var modelId = oldTransform.modelId;
							if( typeof modelId === 'undefined' )
								modelId = "";

							var scale = oldTransform.scale;
							if( typeof scale === 'undefined' )
								scale = "1.0";

							var pitch = oldTransform.pitch;
							if( typeof pitch === 'undefined' )
								pitch = "0";

							var yaw = oldTransform.yaw;
							if( typeof yaw === 'undefined' )
								yaw = "0";
							
							var roll = oldTransform.roll;
							if( typeof roll === 'undefined' )
								roll = "0";
							
							var offX = oldTransform.offX;
							if( typeof offX === 'undefined' )
								offX = "0";
							
							var offY = oldTransform.offY;
							if( typeof offY === 'undefined' )
								offY = "0";
							
							var offZ = oldTransform.offZ;
							if( typeof offZ === 'undefined' )
								offZ = "0";

							if(!givenTabId || givenTabId === "tasks")
								aaapi.cmd("consoleCommand", "ignore_next_tab_up 1");

							aaapi.cmd("spawnEntry", "items", backpackEntry.info.id, "", "", modelId, scale, pitch, yaw, roll, offX, offY, offZ);
							//aaapi.cmd("spawnItem", backpackEntry.info.id);
						}
						else
						{
							var oldTransform = localStorage.getItem("trans" + backpackEntry.info.id);

							if( !!!oldTransform )
								oldTransform = {};
							else
								oldTransform = JSON.parse(oldTransform);

							var modelId = "";
							//var modelId = oldTransform.modelId;
							//if( typeof modelId === 'undefined' )
							//	modelId = "";

							var scale = oldTransform.scale;
							if( typeof scale === 'undefined' )
								scale = "1.0";

							var pitch = oldTransform.pitch;
							if( typeof pitch === 'undefined' )
								pitch = "0";

							var yaw = oldTransform.yaw;
							if( typeof yaw === 'undefined' )
								yaw = "0";
							
							var roll = oldTransform.roll;
							if( typeof roll === 'undefined' )
								roll = "0";
							
							var offX = oldTransform.offX;
							if( typeof offX === 'undefined' )
								offX = "0";
							
							var offY = oldTransform.offY;
							if( typeof offY === 'undefined' )
								offY = "0";
							
							var offZ = oldTransform.offZ;
							if( typeof offZ === 'undefined' )
								offZ = "0";
							
							if(!givenTabId || givenTabId === "tasks")
								aaapi.cmd("consoleCommand", "ignore_next_tab_up 1");

							aaapi.cmd("spawnEntry", "models", backpackEntry.info.id, "", "", modelId, scale, pitch, yaw, roll, offX, offY, offZ);
						}
						//aaapi.cmd("displayTask", this.id);
						//aaapi.cmd("deactivateInputMode");
					}.bind(entryElem), false);

					iconsContainer = document.createElement("div");
					iconsContainer.className = "iconsContainer";
					iconsContainer.style.cssText = "float: right;";



					iconButton = document.createElement("div");
					iconButton.className = "taskButton aaThemeColorOneHoverShadedBackground helpNote";

					iconButton.setAttribute("help", "Edit this entry's properties.");
					iconButton.style.cssText = " margin-right: 8px;";
					//iconButton.taskId = task.id;
					iconButton.addEventListener("click", function(e)
					{
						e.preventDefault();

						if( this.contextType == 'items' )
						{
							var pageName = "editItem.html";
						}
						else if( this.contextType == 'models' )
						{
							var pageName = "editModel.html";
							window.location = "asset://ui/" + pageName + "?id=" + encodeURIComponent(this.backpackEntry.info.id) + "&uiback=" + encodeURIComponent("window.location='asset://ui/tabMenu.html?tab=backpack';");
						}
						else if( this.contextType == 'maps' )
						{
							console.log("Unhandled map thing!!");
						}

						return false;
					}.bind(entryElem), true);

					var iconHTML = arcadeHud.generateIconHTML("editicon.png", typeIconSize, typeIconSize, "aaTextColorOneColor");
					iconButton.innerHTML = iconHTML;
					iconsContainer.appendChild(iconButton);



					iconButton = document.createElement("div");
					iconButton.className = "taskButton aaThemeColorOneHoverShadedBackground helpNote";

					iconButton.setAttribute("help", "Remove this entry from your favorites.");
					iconButton.style.cssText = "margin-right: 8px;";
					//iconButton.taskId = task.id;
					iconButton.addEventListener("click", function(e)
					{
						e.preventDefault();

						var backpackEntry = this.backpackEntry;
						var contextType = this.contextType;
						var matchId = backpackEntry.info.id;

						var typeName = "";
						if( contextType == 'items' )
							typeName = 'item';
						else if( contextType == 'models' )
							typeName = 'model';
						else if ( contextType == 'maps' )
							typeName = 'map';

						var foundEntry = false;
						for( var i = 0; i < backpackEntries.length; i++ )
						{
							if( backpackEntries[i][typeName] === matchId )
							{
								backpackEntries.splice(i, 1);
								foundEntry = true;
								break;
							}
						}

						if( !foundEntry )
							console.log("ERROR: Item already exists in backpack.");
						else
						{
							//localStorage.setItem("myBackpack", JSON.stringify(backpackEntries));
							arcadeHud.saveFavoritesLists();
							aaapi.cmd("addToastMessage", "Removed From Favorites");
							location.reload();
						}

						return false;
					}.bind(entryElem), false);

					var iconHTML = arcadeHud.generateIconHTML("unfavoriteicon.png", typeIconSize, typeIconSize, "aaTextColorOneColor");
					iconButton.innerHTML = iconHTML;
					iconsContainer.appendChild(iconButton);

					backpackEntryContainer.appendChild(iconsContainer);

					backpackEntryContainer.appendChild(entryElem);
					//backpackContainer.appendChild(backpackEntryContainer);
					if( contextType == 'items' )
						listItemsContainer.appendChild(backpackEntryContainer);
					else if( contextType == 'models' )
						listPropsContainer.appendChild(backpackEntryContainer);
					else if( contextType == 'maps' )
						listMapsContainer.appendChild(backpackEntryContainer);
					else if( contextType == 'screenshots' )
						listScreenshotsContainer.appendChild(backpackEntryContainer);
					else if( contextType == 'favorites' )
						listFavoritesContainer.appendChild(backpackEntryContainer);
				}
				else
				{
					var container;
					var tileMode;
					if( contextType == 'items' )
					{
						container = listItemsContainer;
						tileMode = "items";
					}
					else if( contextType == 'models')
					{
						container = listPropsContainer;
						tileMode = "models";
					}
					else if( contextType == 'maps' )
					{
						container = listPropsContainer;
						tileMode = "maps";
					}

					var tileWidth;
					var tileHeight;
					if( zoomSlider.value > -1 )
					{
						var sliderFactor = (zoomSlider.value / 1.3) + 1;
						tileWidth = Math.round((460/2) * sliderFactor);
						tileHeight = Math.round((215/2) * sliderFactor);
					}

					/*var tileContainer = document.createElement('div');
					tileContainer.className = "tileContainer";
					tileContainer.style.cssText = 'width: ' + (tileWidth+12) + 'px; height: ' + (tileHeight+12) + 'px; display: inline-block;';
					tileContainer.entry = backpackEntry;
					//tileContainer.container = container;
					tileContainer.tileMode = tileMode;
					tileContainer.onSpawnClick = onSpawnClick;
					tileContainer.tileWidth = tileWidth;
					tileContainer.tileHeight = tileHeight;
					container.appendChild(tileContainer);*/


					var tile;
					if( contextType == 'maps' )
					{
						var mapHistory = arcadeHud.getMapHistory();

						var screenshot = null;
						var screenshotResponse = null;

						var mapHistoryEntry = mapHistory[backpackEntry.info.id];
						if( !!mapHistoryEntry && mapHistoryEntry.screenshotId !== "" )
						{
							screenshotResponse = aaapi.cmdEx("getScreenshot", mapHistoryEntry.screenshotId);
						}

						if( !!screenshotResponse && !!screenshotResponse.screenshot)
							screenshot = screenshotResponse.screenshot;

						if( !!!screenshot )
						{
							var screenshots = aaapi.cmdEx("getAllMapScreenshots", "id" + backpackEntry.info.id);

							var goodScreenshots = [];
							var screenshotKeys = Object.keys(screenshots);
							for( var i = 0; i < screenshotKeys.length; i++ )
							{
								screenshot = screenshots[screenshotKeys[i]];
	//console.log( screenshot.instance.id + " VS " + "id" + response.maps[j].info.id );
								//if( screenshot.instance.id == "id" + response.maps[j].info.id )
									goodScreenshots.push(screenshot);
							}

							// most recent screenshots on top
							goodScreenshots.sort(function(a, b)
							{
								var aCreated = parseInt(a.created);
								var bCreated = parseInt(b.created);
								if( aCreated > bCreated )
									return -1;
								else if( aCreated < bCreated )
									return 1;
								else
									return 0;
							});

							if( goodScreenshots.length > 0 )
								screenshot = goodScreenshots[0];
							else
								screenshot = null;
						}

						if( !!screenshot )
						{
							var tileWidth;
							var tileHeight;
							if( zoomSlider.value > -1 )
							{
								var sliderFactor = (zoomSlider.value / 1.3) + 1;
								tileWidth = Math.round((460/2) * sliderFactor);
								tileHeight = Math.round((215/2) * sliderFactor);
							}

							var goodScreenshot = screenshot;
							tile = arcadeHud.createTile(goodScreenshot, listMapsContainer, "maps", "", onMapTileClick, tileWidth, tileHeight);
							tile.entry = goodScreenshot;
						}
					}
					else if( contextType == 'screenshots' )
					{
						var tileWidth;
						var tileHeight;
						if( zoomSlider.value > -1 )
						{
							var sliderFactor = (zoomSlider.value / 1.3) + 1;
							tileWidth = Math.round((460/2) * sliderFactor);
							tileHeight = Math.round((215/2) * sliderFactor);
						}

						tile = arcadeHud.createTile(backpackEntry, listScreenshotsContainer, "maps", "", onScreenshotTileClick, tileWidth, tileHeight);
						tile.entry = backpackEntry;
					}
					else if( contextType == 'interactiveshots' )
					{
						var tileWidth;
						var tileHeight;
						if( zoomSlider.value > -1 )
						{
							var sliderFactor = (zoomSlider.value / 1.3) + 1;
							tileWidth = Math.round((460/2) * sliderFactor);
							tileHeight = Math.round((215/2) * sliderFactor);
						}

						tile = arcadeHud.createTile(backpackEntry, listScreenshotsContainer, "maps", "", onScreenshotTileClick, tileWidth, tileHeight);
						tile.entry = backpackEntry;
					}
					else if( contextType == 'favorites' )
					{
						var tileWidth;
						var tileHeight;
						if( zoomSlider.value > -1 )
						{
							var sliderFactor = (zoomSlider.value / 1.3) + 1;
							tileWidth = Math.round((460/2) * sliderFactor);
							tileHeight = Math.round((215/2) * sliderFactor);
						}

						tile = arcadeHud.createTile(backpackEntry, listFavoritesContainer, "favorites", "", onFavoritesClick, tileWidth, tileHeight);
					}
					else
						tile = arcadeHud.createTile(backpackEntry, container, tileMode, "", onSpawnClick, tileWidth, tileHeight);

					//if( arcadeHud.isFavorite('item', backpackEntry.info.id) )
					//{
					//	container.insertBefore(tile, container.firstChild);
					//}
				}
			}

			var entryInfo, entry, hasItem, hasModel, item, model;
			var entryInfoI = 0;
			function intervalFetch()
			{
			//for( var i = 0; i < backpackEntries.length; i++ )
			//{
				if( entryInfoI >= backpackEntries.length )
				{
					listLoading.style.display = "none";

					if( listItemsContainer.parentNode.querySelectorAll(".aaTile").length > 0 )
					{
						listItems.style.display = "block";
						listProps.style.display = "block";
						listMaps.style.display = "block";
						listScreenshots.style.display = "block";
						listFavorites.style.display = "block";
						listServers.style.display = "block";
						livingScroll();
					}
					else
					{
						listLoading.style.display = "none";
						listItems.style.display = "none";
						listProps.style.display = "none";
						listMaps.style.display = "none";
						listScreenshots.style.display = "none";
						listFavorites.style.display = "none";
						listServers.style.display = "none";
						emptyList.style.display = "block";
						livingScroll();
					}

					return;
				}

				entryInfo = backpackEntries[entryInfoI];
				hasItem = (!!entryInfo.item);
				hasModel = (!!entryInfo.model);

				//hasMap = (!!entryInfo.map);

				//console.log(JSON.stringify(entryInfo));

				if( hasItem )
					entry = aaapi.cmdEx("getLibraryItem", entryInfo.item);
				else if( hasModel )
					entry = aaapi.cmdEx("getLibraryModel", entryInfo.model);
				else
				{
					entry = undefined;
					console.log("Backpack entry had no item or model!");
				}

				if( !!entry )
				{
					var typeName;
					if( hasItem )
						typeName = 'items';
					else if( hasModel )
						typeName = 'models';
					else
					{
						console.log("unhandled maps thing C!");
						typeName = 'models';
					}

					appendBackpackEntry(entry, typeName);
				}

				entryInfoI++;
				usedEntries++;

				if( entryInfoI < backpackEntries.length && usedEntries < cacheSize )
				{
					setTimeout(intervalFetch, 10);
				}
				else
				{
					listLoading.style.display = "none";

					if( listItemsContainer.parentNode.querySelectorAll(".aaTile").length > 0 )
					{
						listItems.style.display = "block";
						listProps.style.display = "block";
						listMaps.style.display = "block";
						listScreenshots.style.display = "block";
						listFavorites.style.display = "block";
						listServers.style.display = "block";
						livingScroll();
					}
					else
					{
						listLoading.style.display = "none";
						listItems.style.display = "none";
						listProps.style.display = "none";
						listMaps.style.display = "none";
						listScreenshots.style.display = "none";
						listFavorites.style.display = "none";
						listServers.style.display = "none";
						emptyList.style.display = "block";
						livingScroll();
					}
				}
			//}
			}

			function constructBackpack()
			{
				emptyList.style.display = "none";
				listLoading.style.display = "block";

				listItems.innerHTML = "";
				listItems.style.display = "none";
				listProps.innerHTML = "";
				listProps.style.display = "none";
				listMaps.innerHTML = "";
				listMaps.style.display = "none";
				listScreenshots.innerHTML = "";
				listScreenshots.style.display = "none";
				listFavorites.innerHTML = "";
				listFavorites.style.display = "none";
				listServers.innerHTML = "";
				listServers.style.display = "none";
				//document.querySelector("#backpackCount").innerHTML = backpackEntries.length;

				// test stimuli
				/*
				var backpackEntries = [
					{
						"item": "-pIfOJJYD8G1t3rDPKzW"
					},
					{
						"model": "06369288"
					}
				];
				*/

				//if( backpackEntries.length > 0 )
				//	document.querySelector("#noEntriesInBackpack").style.display = "none";
				//else
				//	document.querySelector("#noEntriesInBackpack").style.display = "block";

//console.log(backpackEntries.length);

				if( backpackEntries.length <= 0 )
				{
					listLoading.style.display = "none";
					listItems.style.display = "none";
					listProps.style.display = "none";
					listMaps.style.display = "none";
					listScreenshots.style.display = "none";
					listFavorites.style.display = "none";
					listServers.style.display = "none";
					emptyList.style.display = "block";
					livingScroll();
					//console.log("yar2");
				}
				else// if( entryInfoI < cacheSize )
				{
					//intervalFetch();

					var librarySearchMax = localStorage.getItem("librarysearchmax");
					if( !!!librarySearchMax )
						librarySearchMax = "40";

					var zoomValue = zoomSlider.value;
					cacheSize = parseInt(librarySearchMax);

					var fullCacheSize = cacheSize;
					//if( zoomValue == -2 )
					//	fullCacheSize = 14;
					//else
						if( zoomValue == -1 )
						fullCacheSize = 120;
					else if( zoomValue == 0 )
						fullCacheSize = 56;
					else if( zoomValue == 1 )
						fullCacheSize = 20;

					//if( fullCacheSize < cacheSize )
						cacheSize = fullCacheSize;

					intervalFetch(fullCacheSize);
				}
			}

			var numUsers = aaapi.cmdEx("getNumUsers");
			document.querySelector("#playerCount").innerHTML = numUsers;

			document.querySelector("#screenshotCount").innerHTML = goodScreenshots.length; 

			//document.querySelector("#backpackCount").innerHTML = backpackEntries.length;

			//document.querySelector("#commandCount").innerHTML = commands.length;

			var g_handledTabs = false;

			if( !!connectedUniverse )
			{

			}
			else
			{
				// hide the PLAYERS, TRANSFERS, and the PANORAMAS tabs.
				var elems = document.querySelectorAll("*[tabid='players']");
				for( var i = 0; i < elems.length; i++ )
					elems[i].style.display = "none";

				elems = document.querySelectorAll("*[tabid='panos']");
				for( var i = 0; i < elems.length; i++ )
					elems[i].style.display = "none";

				elems = document.querySelectorAll("*[tabid='transfers']");
				for( var i = 0; i < elems.length; i++ )
					elems[i].style.display = "none";
			}

			function editList()
			{
				var listId = listSelect.options[listSelect.selectedIndex].value;
				if( listId == '' )
					return;

				window.location = "asset://ui/editList.html?id=" + listId;
			}

			function createList()
			{
				var list = arcadeHud.createFavoritesList(null, "Untitled List");
				arcadeHud.setActiveFavoritesList(list.id);
				window.location = "asset://ui/editList.html?id=" + list.id;
			}

			var listSelect = document.querySelector("#listselect");
			listSelect.addEventListener("change", function(e)
			{
				var listId = this.options[this.selectedIndex].value;
				if( listId != '' )
				{
					if( listSelect.options[0].value == '' )
						listSelect.removeChild(listSelect.options[0]);

					typeSelect.selectedIndex = 0;
					libSearchInput.value = '';

					aaapi.cmd("setLibraryBrowserContext", 'items', '', '', '');

					showList(listId);
				}
				else
					doSearch(libSearchInput.value);
			}.bind(listSelect));

			// add in all the lists to the box
			var option, list;
			for( var listId in arcadeHud.favoritesLists )
			{
				list = arcadeHud.favoritesLists[listId];
				option = document.createElement("option");
				option.value = listId;
				option.text = list.title;

				if( listId === arcadeHud.activeFavoritesList )
					option.selected = true;

				listSelect.appendChild(option);
			}

			/*if( gridViewOption )
			{
				document.querySelector("#listButton").style.display = "inline-block";
			}
			else
			{
				document.querySelector("#gridButton").style.display = "inline-block";
			}*/

			/*function setListTitle(title)
			{
				listTitleContainer.innerHTML = "";
				listTitleContainer.appendChild(document.createTextNode(title));
			}*/

			var response = aaapi.cmdEx("getAllWorkshopSubscriptions");
			var subscriptions = response.subscriptions;
			subscriptions = subscriptions.sort(function(a, b)
			{
				var titleA = a.title.toLowerCase();
				var titleB = b.title.toLowerCase();
				if( titleA < titleB )
					return -1;
				else if( titleA > titleB )
					return 1;
				else
					return 0;
			});
/*
			setTimeout(function()
			{
				emptyList.style.display = "none";
				listLoading.style.display = "none";

				listItems.innerHTML = "";
				listItems.style.display = "block";
				listProps.innerHTML = "";
				listProps.style.display = "block";
				listMaps.innerHTML = "";
				listMaps.style.display = "block";
				listServers.innerHTML = "";
				listServers.style.display = "block";

				for( var i = 0; i < subscriptions.length; i++ )
				{
					sub = subscriptions[i];
					entry = {
						info: {
							id: sub.publishedFileId
						},
						file: 'https://steamcommunity.com/workshop/filedetails/?id=' + sub.publishedFileId,
						description: sub.description,
						title: sub.title,
						screen: sub.previewURL
					};

					appendBackpackEntry(entry, true);
				}
			}, 1000);
*/
			function showPalette(id)
			{
				paletteId = id;
				window.localStorage.setItem('activeTexturePalette', paletteId);

				paletteElem.innerHTML = '';

				getActiveTexturePalette();

				for( var i = 0; i < texturePalette.entries.length; i++ )
					createTextureCard(texturePalette.entries[i]);
			}

			function showList(listId)
			{
				//return;
				var list = arcadeHud.setActiveFavoritesList(listId);
				//setListTitle(list.title);

				backpackEntries = arcadeHud.favorites;
				backpackEntries.sort(sortModelsToBack);
				queryId = "favlist";
				entryInfoI = 0;
				usedEntries = 0;
				constructBackpack();
			}
			
			function changeView()
			{
				gridViewOption = !gridViewOption;
				showList(arcadeHud.activeFavoritesList);
				/*if( gridViewOption )
				{
					document.querySelector("#listButton").style.display = "inline-block";
					document.querySelector("#gridButton").style.display = "none";
				}
				else
				{
					document.querySelector("#gridButton").style.display = "inline-block";
					document.querySelector("#listButton").style.display = "none";
				}*/

				var val = (gridViewOption) ? "1" : "0";
				localStorage.setItem("gridViewOption", val);
			}

			var libraryBrowserContext = aaapi.cmdEx("getLibraryBrowserContext");
			//console.log(JSON.stringify(libraryBrowserContext));
			var contextCategory = (libraryBrowserContext.category) ? libraryBrowserContext.category : "items";
			var contextFilter = (libraryBrowserContext.filter) ? libraryBrowserContext.filter : "";

			context = contextCategory;

			var typeSelect = document.querySelector("#typeSelect");
			typeSelect.addEventListener('change', function(e)
			{
 			//	aaapi.cmd("setLibraryBrowserContext", "items", item.info.id, "", "");

				if( listSelect.options[0].value != '' )
				{
					var option = document.createElement('option');
					option.value = '';
					option.text = 'Search Results...';
					listSelect.insertBefore(option, listSelect.firstChild);
				}

				listSelect.selectedIndex = 0;
					//libSearchInput.value = '';

				context = 'items';

				var oldMode;
				var oldActive = document.querySelector('.modeIconContainerActive');
				if( !!oldActive )
				{
					oldActive.classList.remove('modeIconContainerActive');
					oldMode = oldActive.getAttribute('mode');
				}

				var active = document.querySelector('.modeIconContainer[mode=' + context + ']');
				if( !!active )
					active.classList.add('modeIconContainerActive');

				aaapi.cmd("setLibraryBrowserContext", context, '', libSearchInput.value, typeSelect.value);

				//if( context != oldMode )
					doSearch(libSearchInput.value);
			});

			libSearchInput.value = libraryBrowserContext.search;

			if( libraryBrowserContext.search == '' )
				context = 'items';

			if( context == 'items' )
			{
				if( contextFilter != '' )
					typeSelect.value = contextFilter;
			}
			else
			{
				var oldMode;
				var oldActive = document.querySelector('.modeIconContainerActive');
				if( !!oldActive )
				{
					oldActive.classList.remove('modeIconContainerActive');
					oldMode = oldActive.getAttribute('mode');
				}

				var active = document.querySelector('.modeIconContainer[mode=' + context + ']');
				if( !!active )
					active.classList.add('modeIconContainerActive');
			}

			zoomSlider = document.querySelector("#zoomSlider");

			var oldLibraryZoom = localStorage.getItem('libraryZoom');
			if( oldLibraryZoom )
			{
				if( oldLibraryZoom == "-2" )
					oldLibraryZoom = -1;
				else
					oldLibraryZoom = parseInt(oldLibraryZoom);

				zoomSlider.value = oldLibraryZoom;
			}
			gridViewOption = (oldLibraryZoom != -2);

			zoomSlider.addEventListener('mouseup', function(e)
			{
				localStorage.setItem('libraryZoom', zoomSlider.value);

				var zoomValue = zoomSlider.value;

				var librarySearchMax = localStorage.getItem("librarysearchmax");
				if( !!!librarySearchMax )
					librarySearchMax = "40";

				cacheSize = parseInt(librarySearchMax);

				var fullCacheSize = cacheSize;
				if( zoomValue == -2 )
					fullCacheSize = 14;
				else if( zoomValue == -1 )
					fullCacheSize = 120;
				else if( zoomValue == 0 )
					fullCacheSize = 56;
				else if( zoomValue == 1 )
					fullCacheSize = 20;

				//if( fullCacheSize > cacheSize )
					cacheSize = fullCacheSize;

				if( zoomSlider.value >= -1 )
				{
					if( true || !gridViewOption )
					{
						gridViewOption = true;
						//showList(arcadeHud.activeFavoritesList);

						if(libSearchInput.value != '' || typeSelect.selectedIndex != 0)
							doSearch(libSearchInput.value);
						else
							showList(arcadeHud.activeFavoritesList);
					}
					else
					{
						var tileWidth;
						var tileHeight;
						if( zoomSlider.value > -1 )
						{
							var sliderFactor = (zoomSlider.value / 1.3) + 1;
							tileWidth = Math.round((460/2) * sliderFactor);
							tileHeight = Math.round((215/2) * sliderFactor);
						}
						else
						{
							tileWidth = 100;
							tileHeight = 100;
						}

						var elems = listItemsContainer.querySelectorAll(".aaTile");
						for( var i = elems.length-1; i >= 0; i--)
						{
							elems[i].style.width = tileWidth + "px";
							elems[i].style.height = tileHeight + "px";
						}
					}
				}
				else
				{
					gridViewOption = false;
					//showList(arcadeHud.activeFavoritesList);
		
					if(libSearchInput.value != '' || typeSelect.selectedIndex != 0)
						doSearch(libSearchInput.value);
					else
						showList(arcadeHud.activeFavoritesList);
				}
				//else
				//{
				//	gridViewOption = !gridViewOption;


					//showList(arcadeHud.activeFavoritesList);


				//}
			});


			var librarySearchMax = localStorage.getItem("librarysearchmax");
			if( !!!librarySearchMax )
				librarySearchMax = "40";

			var cacheSize = parseInt(librarySearchMax);
			var usedEntries = 0;
			var queryId;

			function doNextResult(context, response)
			{
				//if( !!!queryId )
				//	return;

				//for( var i = 0; usedEntries < cacheSize && response.success === true; i++ )
				if( response.success )
				{
					//console.log(response.entry.info.id);
					if( (context === "items" || context === "models") && !!arcadeHud.hiddenItems[response.entry.info.id] )
					{
						response = (context === "items") ? aaapi.cmdEx("findNextLibraryEntry", queryId, "items") : aaapi.cmdEx("findNextLibraryEntry", queryId, "models");
						doNextResult(context, response);
						return;
					}
					else if( context == "maps" && !!g_hiddenMaps[response.entry.info.id] )
					{
						g_lastUsedMapResult++;
						response = g_allFoundMapsCached[g_lastUsedMapResult];
						if( !!!response )
							response = {success: false};
						else
							response = {success: true, entry: response};
						doNextResult(context, response);
						return;
					}
					//else
					//	console.log(JSON.stringify(response));

					//console.log(response.entry.title);
					appendBackpackEntry(response.entry, context);
					usedEntries++;

					if( usedEntries < cacheSize )
					{
						if( context == "items" )
							response = aaapi.cmdEx("findNextLibraryEntry", queryId, "items");
						else if( context == "models" )
							response = aaapi.cmdEx("findNextLibraryEntry", queryId, "models");
						else if( context == "maps" )
						{
							g_lastUsedMapResult++;
							response = g_allFoundMapsCached[g_lastUsedMapResult];
							if( !!!response )
								response = {success: false};
							else
								response = {success: true, entry: response};
						}
						else if( context == "screenshots" )
						{
							g_lastUsedScreenshotResult++;
							response = g_allFoundScreenshotsCached[g_lastUsedScreenshotResult];
							if( !!!response )
								response = {success: false};
							else
								response = {success: true, entry: response};
						}
						else if(context === "interactiveshots")
						{
							/*var screenshotResponse = aaapi.cmdEx("getAllMapScreenshots", "", searchTerm);

							for( var x in screenshotResponse )
							{
								if( screenshotResponse[x].hasJSFile != '1' )
									continue;

								g_allFoundScreenshotsCached.push(screenshotResponse[x]);
							}*/

							g_lastUsedScreenshotResult++;
							response = g_allFoundScreenshotsCached[g_lastUsedScreenshotResult];
							if( !!!response )
								response = {success: false};
							else
								response = {success: true, entry: response};
						}
						else if( context == "favorites" )
						{
							g_lastUsedFavoritesResult++;
							//response = g_allFavoritesLists[g_lastUsedFavoritesResult];

							var mockResult;
							if( g_lastUsedFavoritesResult < g_allFavoritesLists.length )
							{
								var resultEntry = g_allFavoritesLists[g_lastUsedFavoritesResult];

								var screenImage = (!!resultEntry.screen && resultEntry.screen != '') ? resultEntry.screen : '';
								mockResult = {
									info: {
										id: resultEntry.id
									},
									title: resultEntry.title,
									screen: resultEntry.screen,
									file: resultEntry.screen
								}
							}

							if( !!!mockResult )
								response = {success: false};
							else
								response = {entry: mockResult, success: true};
							//if( !!!response )
							//	response = {success: false};
							//else
							//	response = {success: true, entry: response};
						}

						setTimeout(function()
						{
							doNextResult(context, response);
						}, 1);
					}
					else
					{
						listLoading.style.display = "none";
						listItems.style.display = "block";
						listProps.style.display = "block";
						listMaps.style.display = "block";
						listScreenshots.style.display = "block";
						listFavorites.style.display = "block";
						listServers.style.display = "block";
						listItems.parentNode.offsetHeight;
						//setTimeout(function()
						//{
							//console.log("check for visibility");
							livingScroll();
						//}, 1000);
					}
				}
				else
				{
					listLoading.style.display = "none";
					listItems.style.display = "block";
					listProps.style.display = "block";
					listMaps.style.display = "block";
					listScreenshots.style.display = "block";
					listFavorites.style.display = "block";
					listServers.style.display = "block";
					//livingScroll();
				}
			}

			function onScreenshotTileClick(tile)
			{
				//e.stopImmediatePropagation();

				var screenshot = tile.entry;


console.log('the day the earth stood still');
if( context === "interactiveshots" )
{
				console.log("Hello world.");
				var snapRef = "asset://shots/" + screenshot.id + ".js";


			var snapScript = document.createElement("script");
			snapScript.src = snapRef;// + ".js?a=b";
			snapScript.onload = function()
			{
				var listEntries = [];
				for( var x in g_snapdata.library.items )
				{
					var entry = {};
					entry['item'] = x;
					listEntries.push(entry);
				}

				for( var x in g_snapdata.library.models )
				{
					if( g_snapdata.library.models[x].dynamic == '1' )
						continue;

					var entry = {};
					entry['model'] = x;
					listEntries.push(entry);
				}

				var fakeList = {
					id: "interactivescreenshot",
					title: "Interactive Screenshot",
					entries: listEntries,
					screen: ""
				};

				arcadeHud.favoritesLists[fakeList.id] = fakeList;
				showList(fakeList.id);
			};
			document.getElementsByTagName("head")[0].appendChild(snapScript);

				return;
}


				var mapFile = "";
				if(!!screenshot && !!screenshot.map && !!screenshot.map.file && screenshot.map.file !== "")
					mapFile = screenshot.map.file.substring(0, screenshot.map.file.lastIndexOf("."));
				else if( !!tile.entry.map && !!tile.entry.map.platforms && !!tile.entry.map.platforms[arcadeHud.platformId] && !!tile.entry.map.platforms[arcadeHud.platformId].file && tile.entry.map.platforms[arcadeHud.platformId].file !== "" )
					mapFile = tile.entry.map.platforms[arcadeHud.platformId].file.substring(0, tile.entry.map.platforms[arcadeHud.platformId].file.lastIndexOf("."));

				if( mapFile !== "" )
				{
					var smartTitle = "";
					var smartURL = "travel.html?mapfile=" + mapFile;

					var title = "";
					if( !!screenshot && !!screenshot.instance && !!screenshot.instance.title && screenshot.instance.title !== "" )
						title = screenshot.instance.title;
					else if( !!tile.entry.map && !!tile.entry.map.title && tile.entry.map.title !== "" )
						title = tile.entry.map.title;
					else if( mapFile !== "" )
						title = mapFile;

					if( title !== "" )
					{
						// NOTE: THIS CODE IS DUPED WITH STUFF IN HUD.JS
						smartTitle = "Jump To: " + title;

						if( !!screenshot )
						{
							//console.log(JSON.stringify(screenshot));
							smartURL += "&screenshot=" + screenshot.id;
							smartURL += "&pos=" + screenshot.body.position;
							smartURL += "&rot=" + screenshot.body.rotation;
							smartURL += "&instance=" + screenshot.instance.id.substring(2);

							if( screenshot.hasOwnProperty("multiplayer") )
							{
								smartURL += "&lobby=" + screenshot.multiplayer.lobby;
								smartURL += "&lobbytitle=Multiplayer Lobby&lobbyauthor=Unknown";
							}
						}

						//console.log(smartTitle);
						//console.log(smartURL);

						aaapi.cmd("setLibraryBrowserContext", "items", "", "", "");
			//	aaapi.cmd("addToastMessage", "Not found in arcade.");
						document.location = "asset://ui/createItem.html?fileLocation=" + encodeURIComponent(smartURL) + "&title=" + encodeURIComponent(smartTitle) + "&type=" + encodeURIComponent("-ohTuY-Me2QaaNaxvi6H");
					}
				}
			}

			function onMapTileClick(tile)
			{
				var screenshot = tile.entry;
				var mapFile = "";
				if(!!screenshot && !!screenshot.map && !!screenshot.map.file && screenshot.map.file !== "")
					mapFile = screenshot.map.file.substring(0, screenshot.map.file.lastIndexOf("."));
				else if( !!tile.entry.map && !!tile.entry.map.platforms && !!tile.entry.map.platforms[arcadeHud.platformId] && !!tile.entry.map.platforms[arcadeHud.platformId].file && tile.entry.map.platforms[arcadeHud.platformId].file !== "" )
					mapFile = tile.entry.map.platforms[arcadeHud.platformId].file.substring(0, tile.entry.map.platforms[arcadeHud.platformId].file.lastIndexOf("."));

				if( mapFile !== "" )
				{
					var smartTitle = "";
					var smartURL = "travel.html?mapfile=" + mapFile;

					var title = "";
					if( !!screenshot && !!screenshot.instance && !!screenshot.instance.title && screenshot.instance.title !== "" )
						title = screenshot.instance.title;
					else if( !!tile.entry.map && !!tile.entry.map.title && tile.entry.map.title !== "" )
						title = tile.entry.map.title;
					else if( mapFile !== "" )
						title = mapFile;

					if( title !== "" )
					{
						smartTitle = "Jump To: " + title;

						if( !!screenshot )
						{
							//console.log(JSON.stringify(screenshot));
							smartURL += "&screenshot=" + screenshot.id;
							smartURL += "&pos=" + screenshot.body.position;
							smartURL += "&rot=" + screenshot.body.rotation;
							smartURL += "&instance=" + screenshot.instance.id.substring(2);
						}

						//console.log(smartTitle);
						//console.log(smartURL);

						aaapi.cmd("setLibraryBrowserContext", "items", "", "", "");
			//	aaapi.cmd("addToastMessage", "Not found in arcade.");
						document.location = "asset://ui/createItem.html?fileLocation=" + encodeURIComponent(smartURL) + "&title=" + encodeURIComponent(smartTitle) + "&type=" + encodeURIComponent("-ohTuY-Me2QaaNaxvi6H");
					}
				}
			}

			function onMapSpawnClick()
			{
				console.log("Yar???");
				arcadeHud.playScreenshotNow(this.item);
			}

			var g_allFoundMapsCached;
			var g_lastUsedMapResult = -1;

			var g_allFoundScreenshotsCached;
			var g_lastUsedScreenshotResult = -1;

			var g_allFavoritesLists;
			var g_lastUsedFavoritesResult = -1;

			//var isSearching = false;
			function doSearch(searchTerm)
			{
				g_allFoundMapsCached = [];
				g_lastUsedMapResult = -1;

				g_allFoundScreenshotsCached = [];
				g_lastUsedScreenshotResult = -1;

				g_allFavoritesLists = [];
				g_lastUsedFavoritesResult = -1;

				if( listSelect.options[0].value != '' )
				{
					var option = document.createElement('option');
					option.value = '';
					option.text = 'Search Results...';
					listSelect.insertBefore(option, listSelect.firstChild);
				}

				listSelect.selectedIndex = 0;
			//	isSearching = true;
				// clear the existing tiles
				// ...

				// fetch the 1st N results, depending on grid size.
				var zoomValue = zoomSlider.value;

				var librarySearchMax = localStorage.getItem("librarysearchmax");
				if( !!!librarySearchMax )
					librarySearchMax = "40";

				cacheSize = parseInt(librarySearchMax);
				var fullCacheSize = cacheSize;
				if( zoomValue == -2 )
					fullCacheSize = 14;
				else if( zoomValue == -1 )
					fullCacheSize = 120;
				else if( zoomValue == 0 )
					fullCacheSize = 56;
				else if( zoomValue == 1 )
					fullCacheSize = 20;

				//if( fullCacheSize > cacheSize )
					cacheSize = fullCacheSize;

				//cacheSize = 300;
				//cacheSize = parseInt(localStorage.getItem("librarysearchmax"));
				//console.log(cacheSize);

				listItemsContainer.innerHTML = "";

				usedEntries = 0;
				type = '';

				var active = document.querySelector('.modeIconContainerActive');
				context = (!!active) ? active.getAttribute('mode') : 'items';

				if( typeSelect.value == '' )
				{
					if(context === "items")
					{
						response = aaapi.cmdEx("findFirstLibraryEntry", "items", "title", searchTerm);
					}
					else if( context == "models")
					{
						response = aaapi.cmdEx("findFirstLibraryEntry", "models", "title", searchTerm);
					}
					else if(context === "maps")
					{
						//response = aaapi.cmdEx("findAllMaps", searchTerm.toLowerCase());

						//for( var x in response.maps )
						//	g_allFoundMapsCached.push(response.maps[x]);
						response = aaapi.cmdEx("findAllMaps", searchTerm.toLowerCase());

						for( var x in response.maps )
							g_allFoundMapsCached.push(response.maps[x]);

						var favoriteMaps = {};
						for( var i = 0; i < g_allFoundMapsCached.length; i++ )
						{
							if( !!g_allFoundMapsCached[i].map )
								favoriteMaps[g_allFoundMapsCached[i].map] = true;
						}

						var mapHistory;// = (localStorage.getItem("mapHistory")) ? JSON.parse(localStorage.getItem("mapHistory")) : {};

						function sortRecent(a, b)
						{
							// most recently visited, then alphabetical
							// check for timestamps
							var a_mapHistoryEntry = mapHistory[a.info.id];
							var b_mapHistoryEntry = mapHistory[b.info.id];

							if( !!a_mapHistoryEntry && !!a_mapHistoryEntry.timestamp && !!b_mapHistoryEntry && !!b_mapHistoryEntry.timestamp )
							{

								var a_time = a_mapHistoryEntry.timestamp;
								var b_time = b_mapHistoryEntry.timestamp;
								if( b_time > a_time )
									return 1;
								else if( a_time > b_time )
									return -1;
								else
									return 0;
							}
							else if( !!b_mapHistoryEntry && !!b_mapHistoryEntry.timestamp && (!!!a_mapHistoryEntry || !!!a_mapHistoryEntry.timestamp) )
								return 1;
							else if( !!a_mapHistoryEntry && !!a_mapHistoryEntry.timestamp && (!!!b_mapHistoryEntry || b_mapHistoryEntry.timestamp) )
								return -1;
							//else if( a.platforms[arcadeHud.platformId].file.toLowerCase() < b.platforms[arcadeHud.platformId].file.toLowerCase() )
							//	return -1;
							//else if( a.platforms[arcadeHud.platformId].file.toLowerCase() > b.platforms[arcadeHud.platformId].file.toLowerCase() )
								//return 1;
							else
								return 0;
						}

						function sortFilename(a, b)
						{
							if( a.platforms[arcadeHud.platformId].file.toLowerCase() < b.platforms[arcadeHud.platformId].file.toLowerCase() )
								return -1;
							else if( a.platforms[arcadeHud.platformId].file.toLowerCase() > b.platforms[arcadeHud.platformId].file.toLowerCase() )
								return 1;
							else
								return 0;
						}

						function sortFilenameAndFavorites(a, b)
						{
							// sm_ first, & alphabetical
							if( !!favoriteMaps[a.info.id] && !!!favoriteMaps[b.info.id] )
								return -1;
							else if( !!favoriteMaps[b.info.id] && !!!favoriteMaps[a.info.id] )
								return 1;
							//else if( !!favoriteMaps[b.info.id] && !!favoriteMaps[a.info.id] )
							//	return 0;
							else if( !!!favoriteMaps[b.info.id] && (b.platforms[arcadeHud.platformId].file.indexOf("sm_") === 0 || b.platforms[arcadeHud.platformId].file.indexOf("meta_") === 0) && (a.platforms[arcadeHud.platformId].file.indexOf("sm_") !== 0 && a.platforms[arcadeHud.platformId].file.indexOf("meta_") !== 0) )
								return 1;
							else if( !!!favoriteMaps[a.info.id] && (a.platforms[arcadeHud.platformId].file.indexOf("sm_") === 0 || a.platforms[arcadeHud.platformId].file.indexOf("meta_") === 0) && (b.platforms[arcadeHud.platformId].file.indexOf("sm_") !== 0 && b.platforms[arcadeHud.platformId].file.indexOf("meta_") !== 0) )
								return -1;
							else
							{
								if( a.platforms[arcadeHud.platformId].file.toLowerCase() < b.platforms[arcadeHud.platformId].file.toLowerCase() )
									return -1;
								else if( a.platforms[arcadeHud.platformId].file.toLowerCase() > b.platforms[arcadeHud.platformId].file.toLowerCase() )
									return 1;
								else
									return 0;
							}
						}

						mapHistory = (localStorage.getItem("mapHistory")) ? JSON.parse(localStorage.getItem("mapHistory")) : {};

						// spawn the most recent maps
						//g_allFoundMapsCached.sort(sortFilename);
						g_allFoundMapsCached.sort(sortRecent);
						//g_allFoundMapsCached.sort(sortFilenameAndFavorites);

						// spawn all of the maps, alphabetically.
						//g_allFoundMapsCached.sort(sortFilename);
						//console.log(JSON.stringify(g_allFoundMapsCached));
					}
					else if(context === "screenshots")
					{
						//response = aaapi.cmdEx("getAllMapScreenshots", "", searchTerm);

						//for( var x in response )
						//	g_allFoundScreenshotsCached.push(response[x]);

						var screenshotsResponse = aaapi.cmdEx("getAllMapScreenshots", "", searchTerm);

						for( var x in screenshotsResponse )
							g_allFoundScreenshotsCached.push(screenshotsResponse[x]);

						function sortRecentShots(a, b)
						{
							if( !!a.created && !!b.created )
							{
								var a_time = a.created;
								var b_time = b.created;
								if( b_time > a_time )
									return 1;
								else if( a_time > b_time )
									return -1;
								else
									return 0;
							}
							else
								return 0;
						}

						g_allFoundScreenshotsCached.sort(sortRecentShots);
					}
					else if(context === "interactiveshots")
					{
						var screenshotsResponse = aaapi.cmdEx("getAllMapScreenshots", "", searchTerm);

						for( var x in screenshotsResponse )
						{
							if( screenshotsResponse[x].hasJSFile != '1' )
								continue;

							g_allFoundScreenshotsCached.push(screenshotsResponse[x]);
						}
					}
					else if(context === "favorites")
					{
						var favoritesResponse = arcadeHud.favoritesLists;

						for( var x in favoritesResponse )
						{
							if( searchTerm == "" || favoritesResponse[x].title.toLowerCase().indexOf(searchTerm.toLowerCase()) >= 0 )
								g_allFavoritesLists.push(favoritesResponse[x]);
						}
					}				
				}
				else
				{
					if(context === "items")
					{
						response = aaapi.cmdEx("findFirstLibraryEntry", "items", "title", searchTerm, "type", typeSelect.value);
					}
					else if(context === "models")
					{
						response = aaapi.cmdEx("findFirstLibraryEntry", "models", "title", searchTerm);
					}
					else if(context === "maps")
					{
						//response = aaapi.cmdEx("getAllMapScreenshots");

						//for( var x in response )
						//	g_allFoundScreenshotsCached.push(response[x]);
						response = aaapi.cmdEx("findAllMaps", searchTerm.toLowerCase());

						for( var x in response.maps )
							g_allFoundMapsCached.push(response.maps[x]);

						var favoriteMaps = {};
						for( var i = 0; i < g_allFoundMapsCached.length; i++ )
						{
							if( !!g_allFoundMapsCached[i].map )
								favoriteMaps[g_allFoundMapsCached[i].map] = true;
						}

						var mapHistory;// = (localStorage.getItem("mapHistory")) ? JSON.parse(localStorage.getItem("mapHistory")) : {};

						function sortRecent(a, b)
						{
							// most recently visited, then alphabetical
							// check for timestamps
							var a_mapHistoryEntry = mapHistory[a.info.id];
							var b_mapHistoryEntry = mapHistory[b.info.id];

							if( !!a_mapHistoryEntry && !!a_mapHistoryEntry.timestamp && !!b_mapHistoryEntry && !!b_mapHistoryEntry.timestamp )
							{

								var a_time = a_mapHistoryEntry.timestamp;
								var b_time = b_mapHistoryEntry.timestamp;
								if( b_time > a_time )
									return 1;
								else if( a_time > b_time )
									return -1;
								else
									return 0;
							}
							else if( !!b_mapHistoryEntry && !!b_mapHistoryEntry.timestamp && (!!!a_mapHistoryEntry || !!!a_mapHistoryEntry.timestamp) )
								return 1;
							else if( !!a_mapHistoryEntry && !!a_mapHistoryEntry.timestamp && (!!!b_mapHistoryEntry || b_mapHistoryEntry.timestamp) )
								return -1;
							//else if( a.platforms[arcadeHud.platformId].file.toLowerCase() < b.platforms[arcadeHud.platformId].file.toLowerCase() )
							//	return -1;
							//else if( a.platforms[arcadeHud.platformId].file.toLowerCase() > b.platforms[arcadeHud.platformId].file.toLowerCase() )
								//return 1;
							else
								return 0;
						}

						function sortFilename(a, b)
						{
							if( a.platforms[arcadeHud.platformId].file.toLowerCase() < b.platforms[arcadeHud.platformId].file.toLowerCase() )
								return -1;
							else if( a.platforms[arcadeHud.platformId].file.toLowerCase() > b.platforms[arcadeHud.platformId].file.toLowerCase() )
								return 1;
							else
								return 0;
						}

						function sortFilenameAndFavorites(a, b)
						{
							// sm_ first, & alphabetical
							if( !!favoriteMaps[a.info.id] && !!!favoriteMaps[b.info.id] )
								return -1;
							else if( !!favoriteMaps[b.info.id] && !!!favoriteMaps[a.info.id] )
								return 1;
							//else if( !!favoriteMaps[b.info.id] && !!favoriteMaps[a.info.id] )
							//	return 0;
							else if( !!!favoriteMaps[b.info.id] && (b.platforms[arcadeHud.platformId].file.indexOf("sm_") === 0 || b.platforms[arcadeHud.platformId].file.indexOf("meta_") === 0) && (a.platforms[arcadeHud.platformId].file.indexOf("sm_") !== 0 && a.platforms[arcadeHud.platformId].file.indexOf("meta_") !== 0) )
								return 1;
							else if( !!!favoriteMaps[a.info.id] && (a.platforms[arcadeHud.platformId].file.indexOf("sm_") === 0 || a.platforms[arcadeHud.platformId].file.indexOf("meta_") === 0) && (b.platforms[arcadeHud.platformId].file.indexOf("sm_") !== 0 && b.platforms[arcadeHud.platformId].file.indexOf("meta_") !== 0) )
								return -1;
							else
							{
								if( a.platforms[arcadeHud.platformId].file.toLowerCase() < b.platforms[arcadeHud.platformId].file.toLowerCase() )
									return -1;
								else if( a.platforms[arcadeHud.platformId].file.toLowerCase() > b.platforms[arcadeHud.platformId].file.toLowerCase() )
									return 1;
								else
									return 0;
							}
						}

						mapHistory = (localStorage.getItem("mapHistory")) ? JSON.parse(localStorage.getItem("mapHistory")) : {};

						// spawn the most recent maps
						//g_allFoundMapsCached.sort(sortFilename);
						g_allFoundMapsCached.sort(sortRecent);
						//g_allFoundMapsCached.sort(sortFilenameAndFavorites);

						// spawn all of the maps, alphabetically.
						//g_allFoundMapsCached.sort(sortFilename);
						//console.log(JSON.stringify(g_allFoundMapsCached));
					}
					else if(context === "screenshots")
					{
						//response = aaapi.cmdEx("getAllMapScreenshots");

						//for( var x in response )
						//	g_allFoundScreenshotsCached.push(response[x]);
						var screenshotResponse = aaapi.cmdEx("getAllMapScreenshots", "", searchTerm);

						for( var x in screenshotResponse )
							g_allFoundScreenshotsCached.push(screenshotResponse[x]);

						function sortRecentShots(a, b)
						{
							if( !!a.created && !!b.created )
							{
								var a_time = a.created;
								var b_time = b.created;
								if( b_time > a_time )
									return 1;
								else if( a_time > b_time )
									return -1;
								else
									return 0;
							}
							else
								return 0;
						}

						g_allFoundScreenshotsCached.sort(sortRecentShots);
					}
					else if(context === "interactiveshots")
					{
						var screenshotResponse = aaapi.cmdEx("getAllMapScreenshots", "", searchTerm);

						for( var x in screenshotResponse )
						{
							if( screenshotResponse[x].hasJSFile != '1' )
								continue;

							g_allFoundScreenshotsCached.push(screenshotResponse[x]);
						}
					}
					else if(context === "favorites")
					{
						var favoritesResponse = arcadeHud.favoritesLists;

						for( var x in favoritesResponse )
							g_allFavoritesLists.push(favoritesResponse[x]);
					}
				}

				if(context === "screenshots")
				{
					listLoading.style.display = "block";
					listItems.style.display = "none";
					listProps.style.display = "none";
					listMaps.style.display = "none";
					listScreenshots.style.display = "none";
					listServers.style.display = "none";
					g_lastUsedScreenshotResult++;

					queryId = 'screenshotsSearch';
					var mockResult = g_allFoundScreenshotsCached[g_lastUsedScreenshotResult];

					if( !!!mockResult )
						response = {success: false};
					else
						response = {entry: mockResult, success: true};

					doNextResult(context, response);
				}
				else if(context === "interactiveshots")
				{
					listLoading.style.display = "block";
					listItems.style.display = "none";
					listProps.style.display = "none";
					listMaps.style.display = "none";
					listScreenshots.style.display = "none";
					listServers.style.display = "none";
					g_lastUsedScreenshotResult++;

					queryId = 'interactiveshotsSearch';
					var mockResult = g_allFoundScreenshotsCached[g_lastUsedScreenshotResult];

					if( !!!mockResult )
						response = {success: false};
					else
						response = {entry: mockResult, success: true};

					doNextResult(context, response);
				}
				else if(context === "favorites")
				{
					listLoading.style.display = "block";
					listItems.style.display = "none";
					listProps.style.display = "none";
					listMaps.style.display = "none";
					listScreenshots.style.display = "none";
					listFavorites.style.display = "none";
					listServers.style.display = "none";
					g_lastUsedFavoritesResult++;

					queryId = 'favoritesSearch';
					var resultEntry;

					var mockResult;
					if( g_lastUsedFavoritesResult < g_allFavoritesLists.length )
					{
						resultEntry = g_allFavoritesLists[g_lastUsedFavoritesResult];

						var screenImage = (!!resultEntry.screen && resultEntry.screen != '') ? resultEntry.screen : '';
						mockResult = {
							info: {
								id: resultEntry.id
							},
							title: resultEntry.title,
							screen: resultEntry.screen,
							file: resultEntry.screen
						}
					}

					if( !!!mockResult )
						response = {success: false};
					else
						response = {entry: mockResult, success: true};

					doNextResult(context, response);
				}
				else if(context === "maps")
				{
					listLoading.style.display = "block";
					listItems.style.display = "none";
					listProps.style.display = "none";
					listMaps.style.display = "none";
					listScreenshots.style.display = "none";
					listFavorites.style.display = "none";
					listServers.style.display = "none";
					g_lastUsedMapResult++;

					queryId = 'mapsSearch';
					var mockResult = g_allFoundMapsCached[g_lastUsedMapResult];

					if( !!!mockResult )
						response = {success: false};
					else
						response = {entry: mockResult, success: true};

					doNextResult(context, response);
				}
				else
				{
					queryId = response.queryId;
					if( response.success )
					{
						listLoading.style.display = "block";
						listItems.style.display = "none";
						listProps.style.display = "none";
						listMaps.style.display = "none";
						listScreenshots.style.display = "none";
						listFavorites.style.display = "none";
						listServers.style.display = "none";
						doNextResult(context, response);
					}
				}

				//var usedEntries = 0;
				//cacheSize = Infinity;
				//console.log(cacheSize);
			}

			// also handle the filters list
			// clear the filters
			while (typeSelect.options.length)
				typeSelect.remove(0);

			//var typeKeys = Object.keys(types);
			//for( var i = 0; i < types.length; i++ )
			//for( key in types )
			//{
				// add category-specific filters
				//if( category === "items" )
				//{
					var fieldValueOption = document.createElement("option");
					fieldValueOption.value = "";
					fieldValueOption.text = "All Types";
					typeSelect.appendChild(fieldValueOption);

					var x;
					for( y in types )
					{
						var type = types[y];

						//if( type.title === "node" )
						//	continue;

						fieldValueOption = document.createElement("option");
						fieldValueOption.value = type.info.id;
						fieldValueOption.text = type.title;
						if( !!libraryBrowserContext && libraryBrowserContext.category == 'items' && libraryBrowserContext.filter == type.info.id )
							fieldValueOption.selected = true;
						//else if( type.info.id === libraryBrowserContext.filter )
						//	fieldValueOption.selected = true;

						typeSelect.appendChild(fieldValueOption);

						//if( isNode )
						//	filterSelect.style.display = "none";
						//else
							//filterSelect.style.display = "inline-block";
					}
				//}
			//}

			var libSearchInput = document.querySelector("#libSearchInput");

			var searchIconContainer = document.createElement('div');
			libSearchInput.parentNode.insertBefore(searchIconContainer, libSearchInput);
			searchIconContainer.style.cssText = 'position: relative;';

			var searchIconHTML = arcadeHud.generateIconHTML("searchicon.png", 24, 24, "aaThemeColorOneColor");

			var searchIcon = document.createElement('div');
			searchIconContainer.appendChild(searchIcon);
			searchIcon.style.cssText = 'position: absolute; z-index: 10; width: 24px; height: 24px; margin: 6px; margin-top: 10px;';
			searchIcon.innerHTML = searchIconHTML;

			function switchModes(e)
			{
				var oldMode;
				var oldActive = document.querySelector('.modeIconContainerActive');
				if( !!oldActive )
				{
					oldActive.classList.remove('modeIconContainerActive');
					oldMode = oldActive.getAttribute('mode');
				}

				typeSelect.selectedIndex = 0;

				var mode = e.currentTarget.getAttribute('mode');

				if( mode == 'favorites' )
					libSearchInput.value = '';

				var active = document.querySelector('.modeIconContainer[mode=' + mode + ']');
				if( !!active )
					active.classList.add('modeIconContainerActive');

				aaapi.cmd("setLibraryBrowserContext", mode, '', libSearchInput.value, typeSelect.value);

				/*if( mode != oldMode )
				{
					doSearch(libSearchInput.value);
				}*/

				if( mode == oldMode && mode != 'interactiveshots' )
				{
					if( libSearchInput.value != "" )
					{
						libSearchInput.value = "";
						doSearch(libSearchInput.value);
					}
				}
				else
				{
					doSearch(libSearchInput.value);
				}
			}

			var elems = document.querySelectorAll('.modeIconContainer');
			for( var i = 0; i < elems.length; i++ )
			{
				elems[i].addEventListener('click', switchModes);
			}

			function resetFilters()
			{
				libSearchInput.value = '';
				typeSelect.selectedIndex = 0;
				listSelect.value = arcadeHud.activeFavoritesList;

				if( listSelect.options[0].value == '' )
					listSelect.removeChild(listSelect.options[0]);


				var oldMode;
				var oldActive = document.querySelector('.modeIconContainerActive');
				if( !!oldActive )
				{
					oldActive.classList.remove('modeIconContainerActive');
					oldMode = oldActive.getAttribute('mode');
				}

				var active = document.querySelector('.modeIconContainer[mode=items]');
				if( !!active )
					active.classList.add('modeIconContainerActive');

				aaapi.cmd("setLibraryBrowserContext", 'items', '', '', '');
				showList(arcadeHud.activeFavoritesList);
			}

			//libSearchInput.parentNode.addEventListener('submit', function(e)
			function searchSubmit(e)
			{
				aaapi.cmd("setLibraryBrowserContext", context, '', libSearchInput.value, typeSelect.value);

				doSearch(libSearchInput.value);
				e.preventDefault;
				return false;
			}//);

			if( tabId == "backpack" )
			{
				setTimeout(function()
				{
					libSearchInput.focus();
				}, 100);
			}

			if( false )
			{
				var sourceSelect = document.querySelector('#sourceSelect');
				var allMounts = aaapi.cmdEx('getAllMounts').mounts;
				var mountOption, mount;
				for( var i = 0; i < allMounts.length; i++ )
				{
					mount = allMounts[i];
					if( !mount.active )
						continue;

					mountOption = document.createElement('option');	
					mountOption.text = mount.title;
					mountOption.value = mount.id;
					//mountOption.mount - mount;
					sourceSelect.appendChild(mountOption);
				}
			}

			setTimeout(function()
			{
				document.body.style.display = "block";
				dragscroll.reset();
			}, 1);

			// paint menu stuff
			//var textureName = '';
			//textureName = textureName.split('').reverse().join('');

			//var textureThumbNameElem = document.querySelector('.textureThumbName');
			//textureThumbNameElem.innerHTML = textureName;


			/*
<div class="textureContainer textureNeedsThumb">
	<div class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="width: 128px; height: 128px; padding: 8px;">
		<div class="textureButtonsContainer textureHasPreset">
			<div style="position: absolute;">
				<div class="textureButton addPreset" onclick="addTexturePreset();"><img src="plusicon.png" /></div>
				<div class="textureButton removePreset" onclick="removeTexturePreset();"><img src="minusicon.png" /></div>
				<div class="textureButton createThumb" onclick="createTextureThumb();"><img src="photoicon.png" /></div>
			</div>
		</div>
		<div class="textureThumb" style="background-image: url('noimageicon.png');"></div>
	</div>
	<div class="textureThumbName">zoeywhite</div>
</div>
*/

			// from https://stackoverflow.com/questions/23104582/scaling-an-image-to-fit-on-canvas
			function drawImageScaled(img, canvas)
			{
				var ctx = canvas.getContext('2d');
				var hRatio = canvas.width  / img.width    ;
				var vRatio =  canvas.height / img.height  ;
				var ratio  = Math.max ( hRatio, vRatio );
				var centerShift_x = ( canvas.width - img.width*ratio ) / 2;
				var centerShift_y = ( canvas.height - img.height*ratio ) / 2;  
				ctx.clearRect(0,0,canvas.width, canvas.height);
				ctx.drawImage(img, 0,0, img.width, img.height,
				centerShift_x,centerShift_y,img.width*ratio, img.height*ratio);  
			}

			var thumbCanvas, paintTexture, texturePalette, paletteElem;
			function createTextureCard(textureName)
			{
				var textureId = aaapi.cmdEx('generateHashId', textureName);

				var textureShortName = textureName;
				var found = textureShortName.lastIndexOf('/');
				if( found < 0 )
					found = textureShortName.lastIndexOf('\\');

				if( found > 0 )
					textureShortName = textureShortName.substring(found+1);

				var containerElem, subContainerElem, buttonsContainerElem, subButtonsContainerElem, plusButtonElem, minusButtonElem, photoButtonElem, textureThumbElem, textureLabelElem;

				containerElem = document.createElement('div');
				paletteElem.appendChild(containerElem);
				containerElem.className = 'textureContainer';
				// textureNeedsThumb: the thumb image needs to attempt to load before we know if it has one or not.
				// textureHasPreset: this one, we know already...
				if(texturePalette.entries.indexOf(textureName) >= 0 )
					containerElem.classList.add('textureHasPreset');

				subContainerElem = document.createElement('div');
				containerElem.appendChild(subContainerElem);
				subContainerElem.className = 'aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor';
				subContainerElem.style.cssText = 'width: 128px; height: 128px; padding: 8px;';
				subContainerElem.textureName = textureName;
				subContainerElem.addEventListener('click', onTextureButtonClicked);

				buttonsContainerElem = document.createElement('div');
				subContainerElem.appendChild(buttonsContainerElem);
				buttonsContainerElem.className = 'textureButtonsContainer';

				subButtonsContainerElem = document.createElement('div');
				buttonsContainerElem.appendChild(subButtonsContainerElem);
				subButtonsContainerElem.style.cssText = 'position: absolute;';

				plusButtonElem = document.createElement('div');
				subButtonsContainerElem.appendChild(plusButtonElem);
				plusButtonElem.className = 'textureButton addPreset helpNote';
				plusButtonElem.setAttribute('help', "Add this texture to your current palette.");
				plusButtonElem.textureName = textureName;
				plusButtonElem.addEventListener('click', onPlusButtonClicked);
				plusButtonElem.innerHTML = texPlusIconHTML;
				arcadeHud.assignHelp(plusButtonElem);

				minusButtonElem = document.createElement('div');
				subButtonsContainerElem.appendChild(minusButtonElem);
				minusButtonElem.className = 'textureButton removePreset helpNote';
				minusButtonElem.setAttribute('help', "Remove this texture from your current palette.");
				minusButtonElem.textureName = textureName;
				minusButtonElem.addEventListener('click', onMinusButtonClicked);
				minusButtonElem.innerHTML = texMinusIconHTML;
				arcadeHud.assignHelp(minusButtonElem);

				photoButtonElem = document.createElement('div');
				subButtonsContainerElem.appendChild(photoButtonElem);
				photoButtonElem.className = 'textureButton createThumb helpNote';
				photoButtonElem.setAttribute('help', "Create a thumbnail for this texture.");
				photoButtonElem.textureName = textureName;
				photoButtonElem.addEventListener('click', onPhotoButtonClicked);
				photoButtonElem.innerHTML = texPhotoIconHTML;
				arcadeHud.assignHelp(photoButtonElem);

				textureThumbElem = document.createElement('div');
				subContainerElem.appendChild(textureThumbElem);
				textureThumbElem.className = 'textureThumb helpNote';
				textureThumbElem.setAttribute('help', "Assign this texture to the material under your crosshair.");
				textureThumbElem.style.cssText = "background-image: url('noimageicon.png');";
				arcadeHud.assignHelp(textureThumbElem);

				textureLabelElem = document.createElement('div');
				containerElem.appendChild(textureLabelElem);
				textureLabelElem.className = 'textureThumbName';
				if( textureName == paintTexture )
					textureLabelElem.style.cssText = 'font-weight: 900; text-decoration: underline;';
				textureLabelElem.appendChild(document.createTextNode(textureShortName));

				var dummy = {
					thumbElem: textureThumbElem,
					containerElem: containerElem,
					buttonsContainerElem: buttonsContainerElem,
					timeout: null
				};

				dummy.timeout = setTimeout(function()
				{
					this.buttonsContainerElem.classList.add('textureNeedsThumb');
					this.timeout = null;
				}.bind(dummy), 500);

				var textureIdForThumb = textureId;//aaapi.cmdEx('generateHashId', textureName);
				if( textureName.indexOf("skybox/") == 0)
				{
					textureIdForThumb = aaapi.cmdEx('generateHashId', textureName + 'ft');
				}

				tga.open( "asset://local/cache/textures/" + textureIdForThumb + ".tga", function()
				{
					if( !!this.timeout )
					{
						clearTimeout(this.timeout);
						this.timeout = null;
						// even if the timeout already happened, it's not too late to swap in the texture even if it did take a long time to load.
					}

					//var canvas = tga.getCanvas();
					if( !!!thumbCanvas )
						thumbCanvas = document.createElement('canvas');
					thumbCanvas.width = '128';
					thumbCanvas.height = '128';

					var thumb = drawImageScaled(tga.getCanvas(), thumbCanvas);
					this.thumbElem.style.backgroundImage = "url('" + thumbCanvas.toDataURL('image/jpeg', 0.9) + "')";
					//this.containerElem.classList.add('textureHasPreset');
				}.bind(dummy));
					
				/*var option;
				for( var i = 0; i < texturePresets.length; i++ )
				{
					option = document.createElement('option');
					option.value = texturePresets[i];
					option.text = texturePresets[i];
					if( texturePresets[i] == paintTexture )
						option.selected = true;

					texturePresetsElem.appendChild(option);
				}*/
			}

			function onPlusButtonClicked(e)
			{
				addTexturePreset(e.currentTarget.textureName);
				e.preventDefault();
				e.stopPropagation();
			}

			function onMinusButtonClicked(e)
			{
				removeTexturePreset(e.currentTarget.textureName);
				e.preventDefault();
				e.stopPropagation();
			}

			function onPhotoButtonClicked(e)
			{
				createTextureThumb(e.currentTarget.textureName);
				e.preventDefault();
				e.stopPropagation();
			}

			function onTextureButtonClicked(e)
			{
				setPaintTexture(e.currentTarget.textureName);
				//aaapi.cmd('deactivateInputMode');
			}


			var texturePalettes = window.localStorage.getItem('texturePalettes');
			if( !!texturePalettes )
				texturePalettes = JSON.parse(texturePalettes);
			else
				texturePalettes = ['default'];

			/*var badIndex = texturePalettes.indexOf('');
			if( badIndex >= 0 )
			{
				texturePalettes.splice(badIndex, 1);
				window.localStorage.setItem('texturePalettes', JSON.stringify(texturePalettes));
			}*/

			var paletteId = window.localStorage.getItem('activeTexturePalette');
			if( !!!paletteId )
				paletteId = 'default';

			var texturePalette;

			function getActiveTexturePalette()
			{
				texturePalette = window.localStorage.getItem('texturePalette' + paletteId);
				if( !!texturePalette )
					texturePalette = JSON.parse(texturePalette);
				else
				{
					paletteId = 'default';

					texturePalette = {
						id: paletteId,
						title: "Palette",
						screen: "",
						entries: []
					};

					if( texturePalettes.indexOf(paletteId) < 0 )
					{
						texturePalettes.push(paletteId);
						window.localStorage.setItem('texturePalettes', JSON.stringify(texturePalettes));
					}
				}
			}
			getActiveTexturePalette();

			//texturePalette.entries = JSON.parse(window.localStorage.getItem('texturePresets'));
			//window.localStorage.setItem('texturePalette' + paletteId, JSON.stringify(texturePalette));

			function editPalette()
			{
				//var listId = listSelect.options[listSelect.selectedIndex].value;
				window.location = "asset://ui/editPalette.html?id=" + paletteId;
			}

			function createPalette()
			{
				var palette = arcadeHud.createTexturePalette(null, "Untitled Palette", '');
				paletteId = palette.id;
				window.localStorage.setItem('activeTexturePalette', paletteId);

				if( texturePalettes.indexOf(paletteId) < 0 )
				{
					texturePalettes.push(paletteId);
					window.localStorage.setItem('texturePalettes', JSON.stringify(texturePalettes));
				}

				window.location = "asset://ui/editPalette.html?id=" + paletteId;
			}

			function prepQuestsMenu()
			{
				console.log("Prep the quests menu!");

				var questsInactiveContainer = document.querySelector("#questsInactiveContainer");
				var questsActiveContainer = document.querySelector("#questsActiveContainer");
				var questsCompletedContainer = document.querySelector("#questsCompletedContainer");
				var questsHiddenContainer = document.querySelector("#questsHiddenContainer");

				var allQuests = aaapi.cmdEx("getAllQuests");
				/*var quest = {
					name: "Coin Collecting",
					objective: "Collect all the coins!",
					id: "sampleId",
					status: 1,
					hidden: false,
					collectOnce: true,
					numCollectible: 17,
					numCollected: 15
//	std::string name;
//	std::string objective;
//	std::string id;
//	eQuestStatus eStatus;
//	bool bHidden;
//	bool bCollectOnce;
//	float flStartTime;
//	float flMaxDuration;
	//std::vector<std::string> collectibleObjects;
	//std::vector<std::string> collectedObjects;
				};*/

				for( var i = 0; i < allQuests.length; i++ )
				{
					var quest = allQuests[i];

					var taskContainer = document.createElement("div");
					taskContainer.className = "taskContainer aaTitleTextSize aaTitleText";
					if( quest.status == 1 )
						taskContainer.className += " displayed aaThemeColorOneHoverShadedBackground aaThemeColorOneShadedBorderColor";
					else
						taskContainer.className += " aaThemeColorTwoHoverShadedBackground aaThemeColorOneShadedBorderColor";

					taskContainer.style.cssText = "font-family: Arial; font-weight: bold; letter-spacing: 0.1em; padding: 10px; border-radius: 4px; border-style: solid; border-width: 2px; cursor-events: all; margin-top: 4px; margin-bottom: 4px; box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7); margin-right: 4px; cursor: pointer; height: auto;";

					taskElem = document.createElement("div");
					taskElem.style.cssText += " width: 80%;";

					var taskImageContainer = document.createElement("div");
					taskImageContainer.style.cssText = "display: inline-block; margin-right: 10px; vertical-align: top; width: 90px; height: 38px; text-align: center; box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);";

					var taskImage = document.createElement("img");
					taskImage.style.display = "none";

					/*
					var taskItem = aaapi.cmdEx("getLibraryItem", task.itemId);
					taskImage.item = taskItem;
					taskImageContainer.appendChild(taskImage);
					taskElem.appendChild(taskImageContainer);
					taskElem.image = taskImage;
					taskContainer.addEventListener("mouseover", function(e)
					{
						if(false && !!this.image.ready)
						{
							var table = document.querySelector("#dummyMarker").parentNode.parentNode.parentNode.parentNode;
							table.style.background = "transparent url('" + this.image.src + "') center scroll no-repeat";
							table.style.backgroundSize = "cover";
						}
						e.preventDefault();
					}.bind(taskElem), true);

					arcadeHud.loadItemBestImage(taskImage, taskImage.item, function()
					{
						this.ready = true;

						var imageContainer = this.parentNode;
						imageContainer.style.background = "transparent url('" + this.src + "') center";
						imageContainer.style.backgroundSize = "cover";
					}.bind(taskImage));
					*/

					if( quest.status == 1 )
						taskElem.className = "taskTitle aaTextColorOneColor";
					else
					{
						taskElem.className = "taskTitle aaTextColorTwoColor";
						taskElem.style.cssText += " text-shadow: none;";
					}

					taskElem.style.cssText += " position: relative; top: -6px;";

					var questTitle = quest.name;
					if( quest.numCollectible > 1 )
						questTitle = questTitle + " (" + quest.numCollected + "/" + quest.numCollectible + ")";

					if( quest.status == 0 )
						questTitle = "(INACTIVE) " + questTitle;

					var textNode = document.createTextNode(questTitle);
					taskElem.appendChild(textNode);

					var objectiveElem = document.createElement('div');
					objectiveElem.appendChild(document.createTextNode("- " + quest.objective));
					objectiveElem.style.cssText = "display: block; font-size: 12px; height: 6px; line-height: 1px; padding-left: 20px;";

					taskElem.appendChild(objectiveElem);

	/*
					taskElem.addEventListener("click", function(e)
					{
						//aaapi.cmd("selectTaskObject", this.id);
						aaapi.cmd("displayTask", this.id);
						aaapi.cmd("deactivateInputMode");
					}.bind(task));
					*/

					iconsContainer = document.createElement("div");
					iconsContainer.className = "iconsContainer";
					iconsContainer.style.cssText = "float: right;";

					// EDIT button
					iconButton = document.createElement("div");
					iconButton.className = "taskButton aaThemeColorOneHoverShadedBackground helpNote";

					iconButton.setAttribute("help", "Edit this quest.");
					iconButton.style.cssText = "margin-right: 8px;";
					iconButton.questId = quest.id;
					iconButton.quest = quest;
					iconButton.addEventListener("click", function()
					{
						editEZQuest(this.quest);
						//aaapi.cmdEx('editEZQuest', this.questId);
						//location.reload();
						/*
						aaapi.cmd("closeTask", this.questId);
						aaapi.cmdEx("threadBlock");	// wait for the engine to catch up.
						location.reload();
						*/
					}.bind(iconButton));
					iconImage = document.createElement("img");
					iconImage.src = "editicon.png";
					iconButton.appendChild(iconImage);
					iconsContainer.appendChild(iconButton);

					// RESTART button
					iconButton = document.createElement("div");
					iconButton.className = "taskButton aaThemeColorOneHoverShadedBackground helpNote";

					iconButton.setAttribute("help", "Restart this quest.");
					iconButton.style.cssText = "margin-right: 8px;";
					iconButton.questId = quest.id;
					iconButton.addEventListener("click", function()
					{
						aaapi.cmdEx('resetQuest', this.questId);
						location.reload();
						/*
						aaapi.cmd("closeTask", this.questId);
						aaapi.cmdEx("threadBlock");	// wait for the engine to catch up.
						location.reload();
						*/
					});
					iconImage = document.createElement("img");
					iconImage.src = "refreshicon.png";
					iconButton.appendChild(iconImage);
					iconsContainer.appendChild(iconButton);

					taskContainer.appendChild(iconsContainer);
					taskContainer.appendChild(taskElem);

					if( quest.hidden )
					{
						questsHiddenContainer.appendChild(taskContainer);
						//var elems = document.querySelectorAll('.hiddenQuestsSection');
						//for( var j = 0; j < elems.length; j++ )
							//elems[j].style.display = 'block';
						////questsHiddenContainer.style.display = "block";
					}
					else if( quest.status == 0 )
					{
						questsInactiveContainer.appendChild(taskContainer);
						var elems = document.querySelectorAll('.inactiveQuestsSection');
						for( var j = 0; j < elems.length; j++ )
							elems[j].style.display = 'block';
						//questsInactiveContainer.style.display = "block";
					}
					else if( quest.status == 1 )
					{
						questsActiveContainer.appendChild(taskContainer);
						var elems = document.querySelectorAll('.activeQuestsSection');
						for( var j = 0; j < elems.length; j++ )
							elems[j].style.display = 'block';
						//questsActiveContainer.style.display = "block";
					}
					else if( quest.status == 2 )
					{
						questsCompletedContainer.appendChild(taskContainer);
						var elems = document.querySelectorAll('.completedQuestsSection');
						for( var j = 0; j < elems.length; j++ )
							elems[j].style.display = 'block';
						//questsCompletedContainer.style.display = "block";
					}
				}

				if( allQuests.length <= 0 )
					document.querySelector("#noQuestsAvailable").style.display = "block";
				else
					document.querySelector("#noQuestsAvailable").style.display = "none";
			}

			var texPlusIconHTML, texMinusIconHTML, texPhotoIconHTML;
			function prepPaintMenu()
			{
				texPlusIconHTML = arcadeHud.generateIconHTML("plusicon.png", 24, 24, "aaTextColorTwoColor");
				texMinusIconHTML = arcadeHud.generateIconHTML("minusicon.png", 24, 24, "aaTextColorTwoColor");
				texPhotoIconHTML = arcadeHud.generateIconHTML("photoicon.png", 24, 24, "aaTextColorTwoColor");
				texEraseIconHTML = arcadeHud.generateIconHTML("eraseicon.png", 24, 24, "aaTextColorTwoColor");
				texPickerIconHTML = arcadeHud.generateIconHTML("pickericon.png", 24, 24, "aaTextColorTwoColor");
				texRefreshIconHTML = arcadeHud.generateIconHTML("refreshicon.png", 24, 24, "aaTextColorTwoColor");
				texSkyboxIconHTML = arcadeHud.generateIconHTML("skyboxicon.png", 24, 24, "aaTextColorTwoColor");
				texRefreshSkyboxIconHTML = arcadeHud.generateIconHTML("eraseicon.png", 24, 24, "aaTextColorTwoColor");

				document.querySelector('#reapplyMatButton').innerHTML = texRefreshIconHTML + '<div style="padding-left: 6px; display: inline;">Re-Apply All</div>';

				document.querySelector('#resetMatButton').innerHTML = texEraseIconHTML + '<div style="padding-left: 6px; display: inline;">Reset Material</div>';

				document.querySelector('#pickTextureButton').innerHTML = texPickerIconHTML + '<div style="padding-left: 6px; display: inline;">Pick Texture</div>';

				document.querySelector('#pickSkyboxButton').innerHTML = texSkyboxIconHTML + '<div style="padding-left: 6px; display: inline;">Pick Skybox</div>';

				document.querySelector('#unpaintSkyboxButton').innerHTML = texRefreshSkyboxIconHTML + '<div style="padding-left: 6px; display: inline;">Reset Skybox</div>';

				paletteElem = document.querySelector('#palette');
				paintTexture = aaapi.cmdEx('getConVarValue', 'paint_texture');

				var paletteSelect = document.querySelector("#paletteselect");

				paletteSelect.addEventListener("change", function(e)
				{
					var id = this.options[this.selectedIndex].value;
					if( id == paletteId )
						return;

					showPalette(id);
				}.bind(paletteSelect));

				// add in all the palettes to the box
				var option, palette;
				for( var i = 0; i < texturePalettes.length; i++ )
				{
					palette = window.localStorage.getItem('texturePalette' + texturePalettes[i]);
					if( !!!palette )
						continue;
					else
						palette = JSON.parse(palette);

					option = document.createElement("option");
					option.value = palette.id;
					option.text = palette.title;

					if( palette.id === paletteId )
						option.selected = true;

					paletteSelect.appendChild(option);
				}

				for( var i = 0; i < texturePalette.entries.length; i++ )
				{
					//console.log("Entry: " + texturePalette.entries[i]);
					createTextureCard(texturePalette.entries[i]);
				}
			}

			/*function showPalette(paletteId)
			{
				console.log("Show Palette: " + paletteId);	
			}*/

			function setPaintTexture(textureName)
			{
				if( textureName.indexOf("skybox/") == 0)
				{
					paintSky(textureName);
					return;
				}

				aaapi.cmd('consoleCommand', 'paint_texture "' + textureName + '"; paint;');//deactivateInputMode; 
			}

			function paintSky(textureName)
			{
				if( textureName.indexOf("skybox/") != 0 )
					return;

				var targetSky = textureName.substring(7);
				//console.log(targetSky);
				//return;

				//var originalSky = aaapi.cmdEx('getConVarValue', 'sv_skyname');
				//aaapi.cmd('consoleCommand', 'sv_skyname "' + targetSky + '"');

				var originalSky = aaapi.cmdEx('getConVarValue', 'sv_skyname');
				aaapi.cmd('setMaterialMod', 'skybox/' + originalSky + 'bk', '$basetexture', 'skybox/' + targetSky + 'bk', false);
				aaapi.cmd('setMaterialMod', 'skybox/' + originalSky + 'dn', '$basetexture', 'skybox/' + targetSky + 'dn', false);
				aaapi.cmd('setMaterialMod', 'skybox/' + originalSky + 'ft', '$basetexture', 'skybox/' + targetSky + 'ft', false);
				aaapi.cmd('setMaterialMod', 'skybox/' + originalSky + 'lf', '$basetexture', 'skybox/' + targetSky + 'lf', false);
				aaapi.cmd('setMaterialMod', 'skybox/' + originalSky + 'rt', '$basetexture', 'skybox/' + targetSky + 'rt', false);
				aaapi.cmd('setMaterialMod', 'skybox/' + originalSky + 'up', '$basetexture', 'skybox/' + targetSky + 'up', true);
			}

			function unpaintSky()
			{
				var originalSky = aaapi.cmdEx('getConVarValue', 'sv_skyname');
				aaapi.cmd('clearMaterialMod', 'skybox/' + originalSky + 'bk', '$basetexture', false);
				aaapi.cmd('clearMaterialMod', 'skybox/' + originalSky + 'dn', '$basetexture', false);
				aaapi.cmd('clearMaterialMod', 'skybox/' + originalSky + 'ft', '$basetexture', false);
				aaapi.cmd('clearMaterialMod', 'skybox/' + originalSky + 'lf', '$basetexture', false);
				aaapi.cmd('clearMaterialMod', 'skybox/' + originalSky + 'rt', '$basetexture', false);
				aaapi.cmd('clearMaterialMod', 'skybox/' + originalSky + 'up', '$basetexture', true);
				//aaapi.cmd('consoleCommand', 'unpaint');
				//aaapi.cmd('deactivateInputMode');
			}

			function createTextureThumb(textureName)
			{
				if( textureName.indexOf("skybox/") != 0 )
				{
					var thumbId = aaapi.cmdEx('generateTextureThumb', textureName);
					setTimeout(function()
					{
						document.location.href = 'tabMenu.html?tab=paint';
					}, 200);
				}
				else
				{
					var goodTextureName = textureName + "ft";

					var thumbId = aaapi.cmdEx('generateTextureThumb', goodTextureName);
					setTimeout(function()
					{
						document.location.href = 'tabMenu.html?tab=paint';
					}, 200);

					/*
					var skyboxNames = ['bk', 'dn', 'ft', 'lf', 'rt', 'up'];
					for( var i = 0; i < skyboxNames.length; i++ )
					{
						var goodTextureName = textureName + skyboxNames[i];
						var thumbId = aaapi.cmdEx('generateTextureThumb', goodTextureName);
					}

					setTimeout(function()
					{
						document.location.href = 'tabMenu.html?tab=paint';
					}, 200);
					*/
				}
			}

			function addTexturePreset(textureName)
			{
				if( texturePalette.entries.indexOf(textureName) < 0 )
				{
					texturePalette.entries.push(textureName);
					window.localStorage.setItem('texturePalette' + paletteId, JSON.stringify(texturePalette));
					document.location.href = 'tabMenu.html?tab=paint';
				}
			}

			function removeTexturePreset(textureName)
			{
				var arrayIndex = texturePalette.entries.indexOf(textureName);
				if( arrayIndex >= 0 )
				{
					texturePalette.entries.splice(arrayIndex, 1);
					window.localStorage.setItem('texturePalette' + paletteId, JSON.stringify(texturePalette));
					document.location.href = 'tabMenu.html?tab=paint';
				}
			}

			function pickTexture()
			{
				aaapi.cmd('consoleCommand', 'pick_texture');
				setTimeout(function()
				{
					paintTexture = aaapi.cmdEx('getConVarValue', 'paint_texture');

					if( paintTexture != '' && texturePalette.entries.indexOf(paintTexture) < 0 )
					{
						texturePalette.entries.push(paintTexture);
						window.localStorage.setItem('texturePalette' + paletteId, JSON.stringify(texturePalette));
					}

					document.location.href = 'tabMenu.html?tab=paint';
				}, 100);
			}

			function resetMaterial()
			{
				aaapi.cmd('consoleCommand', 'unpaint');
				aaapi.cmd('deactivateInputMode');
			}

			function reapplyAll()
			{
				aaapi.cmd('consoleCommand', 'repaint');
			}

			/*function resetAllMaterials()
			{
				aaapi.cmd('clearAllMaterialMods');
				aaapi.cmd('deactivateInputMode');
			}*/

			var objectCreatedListener = {
				objectCreated: function()
				{
					// do nothing, but squash the console spam.
				}
			};


			// from https://stackoverflow.com/questions/15900485/correct-way-to-convert-size-in-bytes-to-kb-mb-gb-in-javascript
			function formatBytes(a,b){if(0==a)return"0 Bytes";var c=1024,d=b||2,e=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],f=Math.floor(Math.log(a)/Math.log(c));return parseFloat((a/Math.pow(c,f)).toFixed(d))+" "+e[f]}
			//Backup Library (' + formatBytes(aaapi.cmdEx("getDbSize")) + ')

			var noUploadsElem = document.querySelector("#noUploads");
			var uploadCountContainer = document.querySelector('#uploadCount');
			var uploadedCountContainer = document.querySelector('#uploadedCount');
			var uploadedContainer = document.querySelector('#uploaded');
			var uploadingContainer = document.querySelector('#uploading');
			var uploadsContainer = document.querySelector('#uploads');
			var requestedUploadsContainer = document.querySelector('#requestedUploads');

			var noDownloadsElem = document.querySelector('#noDownloads');
			var downloadingContainer = document.querySelector('#downloading');
			var downloadsContainer = document.querySelector('#downloads');
			var downloadedContainer = document.querySelector('#downloaded');
			var requestedContainer = document.querySelector('#requested');
			var downloadCountContainer = document.querySelector('#downloadCount');
			var downloadedCountContainer = document.querySelector('#downloadedCount');
			var downloadsStuffContainer = document.querySelector('#downloadsStuff');
			//var downloadedStuffContainer = document.querySelector('#downloadedStuff');
			var downloadsPane = document.querySelector('#downloadsPane');
			//var downloadedPane = document.querySelector('#downloadedPane');

			var transfers = {
				downloads: [],
				downloaded: [],
				requested: []
			};

			var uploads = transfers.uploads;
			var downloads = transfers.downloads;
			var downloadedList = {};
			var downloaded = transfers.downloaded;
			var requested = transfers.requested;
			function processFileRequested(fileRequestEntry)
			{
				var container;
				for( var i = 0; i < downloads.length; i++ )
				{
					//console.log(downloads[i].id + ' vs ' + fileRequestEntry.id);
					if( downloads[i].id == fileRequestEntry.id )
						return;
				}

				for( var i = 0; i < downloaded.length; i++ )
				{
					if( downloaded[i].id == fileRequestEntry.id )
						return;
				}
				
				var shortFileName = fileRequestEntry.file;
				var found = shortFileName.lastIndexOf("/");
				if( found < 0 )
					found = shortFileName.lastIndexOf("\\");
				if( found > 0 )
					shortFileName = shortFileName.substring(found+1);

				found = shortFileName.lastIndexOf(".");
				if( found > 0 )
					shortFileName = shortFileName.substring(0, found);

				var myFakeMessage = {
					"type": "byteprogress",
					"text": "",
					"title": shortFileName,
					"id": fileRequestEntry.id,
					"min": "",
					"max": "",
					"current": "",
					"callbackMethod": "",
					"slate": requestedContainer
				};

				arcadeHud.addHudLoadingMessage(myFakeMessage.type, myFakeMessage.text, myFakeMessage.title, myFakeMessage.id, myFakeMessage.min, myFakeMessage.max, myFakeMessage.current, myFakeMessage.callbackMethod, myFakeMessage.slate);
			}

			function processUploadUpdate(uploadEntry)
			{
				if( !!!uploads )
					return;

				var alreadyFound = false;

				for( var i = 0; i < uploads.length; i++ )
				{
					if(  uploads[i].id == uploadEntry.id )
					{
						uploads.splice(i, 1, uploadEntry);
						alreadyFound = true;
						break;
					}
				}
				if( !alreadyFound )
					uploads.push(uploadEntry);

				if( uploadEntry.status == "uploaded" )
				{
					var container, fileName, size, totalSize;//, percent;
					var other;

					totalSize = parseInt(uploadEntry.size);

					var shortFileName = uploadEntry.file;
					var found = shortFileName.lastIndexOf("/");
					if( found < 0 )
						found = shortFileName.lastIndexOf("\\");
					if( found > 0 )
						shortFileName = shortFileName.substring(found+1);

					found = shortFileName.lastIndexOf(".");
					if( found > 0 )
						shortFileName = shortFileName.substring(0, found);

					var myFakeMessage = {
						"type": "byteprogress",
						"text": "",
						"title": shortFileName,
						"id": uploadEntry.id,
						"min": "",//0 + "",
						"max": "",//totalSize + "",
						"current": totalSize + "",
						"callbackMethod": "",
						"slate": uploadedContainer
					};

					arcadeHud.addHudLoadingMessage(myFakeMessage.type, myFakeMessage.text, myFakeMessage.title, myFakeMessage.id, myFakeMessage.min, myFakeMessage.max, myFakeMessage.current, myFakeMessage.callbackMethod, myFakeMessage.slate);					

					var numUploaded = 0;
					for( var i = 0; i < uploads.length; i++ )
					{
						if( uploads[i].status == 'uploaded' )
							numUploaded++;
					}

					// uploads
					uploadCountContainer.innerHTML = '';
					uploadCountContainer.appendChild(document.createTextNode(uploads.length));

					// uploaded
					uploadedCountContainer.innerHTML = '';
					uploadedCountContainer.appendChild(document.createTextNode(numUploaded));
				}
				else if( uploadEntry.status == 'uploading' )
				{
					var container, fileName, status, size, totalSize;//, percent;
					var other;

					//totalSize = unknown parseInt(uploadEntry.size);
					sizeUploaded = uploadEntry.size;
					
					var shortFileName = uploadEntry.file;
					var found = shortFileName.lastIndexOf("/");
					if( found < 0 )
						found = shortFileName.lastIndexOf("\\");
					if( found > 0 )
						shortFileName = shortFileName.substring(found+1);

					found = shortFileName.lastIndexOf(".");
					if( found > 0 )
						shortFileName = shortFileName.substring(0, found);

					var myFakeMessage = {
						"type": "progress",
						"text": "",
						"title": shortFileName,
						"id": uploadEntry.id,
						"min": 0 + "",
						"max": uploadEntry.total + "",
						"current": uploadEntry.current + "",
						"callbackMethod": "",
						"slate": uploadsContainer
					};

					if( uploadEntry.total > 0 )
					{
						arcadeHud.removeHudLoadingMessage(uploadEntry.id);
						myFakeMessage.slate = uploadingContainer;
					}

					arcadeHud.addHudLoadingMessage(myFakeMessage.type, myFakeMessage.text, myFakeMessage.title, myFakeMessage.id, myFakeMessage.min, myFakeMessage.max, myFakeMessage.current, myFakeMessage.callbackMethod, myFakeMessage.slate);
				}
				else if( uploadEntry.status == 'pending' )
				{
					var container;
					for( var i = 0; i < uploads.length; i++ )
					{
						if(  uploads[i].id == uploadEntry.id )
							return;
					}
					
					var shortFileName = uploadEntry.file;
					var found = shortFileName.lastIndexOf("/");
					if( found < 0 )
						found = shortFileName.lastIndexOf("\\");
					if( found > 0 )
						shortFileName = shortFileName.substring(found+1);

					found = shortFileName.lastIndexOf(".");
					if( found > 0 )
						shortFileName = shortFileName.substring(0, found);

					var myFakeMessage = {
						"type": "byteprogress",
						"text": "",
						"title": shortFileName,
						"id": uploadEntry.id,
						"min": "",
						"max": "",
						"current": "",
						"callbackMethod": "",
						"slate": requestedUploadsContainer
					};

					arcadeHud.addHudLoadingMessage(myFakeMessage.type, myFakeMessage.text, myFakeMessage.title, myFakeMessage.id, myFakeMessage.min, myFakeMessage.max, myFakeMessage.current, myFakeMessage.callbackMethod, myFakeMessage.slate);
				}

				//console.log(JSON.stringify(uploadEntry));
			}

			function editEZQuest(quest)
			{
				if( quest._template == '' )
					return;
								
				if(!originalGivenTabId)
					aaapi.cmd("consoleCommand", "ignore_next_tab_up 1");

				window.location = "asset://ui/questBuilder_" + quest._template + ".html?questId=" + quest.id;
			}

			function processDownloadUpdate(downloadEntry)
			{
				var container, fileName, status, size, totalSize;//, percent;
				var other;

				totalSize = parseInt(downloadEntry.size);
				sizeDownloaded = 0;

				if( downloadedList.hasOwnProperty(downloadEntry.id) )
					sizeDownloaded += parseInt(downloadEntry.size);

				for( var x in downloadEntry.other )
				{
					other = downloadEntry.other[x];
					totalSize += parseInt(other.size);

					// check if this one is already downloaded or not
					if( !!downloadedList && downloadedList.hasOwnProperty(x) )
						sizeDownloaded += parseInt(other.size);
				}
				
				var shortFileName = downloadEntry.file;
				var found = shortFileName.lastIndexOf("/");
				if( found < 0 )
					found = shortFileName.lastIndexOf("\\");
				if( found > 0 )
					shortFileName = shortFileName.substring(found+1);

				found = shortFileName.lastIndexOf(".");
				if( found > 0 )
					shortFileName = shortFileName.substring(0, found);

				var myFakeMessage = {
					"type": "byteprogress",
					"text": "",
					"title": shortFileName,
					"id": downloadEntry.id,
					"min": 0 + "",
					"max": totalSize + "",
					"current": sizeDownloaded + "",
					"callbackMethod": "",
					"slate": downloadsContainer
				};

				if( sizeDownloaded > 0 )
				{
					arcadeHud.removeHudLoadingMessage(downloadEntry.id);
					myFakeMessage.slate = downloadingContainer;
				}

				arcadeHud.addHudLoadingMessage(myFakeMessage.type, myFakeMessage.text, myFakeMessage.title, myFakeMessage.id, myFakeMessage.min, myFakeMessage.max, myFakeMessage.current, myFakeMessage.callbackMethod, myFakeMessage.slate);
			}

			function processDownloadedUpdate(downloadedEntry)
			{
				var container, fileName, size, totalSize;//, percent;
				var other;

				totalSize = parseInt(downloadedEntry.size);
				sizeDownloaded = 0;

				if( !!downloadedList && !downloadedList.hasOwnProperty(downloadedEntry.id) )
					sizeDownloaded += parseInt(downloadedEntry.size);

				for( var x in downloadedEntry.other )
				{
					other = downloadedEntry.other[x];
					totalSize += parseInt(other.size);

					//if( !!downloadedList && !downloadedList.hasOwnProperty(x) )
						sizeDownloaded += parseInt(other.size);
				}

				var shortFileName = downloadedEntry.file;
				var found = shortFileName.lastIndexOf("/");
				if( found < 0 )
					found = shortFileName.lastIndexOf("\\");
				if( found > 0 )
					shortFileName = shortFileName.substring(found+1);

				found = shortFileName.lastIndexOf(".");
				if( found > 0 )
					shortFileName = shortFileName.substring(0, found);

				var myFakeMessage = {
					"type": "byteprogress",
					"text": "",
					"title": shortFileName,
					"id": downloadedEntry.id,
					"min": "",//0 + "",
					"max": "",//totalSize + "",
					"current": sizeDownloaded + "",
					"callbackMethod": "",
					"slate": downloadedContainer
				};

				arcadeHud.addHudLoadingMessage(myFakeMessage.type, myFakeMessage.text, myFakeMessage.title, myFakeMessage.id, myFakeMessage.min, myFakeMessage.max, myFakeMessage.current, myFakeMessage.callbackMethod, myFakeMessage.slate);
			}

			function prepTransfersMenu()
			{
				transfers = aaapi.cmdEx('getAllTransfers');
				uploads = transfers.uploads;
				downloads = transfers.downloads;
				downloadedList = (downloads.length > 0) ? downloads[0].downloaded : {};
				downloaded = transfers.downloaded;
				requested = transfers.requested;
				
				for( var i = 0; i < downloads.length; i++ )
					processDownloadUpdate(downloads[i]);

				for( var i = 0; i < downloaded.length; i++ )
					processDownloadedUpdate(downloaded[i]);

				for( var i = 0; i < requested.length; i++ )
					processFileRequested(requested[i]);

				if( (downloads.length > 0 || downloaded.length > 0 || requested.length > 0) && noDownloadsElem.style.display != 'none' )
					noDownloadsElem.style.display = 'none';

				// downloads
				//while(downloadCountContainer.firstChild)
					//downloadCountContainer.removeChild(downloadCountContainer.firstChild);
				downloadCountContainer.innerHTML = '';

				downloadCountContainer.appendChild(document.createTextNode(downloads.length + downloaded.length));

				// downloaded
				//while(downloadedCountContainer.firstChild)
				//	downloadedCountContainer.removeChild(downloadedCountContainer.firstChild);
				downloadedCountContainer.innerHTML = '';

				downloadedCountContainer.appendChild(document.createTextNode(downloaded.length));


				// UPLOADS
				for( var i = 0; i < uploads.length; i++ )
					processUploadUpdate(uploads[i]);

				if( uploads.length > 0 && noUploadsElem.style.display != 'none' )
					noUploadsElem.style.display = 'none';

				var numUploaded = 0;
				for( var i = 0; i < uploads.length; i++ )
				{
					if( uploads[i].status == 'uploaded' )
						numUploaded++;
				}

				// uploads
				uploadCountContainer.innerHTML = '';
				uploadCountContainer.appendChild(document.createTextNode(uploads.length));

				// uploaded
				uploadedCountContainer.innerHTML = '';
				uploadedCountContainer.appendChild(document.createTextNode(numUploaded));
			}

			var transferListener = {
				onFileRequested: function(fileRequestEntry)
				{
					if( !!!downloadedList )
						downloadedList = {};

					requested.push(fileRequestEntry);

					if( noDownloadsElem.style.display != 'none' )
						noDownloadsElem.style.display = 'none';

					processFileRequested(fileRequestEntry);
				},
				onDownloadUpdate: function(transferEntry, fileId)
				{
					downloadedList = transferEntry.downloaded;

					if( !!transferEntry.downloaded )
						downloadedList = transferEntry.downloaded;
					else if( !!!downloadedList )
						downloadedList = {};

					if( (downloads.length > 0 || downloaded.length > 0 || requested.length > 0) && noDownloadsElem.style.display != 'none' )
						noDownloadsElem.style.display = 'none';

					processDownloadUpdate(transferEntry);
				},
				onDownloadAdded: function(transferEntry)
				{
					// add it to downloads
					downloads.push(transferEntry);

					// if we are already on the list as a request, remove our hud msg there.
					/*for( var i = 0; i < requested.length; i++ )
					{
						if( requested[i].id == transferEntry.id )
						{
							arcadeHud.removeHudLoadingMessage(transferEntry.id);
							continue;
						}
					}*/

					if( !!transferEntry.downloaded )
						downloadedList = transferEntry.downloaded;
					else if( !!!downloadedList )
						downloadedList = {};

					// downloads
					//while(downloadCountContainer.firstChild)
					//	downloadCountContainer.removeChild(downloadCountContainer.firstChild);
					downloadCountContainer.innerHTML = '';

					downloadCountContainer.appendChild(document.createTextNode(downloads.length + downloaded.length));

					// downloaded
					//while(downloadedCountContainer.firstChild)
					//	downloadedCountContainer.removeChild(downloadedCountContainer.firstChild);
					downloadedCountContainer.innerHTML = '';

					downloadedCountContainer.appendChild(document.createTextNode(downloaded.length));

					if( noDownloadsElem.style.display != 'none' )
						noDownloadsElem.style.display = 'none';

					processDownloadUpdate(transferEntry);
				},
				onDownloadComplete: function(transferEntry)
				{
					// remove the entry from downloads
					for( var i = 0; i < downloads.length; i++ )
					{
						if( downloads[i].id == transferEntry.id )
						{
							downloads.splice(i, 1);
							break;
						}
					}
					arcadeHud.removeHudLoadingMessage(transferEntry.id);

					// add it to downloaded
					downloaded.push(transferEntry);

					// downloads
					//while(downloadCountContainer.firstChild)
					//	downloadCountContainer.removeChild(downloadCountContainer.firstChild);\
					downloadCountContainer.innerHTML = '';

					downloadCountContainer.appendChild(document.createTextNode(downloads.length + downloaded.length));

					// downloaded
					//while(downloadedCountContainer.firstChild)
					//	downloadedCountContainer.removeChild(downloadedCountContainer.firstChild);
					downloadedCountContainer.innerHTML = '';

					downloadedCountContainer.appendChild(document.createTextNode(downloaded.length));

					if( noDownloadsElem.style.display != 'none' )
						noDownloadsElem.style.display = 'none';

					processDownloadedUpdate(transferEntry);
				},
				onUploadStatusAdded: function(transferEntry)
				{
					processUploadUpdate(transferEntry);
				},
				onUploadStatusSkipped: function(transferEntry)
				{
					processUploadUpdate(transferEntry);
				},
				onUploadStatusFailure: function(transferEntry)
				{
					processUploadUpdate(transferEntry);
				},
				onUploadStatusSuccess: function(transferEntry)
				{
					processUploadUpdate(transferEntry);
				}
			};

			function aaOnActivateInputMode(opts)
			{
				/*
					"fullscreen": isFullscreen,
					"hudPinned": isHudPinned,
					"mapLoaded": isMapLoaded,
					"objectSelected": isObjectSelected,
					"itemSelected": isItemSelected,
					"mainMenu": isMainMenu,
					"url": url,
					"selectedObject": isSelectedObject,
					"embeddedInstanceType": embeddedInstanceType,
					"canStream": canStream,
					"canPreview": canPreview,
					"canGoForward": canGoForward,
					"canGoBack": canGoBack,
					"libretroCore": libretroCore,
					"libretroFile": libretroFile,
					"libretroCanRun": libretroCanRun,
					"libretroOverlayX": libretroOverlayX,
					"libretroOverlayY": libretroOverlayY,
					"libretroOverlayWidth": libretroOverlayWidth,
					"libretroOverlayHeight": libretroOverlayHeight,
					"libretroOverlayId": libretroOverlayId,
					"activeScraperId": activeScraperId,
					"connectedToUniverse": connectedToUniverse,
					"isHost": isHost,
					"isGamepadInput": isGamepadInput
				*/
				if( opts.isHost !== true )
					downloadsPane.style.maxHeight = "750px";
			}

			function toggleHiddenQuests()
			{
				var elem = document.querySelector('#questsHiddenContainer');
				if(elem.style.display == 'block')
				{
					elem.style.display =  'none';
					var elems = document.querySelectorAll(".questHiddenCategoryState");
					for( var i = 0; i < elems.length; i++)
					{
						elems[i].innerHTML = "&#9650;";
					}
				}
				else
				{
					elem.style.display =  'block';
					var elems = document.querySelectorAll(".questHiddenCategoryState");
					for( var i = 0; i < elems.length; i++)
					{
						elems[i].innerHTML = "&#9660;";
					}
				}
			}
		</script>

		<!--div style="position: absolute; bottom: 0; text-align: center; width: 100%; padding: 8px; font-size: 30px; padding-bottom: 24px;"><div class="aaHelpContainer"></div></div-->
	</body>
</html>