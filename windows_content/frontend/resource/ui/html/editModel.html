<html>
	<head>
		<link rel="stylesheet" type="text/css" href="asset://ui/hud.css"></link>
		<script src="asset://ui/hud.js"></script>
	</head>
	<body>

		<div style="pointer-events: none; position: absolute; left: 0; top: 0; right: 0; bottom: 0;">
		<table style="width: 100%; height: 100%;">
		<tr ><td valign="middle" align="center">
		<div style="display: inline-block;">

		<script>
			var id = arcadeHud.getParameterByName("id");
			var model = aaapi.cmdEx("getLibraryModel", id);
			var fullPath = aaapi.cmdEx("getFullAssetPath", model.platforms[arcadeHud.platformId].file);
			console.log(fullPath);
			
			var uiBack = arcadeHud.getParameterByName("uiback");
			var uiClose = arcadeHud.getParameterByName("uiClose");
			if( !!!uiClose || uiClose === "" )
				uiClose = "aaapi.cmd('deactivateInputMode');";
			//"window.location='asset://ui/overlay.html';";
			var windowHeaderHTML = arcadeHud.generateWindowHeaderHTML("Model Properties", "width: 600px;", false, true, uiBack, uiClose);
			document.write(windowHeaderHTML);

			function metaSearch(filedName)
			{
				//document.location = "asset://ui/metaSearch.html?id=" + encodeURIComponent(id) + "&field=" + encodeURIComponent(filedName);
				//return;
			}
		</script>

		<form id="entryForm" style="margin: 0;">

		<script>
			var windowTabsHeaderHTML = arcadeHud.generateWindowTabsHeaderHTML({
				"tabs": [
					{
						"id": "general",
						"title": "General"
					},
					{
						"id": "other",
						"title": "Other"
					}
				]
			});
			document.write(windowTabsHeaderHTML);
		</script>

		<div class="aaTabContent aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor" tabid="general">
			<table class="aaKeyValueTable" style="width: 100%;" cellspacing="0">
				<tr class="helpNote" help="The title of the model. Useful when searching through your props.">
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Title:
					</td>
					<td class="aaKeyValueTableValue">
						<input fieldname="title" type="text" class="aaTextSizeFontSize" style="width: 100%;" />
					</td>
					<td style="width: 1%; white-space: nowrap;">
					</td>
				</tr>
				<!--
				<tr>
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Type:
					</td>
					<td class="aaKeyvalueTableValue">
						<select fieldname="type" class="aaTextSizeFontSize" style="width: 100%;">
							<option value="">Other</option>
						</select>
					</td>
					<td style="width: 1%; white-space: nowrap;">
					</td>
				</tr>
				<tr>
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Open With:
					</td>
					<td class="aaKeyvalueTableValue">
						<select fieldname="app" class="aaTextSizeFontSize" style="width: 100%;">
							<option>Windows (default)</option>
						</select>
					</td>
					<td style="width: 1%; white-space: nowrap;">
					</td>
				</tr>
				-->
				<tr class="helpNote" help="WARNING: You usually shouldn't change this!<br /><br />This is the actual MDL file that this model uses.<br /><br />It's only useful to change this to a different MDL if you have a lot of instances of the same broken model everywhere and don't want to replace them all one-by-one.">
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Model File:
					</td>
					<td class="aaKeyvalueTableValue">
						<input fieldname="platforms/-KJvcne3IKMZQTaG7lPo/file" type="text" class="aaTextSizeFontSize" style="width: 100%;" disabled />
					</td>
					<td style="width: 1%; white-space: nowrap;">
						<div style="display: none;">
						<div class="aaButton aaKeyValuesRowButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="min-width: initial; padding: 6px; width: 18px; height: 18px; margin-left: 4px; display: inline-block;" onclick="fileBrowse('platforms/-KJvcne3IKMZQTaG7lPo/file');">
							<script>
								document.write(arcadeHud.generateIconHTML("browseicon.png", 18, 18, "aaTextColorTwoHighColor"));
							</script>
						</div>
						<!--
						<div class="aaButton aaKeyValuesRowButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="min-width: initial; padding: 6px; width: 18px; height: 18px; margin-left: 4px; display: inline-block;" onclick="metaSearch('file');">
							<script>
								document.write(arcadeHud.generateIconHTML("webicon.png", 18, 18, "aaTextColorTwoHighColor"));
							</script>
						</div>
						-->
						</div>
					</td>
				</tr>
				<tr class="helpNote" help="This image is used in various menus.">
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Thumbnail:
					</td>
					<td class="aaKeyValueTableValue">
						<input fieldname="screen" type="text" class="aaTextSizeFontSize" style="width: 100%;" />
					</td>
					<td style="width: 1%; white-space: nowrap;">
						<div class="aaButton aaKeyValuesRowButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="min-width: initial; padding: 6px; width: 18px; height: 18px; margin-left: 4px; display: inline-block;" onclick="fileBrowse('screen');">
							<script>
								document.write(arcadeHud.generateIconHTML("browseicon.png", 18, 18, "aaTextColorTwoHighColor"));
							</script>
						</div><!--
						<div class="aaButton aaKeyValuesRowButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="min-width: initial; padding: 6px; width: 18px; height: 18px; margin-left: 4px; display: inline-block;" onclick="metaSearch('screen');">
							<script>
								document.write(arcadeHud.generateIconHTML("webicon.png", 18, 18, "aaTextColorTwoHighColor"));
							</script>
						</div>-->
					</td>
				</tr>
				<tr class="helpNote" help="Your tags will be useful when selecting cabinets.<br /><br />Comma-separated tags, for example: console, retro, tabletop">
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Tags:
					</td>
					<td class="aaKeyValueTableValue">
						<input fieldname="keywords" type="text" class="aaTextSizeFontSize" style="width: 100%;" />
					</td>
					<td style="width: 1%; white-space: nowrap;">
					</td>
				</tr>
			</table>
		</div>
		<div class="aaTabContent aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor" tabid="other">
			<table class="aaKeyValueTable" style="width: 100%;" cellspacing="0">
				<tr>
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Mount:
					</td>
					<td class="aaKeyValueTableValue">
						<input fieldname="platforms/-KJvcne3IKMZQTaG7lPo/mountid" type="text" class="aaTextSizeFontSize" style="width: 100%;" disabled />
						<!--<select fieldname="platforms/-KJvcne3IKMZQTaG7lPo/mountids" class="aaTextSizeFontSize" style="width: 100%;">
						</select>-->
					</td>
					<td style="width: 1%; white-space: nowrap;">
					</td>
				</tr>
				<tr>
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Workshop:
					</td>
					<td class="aaKeyValueTableValue">
						<input fieldname="platforms/-KJvcne3IKMZQTaG7lPo/workshopid" type="text" class="aaTextSizeFontSize" style="width: 100%;" disabled />
					</td>
					<td style="width: 1%; white-space: nowrap;">
					</td>
				</tr>
				<tr class="helpNote" help="A URL where this model can be downloaded from. Usually a URL to GarrysMod.org, ModDb.com, or GameBanana.com, etc.">
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Download Website:
					</td>
					<td class="aaKeyValueTableValue">
						<input fieldname="platforms/-KJvcne3IKMZQTaG7lPo/download" type="text" class="aaTextSizeFontSize" style="width: 100%;" />
					</td>
					<td style="width: 1%; white-space: nowrap;">
					</td>
				</tr>
				<tr>
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Preview Website:
					</td>
					<td class="aaKeyValueTableValue">
						<input fieldname="preview" type="text" class="aaTextSizeFontSize" style="width: 100%;" disabled />
					</td>
					<td style="width: 1%; white-space: nowrap;">
					</td>
				</tr>
				<!--
				<tr>
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Stream Website:
					</td>
					<td class="aaKeyValueTableValue">
						<input fieldname="stream" type="text" class="aaTextSizeFontSize" style="width: 100%;" />
					</td>
					<td style="width: 1%; white-space: nowrap;">
						<div class="aaButton aaKeyValuesRowButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="min-width: initial; padding: 6px; width: 18px; height: 18px; margin-left: 4px; display: inline-block;" onclick="metaSearch('stream');">
							<script>
								document.write(arcadeHud.generateIconHTML("webicon.png", 18, 18, "aaTextColorTwoHighColor"));
							</script>
						</div>
					</td>
				</tr><tr>
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Download Website:
					</td>
					<td class="aaKeyValueTableValue">
						<input fieldname="download" type="text" class="aaTextSizeFontSize" style="width: 100%;" />
					</td>
					<td style="width: 1%; white-space: nowrap;">
						<div class="aaButton aaKeyValuesRowButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="min-width: initial; padding: 6px; width: 18px; height: 18px; margin-left: 4px; display: inline-block;" onclick="metaSearch('download');">
							<script>
								document.write(arcadeHud.generateIconHTML("webicon.png", 18, 18, "aaTextColorTwoHighColor"));
							</script>
						</div>
					</td>
				</tr><tr>
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Reference Website:
					</td>
					<td class="aaKeyValueTableValue">
						<input fieldname="reference" type="text" class="aaTextSizeFontSize" style="width: 100%;" />
					</td>
					<td style="width: 1%; white-space: nowrap;">
						<div class="aaButton aaKeyValuesRowButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" style="min-width: initial; padding: 6px; width: 18px; height: 18px; margin-left: 4px; display: inline-block;" onclick="metaSearch('reference');">
							<script>
								document.write(arcadeHud.generateIconHTML("webicon.png", 18, 18, "aaTextColorTwoHighColor"));
							</script>
						</div>
					</td>
				</tr><tr>
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Description:
					</td>
					<td class="aaKeyValueTableValue">
						<input fieldname="description" type="text" class="aaTextSizeFontSize" style="width: 100%;" />
					</td>
					<td style="width: 1%; white-space: nowrap;">
					</td>
				</tr><tr>
					<td class="aaKeyValueTableKey aaTextColorTwoColor aaTextSizeFontSize">
						Tags:
					</td>
					<td class="aaKeyValueTableValue">
						<input fieldname="keywords" type="text" class="aaTextSizeFontSize" style="width: 100%;" />
					</td>
					<td style="width: 1%; white-space: nowrap;">
					</td>
				</tr>
				-->
			</table>
		</div>

		<script>
			var windowTabsFooterHTML = arcadeHud.generateWindowTabsFooterHTML();
			document.write(windowTabsFooterHTML);
		</script>

		<table class="aaWindowActions" style="position: absolute; pointer-events: none; visibility: hidden;">
			<tr>
				<td>
				</td>
				<td style="width: 1%; white-space: nowrap;">
					<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" value="OK" />
					<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" value="Cancel" />
					<input type="submit" class="aaButton aaButtonDisabled aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" value="Apply" />
				</td>
			</tr>
		</table>
		</form>

		<script>
			var windowFooterHTML = arcadeHud.generateWindowFooterHTML();
			document.write(windowFooterHTML);
		</script>

		</div>
		</td></tr>
		</table>
		</div>

		<a href="javascript:location.reload();" class="devReload">&bull;&nbsp;</a>

		<script>
			if( !!!uiBack )
				uiBack = "";

			var entryForm = document.querySelector("#entryForm");

			function fileBrowse(fieldName)
			{
				var fieldElem = document.querySelector(".aaKeyValueTableValue > input[fieldname='" + fieldName + "'], .aaKeyValueTableValue > select[fieldname='" + fieldName + "']");

				arcadeHud.browseForFile(function(chosenFile)
				{
					var okayToSave = false;
					if(chosenFile !== "")
					{
						if( fieldName === "platforms/-KJvcne3IKMZQTaG7lPo/file" )
						{
							if( chosenFile.toLowerCase().indexOf(".mdl") === chosenFile.length - 4 )
							{
								// Hack 'n slash the absolute path to be relative:
								// Assume 1st instance of a "models" folder is the root folder,
								// this will be correct in most cases.  The major exception is if
								// the user chooses an MDL manually that is outside of any mounted folder.
								// This sort of exception can only be caught by the back-end and should
								// result in success = false in the response for creating the library entry.

								// STEP 1 (handled by us):
								//		Drop everything before the "models" folder.  No models folder = invalid.
								// STEP 2 (handled by AAAPI):
								//		Make sure the file (using the relative path given in API call) exists.
								var matchIndex = chosenFile.indexOf("/models/");
								if( matchIndex === -1 )
									matchIndex = chosenFile.indexOf("\\models\\") + 1;

								if( matchIndex >= 0 )
								{
									chosenFile = chosenFile.substring(matchIndex);
									okayToSave = true;
								}
								else
									console.log("Invalid path.");
							}
						}
						else
							okayToSave = true;
					}

					if( okayToSave )
					{
						this.value = chosenFile;
						this.focus();
						entryForm.querySelector("input[type='submit']").click();
					}
				}.bind(fieldElem));
			}

			// PREPARE FORM
			entryForm.addEventListener("submit", function(e)
			{
				e.preventDefault();

				var focusedElem = document.activeElement;
				var focusedFieldName = focusedElem.getAttribute("fieldname");
				var focusedFieldValue = focusedElem.value;

				if( focusedFieldValue.toLowerCase().indexOf("https://") === 0 )
					focusedFieldValue = "http://" + focusedFieldValue.substring(8);
				
				if( !focusedFieldName )
					focusedElem = null;

				// DO WORK
				if( !!focusedElem )
				{
					console.log("Entry form submitted with field " + focusedFieldName + " focused.");

					var success = aaapi.cmdEx("updateModel", id, [focusedFieldName, focusedFieldValue]);
					if( success )
					{
						focusedElem.style.webkitTransition = "initial";
						focusedElem.classList.add("aaThemeColorOneBackgroundColor");
						focusedElem.offsetTop;
						focusedElem.style.webkitTransition = "background-color 0.5s ease-in-out";
						focusedElem.classList.remove("aaThemeColorOneBackgroundColor");

						//model[focusedFieldName] = focusedFieldValue;
						if( focusedFieldName.indexOf("/") === -1 )
							model[focusedFieldName] = focusedFieldValue;
						else
						{
							// convert slashes into structures
							var tree = focusedFieldName.split("/");
							var object = model;
							for( var j = 0; typeof object !== "undefined" && j < tree.length-1; j++ )
								object = object[tree[j]];

							object[tree[tree.length - 1]] = focusedFieldValue;
						}

						//field = focusedFieldValue;
						console.log("Model updated!");
						aaapi.cmd("sendEntryUpdate", "Model", id);
					}
					else
						console.log("Model update rejected!");
				}
				else
					console.log("Entry form submitted via button click.");

				// done doing work
				if( !!focusedElem )
					focusedElem.blur();
			}, true);

			// PREPARE TYPES
			var allTypes = aaapi.cmdEx("getAllLibraryTypes");
			var allTypesSorted = [];

			for( var x in allTypes )
				allTypesSorted.push(allTypes[x]);

			allTypesSorted.sort(function(a, b)
			{
				if( a.title.toLowerCase() < b.title.toLowerCase() )
					return -1;
				else if( a.title.toLowerCase() > b.title.toLowerCase() )
					return 1;
				else
					return 0;
			});


			// PREPARE APPS
			var allApps = aaapi.cmdEx("getAllLibraryApps");
			var allAppsSorted = [];

			for( var x in allApps )
				allAppsSorted.push(allApps[x]);

			allAppsSorted.sort(function(a, b)
			{
				if( a.title.toLowerCase() < b.title.toLowerCase() )
					return -1;
				else if( a.title.toLowerCase() > b.title.toLowerCase() )
					return 1;
				else
					return 0;
			});


			// PREPARE THE MODEL
			var fieldName;
			var valueElems;
			var dummyElem;
			var dummyElems = document.querySelectorAll(".aaKeyValueTableValue > input, .aaKeyValueTableValue > select");

			for( var i = 0; i < dummyElems.length; i++ )
			{
				dummyElem = dummyElems[i];
				fieldName = dummyElem.getAttribute("fieldname");
/*
				if( fieldName === "type" )
				{
					dummyElem.addEventListener("change", function(e)
					{
						var elem = e.target;
						var fieldName = elem.getAttribute("fieldname");
						var fieldValue = elem.value;

						var success = aaapi.cmdEx("updateModel", id, [fieldName, fieldValue]);
						if( success )
						{
							elem.style.webkitTransition = "initial";
							elem.classList.add("aaThemeColorOneBackgroundColor");
							elem.offsetTop;
							elem.style.webkitTransition = "background-color 0.5s ease-in-out";
							elem.classList.remove("aaThemeColorOneBackgroundColor");

							model[fieldName] = fieldValue;
							console.log("Model updated!");
						}
						else
							console.log("Model update rejected!");
					}, true);

					// populate any TYPE lists
					for( var j = 0; j < allTypesSorted.length; j++ )
					{
						var optionElem = document.createElement("option");
						optionElem.text = allTypesSorted[j].title;
						optionElem.value = allTypesSorted[j].info.id;
						dummyElem.appendChild(optionElem);
					}
				}
				else
				{*/
					dummyElem.addEventListener('blur', function(e)
					{
						var elem = e.target;
						var fieldName = elem.getAttribute("fieldname");

						var val;
						if( fieldName.indexOf("/") === -1 )
							val = model[fieldName];
						else
						{
							// convert slashes into structures
							var tree = fieldName.split("/");
							val = model;
							for( var j = 0; typeof val !== "undefined" && j < tree.length; j++ )
								val = val[tree[j]];
						}

						//console.log(fieldName + " is: " + elem.value + " vs " + val);
						if( elem.value != val )
							elem.value = (!!val) ? val : "";
					}, true);
				//}

				var val;
				if( fieldName.indexOf("/") === -1 )
					val = model[fieldName];
				else
				{
					// convert slashes into structures
					var tree = fieldName.split("/");
					val = model;
					for( var j = 0; typeof val !== "undefined" && j < tree.length; j++ )
						val = val[tree[j]];
				}

				if( typeof val !== "undefined" )
				{
					//console.log(dummyElem.tagName);
					if( fieldName.indexOf("mountids") === fieldName.length - 8 )
					{
						var mount = aaapi.cmdEx("getMount", val);
						if( mount )
						{
							console.log(JSON.stringify(mount));
							dummyElem.value = mount.title;
						}
						else
							dummyElem.value = val;
					}
					else if( fieldName.indexOf("workshopid") === fieldName.length - 10 )
					{
						var workshopSub = aaapi.cmdEx("getWorkshopSubscription", val);
						//console.log(JSON.stringify(workshopSub));
						if( !!workshopSub )
						{
							dummyElem.value = workshopSub.title;
						}
						else
							dummyElem.value = val;
					}
					else
						dummyElem.value = val;
				}
			}
		</script>
	</body>
</html>